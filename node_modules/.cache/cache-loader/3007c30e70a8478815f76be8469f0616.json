{"remainingRequest":"C:\\mine\\搭webpack环境\\so\\node_modules\\thread-loader\\dist\\cjs.js!C:\\mine\\搭webpack环境\\so\\node_modules\\babel-loader\\lib\\index.js!C:\\mine\\搭webpack环境\\so\\node_modules\\babel-loader\\lib\\index.js!C:\\mine\\搭webpack环境\\so\\node_modules\\vue\\dist\\vue.runtime.esm.js","dependencies":[{"path":"C:\\mine\\搭webpack环境\\so\\node_modules\\vue\\dist\\vue.runtime.esm.js","mtime":499162500000},{"path":"C:\\mine\\搭webpack环境\\so\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"C:\\mine\\搭webpack环境\\so\\node_modules\\thread-loader\\dist\\cjs.js","mtime":499162500000},{"path":"C:\\mine\\搭webpack环境\\so\\node_modules\\babel-loader\\lib\\index.js","mtime":499162500000},{"path":"C:\\mine\\搭webpack环境\\so\\node_modules\\babel-loader\\lib\\index.js","mtime":499162500000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:ZnVuY3Rpb24gX3R5cGVvZjIob2JqKSB7IGlmICh0eXBlb2YgU3ltYm9sID09PSAiZnVuY3Rpb24iICYmIHR5cGVvZiBTeW1ib2wuaXRlcmF0b3IgPT09ICJzeW1ib2wiKSB7IF90eXBlb2YyID0gZnVuY3Rpb24gX3R5cGVvZjIob2JqKSB7IHJldHVybiB0eXBlb2Ygb2JqOyB9OyB9IGVsc2UgeyBfdHlwZW9mMiA9IGZ1bmN0aW9uIF90eXBlb2YyKG9iaikgeyByZXR1cm4gb2JqICYmIHR5cGVvZiBTeW1ib2wgPT09ICJmdW5jdGlvbiIgJiYgb2JqLmNvbnN0cnVjdG9yID09PSBTeW1ib2wgJiYgb2JqICE9PSBTeW1ib2wucHJvdG90eXBlID8gInN5bWJvbCIgOiB0eXBlb2Ygb2JqOyB9OyB9IHJldHVybiBfdHlwZW9mMihvYmopOyB9CgpmdW5jdGlvbiBfdHlwZW9mKG9iaikgewogIGlmICh0eXBlb2YgU3ltYm9sID09PSAiZnVuY3Rpb24iICYmIF90eXBlb2YyKFN5bWJvbC5pdGVyYXRvcikgPT09ICJzeW1ib2wiKSB7CiAgICBfdHlwZW9mID0gZnVuY3Rpb24gX3R5cGVvZihvYmopIHsKICAgICAgcmV0dXJuIF90eXBlb2YyKG9iaik7CiAgICB9OwogIH0gZWxzZSB7CiAgICBfdHlwZW9mID0gZnVuY3Rpb24gX3R5cGVvZihvYmopIHsKICAgICAgcmV0dXJuIG9iaiAmJiB0eXBlb2YgU3ltYm9sID09PSAiZnVuY3Rpb24iICYmIG9iai5jb25zdHJ1Y3RvciA9PT0gU3ltYm9sICYmIG9iaiAhPT0gU3ltYm9sLnByb3RvdHlwZSA/ICJzeW1ib2wiIDogX3R5cGVvZjIob2JqKTsKICAgIH07CiAgfQoKICByZXR1cm4gX3R5cGVvZihvYmopOwp9Ci8qIQogKiBWdWUuanMgdjIuNi4xMAogKiAoYykgMjAxNC0yMDE5IEV2YW4gWW91CiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgTGljZW5zZS4KICovCgovKiAgKi8KCgp2YXIgZW1wdHlPYmplY3QgPSBPYmplY3QuZnJlZXplKHt9KTsgLy8gVGhlc2UgaGVscGVycyBwcm9kdWNlIGJldHRlciBWTSBjb2RlIGluIEpTIGVuZ2luZXMgZHVlIHRvIHRoZWlyCi8vIGV4cGxpY2l0bmVzcyBhbmQgZnVuY3Rpb24gaW5saW5pbmcuCgpmdW5jdGlvbiBpc1VuZGVmKHYpIHsKICByZXR1cm4gdiA9PT0gdW5kZWZpbmVkIHx8IHYgPT09IG51bGw7Cn0KCmZ1bmN0aW9uIGlzRGVmKHYpIHsKICByZXR1cm4gdiAhPT0gdW5kZWZpbmVkICYmIHYgIT09IG51bGw7Cn0KCmZ1bmN0aW9uIGlzVHJ1ZSh2KSB7CiAgcmV0dXJuIHYgPT09IHRydWU7Cn0KCmZ1bmN0aW9uIGlzRmFsc2UodikgewogIHJldHVybiB2ID09PSBmYWxzZTsKfQovKioKICogQ2hlY2sgaWYgdmFsdWUgaXMgcHJpbWl0aXZlLgogKi8KCgpmdW5jdGlvbiBpc1ByaW1pdGl2ZSh2YWx1ZSkgewogIHJldHVybiB0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnIHx8IHR5cGVvZiB2YWx1ZSA9PT0gJ251bWJlcicgfHwgLy8gJGZsb3ctZGlzYWJsZS1saW5lCiAgX3R5cGVvZih2YWx1ZSkgPT09ICdzeW1ib2wnIHx8IHR5cGVvZiB2YWx1ZSA9PT0gJ2Jvb2xlYW4nOwp9Ci8qKgogKiBRdWljayBvYmplY3QgY2hlY2sgLSB0aGlzIGlzIHByaW1hcmlseSB1c2VkIHRvIHRlbGwKICogT2JqZWN0cyBmcm9tIHByaW1pdGl2ZSB2YWx1ZXMgd2hlbiB3ZSBrbm93IHRoZSB2YWx1ZQogKiBpcyBhIEpTT04tY29tcGxpYW50IHR5cGUuCiAqLwoKCmZ1bmN0aW9uIGlzT2JqZWN0KG9iaikgewogIHJldHVybiBvYmogIT09IG51bGwgJiYgX3R5cGVvZihvYmopID09PSAnb2JqZWN0JzsKfQovKioKICogR2V0IHRoZSByYXcgdHlwZSBzdHJpbmcgb2YgYSB2YWx1ZSwgZS5nLiwgW29iamVjdCBPYmplY3RdLgogKi8KCgp2YXIgX3RvU3RyaW5nID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZzsKCmZ1bmN0aW9uIHRvUmF3VHlwZSh2YWx1ZSkgewogIHJldHVybiBfdG9TdHJpbmcuY2FsbCh2YWx1ZSkuc2xpY2UoOCwgLTEpOwp9Ci8qKgogKiBTdHJpY3Qgb2JqZWN0IHR5cGUgY2hlY2suIE9ubHkgcmV0dXJucyB0cnVlCiAqIGZvciBwbGFpbiBKYXZhU2NyaXB0IG9iamVjdHMuCiAqLwoKCmZ1bmN0aW9uIGlzUGxhaW5PYmplY3Qob2JqKSB7CiAgcmV0dXJuIF90b1N0cmluZy5jYWxsKG9iaikgPT09ICdbb2JqZWN0IE9iamVjdF0nOwp9CgpmdW5jdGlvbiBpc1JlZ0V4cCh2KSB7CiAgcmV0dXJuIF90b1N0cmluZy5jYWxsKHYpID09PSAnW29iamVjdCBSZWdFeHBdJzsKfQovKioKICogQ2hlY2sgaWYgdmFsIGlzIGEgdmFsaWQgYXJyYXkgaW5kZXguCiAqLwoKCmZ1bmN0aW9uIGlzVmFsaWRBcnJheUluZGV4KHZhbCkgewogIHZhciBuID0gcGFyc2VGbG9hdChTdHJpbmcodmFsKSk7CiAgcmV0dXJuIG4gPj0gMCAmJiBNYXRoLmZsb29yKG4pID09PSBuICYmIGlzRmluaXRlKHZhbCk7Cn0KCmZ1bmN0aW9uIGlzUHJvbWlzZSh2YWwpIHsKICByZXR1cm4gaXNEZWYodmFsKSAmJiB0eXBlb2YgdmFsLnRoZW4gPT09ICdmdW5jdGlvbicgJiYgdHlwZW9mIHZhbFsiY2F0Y2giXSA9PT0gJ2Z1bmN0aW9uJzsKfQovKioKICogQ29udmVydCBhIHZhbHVlIHRvIGEgc3RyaW5nIHRoYXQgaXMgYWN0dWFsbHkgcmVuZGVyZWQuCiAqLwoKCmZ1bmN0aW9uIHRvU3RyaW5nKHZhbCkgewogIHJldHVybiB2YWwgPT0gbnVsbCA/ICcnIDogQXJyYXkuaXNBcnJheSh2YWwpIHx8IGlzUGxhaW5PYmplY3QodmFsKSAmJiB2YWwudG9TdHJpbmcgPT09IF90b1N0cmluZyA/IEpTT04uc3RyaW5naWZ5KHZhbCwgbnVsbCwgMikgOiBTdHJpbmcodmFsKTsKfQovKioKICogQ29udmVydCBhbiBpbnB1dCB2YWx1ZSB0byBhIG51bWJlciBmb3IgcGVyc2lzdGVuY2UuCiAqIElmIHRoZSBjb252ZXJzaW9uIGZhaWxzLCByZXR1cm4gb3JpZ2luYWwgc3RyaW5nLgogKi8KCgpmdW5jdGlvbiB0b051bWJlcih2YWwpIHsKICB2YXIgbiA9IHBhcnNlRmxvYXQodmFsKTsKICByZXR1cm4gaXNOYU4obikgPyB2YWwgOiBuOwp9Ci8qKgogKiBNYWtlIGEgbWFwIGFuZCByZXR1cm4gYSBmdW5jdGlvbiBmb3IgY2hlY2tpbmcgaWYgYSBrZXkKICogaXMgaW4gdGhhdCBtYXAuCiAqLwoKCmZ1bmN0aW9uIG1ha2VNYXAoc3RyLCBleHBlY3RzTG93ZXJDYXNlKSB7CiAgdmFyIG1hcCA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgdmFyIGxpc3QgPSBzdHIuc3BsaXQoJywnKTsKCiAgZm9yICh2YXIgaSA9IDA7IGkgPCBsaXN0Lmxlbmd0aDsgaSsrKSB7CiAgICBtYXBbbGlzdFtpXV0gPSB0cnVlOwogIH0KCiAgcmV0dXJuIGV4cGVjdHNMb3dlckNhc2UgPyBmdW5jdGlvbiAodmFsKSB7CiAgICByZXR1cm4gbWFwW3ZhbC50b0xvd2VyQ2FzZSgpXTsKICB9IDogZnVuY3Rpb24gKHZhbCkgewogICAgcmV0dXJuIG1hcFt2YWxdOwogIH07Cn0KLyoqCiAqIENoZWNrIGlmIGEgdGFnIGlzIGEgYnVpbHQtaW4gdGFnLgogKi8KCgp2YXIgaXNCdWlsdEluVGFnID0gbWFrZU1hcCgnc2xvdCxjb21wb25lbnQnLCB0cnVlKTsKLyoqCiAqIENoZWNrIGlmIGFuIGF0dHJpYnV0ZSBpcyBhIHJlc2VydmVkIGF0dHJpYnV0ZS4KICovCgp2YXIgaXNSZXNlcnZlZEF0dHJpYnV0ZSA9IG1ha2VNYXAoJ2tleSxyZWYsc2xvdCxzbG90LXNjb3BlLGlzJyk7Ci8qKgogKiBSZW1vdmUgYW4gaXRlbSBmcm9tIGFuIGFycmF5LgogKi8KCmZ1bmN0aW9uIHJlbW92ZShhcnIsIGl0ZW0pIHsKICBpZiAoYXJyLmxlbmd0aCkgewogICAgdmFyIGluZGV4ID0gYXJyLmluZGV4T2YoaXRlbSk7CgogICAgaWYgKGluZGV4ID4gLTEpIHsKICAgICAgcmV0dXJuIGFyci5zcGxpY2UoaW5kZXgsIDEpOwogICAgfQogIH0KfQovKioKICogQ2hlY2sgd2hldGhlciBhbiBvYmplY3QgaGFzIHRoZSBwcm9wZXJ0eS4KICovCgoKdmFyIGhhc093blByb3BlcnR5ID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eTsKCmZ1bmN0aW9uIGhhc093bihvYmosIGtleSkgewogIHJldHVybiBoYXNPd25Qcm9wZXJ0eS5jYWxsKG9iaiwga2V5KTsKfQovKioKICogQ3JlYXRlIGEgY2FjaGVkIHZlcnNpb24gb2YgYSBwdXJlIGZ1bmN0aW9uLgogKi8KCgpmdW5jdGlvbiBjYWNoZWQoZm4pIHsKICB2YXIgY2FjaGUgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogIHJldHVybiBmdW5jdGlvbiBjYWNoZWRGbihzdHIpIHsKICAgIHZhciBoaXQgPSBjYWNoZVtzdHJdOwogICAgcmV0dXJuIGhpdCB8fCAoY2FjaGVbc3RyXSA9IGZuKHN0cikpOwogIH07Cn0KLyoqCiAqIENhbWVsaXplIGEgaHlwaGVuLWRlbGltaXRlZCBzdHJpbmcuCiAqLwoKCnZhciBjYW1lbGl6ZVJFID0gLy0oXHcpL2c7CnZhciBjYW1lbGl6ZSA9IGNhY2hlZChmdW5jdGlvbiAoc3RyKSB7CiAgcmV0dXJuIHN0ci5yZXBsYWNlKGNhbWVsaXplUkUsIGZ1bmN0aW9uIChfLCBjKSB7CiAgICByZXR1cm4gYyA/IGMudG9VcHBlckNhc2UoKSA6ICcnOwogIH0pOwp9KTsKLyoqCiAqIENhcGl0YWxpemUgYSBzdHJpbmcuCiAqLwoKdmFyIGNhcGl0YWxpemUgPSBjYWNoZWQoZnVuY3Rpb24gKHN0cikgewogIHJldHVybiBzdHIuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyBzdHIuc2xpY2UoMSk7Cn0pOwovKioKICogSHlwaGVuYXRlIGEgY2FtZWxDYXNlIHN0cmluZy4KICovCgp2YXIgaHlwaGVuYXRlUkUgPSAvXEIoW0EtWl0pL2c7CnZhciBoeXBoZW5hdGUgPSBjYWNoZWQoZnVuY3Rpb24gKHN0cikgewogIHJldHVybiBzdHIucmVwbGFjZShoeXBoZW5hdGVSRSwgJy0kMScpLnRvTG93ZXJDYXNlKCk7Cn0pOwovKioKICogU2ltcGxlIGJpbmQgcG9seWZpbGwgZm9yIGVudmlyb25tZW50cyB0aGF0IGRvIG5vdCBzdXBwb3J0IGl0LAogKiBlLmcuLCBQaGFudG9tSlMgMS54LiBUZWNobmljYWxseSwgd2UgZG9uJ3QgbmVlZCB0aGlzIGFueW1vcmUKICogc2luY2UgbmF0aXZlIGJpbmQgaXMgbm93IHBlcmZvcm1hbnQgZW5vdWdoIGluIG1vc3QgYnJvd3NlcnMuCiAqIEJ1dCByZW1vdmluZyBpdCB3b3VsZCBtZWFuIGJyZWFraW5nIGNvZGUgdGhhdCB3YXMgYWJsZSB0byBydW4gaW4KICogUGhhbnRvbUpTIDEueCwgc28gdGhpcyBtdXN0IGJlIGtlcHQgZm9yIGJhY2t3YXJkIGNvbXBhdGliaWxpdHkuCiAqLwoKLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8KCmZ1bmN0aW9uIHBvbHlmaWxsQmluZChmbiwgY3R4KSB7CiAgZnVuY3Rpb24gYm91bmRGbihhKSB7CiAgICB2YXIgbCA9IGFyZ3VtZW50cy5sZW5ndGg7CiAgICByZXR1cm4gbCA/IGwgPiAxID8gZm4uYXBwbHkoY3R4LCBhcmd1bWVudHMpIDogZm4uY2FsbChjdHgsIGEpIDogZm4uY2FsbChjdHgpOwogIH0KCiAgYm91bmRGbi5fbGVuZ3RoID0gZm4ubGVuZ3RoOwogIHJldHVybiBib3VuZEZuOwp9CgpmdW5jdGlvbiBuYXRpdmVCaW5kKGZuLCBjdHgpIHsKICByZXR1cm4gZm4uYmluZChjdHgpOwp9Cgp2YXIgYmluZCA9IEZ1bmN0aW9uLnByb3RvdHlwZS5iaW5kID8gbmF0aXZlQmluZCA6IHBvbHlmaWxsQmluZDsKLyoqCiAqIENvbnZlcnQgYW4gQXJyYXktbGlrZSBvYmplY3QgdG8gYSByZWFsIEFycmF5LgogKi8KCmZ1bmN0aW9uIHRvQXJyYXkobGlzdCwgc3RhcnQpIHsKICBzdGFydCA9IHN0YXJ0IHx8IDA7CiAgdmFyIGkgPSBsaXN0Lmxlbmd0aCAtIHN0YXJ0OwogIHZhciByZXQgPSBuZXcgQXJyYXkoaSk7CgogIHdoaWxlIChpLS0pIHsKICAgIHJldFtpXSA9IGxpc3RbaSArIHN0YXJ0XTsKICB9CgogIHJldHVybiByZXQ7Cn0KLyoqCiAqIE1peCBwcm9wZXJ0aWVzIGludG8gdGFyZ2V0IG9iamVjdC4KICovCgoKZnVuY3Rpb24gZXh0ZW5kKHRvLCBfZnJvbSkgewogIGZvciAodmFyIGtleSBpbiBfZnJvbSkgewogICAgdG9ba2V5XSA9IF9mcm9tW2tleV07CiAgfQoKICByZXR1cm4gdG87Cn0KLyoqCiAqIE1lcmdlIGFuIEFycmF5IG9mIE9iamVjdHMgaW50byBhIHNpbmdsZSBPYmplY3QuCiAqLwoKCmZ1bmN0aW9uIHRvT2JqZWN0KGFycikgewogIHZhciByZXMgPSB7fTsKCiAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcnIubGVuZ3RoOyBpKyspIHsKICAgIGlmIChhcnJbaV0pIHsKICAgICAgZXh0ZW5kKHJlcywgYXJyW2ldKTsKICAgIH0KICB9CgogIHJldHVybiByZXM7Cn0KLyogZXNsaW50LWRpc2FibGUgbm8tdW51c2VkLXZhcnMgKi8KCi8qKgogKiBQZXJmb3JtIG5vIG9wZXJhdGlvbi4KICogU3R1YmJpbmcgYXJncyB0byBtYWtlIEZsb3cgaGFwcHkgd2l0aG91dCBsZWF2aW5nIHVzZWxlc3MgdHJhbnNwaWxlZCBjb2RlCiAqIHdpdGggLi4ucmVzdCAoaHR0cHM6Ly9mbG93Lm9yZy9ibG9nLzIwMTcvMDUvMDcvU3RyaWN0LUZ1bmN0aW9uLUNhbGwtQXJpdHkvKS4KICovCgoKZnVuY3Rpb24gbm9vcChhLCBiLCBjKSB7fQovKioKICogQWx3YXlzIHJldHVybiBmYWxzZS4KICovCgoKdmFyIG5vID0gZnVuY3Rpb24gbm8oYSwgYiwgYykgewogIHJldHVybiBmYWxzZTsKfTsKLyogZXNsaW50LWVuYWJsZSBuby11bnVzZWQtdmFycyAqLwoKLyoqCiAqIFJldHVybiB0aGUgc2FtZSB2YWx1ZS4KICovCgoKdmFyIGlkZW50aXR5ID0gZnVuY3Rpb24gaWRlbnRpdHkoXykgewogIHJldHVybiBfOwp9OwovKioKICogQ2hlY2sgaWYgdHdvIHZhbHVlcyBhcmUgbG9vc2VseSBlcXVhbCAtIHRoYXQgaXMsCiAqIGlmIHRoZXkgYXJlIHBsYWluIG9iamVjdHMsIGRvIHRoZXkgaGF2ZSB0aGUgc2FtZSBzaGFwZT8KICovCgoKZnVuY3Rpb24gbG9vc2VFcXVhbChhLCBiKSB7CiAgaWYgKGEgPT09IGIpIHsKICAgIHJldHVybiB0cnVlOwogIH0KCiAgdmFyIGlzT2JqZWN0QSA9IGlzT2JqZWN0KGEpOwogIHZhciBpc09iamVjdEIgPSBpc09iamVjdChiKTsKCiAgaWYgKGlzT2JqZWN0QSAmJiBpc09iamVjdEIpIHsKICAgIHRyeSB7CiAgICAgIHZhciBpc0FycmF5QSA9IEFycmF5LmlzQXJyYXkoYSk7CiAgICAgIHZhciBpc0FycmF5QiA9IEFycmF5LmlzQXJyYXkoYik7CgogICAgICBpZiAoaXNBcnJheUEgJiYgaXNBcnJheUIpIHsKICAgICAgICByZXR1cm4gYS5sZW5ndGggPT09IGIubGVuZ3RoICYmIGEuZXZlcnkoZnVuY3Rpb24gKGUsIGkpIHsKICAgICAgICAgIHJldHVybiBsb29zZUVxdWFsKGUsIGJbaV0pOwogICAgICAgIH0pOwogICAgICB9IGVsc2UgaWYgKGEgaW5zdGFuY2VvZiBEYXRlICYmIGIgaW5zdGFuY2VvZiBEYXRlKSB7CiAgICAgICAgcmV0dXJuIGEuZ2V0VGltZSgpID09PSBiLmdldFRpbWUoKTsKICAgICAgfSBlbHNlIGlmICghaXNBcnJheUEgJiYgIWlzQXJyYXlCKSB7CiAgICAgICAgdmFyIGtleXNBID0gT2JqZWN0LmtleXMoYSk7CiAgICAgICAgdmFyIGtleXNCID0gT2JqZWN0LmtleXMoYik7CiAgICAgICAgcmV0dXJuIGtleXNBLmxlbmd0aCA9PT0ga2V5c0IubGVuZ3RoICYmIGtleXNBLmV2ZXJ5KGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICAgIHJldHVybiBsb29zZUVxdWFsKGFba2V5XSwgYltrZXldKTsKICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLwogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgfSBjYXRjaCAoZSkgewogICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLwogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgfSBlbHNlIGlmICghaXNPYmplY3RBICYmICFpc09iamVjdEIpIHsKICAgIHJldHVybiBTdHJpbmcoYSkgPT09IFN0cmluZyhiKTsKICB9IGVsc2UgewogICAgcmV0dXJuIGZhbHNlOwogIH0KfQovKioKICogUmV0dXJuIHRoZSBmaXJzdCBpbmRleCBhdCB3aGljaCBhIGxvb3NlbHkgZXF1YWwgdmFsdWUgY2FuIGJlCiAqIGZvdW5kIGluIHRoZSBhcnJheSAoaWYgdmFsdWUgaXMgYSBwbGFpbiBvYmplY3QsIHRoZSBhcnJheSBtdXN0CiAqIGNvbnRhaW4gYW4gb2JqZWN0IG9mIHRoZSBzYW1lIHNoYXBlKSwgb3IgLTEgaWYgaXQgaXMgbm90IHByZXNlbnQuCiAqLwoKCmZ1bmN0aW9uIGxvb3NlSW5kZXhPZihhcnIsIHZhbCkgewogIGZvciAodmFyIGkgPSAwOyBpIDwgYXJyLmxlbmd0aDsgaSsrKSB7CiAgICBpZiAobG9vc2VFcXVhbChhcnJbaV0sIHZhbCkpIHsKICAgICAgcmV0dXJuIGk7CiAgICB9CiAgfQoKICByZXR1cm4gLTE7Cn0KLyoqCiAqIEVuc3VyZSBhIGZ1bmN0aW9uIGlzIGNhbGxlZCBvbmx5IG9uY2UuCiAqLwoKCmZ1bmN0aW9uIG9uY2UoZm4pIHsKICB2YXIgY2FsbGVkID0gZmFsc2U7CiAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgIGlmICghY2FsbGVkKSB7CiAgICAgIGNhbGxlZCA9IHRydWU7CiAgICAgIGZuLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9CiAgfTsKfQoKdmFyIFNTUl9BVFRSID0gJ2RhdGEtc2VydmVyLXJlbmRlcmVkJzsKdmFyIEFTU0VUX1RZUEVTID0gWydjb21wb25lbnQnLCAnZGlyZWN0aXZlJywgJ2ZpbHRlciddOwp2YXIgTElGRUNZQ0xFX0hPT0tTID0gWydiZWZvcmVDcmVhdGUnLCAnY3JlYXRlZCcsICdiZWZvcmVNb3VudCcsICdtb3VudGVkJywgJ2JlZm9yZVVwZGF0ZScsICd1cGRhdGVkJywgJ2JlZm9yZURlc3Ryb3knLCAnZGVzdHJveWVkJywgJ2FjdGl2YXRlZCcsICdkZWFjdGl2YXRlZCcsICdlcnJvckNhcHR1cmVkJywgJ3NlcnZlclByZWZldGNoJ107Ci8qICAqLwoKdmFyIGNvbmZpZyA9IHsKICAvKioKICAgKiBPcHRpb24gbWVyZ2Ugc3RyYXRlZ2llcyAodXNlZCBpbiBjb3JlL3V0aWwvb3B0aW9ucykKICAgKi8KICAvLyAkZmxvdy1kaXNhYmxlLWxpbmUKICBvcHRpb25NZXJnZVN0cmF0ZWdpZXM6IE9iamVjdC5jcmVhdGUobnVsbCksCgogIC8qKgogICAqIFdoZXRoZXIgdG8gc3VwcHJlc3Mgd2FybmluZ3MuCiAgICovCiAgc2lsZW50OiBmYWxzZSwKCiAgLyoqCiAgICogU2hvdyBwcm9kdWN0aW9uIG1vZGUgdGlwIG1lc3NhZ2Ugb24gYm9vdD8KICAgKi8KICBwcm9kdWN0aW9uVGlwOiBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nLAoKICAvKioKICAgKiBXaGV0aGVyIHRvIGVuYWJsZSBkZXZ0b29scwogICAqLwogIGRldnRvb2xzOiBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nLAoKICAvKioKICAgKiBXaGV0aGVyIHRvIHJlY29yZCBwZXJmCiAgICovCiAgcGVyZm9ybWFuY2U6IGZhbHNlLAoKICAvKioKICAgKiBFcnJvciBoYW5kbGVyIGZvciB3YXRjaGVyIGVycm9ycwogICAqLwogIGVycm9ySGFuZGxlcjogbnVsbCwKCiAgLyoqCiAgICogV2FybiBoYW5kbGVyIGZvciB3YXRjaGVyIHdhcm5zCiAgICovCiAgd2FybkhhbmRsZXI6IG51bGwsCgogIC8qKgogICAqIElnbm9yZSBjZXJ0YWluIGN1c3RvbSBlbGVtZW50cwogICAqLwogIGlnbm9yZWRFbGVtZW50czogW10sCgogIC8qKgogICAqIEN1c3RvbSB1c2VyIGtleSBhbGlhc2VzIGZvciB2LW9uCiAgICovCiAgLy8gJGZsb3ctZGlzYWJsZS1saW5lCiAga2V5Q29kZXM6IE9iamVjdC5jcmVhdGUobnVsbCksCgogIC8qKgogICAqIENoZWNrIGlmIGEgdGFnIGlzIHJlc2VydmVkIHNvIHRoYXQgaXQgY2Fubm90IGJlIHJlZ2lzdGVyZWQgYXMgYQogICAqIGNvbXBvbmVudC4gVGhpcyBpcyBwbGF0Zm9ybS1kZXBlbmRlbnQgYW5kIG1heSBiZSBvdmVyd3JpdHRlbi4KICAgKi8KICBpc1Jlc2VydmVkVGFnOiBubywKCiAgLyoqCiAgICogQ2hlY2sgaWYgYW4gYXR0cmlidXRlIGlzIHJlc2VydmVkIHNvIHRoYXQgaXQgY2Fubm90IGJlIHVzZWQgYXMgYSBjb21wb25lbnQKICAgKiBwcm9wLiBUaGlzIGlzIHBsYXRmb3JtLWRlcGVuZGVudCBhbmQgbWF5IGJlIG92ZXJ3cml0dGVuLgogICAqLwogIGlzUmVzZXJ2ZWRBdHRyOiBubywKCiAgLyoqCiAgICogQ2hlY2sgaWYgYSB0YWcgaXMgYW4gdW5rbm93biBlbGVtZW50LgogICAqIFBsYXRmb3JtLWRlcGVuZGVudC4KICAgKi8KICBpc1Vua25vd25FbGVtZW50OiBubywKCiAgLyoqCiAgICogR2V0IHRoZSBuYW1lc3BhY2Ugb2YgYW4gZWxlbWVudAogICAqLwogIGdldFRhZ05hbWVzcGFjZTogbm9vcCwKCiAgLyoqCiAgICogUGFyc2UgdGhlIHJlYWwgdGFnIG5hbWUgZm9yIHRoZSBzcGVjaWZpYyBwbGF0Zm9ybS4KICAgKi8KICBwYXJzZVBsYXRmb3JtVGFnTmFtZTogaWRlbnRpdHksCgogIC8qKgogICAqIENoZWNrIGlmIGFuIGF0dHJpYnV0ZSBtdXN0IGJlIGJvdW5kIHVzaW5nIHByb3BlcnR5LCBlLmcuIHZhbHVlCiAgICogUGxhdGZvcm0tZGVwZW5kZW50LgogICAqLwogIG11c3RVc2VQcm9wOiBubywKCiAgLyoqCiAgICogUGVyZm9ybSB1cGRhdGVzIGFzeW5jaHJvbm91c2x5LiBJbnRlbmRlZCB0byBiZSB1c2VkIGJ5IFZ1ZSBUZXN0IFV0aWxzCiAgICogVGhpcyB3aWxsIHNpZ25pZmljYW50bHkgcmVkdWNlIHBlcmZvcm1hbmNlIGlmIHNldCB0byBmYWxzZS4KICAgKi8KICBhc3luYzogdHJ1ZSwKCiAgLyoqCiAgICogRXhwb3NlZCBmb3IgbGVnYWN5IHJlYXNvbnMKICAgKi8KICBfbGlmZWN5Y2xlSG9va3M6IExJRkVDWUNMRV9IT09LUwp9OwovKiAgKi8KCi8qKgogKiB1bmljb2RlIGxldHRlcnMgdXNlZCBmb3IgcGFyc2luZyBodG1sIHRhZ3MsIGNvbXBvbmVudCBuYW1lcyBhbmQgcHJvcGVydHkgcGF0aHMuCiAqIHVzaW5nIGh0dHBzOi8vd3d3LnczLm9yZy9UUi9odG1sNTMvc2VtYW50aWNzLXNjcmlwdGluZy5odG1sI3BvdGVudGlhbGN1c3RvbWVsZW1lbnRuYW1lCiAqIHNraXBwaW5nIFx1MTAwMDAtXHVFRkZGRiBkdWUgdG8gaXQgZnJlZXppbmcgdXAgUGhhbnRvbUpTCiAqLwoKdmFyIHVuaWNvZGVSZWdFeHAgPSAvYS16QS1aXHUwMEI3XHUwMEMwLVx1MDBENlx1MDBEOC1cdTAwRjZcdTAwRjgtXHUwMzdEXHUwMzdGLVx1MUZGRlx1MjAwQy1cdTIwMERcdTIwM0YtXHUyMDQwXHUyMDcwLVx1MjE4Rlx1MkMwMC1cdTJGRUZcdTMwMDEtXHVEN0ZGXHVGOTAwLVx1RkRDRlx1RkRGMC1cdUZGRkQvOwovKioKICogQ2hlY2sgaWYgYSBzdHJpbmcgc3RhcnRzIHdpdGggJCBvciBfCiAqLwoKZnVuY3Rpb24gaXNSZXNlcnZlZChzdHIpIHsKICB2YXIgYyA9IChzdHIgKyAnJykuY2hhckNvZGVBdCgwKTsKICByZXR1cm4gYyA9PT0gMHgyNCB8fCBjID09PSAweDVGOwp9Ci8qKgogKiBEZWZpbmUgYSBwcm9wZXJ0eS4KICovCgoKZnVuY3Rpb24gZGVmKG9iaiwga2V5LCB2YWwsIGVudW1lcmFibGUpIHsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkob2JqLCBrZXksIHsKICAgIHZhbHVlOiB2YWwsCiAgICBlbnVtZXJhYmxlOiAhIWVudW1lcmFibGUsCiAgICB3cml0YWJsZTogdHJ1ZSwKICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZQogIH0pOwp9Ci8qKgogKiBQYXJzZSBzaW1wbGUgcGF0aC4KICovCgoKdmFyIGJhaWxSRSA9IG5ldyBSZWdFeHAoIlteIiArIHVuaWNvZGVSZWdFeHAuc291cmNlICsgIi4kX1xcZF0iKTsKCmZ1bmN0aW9uIHBhcnNlUGF0aChwYXRoKSB7CiAgaWYgKGJhaWxSRS50ZXN0KHBhdGgpKSB7CiAgICByZXR1cm47CiAgfQoKICB2YXIgc2VnbWVudHMgPSBwYXRoLnNwbGl0KCcuJyk7CiAgcmV0dXJuIGZ1bmN0aW9uIChvYmopIHsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc2VnbWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgaWYgKCFvYmopIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIG9iaiA9IG9ialtzZWdtZW50c1tpXV07CiAgICB9CgogICAgcmV0dXJuIG9iajsKICB9Owp9Ci8qICAqLwovLyBjYW4gd2UgdXNlIF9fcHJvdG9fXz8KCgp2YXIgaGFzUHJvdG8gPSAnX19wcm90b19fJyBpbiB7fTsgLy8gQnJvd3NlciBlbnZpcm9ubWVudCBzbmlmZmluZwoKdmFyIGluQnJvd3NlciA9IHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnOwp2YXIgaW5XZWV4ID0gdHlwZW9mIFdYRW52aXJvbm1lbnQgIT09ICd1bmRlZmluZWQnICYmICEhV1hFbnZpcm9ubWVudC5wbGF0Zm9ybTsKdmFyIHdlZXhQbGF0Zm9ybSA9IGluV2VleCAmJiBXWEVudmlyb25tZW50LnBsYXRmb3JtLnRvTG93ZXJDYXNlKCk7CnZhciBVQSA9IGluQnJvd3NlciAmJiB3aW5kb3cubmF2aWdhdG9yLnVzZXJBZ2VudC50b0xvd2VyQ2FzZSgpOwp2YXIgaXNJRSA9IFVBICYmIC9tc2llfHRyaWRlbnQvLnRlc3QoVUEpOwp2YXIgaXNJRTkgPSBVQSAmJiBVQS5pbmRleE9mKCdtc2llIDkuMCcpID4gMDsKdmFyIGlzRWRnZSA9IFVBICYmIFVBLmluZGV4T2YoJ2VkZ2UvJykgPiAwOwp2YXIgaXNBbmRyb2lkID0gVUEgJiYgVUEuaW5kZXhPZignYW5kcm9pZCcpID4gMCB8fCB3ZWV4UGxhdGZvcm0gPT09ICdhbmRyb2lkJzsKdmFyIGlzSU9TID0gVUEgJiYgL2lwaG9uZXxpcGFkfGlwb2R8aW9zLy50ZXN0KFVBKSB8fCB3ZWV4UGxhdGZvcm0gPT09ICdpb3MnOwp2YXIgaXNDaHJvbWUgPSBVQSAmJiAvY2hyb21lXC9cZCsvLnRlc3QoVUEpICYmICFpc0VkZ2U7CnZhciBpc1BoYW50b21KUyA9IFVBICYmIC9waGFudG9tanMvLnRlc3QoVUEpOwp2YXIgaXNGRiA9IFVBICYmIFVBLm1hdGNoKC9maXJlZm94XC8oXGQrKS8pOyAvLyBGaXJlZm94IGhhcyBhICJ3YXRjaCIgZnVuY3Rpb24gb24gT2JqZWN0LnByb3RvdHlwZS4uLgoKdmFyIG5hdGl2ZVdhdGNoID0ge30ud2F0Y2g7CnZhciBzdXBwb3J0c1Bhc3NpdmUgPSBmYWxzZTsKCmlmIChpbkJyb3dzZXIpIHsKICB0cnkgewogICAgdmFyIG9wdHMgPSB7fTsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShvcHRzLCAncGFzc2l2ZScsIHsKICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8KICAgICAgICBzdXBwb3J0c1Bhc3NpdmUgPSB0cnVlOwogICAgICB9CiAgICB9KTsgLy8gaHR0cHM6Ly9naXRodWIuY29tL2ZhY2Vib29rL2Zsb3cvaXNzdWVzLzI4NQoKICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCd0ZXN0LXBhc3NpdmUnLCBudWxsLCBvcHRzKTsKICB9IGNhdGNoIChlKSB7fQp9IC8vIHRoaXMgbmVlZHMgdG8gYmUgbGF6eS1ldmFsZWQgYmVjYXVzZSB2dWUgbWF5IGJlIHJlcXVpcmVkIGJlZm9yZQovLyB2dWUtc2VydmVyLXJlbmRlcmVyIGNhbiBzZXQgVlVFX0VOVgoKCnZhciBfaXNTZXJ2ZXI7Cgp2YXIgaXNTZXJ2ZXJSZW5kZXJpbmcgPSBmdW5jdGlvbiBpc1NlcnZlclJlbmRlcmluZygpIHsKICBpZiAoX2lzU2VydmVyID09PSB1bmRlZmluZWQpIHsKICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogICAgaWYgKCFpbkJyb3dzZXIgJiYgIWluV2VleCAmJiB0eXBlb2YgZ2xvYmFsICE9PSAndW5kZWZpbmVkJykgewogICAgICAvLyBkZXRlY3QgcHJlc2VuY2Ugb2YgdnVlLXNlcnZlci1yZW5kZXJlciBhbmQgYXZvaWQKICAgICAgLy8gV2VicGFjayBzaGltbWluZyB0aGUgcHJvY2VzcwogICAgICBfaXNTZXJ2ZXIgPSBnbG9iYWxbJ3Byb2Nlc3MnXSAmJiBnbG9iYWxbJ3Byb2Nlc3MnXS5lbnYuVlVFX0VOViA9PT0gJ3NlcnZlcic7CiAgICB9IGVsc2UgewogICAgICBfaXNTZXJ2ZXIgPSBmYWxzZTsKICAgIH0KICB9CgogIHJldHVybiBfaXNTZXJ2ZXI7Cn07IC8vIGRldGVjdCBkZXZ0b29scwoKCnZhciBkZXZ0b29scyA9IGluQnJvd3NlciAmJiB3aW5kb3cuX19WVUVfREVWVE9PTFNfR0xPQkFMX0hPT0tfXzsKLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8KCmZ1bmN0aW9uIGlzTmF0aXZlKEN0b3IpIHsKICByZXR1cm4gdHlwZW9mIEN0b3IgPT09ICdmdW5jdGlvbicgJiYgL25hdGl2ZSBjb2RlLy50ZXN0KEN0b3IudG9TdHJpbmcoKSk7Cn0KCnZhciBoYXNTeW1ib2wgPSB0eXBlb2YgU3ltYm9sICE9PSAndW5kZWZpbmVkJyAmJiBpc05hdGl2ZShTeW1ib2wpICYmIHR5cGVvZiBSZWZsZWN0ICE9PSAndW5kZWZpbmVkJyAmJiBpc05hdGl2ZShSZWZsZWN0Lm93bktleXMpOwoKdmFyIF9TZXQ7Ci8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwovLyAkZmxvdy1kaXNhYmxlLWxpbmUKCgppZiAodHlwZW9mIFNldCAhPT0gJ3VuZGVmaW5lZCcgJiYgaXNOYXRpdmUoU2V0KSkgewogIC8vIHVzZSBuYXRpdmUgU2V0IHdoZW4gYXZhaWxhYmxlLgogIF9TZXQgPSBTZXQ7Cn0gZWxzZSB7CiAgLy8gYSBub24tc3RhbmRhcmQgU2V0IHBvbHlmaWxsIHRoYXQgb25seSB3b3JrcyB3aXRoIHByaW1pdGl2ZSBrZXlzLgogIF9TZXQgPQogIC8qQF9fUFVSRV9fKi8KICBmdW5jdGlvbiAoKSB7CiAgICBmdW5jdGlvbiBTZXQoKSB7CiAgICAgIHRoaXMuc2V0ID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgIH0KCiAgICBTZXQucHJvdG90eXBlLmhhcyA9IGZ1bmN0aW9uIGhhcyhrZXkpIHsKICAgICAgcmV0dXJuIHRoaXMuc2V0W2tleV0gPT09IHRydWU7CiAgICB9OwoKICAgIFNldC5wcm90b3R5cGUuYWRkID0gZnVuY3Rpb24gYWRkKGtleSkgewogICAgICB0aGlzLnNldFtrZXldID0gdHJ1ZTsKICAgIH07CgogICAgU2V0LnByb3RvdHlwZS5jbGVhciA9IGZ1bmN0aW9uIGNsZWFyKCkgewogICAgICB0aGlzLnNldCA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICB9OwoKICAgIHJldHVybiBTZXQ7CiAgfSgpOwp9Ci8qICAqLwoKCnZhciB3YXJuID0gbm9vcDsKdmFyIHRpcCA9IG5vb3A7CnZhciBnZW5lcmF0ZUNvbXBvbmVudFRyYWNlID0gbm9vcDsgLy8gd29yayBhcm91bmQgZmxvdyBjaGVjawoKdmFyIGZvcm1hdENvbXBvbmVudE5hbWUgPSBub29wOwoKaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICB2YXIgaGFzQ29uc29sZSA9IHR5cGVvZiBjb25zb2xlICE9PSAndW5kZWZpbmVkJzsKICB2YXIgY2xhc3NpZnlSRSA9IC8oPzpefFstX10pKFx3KS9nOwoKICB2YXIgY2xhc3NpZnkgPSBmdW5jdGlvbiBjbGFzc2lmeShzdHIpIHsKICAgIHJldHVybiBzdHIucmVwbGFjZShjbGFzc2lmeVJFLCBmdW5jdGlvbiAoYykgewogICAgICByZXR1cm4gYy50b1VwcGVyQ2FzZSgpOwogICAgfSkucmVwbGFjZSgvWy1fXS9nLCAnJyk7CiAgfTsKCiAgd2FybiA9IGZ1bmN0aW9uIHdhcm4obXNnLCB2bSkgewogICAgdmFyIHRyYWNlID0gdm0gPyBnZW5lcmF0ZUNvbXBvbmVudFRyYWNlKHZtKSA6ICcnOwoKICAgIGlmIChjb25maWcud2FybkhhbmRsZXIpIHsKICAgICAgY29uZmlnLndhcm5IYW5kbGVyLmNhbGwobnVsbCwgbXNnLCB2bSwgdHJhY2UpOwogICAgfSBlbHNlIGlmIChoYXNDb25zb2xlICYmICFjb25maWcuc2lsZW50KSB7CiAgICAgIGNvbnNvbGUuZXJyb3IoIltWdWUgd2Fybl06ICIgKyBtc2cgKyB0cmFjZSk7CiAgICB9CiAgfTsKCiAgdGlwID0gZnVuY3Rpb24gdGlwKG1zZywgdm0pIHsKICAgIGlmIChoYXNDb25zb2xlICYmICFjb25maWcuc2lsZW50KSB7CiAgICAgIGNvbnNvbGUud2FybigiW1Z1ZSB0aXBdOiAiICsgbXNnICsgKHZtID8gZ2VuZXJhdGVDb21wb25lbnRUcmFjZSh2bSkgOiAnJykpOwogICAgfQogIH07CgogIGZvcm1hdENvbXBvbmVudE5hbWUgPSBmdW5jdGlvbiBmb3JtYXRDb21wb25lbnROYW1lKHZtLCBpbmNsdWRlRmlsZSkgewogICAgaWYgKHZtLiRyb290ID09PSB2bSkgewogICAgICByZXR1cm4gJzxSb290Pic7CiAgICB9CgogICAgdmFyIG9wdGlvbnMgPSB0eXBlb2Ygdm0gPT09ICdmdW5jdGlvbicgJiYgdm0uY2lkICE9IG51bGwgPyB2bS5vcHRpb25zIDogdm0uX2lzVnVlID8gdm0uJG9wdGlvbnMgfHwgdm0uY29uc3RydWN0b3Iub3B0aW9ucyA6IHZtOwogICAgdmFyIG5hbWUgPSBvcHRpb25zLm5hbWUgfHwgb3B0aW9ucy5fY29tcG9uZW50VGFnOwogICAgdmFyIGZpbGUgPSBvcHRpb25zLl9fZmlsZTsKCiAgICBpZiAoIW5hbWUgJiYgZmlsZSkgewogICAgICB2YXIgbWF0Y2ggPSBmaWxlLm1hdGNoKC8oW14vXFxdKylcLnZ1ZSQvKTsKICAgICAgbmFtZSA9IG1hdGNoICYmIG1hdGNoWzFdOwogICAgfQoKICAgIHJldHVybiAobmFtZSA/ICI8IiArIGNsYXNzaWZ5KG5hbWUpICsgIj4iIDogIjxBbm9ueW1vdXM+IikgKyAoZmlsZSAmJiBpbmNsdWRlRmlsZSAhPT0gZmFsc2UgPyAiIGF0ICIgKyBmaWxlIDogJycpOwogIH07CgogIHZhciByZXBlYXQgPSBmdW5jdGlvbiByZXBlYXQoc3RyLCBuKSB7CiAgICB2YXIgcmVzID0gJyc7CgogICAgd2hpbGUgKG4pIHsKICAgICAgaWYgKG4gJSAyID09PSAxKSB7CiAgICAgICAgcmVzICs9IHN0cjsKICAgICAgfQoKICAgICAgaWYgKG4gPiAxKSB7CiAgICAgICAgc3RyICs9IHN0cjsKICAgICAgfQoKICAgICAgbiA+Pj0gMTsKICAgIH0KCiAgICByZXR1cm4gcmVzOwogIH07CgogIGdlbmVyYXRlQ29tcG9uZW50VHJhY2UgPSBmdW5jdGlvbiBnZW5lcmF0ZUNvbXBvbmVudFRyYWNlKHZtKSB7CiAgICBpZiAodm0uX2lzVnVlICYmIHZtLiRwYXJlbnQpIHsKICAgICAgdmFyIHRyZWUgPSBbXTsKICAgICAgdmFyIGN1cnJlbnRSZWN1cnNpdmVTZXF1ZW5jZSA9IDA7CgogICAgICB3aGlsZSAodm0pIHsKICAgICAgICBpZiAodHJlZS5sZW5ndGggPiAwKSB7CiAgICAgICAgICB2YXIgbGFzdCA9IHRyZWVbdHJlZS5sZW5ndGggLSAxXTsKCiAgICAgICAgICBpZiAobGFzdC5jb25zdHJ1Y3RvciA9PT0gdm0uY29uc3RydWN0b3IpIHsKICAgICAgICAgICAgY3VycmVudFJlY3Vyc2l2ZVNlcXVlbmNlKys7CiAgICAgICAgICAgIHZtID0gdm0uJHBhcmVudDsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9IGVsc2UgaWYgKGN1cnJlbnRSZWN1cnNpdmVTZXF1ZW5jZSA+IDApIHsKICAgICAgICAgICAgdHJlZVt0cmVlLmxlbmd0aCAtIDFdID0gW2xhc3QsIGN1cnJlbnRSZWN1cnNpdmVTZXF1ZW5jZV07CiAgICAgICAgICAgIGN1cnJlbnRSZWN1cnNpdmVTZXF1ZW5jZSA9IDA7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB0cmVlLnB1c2godm0pOwogICAgICAgIHZtID0gdm0uJHBhcmVudDsKICAgICAgfQoKICAgICAgcmV0dXJuICdcblxuZm91bmQgaW5cblxuJyArIHRyZWUubWFwKGZ1bmN0aW9uICh2bSwgaSkgewogICAgICAgIHJldHVybiAiIiArIChpID09PSAwID8gJy0tLT4gJyA6IHJlcGVhdCgnICcsIDUgKyBpICogMikpICsgKEFycmF5LmlzQXJyYXkodm0pID8gZm9ybWF0Q29tcG9uZW50TmFtZSh2bVswXSkgKyAiLi4uICgiICsgdm1bMV0gKyAiIHJlY3Vyc2l2ZSBjYWxscykiIDogZm9ybWF0Q29tcG9uZW50TmFtZSh2bSkpOwogICAgICB9KS5qb2luKCdcbicpOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuICJcblxuKGZvdW5kIGluICIgKyBmb3JtYXRDb21wb25lbnROYW1lKHZtKSArICIpIjsKICAgIH0KICB9Owp9Ci8qICAqLwoKCnZhciB1aWQgPSAwOwovKioKICogQSBkZXAgaXMgYW4gb2JzZXJ2YWJsZSB0aGF0IGNhbiBoYXZlIG11bHRpcGxlCiAqIGRpcmVjdGl2ZXMgc3Vic2NyaWJpbmcgdG8gaXQuCiAqLwoKdmFyIERlcCA9IGZ1bmN0aW9uIERlcCgpIHsKICB0aGlzLmlkID0gdWlkKys7CiAgdGhpcy5zdWJzID0gW107Cn07CgpEZXAucHJvdG90eXBlLmFkZFN1YiA9IGZ1bmN0aW9uIGFkZFN1YihzdWIpIHsKICB0aGlzLnN1YnMucHVzaChzdWIpOwp9OwoKRGVwLnByb3RvdHlwZS5yZW1vdmVTdWIgPSBmdW5jdGlvbiByZW1vdmVTdWIoc3ViKSB7CiAgcmVtb3ZlKHRoaXMuc3Vicywgc3ViKTsKfTsKCkRlcC5wcm90b3R5cGUuZGVwZW5kID0gZnVuY3Rpb24gZGVwZW5kKCkgewogIGlmIChEZXAudGFyZ2V0KSB7CiAgICBEZXAudGFyZ2V0LmFkZERlcCh0aGlzKTsKICB9Cn07CgpEZXAucHJvdG90eXBlLm5vdGlmeSA9IGZ1bmN0aW9uIG5vdGlmeSgpIHsKICAvLyBzdGFiaWxpemUgdGhlIHN1YnNjcmliZXIgbGlzdCBmaXJzdAogIHZhciBzdWJzID0gdGhpcy5zdWJzLnNsaWNlKCk7CgogIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmICFjb25maWcuYXN5bmMpIHsKICAgIC8vIHN1YnMgYXJlbid0IHNvcnRlZCBpbiBzY2hlZHVsZXIgaWYgbm90IHJ1bm5pbmcgYXN5bmMKICAgIC8vIHdlIG5lZWQgdG8gc29ydCB0aGVtIG5vdyB0byBtYWtlIHN1cmUgdGhleSBmaXJlIGluIGNvcnJlY3QKICAgIC8vIG9yZGVyCiAgICBzdWJzLnNvcnQoZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgcmV0dXJuIGEuaWQgLSBiLmlkOwogICAgfSk7CiAgfQoKICBmb3IgKHZhciBpID0gMCwgbCA9IHN1YnMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICBzdWJzW2ldLnVwZGF0ZSgpOwogIH0KfTsgLy8gVGhlIGN1cnJlbnQgdGFyZ2V0IHdhdGNoZXIgYmVpbmcgZXZhbHVhdGVkLgovLyBUaGlzIGlzIGdsb2JhbGx5IHVuaXF1ZSBiZWNhdXNlIG9ubHkgb25lIHdhdGNoZXIKLy8gY2FuIGJlIGV2YWx1YXRlZCBhdCBhIHRpbWUuCgoKRGVwLnRhcmdldCA9IG51bGw7CnZhciB0YXJnZXRTdGFjayA9IFtdOwoKZnVuY3Rpb24gcHVzaFRhcmdldCh0YXJnZXQpIHsKICB0YXJnZXRTdGFjay5wdXNoKHRhcmdldCk7CiAgRGVwLnRhcmdldCA9IHRhcmdldDsKfQoKZnVuY3Rpb24gcG9wVGFyZ2V0KCkgewogIHRhcmdldFN0YWNrLnBvcCgpOwogIERlcC50YXJnZXQgPSB0YXJnZXRTdGFja1t0YXJnZXRTdGFjay5sZW5ndGggLSAxXTsKfQovKiAgKi8KCgp2YXIgVk5vZGUgPSBmdW5jdGlvbiBWTm9kZSh0YWcsIGRhdGEsIGNoaWxkcmVuLCB0ZXh0LCBlbG0sIGNvbnRleHQsIGNvbXBvbmVudE9wdGlvbnMsIGFzeW5jRmFjdG9yeSkgewogIHRoaXMudGFnID0gdGFnOwogIHRoaXMuZGF0YSA9IGRhdGE7CiAgdGhpcy5jaGlsZHJlbiA9IGNoaWxkcmVuOwogIHRoaXMudGV4dCA9IHRleHQ7CiAgdGhpcy5lbG0gPSBlbG07CiAgdGhpcy5ucyA9IHVuZGVmaW5lZDsKICB0aGlzLmNvbnRleHQgPSBjb250ZXh0OwogIHRoaXMuZm5Db250ZXh0ID0gdW5kZWZpbmVkOwogIHRoaXMuZm5PcHRpb25zID0gdW5kZWZpbmVkOwogIHRoaXMuZm5TY29wZUlkID0gdW5kZWZpbmVkOwogIHRoaXMua2V5ID0gZGF0YSAmJiBkYXRhLmtleTsKICB0aGlzLmNvbXBvbmVudE9wdGlvbnMgPSBjb21wb25lbnRPcHRpb25zOwogIHRoaXMuY29tcG9uZW50SW5zdGFuY2UgPSB1bmRlZmluZWQ7CiAgdGhpcy5wYXJlbnQgPSB1bmRlZmluZWQ7CiAgdGhpcy5yYXcgPSBmYWxzZTsKICB0aGlzLmlzU3RhdGljID0gZmFsc2U7CiAgdGhpcy5pc1Jvb3RJbnNlcnQgPSB0cnVlOwogIHRoaXMuaXNDb21tZW50ID0gZmFsc2U7CiAgdGhpcy5pc0Nsb25lZCA9IGZhbHNlOwogIHRoaXMuaXNPbmNlID0gZmFsc2U7CiAgdGhpcy5hc3luY0ZhY3RvcnkgPSBhc3luY0ZhY3Rvcnk7CiAgdGhpcy5hc3luY01ldGEgPSB1bmRlZmluZWQ7CiAgdGhpcy5pc0FzeW5jUGxhY2Vob2xkZXIgPSBmYWxzZTsKfTsKCnZhciBwcm90b3R5cGVBY2Nlc3NvcnMgPSB7CiAgY2hpbGQ6IHsKICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZQogIH0KfTsgLy8gREVQUkVDQVRFRDogYWxpYXMgZm9yIGNvbXBvbmVudEluc3RhbmNlIGZvciBiYWNrd2FyZHMgY29tcGF0LgoKLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8KCnByb3RvdHlwZUFjY2Vzc29ycy5jaGlsZC5nZXQgPSBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIHRoaXMuY29tcG9uZW50SW5zdGFuY2U7Cn07CgpPYmplY3QuZGVmaW5lUHJvcGVydGllcyhWTm9kZS5wcm90b3R5cGUsIHByb3RvdHlwZUFjY2Vzc29ycyk7Cgp2YXIgY3JlYXRlRW1wdHlWTm9kZSA9IGZ1bmN0aW9uIGNyZWF0ZUVtcHR5Vk5vZGUodGV4dCkgewogIGlmICh0ZXh0ID09PSB2b2lkIDApIHRleHQgPSAnJzsKICB2YXIgbm9kZSA9IG5ldyBWTm9kZSgpOwogIG5vZGUudGV4dCA9IHRleHQ7CiAgbm9kZS5pc0NvbW1lbnQgPSB0cnVlOwogIHJldHVybiBub2RlOwp9OwoKZnVuY3Rpb24gY3JlYXRlVGV4dFZOb2RlKHZhbCkgewogIHJldHVybiBuZXcgVk5vZGUodW5kZWZpbmVkLCB1bmRlZmluZWQsIHVuZGVmaW5lZCwgU3RyaW5nKHZhbCkpOwp9IC8vIG9wdGltaXplZCBzaGFsbG93IGNsb25lCi8vIHVzZWQgZm9yIHN0YXRpYyBub2RlcyBhbmQgc2xvdCBub2RlcyBiZWNhdXNlIHRoZXkgbWF5IGJlIHJldXNlZCBhY3Jvc3MKLy8gbXVsdGlwbGUgcmVuZGVycywgY2xvbmluZyB0aGVtIGF2b2lkcyBlcnJvcnMgd2hlbiBET00gbWFuaXB1bGF0aW9ucyByZWx5Ci8vIG9uIHRoZWlyIGVsbSByZWZlcmVuY2UuCgoKZnVuY3Rpb24gY2xvbmVWTm9kZSh2bm9kZSkgewogIHZhciBjbG9uZWQgPSBuZXcgVk5vZGUodm5vZGUudGFnLCB2bm9kZS5kYXRhLCAvLyAjNzk3NQogIC8vIGNsb25lIGNoaWxkcmVuIGFycmF5IHRvIGF2b2lkIG11dGF0aW5nIG9yaWdpbmFsIGluIGNhc2Ugb2YgY2xvbmluZwogIC8vIGEgY2hpbGQuCiAgdm5vZGUuY2hpbGRyZW4gJiYgdm5vZGUuY2hpbGRyZW4uc2xpY2UoKSwgdm5vZGUudGV4dCwgdm5vZGUuZWxtLCB2bm9kZS5jb250ZXh0LCB2bm9kZS5jb21wb25lbnRPcHRpb25zLCB2bm9kZS5hc3luY0ZhY3RvcnkpOwogIGNsb25lZC5ucyA9IHZub2RlLm5zOwogIGNsb25lZC5pc1N0YXRpYyA9IHZub2RlLmlzU3RhdGljOwogIGNsb25lZC5rZXkgPSB2bm9kZS5rZXk7CiAgY2xvbmVkLmlzQ29tbWVudCA9IHZub2RlLmlzQ29tbWVudDsKICBjbG9uZWQuZm5Db250ZXh0ID0gdm5vZGUuZm5Db250ZXh0OwogIGNsb25lZC5mbk9wdGlvbnMgPSB2bm9kZS5mbk9wdGlvbnM7CiAgY2xvbmVkLmZuU2NvcGVJZCA9IHZub2RlLmZuU2NvcGVJZDsKICBjbG9uZWQuYXN5bmNNZXRhID0gdm5vZGUuYXN5bmNNZXRhOwogIGNsb25lZC5pc0Nsb25lZCA9IHRydWU7CiAgcmV0dXJuIGNsb25lZDsKfQovKgogKiBub3QgdHlwZSBjaGVja2luZyB0aGlzIGZpbGUgYmVjYXVzZSBmbG93IGRvZXNuJ3QgcGxheSB3ZWxsIHdpdGgKICogZHluYW1pY2FsbHkgYWNjZXNzaW5nIG1ldGhvZHMgb24gQXJyYXkgcHJvdG90eXBlCiAqLwoKCnZhciBhcnJheVByb3RvID0gQXJyYXkucHJvdG90eXBlOwp2YXIgYXJyYXlNZXRob2RzID0gT2JqZWN0LmNyZWF0ZShhcnJheVByb3RvKTsKdmFyIG1ldGhvZHNUb1BhdGNoID0gWydwdXNoJywgJ3BvcCcsICdzaGlmdCcsICd1bnNoaWZ0JywgJ3NwbGljZScsICdzb3J0JywgJ3JldmVyc2UnXTsKLyoqCiAqIEludGVyY2VwdCBtdXRhdGluZyBtZXRob2RzIGFuZCBlbWl0IGV2ZW50cwogKi8KCm1ldGhvZHNUb1BhdGNoLmZvckVhY2goZnVuY3Rpb24gKG1ldGhvZCkgewogIC8vIGNhY2hlIG9yaWdpbmFsIG1ldGhvZAogIHZhciBvcmlnaW5hbCA9IGFycmF5UHJvdG9bbWV0aG9kXTsKICBkZWYoYXJyYXlNZXRob2RzLCBtZXRob2QsIGZ1bmN0aW9uIG11dGF0b3IoKSB7CiAgICB2YXIgYXJncyA9IFtdLAogICAgICAgIGxlbiA9IGFyZ3VtZW50cy5sZW5ndGg7CgogICAgd2hpbGUgKGxlbi0tKSB7CiAgICAgIGFyZ3NbbGVuXSA9IGFyZ3VtZW50c1tsZW5dOwogICAgfQoKICAgIHZhciByZXN1bHQgPSBvcmlnaW5hbC5hcHBseSh0aGlzLCBhcmdzKTsKICAgIHZhciBvYiA9IHRoaXMuX19vYl9fOwogICAgdmFyIGluc2VydGVkOwoKICAgIHN3aXRjaCAobWV0aG9kKSB7CiAgICAgIGNhc2UgJ3B1c2gnOgogICAgICBjYXNlICd1bnNoaWZ0JzoKICAgICAgICBpbnNlcnRlZCA9IGFyZ3M7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlICdzcGxpY2UnOgogICAgICAgIGluc2VydGVkID0gYXJncy5zbGljZSgyKTsKICAgICAgICBicmVhazsKICAgIH0KCiAgICBpZiAoaW5zZXJ0ZWQpIHsKICAgICAgb2Iub2JzZXJ2ZUFycmF5KGluc2VydGVkKTsKICAgIH0gLy8gbm90aWZ5IGNoYW5nZQoKCiAgICBvYi5kZXAubm90aWZ5KCk7CiAgICByZXR1cm4gcmVzdWx0OwogIH0pOwp9KTsKLyogICovCgp2YXIgYXJyYXlLZXlzID0gT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXMoYXJyYXlNZXRob2RzKTsKLyoqCiAqIEluIHNvbWUgY2FzZXMgd2UgbWF5IHdhbnQgdG8gZGlzYWJsZSBvYnNlcnZhdGlvbiBpbnNpZGUgYSBjb21wb25lbnQncwogKiB1cGRhdGUgY29tcHV0YXRpb24uCiAqLwoKdmFyIHNob3VsZE9ic2VydmUgPSB0cnVlOwoKZnVuY3Rpb24gdG9nZ2xlT2JzZXJ2aW5nKHZhbHVlKSB7CiAgc2hvdWxkT2JzZXJ2ZSA9IHZhbHVlOwp9Ci8qKgogKiBPYnNlcnZlciBjbGFzcyB0aGF0IGlzIGF0dGFjaGVkIHRvIGVhY2ggb2JzZXJ2ZWQKICogb2JqZWN0LiBPbmNlIGF0dGFjaGVkLCB0aGUgb2JzZXJ2ZXIgY29udmVydHMgdGhlIHRhcmdldAogKiBvYmplY3QncyBwcm9wZXJ0eSBrZXlzIGludG8gZ2V0dGVyL3NldHRlcnMgdGhhdAogKiBjb2xsZWN0IGRlcGVuZGVuY2llcyBhbmQgZGlzcGF0Y2ggdXBkYXRlcy4KICovCgoKdmFyIE9ic2VydmVyID0gZnVuY3Rpb24gT2JzZXJ2ZXIodmFsdWUpIHsKICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgdGhpcy5kZXAgPSBuZXcgRGVwKCk7CiAgdGhpcy52bUNvdW50ID0gMDsKICBkZWYodmFsdWUsICdfX29iX18nLCB0aGlzKTsKCiAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7CiAgICBpZiAoaGFzUHJvdG8pIHsKICAgICAgcHJvdG9BdWdtZW50KHZhbHVlLCBhcnJheU1ldGhvZHMpOwogICAgfSBlbHNlIHsKICAgICAgY29weUF1Z21lbnQodmFsdWUsIGFycmF5TWV0aG9kcywgYXJyYXlLZXlzKTsKICAgIH0KCiAgICB0aGlzLm9ic2VydmVBcnJheSh2YWx1ZSk7CiAgfSBlbHNlIHsKICAgIHRoaXMud2Fsayh2YWx1ZSk7CiAgfQp9OwovKioKICogV2FsayB0aHJvdWdoIGFsbCBwcm9wZXJ0aWVzIGFuZCBjb252ZXJ0IHRoZW0gaW50bwogKiBnZXR0ZXIvc2V0dGVycy4gVGhpcyBtZXRob2Qgc2hvdWxkIG9ubHkgYmUgY2FsbGVkIHdoZW4KICogdmFsdWUgdHlwZSBpcyBPYmplY3QuCiAqLwoKCk9ic2VydmVyLnByb3RvdHlwZS53YWxrID0gZnVuY3Rpb24gd2FsayhvYmopIHsKICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKG9iaik7CgogIGZvciAodmFyIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgZGVmaW5lUmVhY3RpdmUkJDEob2JqLCBrZXlzW2ldKTsKICB9Cn07Ci8qKgogKiBPYnNlcnZlIGEgbGlzdCBvZiBBcnJheSBpdGVtcy4KICovCgoKT2JzZXJ2ZXIucHJvdG90eXBlLm9ic2VydmVBcnJheSA9IGZ1bmN0aW9uIG9ic2VydmVBcnJheShpdGVtcykgewogIGZvciAodmFyIGkgPSAwLCBsID0gaXRlbXMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICBvYnNlcnZlKGl0ZW1zW2ldKTsKICB9Cn07IC8vIGhlbHBlcnMKCi8qKgogKiBBdWdtZW50IGEgdGFyZ2V0IE9iamVjdCBvciBBcnJheSBieSBpbnRlcmNlcHRpbmcKICogdGhlIHByb3RvdHlwZSBjaGFpbiB1c2luZyBfX3Byb3RvX18KICovCgoKZnVuY3Rpb24gcHJvdG9BdWdtZW50KHRhcmdldCwgc3JjKSB7CiAgLyogZXNsaW50LWRpc2FibGUgbm8tcHJvdG8gKi8KICB0YXJnZXQuX19wcm90b19fID0gc3JjOwogIC8qIGVzbGludC1lbmFibGUgbm8tcHJvdG8gKi8KfQovKioKICogQXVnbWVudCBhIHRhcmdldCBPYmplY3Qgb3IgQXJyYXkgYnkgZGVmaW5pbmcKICogaGlkZGVuIHByb3BlcnRpZXMuCiAqLwoKLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8KCgpmdW5jdGlvbiBjb3B5QXVnbWVudCh0YXJnZXQsIHNyYywga2V5cykgewogIGZvciAodmFyIGkgPSAwLCBsID0ga2V5cy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgIHZhciBrZXkgPSBrZXlzW2ldOwogICAgZGVmKHRhcmdldCwga2V5LCBzcmNba2V5XSk7CiAgfQp9Ci8qKgogKiBBdHRlbXB0IHRvIGNyZWF0ZSBhbiBvYnNlcnZlciBpbnN0YW5jZSBmb3IgYSB2YWx1ZSwKICogcmV0dXJucyB0aGUgbmV3IG9ic2VydmVyIGlmIHN1Y2Nlc3NmdWxseSBvYnNlcnZlZCwKICogb3IgdGhlIGV4aXN0aW5nIG9ic2VydmVyIGlmIHRoZSB2YWx1ZSBhbHJlYWR5IGhhcyBvbmUuCiAqLwoKCmZ1bmN0aW9uIG9ic2VydmUodmFsdWUsIGFzUm9vdERhdGEpIHsKICBpZiAoIWlzT2JqZWN0KHZhbHVlKSB8fCB2YWx1ZSBpbnN0YW5jZW9mIFZOb2RlKSB7CiAgICByZXR1cm47CiAgfQoKICB2YXIgb2I7CgogIGlmIChoYXNPd24odmFsdWUsICdfX29iX18nKSAmJiB2YWx1ZS5fX29iX18gaW5zdGFuY2VvZiBPYnNlcnZlcikgewogICAgb2IgPSB2YWx1ZS5fX29iX187CiAgfSBlbHNlIGlmIChzaG91bGRPYnNlcnZlICYmICFpc1NlcnZlclJlbmRlcmluZygpICYmIChBcnJheS5pc0FycmF5KHZhbHVlKSB8fCBpc1BsYWluT2JqZWN0KHZhbHVlKSkgJiYgT2JqZWN0LmlzRXh0ZW5zaWJsZSh2YWx1ZSkgJiYgIXZhbHVlLl9pc1Z1ZSkgewogICAgb2IgPSBuZXcgT2JzZXJ2ZXIodmFsdWUpOwogIH0KCiAgaWYgKGFzUm9vdERhdGEgJiYgb2IpIHsKICAgIG9iLnZtQ291bnQrKzsKICB9CgogIHJldHVybiBvYjsKfQovKioKICogRGVmaW5lIGEgcmVhY3RpdmUgcHJvcGVydHkgb24gYW4gT2JqZWN0LgogKi8KCgpmdW5jdGlvbiBkZWZpbmVSZWFjdGl2ZSQkMShvYmosIGtleSwgdmFsLCBjdXN0b21TZXR0ZXIsIHNoYWxsb3cpIHsKICB2YXIgZGVwID0gbmV3IERlcCgpOwogIHZhciBwcm9wZXJ0eSA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3Iob2JqLCBrZXkpOwoKICBpZiAocHJvcGVydHkgJiYgcHJvcGVydHkuY29uZmlndXJhYmxlID09PSBmYWxzZSkgewogICAgcmV0dXJuOwogIH0gLy8gY2F0ZXIgZm9yIHByZS1kZWZpbmVkIGdldHRlci9zZXR0ZXJzCgoKICB2YXIgZ2V0dGVyID0gcHJvcGVydHkgJiYgcHJvcGVydHkuZ2V0OwogIHZhciBzZXR0ZXIgPSBwcm9wZXJ0eSAmJiBwcm9wZXJ0eS5zZXQ7CgogIGlmICgoIWdldHRlciB8fCBzZXR0ZXIpICYmIGFyZ3VtZW50cy5sZW5ndGggPT09IDIpIHsKICAgIHZhbCA9IG9ialtrZXldOwogIH0KCiAgdmFyIGNoaWxkT2IgPSAhc2hhbGxvdyAmJiBvYnNlcnZlKHZhbCk7CiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG9iaiwga2V5LCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiByZWFjdGl2ZUdldHRlcigpIHsKICAgICAgdmFyIHZhbHVlID0gZ2V0dGVyID8gZ2V0dGVyLmNhbGwob2JqKSA6IHZhbDsKCiAgICAgIGlmIChEZXAudGFyZ2V0KSB7CiAgICAgICAgZGVwLmRlcGVuZCgpOwoKICAgICAgICBpZiAoY2hpbGRPYikgewogICAgICAgICAgY2hpbGRPYi5kZXAuZGVwZW5kKCk7CgogICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgICAgIGRlcGVuZEFycmF5KHZhbHVlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0sCiAgICBzZXQ6IGZ1bmN0aW9uIHJlYWN0aXZlU2V0dGVyKG5ld1ZhbCkgewogICAgICB2YXIgdmFsdWUgPSBnZXR0ZXIgPyBnZXR0ZXIuY2FsbChvYmopIDogdmFsOwogICAgICAvKiBlc2xpbnQtZGlzYWJsZSBuby1zZWxmLWNvbXBhcmUgKi8KCiAgICAgIGlmIChuZXdWYWwgPT09IHZhbHVlIHx8IG5ld1ZhbCAhPT0gbmV3VmFsICYmIHZhbHVlICE9PSB2YWx1ZSkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICAvKiBlc2xpbnQtZW5hYmxlIG5vLXNlbGYtY29tcGFyZSAqLwoKCiAgICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIGN1c3RvbVNldHRlcikgewogICAgICAgIGN1c3RvbVNldHRlcigpOwogICAgICB9IC8vICM3OTgxOiBmb3IgYWNjZXNzb3IgcHJvcGVydGllcyB3aXRob3V0IHNldHRlcgoKCiAgICAgIGlmIChnZXR0ZXIgJiYgIXNldHRlcikgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgaWYgKHNldHRlcikgewogICAgICAgIHNldHRlci5jYWxsKG9iaiwgbmV3VmFsKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YWwgPSBuZXdWYWw7CiAgICAgIH0KCiAgICAgIGNoaWxkT2IgPSAhc2hhbGxvdyAmJiBvYnNlcnZlKG5ld1ZhbCk7CiAgICAgIGRlcC5ub3RpZnkoKTsKICAgIH0KICB9KTsKfQovKioKICogU2V0IGEgcHJvcGVydHkgb24gYW4gb2JqZWN0LiBBZGRzIHRoZSBuZXcgcHJvcGVydHkgYW5kCiAqIHRyaWdnZXJzIGNoYW5nZSBub3RpZmljYXRpb24gaWYgdGhlIHByb3BlcnR5IGRvZXNuJ3QKICogYWxyZWFkeSBleGlzdC4KICovCgoKZnVuY3Rpb24gc2V0KHRhcmdldCwga2V5LCB2YWwpIHsKICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiAoaXNVbmRlZih0YXJnZXQpIHx8IGlzUHJpbWl0aXZlKHRhcmdldCkpKSB7CiAgICB3YXJuKCJDYW5ub3Qgc2V0IHJlYWN0aXZlIHByb3BlcnR5IG9uIHVuZGVmaW5lZCwgbnVsbCwgb3IgcHJpbWl0aXZlIHZhbHVlOiAiICsgdGFyZ2V0KTsKICB9CgogIGlmIChBcnJheS5pc0FycmF5KHRhcmdldCkgJiYgaXNWYWxpZEFycmF5SW5kZXgoa2V5KSkgewogICAgdGFyZ2V0Lmxlbmd0aCA9IE1hdGgubWF4KHRhcmdldC5sZW5ndGgsIGtleSk7CiAgICB0YXJnZXQuc3BsaWNlKGtleSwgMSwgdmFsKTsKICAgIHJldHVybiB2YWw7CiAgfQoKICBpZiAoa2V5IGluIHRhcmdldCAmJiAhKGtleSBpbiBPYmplY3QucHJvdG90eXBlKSkgewogICAgdGFyZ2V0W2tleV0gPSB2YWw7CiAgICByZXR1cm4gdmFsOwogIH0KCiAgdmFyIG9iID0gdGFyZ2V0Ll9fb2JfXzsKCiAgaWYgKHRhcmdldC5faXNWdWUgfHwgb2IgJiYgb2Iudm1Db3VudCkgewogICAgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiB3YXJuKCdBdm9pZCBhZGRpbmcgcmVhY3RpdmUgcHJvcGVydGllcyB0byBhIFZ1ZSBpbnN0YW5jZSBvciBpdHMgcm9vdCAkZGF0YSAnICsgJ2F0IHJ1bnRpbWUgLSBkZWNsYXJlIGl0IHVwZnJvbnQgaW4gdGhlIGRhdGEgb3B0aW9uLicpOwogICAgcmV0dXJuIHZhbDsKICB9CgogIGlmICghb2IpIHsKICAgIHRhcmdldFtrZXldID0gdmFsOwogICAgcmV0dXJuIHZhbDsKICB9CgogIGRlZmluZVJlYWN0aXZlJCQxKG9iLnZhbHVlLCBrZXksIHZhbCk7CiAgb2IuZGVwLm5vdGlmeSgpOwogIHJldHVybiB2YWw7Cn0KLyoqCiAqIERlbGV0ZSBhIHByb3BlcnR5IGFuZCB0cmlnZ2VyIGNoYW5nZSBpZiBuZWNlc3NhcnkuCiAqLwoKCmZ1bmN0aW9uIGRlbCh0YXJnZXQsIGtleSkgewogIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIChpc1VuZGVmKHRhcmdldCkgfHwgaXNQcmltaXRpdmUodGFyZ2V0KSkpIHsKICAgIHdhcm4oIkNhbm5vdCBkZWxldGUgcmVhY3RpdmUgcHJvcGVydHkgb24gdW5kZWZpbmVkLCBudWxsLCBvciBwcmltaXRpdmUgdmFsdWU6ICIgKyB0YXJnZXQpOwogIH0KCiAgaWYgKEFycmF5LmlzQXJyYXkodGFyZ2V0KSAmJiBpc1ZhbGlkQXJyYXlJbmRleChrZXkpKSB7CiAgICB0YXJnZXQuc3BsaWNlKGtleSwgMSk7CiAgICByZXR1cm47CiAgfQoKICB2YXIgb2IgPSB0YXJnZXQuX19vYl9fOwoKICBpZiAodGFyZ2V0Ll9pc1Z1ZSB8fCBvYiAmJiBvYi52bUNvdW50KSB7CiAgICBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIHdhcm4oJ0F2b2lkIGRlbGV0aW5nIHByb3BlcnRpZXMgb24gYSBWdWUgaW5zdGFuY2Ugb3IgaXRzIHJvb3QgJGRhdGEgJyArICctIGp1c3Qgc2V0IGl0IHRvIG51bGwuJyk7CiAgICByZXR1cm47CiAgfQoKICBpZiAoIWhhc093bih0YXJnZXQsIGtleSkpIHsKICAgIHJldHVybjsKICB9CgogIGRlbGV0ZSB0YXJnZXRba2V5XTsKCiAgaWYgKCFvYikgewogICAgcmV0dXJuOwogIH0KCiAgb2IuZGVwLm5vdGlmeSgpOwp9Ci8qKgogKiBDb2xsZWN0IGRlcGVuZGVuY2llcyBvbiBhcnJheSBlbGVtZW50cyB3aGVuIHRoZSBhcnJheSBpcyB0b3VjaGVkLCBzaW5jZQogKiB3ZSBjYW5ub3QgaW50ZXJjZXB0IGFycmF5IGVsZW1lbnQgYWNjZXNzIGxpa2UgcHJvcGVydHkgZ2V0dGVycy4KICovCgoKZnVuY3Rpb24gZGVwZW5kQXJyYXkodmFsdWUpIHsKICBmb3IgKHZhciBlID0gdm9pZCAwLCBpID0gMCwgbCA9IHZhbHVlLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgZSA9IHZhbHVlW2ldOwogICAgZSAmJiBlLl9fb2JfXyAmJiBlLl9fb2JfXy5kZXAuZGVwZW5kKCk7CgogICAgaWYgKEFycmF5LmlzQXJyYXkoZSkpIHsKICAgICAgZGVwZW5kQXJyYXkoZSk7CiAgICB9CiAgfQp9Ci8qICAqLwoKLyoqCiAqIE9wdGlvbiBvdmVyd3JpdGluZyBzdHJhdGVnaWVzIGFyZSBmdW5jdGlvbnMgdGhhdCBoYW5kbGUKICogaG93IHRvIG1lcmdlIGEgcGFyZW50IG9wdGlvbiB2YWx1ZSBhbmQgYSBjaGlsZCBvcHRpb24KICogdmFsdWUgaW50byB0aGUgZmluYWwgdmFsdWUuCiAqLwoKCnZhciBzdHJhdHMgPSBjb25maWcub3B0aW9uTWVyZ2VTdHJhdGVnaWVzOwovKioKICogT3B0aW9ucyB3aXRoIHJlc3RyaWN0aW9ucwogKi8KCmlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgc3RyYXRzLmVsID0gc3RyYXRzLnByb3BzRGF0YSA9IGZ1bmN0aW9uIChwYXJlbnQsIGNoaWxkLCB2bSwga2V5KSB7CiAgICBpZiAoIXZtKSB7CiAgICAgIHdhcm4oIm9wdGlvbiBcIiIgKyBrZXkgKyAiXCIgY2FuIG9ubHkgYmUgdXNlZCBkdXJpbmcgaW5zdGFuY2UgIiArICdjcmVhdGlvbiB3aXRoIHRoZSBgbmV3YCBrZXl3b3JkLicpOwogICAgfQoKICAgIHJldHVybiBkZWZhdWx0U3RyYXQocGFyZW50LCBjaGlsZCk7CiAgfTsKfQovKioKICogSGVscGVyIHRoYXQgcmVjdXJzaXZlbHkgbWVyZ2VzIHR3byBkYXRhIG9iamVjdHMgdG9nZXRoZXIuCiAqLwoKCmZ1bmN0aW9uIG1lcmdlRGF0YSh0bywgZnJvbSkgewogIGlmICghZnJvbSkgewogICAgcmV0dXJuIHRvOwogIH0KCiAgdmFyIGtleSwgdG9WYWwsIGZyb21WYWw7CiAgdmFyIGtleXMgPSBoYXNTeW1ib2wgPyBSZWZsZWN0Lm93bktleXMoZnJvbSkgOiBPYmplY3Qua2V5cyhmcm9tKTsKCiAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7CiAgICBrZXkgPSBrZXlzW2ldOyAvLyBpbiBjYXNlIHRoZSBvYmplY3QgaXMgYWxyZWFkeSBvYnNlcnZlZC4uLgoKICAgIGlmIChrZXkgPT09ICdfX29iX18nKSB7CiAgICAgIGNvbnRpbnVlOwogICAgfQoKICAgIHRvVmFsID0gdG9ba2V5XTsKICAgIGZyb21WYWwgPSBmcm9tW2tleV07CgogICAgaWYgKCFoYXNPd24odG8sIGtleSkpIHsKICAgICAgc2V0KHRvLCBrZXksIGZyb21WYWwpOwogICAgfSBlbHNlIGlmICh0b1ZhbCAhPT0gZnJvbVZhbCAmJiBpc1BsYWluT2JqZWN0KHRvVmFsKSAmJiBpc1BsYWluT2JqZWN0KGZyb21WYWwpKSB7CiAgICAgIG1lcmdlRGF0YSh0b1ZhbCwgZnJvbVZhbCk7CiAgICB9CiAgfQoKICByZXR1cm4gdG87Cn0KLyoqCiAqIERhdGEKICovCgoKZnVuY3Rpb24gbWVyZ2VEYXRhT3JGbihwYXJlbnRWYWwsIGNoaWxkVmFsLCB2bSkgewogIGlmICghdm0pIHsKICAgIC8vIGluIGEgVnVlLmV4dGVuZCBtZXJnZSwgYm90aCBzaG91bGQgYmUgZnVuY3Rpb25zCiAgICBpZiAoIWNoaWxkVmFsKSB7CiAgICAgIHJldHVybiBwYXJlbnRWYWw7CiAgICB9CgogICAgaWYgKCFwYXJlbnRWYWwpIHsKICAgICAgcmV0dXJuIGNoaWxkVmFsOwogICAgfSAvLyB3aGVuIHBhcmVudFZhbCAmIGNoaWxkVmFsIGFyZSBib3RoIHByZXNlbnQsCiAgICAvLyB3ZSBuZWVkIHRvIHJldHVybiBhIGZ1bmN0aW9uIHRoYXQgcmV0dXJucyB0aGUKICAgIC8vIG1lcmdlZCByZXN1bHQgb2YgYm90aCBmdW5jdGlvbnMuLi4gbm8gbmVlZCB0bwogICAgLy8gY2hlY2sgaWYgcGFyZW50VmFsIGlzIGEgZnVuY3Rpb24gaGVyZSBiZWNhdXNlCiAgICAvLyBpdCBoYXMgdG8gYmUgYSBmdW5jdGlvbiB0byBwYXNzIHByZXZpb3VzIG1lcmdlcy4KCgogICAgcmV0dXJuIGZ1bmN0aW9uIG1lcmdlZERhdGFGbigpIHsKICAgICAgcmV0dXJuIG1lcmdlRGF0YSh0eXBlb2YgY2hpbGRWYWwgPT09ICdmdW5jdGlvbicgPyBjaGlsZFZhbC5jYWxsKHRoaXMsIHRoaXMpIDogY2hpbGRWYWwsIHR5cGVvZiBwYXJlbnRWYWwgPT09ICdmdW5jdGlvbicgPyBwYXJlbnRWYWwuY2FsbCh0aGlzLCB0aGlzKSA6IHBhcmVudFZhbCk7CiAgICB9OwogIH0gZWxzZSB7CiAgICByZXR1cm4gZnVuY3Rpb24gbWVyZ2VkSW5zdGFuY2VEYXRhRm4oKSB7CiAgICAgIC8vIGluc3RhbmNlIG1lcmdlCiAgICAgIHZhciBpbnN0YW5jZURhdGEgPSB0eXBlb2YgY2hpbGRWYWwgPT09ICdmdW5jdGlvbicgPyBjaGlsZFZhbC5jYWxsKHZtLCB2bSkgOiBjaGlsZFZhbDsKICAgICAgdmFyIGRlZmF1bHREYXRhID0gdHlwZW9mIHBhcmVudFZhbCA9PT0gJ2Z1bmN0aW9uJyA/IHBhcmVudFZhbC5jYWxsKHZtLCB2bSkgOiBwYXJlbnRWYWw7CgogICAgICBpZiAoaW5zdGFuY2VEYXRhKSB7CiAgICAgICAgcmV0dXJuIG1lcmdlRGF0YShpbnN0YW5jZURhdGEsIGRlZmF1bHREYXRhKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gZGVmYXVsdERhdGE7CiAgICAgIH0KICAgIH07CiAgfQp9CgpzdHJhdHMuZGF0YSA9IGZ1bmN0aW9uIChwYXJlbnRWYWwsIGNoaWxkVmFsLCB2bSkgewogIGlmICghdm0pIHsKICAgIGlmIChjaGlsZFZhbCAmJiB0eXBlb2YgY2hpbGRWYWwgIT09ICdmdW5jdGlvbicpIHsKICAgICAgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiB3YXJuKCdUaGUgImRhdGEiIG9wdGlvbiBzaG91bGQgYmUgYSBmdW5jdGlvbiAnICsgJ3RoYXQgcmV0dXJucyBhIHBlci1pbnN0YW5jZSB2YWx1ZSBpbiBjb21wb25lbnQgJyArICdkZWZpbml0aW9ucy4nLCB2bSk7CiAgICAgIHJldHVybiBwYXJlbnRWYWw7CiAgICB9CgogICAgcmV0dXJuIG1lcmdlRGF0YU9yRm4ocGFyZW50VmFsLCBjaGlsZFZhbCk7CiAgfQoKICByZXR1cm4gbWVyZ2VEYXRhT3JGbihwYXJlbnRWYWwsIGNoaWxkVmFsLCB2bSk7Cn07Ci8qKgogKiBIb29rcyBhbmQgcHJvcHMgYXJlIG1lcmdlZCBhcyBhcnJheXMuCiAqLwoKCmZ1bmN0aW9uIG1lcmdlSG9vayhwYXJlbnRWYWwsIGNoaWxkVmFsKSB7CiAgdmFyIHJlcyA9IGNoaWxkVmFsID8gcGFyZW50VmFsID8gcGFyZW50VmFsLmNvbmNhdChjaGlsZFZhbCkgOiBBcnJheS5pc0FycmF5KGNoaWxkVmFsKSA/IGNoaWxkVmFsIDogW2NoaWxkVmFsXSA6IHBhcmVudFZhbDsKICByZXR1cm4gcmVzID8gZGVkdXBlSG9va3MocmVzKSA6IHJlczsKfQoKZnVuY3Rpb24gZGVkdXBlSG9va3MoaG9va3MpIHsKICB2YXIgcmVzID0gW107CgogIGZvciAodmFyIGkgPSAwOyBpIDwgaG9va3MubGVuZ3RoOyBpKyspIHsKICAgIGlmIChyZXMuaW5kZXhPZihob29rc1tpXSkgPT09IC0xKSB7CiAgICAgIHJlcy5wdXNoKGhvb2tzW2ldKTsKICAgIH0KICB9CgogIHJldHVybiByZXM7Cn0KCkxJRkVDWUNMRV9IT09LUy5mb3JFYWNoKGZ1bmN0aW9uIChob29rKSB7CiAgc3RyYXRzW2hvb2tdID0gbWVyZ2VIb29rOwp9KTsKLyoqCiAqIEFzc2V0cwogKgogKiBXaGVuIGEgdm0gaXMgcHJlc2VudCAoaW5zdGFuY2UgY3JlYXRpb24pLCB3ZSBuZWVkIHRvIGRvCiAqIGEgdGhyZWUtd2F5IG1lcmdlIGJldHdlZW4gY29uc3RydWN0b3Igb3B0aW9ucywgaW5zdGFuY2UKICogb3B0aW9ucyBhbmQgcGFyZW50IG9wdGlvbnMuCiAqLwoKZnVuY3Rpb24gbWVyZ2VBc3NldHMocGFyZW50VmFsLCBjaGlsZFZhbCwgdm0sIGtleSkgewogIHZhciByZXMgPSBPYmplY3QuY3JlYXRlKHBhcmVudFZhbCB8fCBudWxsKTsKCiAgaWYgKGNoaWxkVmFsKSB7CiAgICBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIGFzc2VydE9iamVjdFR5cGUoa2V5LCBjaGlsZFZhbCwgdm0pOwogICAgcmV0dXJuIGV4dGVuZChyZXMsIGNoaWxkVmFsKTsKICB9IGVsc2UgewogICAgcmV0dXJuIHJlczsKICB9Cn0KCkFTU0VUX1RZUEVTLmZvckVhY2goZnVuY3Rpb24gKHR5cGUpIHsKICBzdHJhdHNbdHlwZSArICdzJ10gPSBtZXJnZUFzc2V0czsKfSk7Ci8qKgogKiBXYXRjaGVycy4KICoKICogV2F0Y2hlcnMgaGFzaGVzIHNob3VsZCBub3Qgb3ZlcndyaXRlIG9uZQogKiBhbm90aGVyLCBzbyB3ZSBtZXJnZSB0aGVtIGFzIGFycmF5cy4KICovCgpzdHJhdHMud2F0Y2ggPSBmdW5jdGlvbiAocGFyZW50VmFsLCBjaGlsZFZhbCwgdm0sIGtleSkgewogIC8vIHdvcmsgYXJvdW5kIEZpcmVmb3gncyBPYmplY3QucHJvdG90eXBlLndhdGNoLi4uCiAgaWYgKHBhcmVudFZhbCA9PT0gbmF0aXZlV2F0Y2gpIHsKICAgIHBhcmVudFZhbCA9IHVuZGVmaW5lZDsKICB9CgogIGlmIChjaGlsZFZhbCA9PT0gbmF0aXZlV2F0Y2gpIHsKICAgIGNoaWxkVmFsID0gdW5kZWZpbmVkOwogIH0KICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KCgogIGlmICghY2hpbGRWYWwpIHsKICAgIHJldHVybiBPYmplY3QuY3JlYXRlKHBhcmVudFZhbCB8fCBudWxsKTsKICB9CgogIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICBhc3NlcnRPYmplY3RUeXBlKGtleSwgY2hpbGRWYWwsIHZtKTsKICB9CgogIGlmICghcGFyZW50VmFsKSB7CiAgICByZXR1cm4gY2hpbGRWYWw7CiAgfQoKICB2YXIgcmV0ID0ge307CiAgZXh0ZW5kKHJldCwgcGFyZW50VmFsKTsKCiAgZm9yICh2YXIga2V5JDEgaW4gY2hpbGRWYWwpIHsKICAgIHZhciBwYXJlbnQgPSByZXRba2V5JDFdOwogICAgdmFyIGNoaWxkID0gY2hpbGRWYWxba2V5JDFdOwoKICAgIGlmIChwYXJlbnQgJiYgIUFycmF5LmlzQXJyYXkocGFyZW50KSkgewogICAgICBwYXJlbnQgPSBbcGFyZW50XTsKICAgIH0KCiAgICByZXRba2V5JDFdID0gcGFyZW50ID8gcGFyZW50LmNvbmNhdChjaGlsZCkgOiBBcnJheS5pc0FycmF5KGNoaWxkKSA/IGNoaWxkIDogW2NoaWxkXTsKICB9CgogIHJldHVybiByZXQ7Cn07Ci8qKgogKiBPdGhlciBvYmplY3QgaGFzaGVzLgogKi8KCgpzdHJhdHMucHJvcHMgPSBzdHJhdHMubWV0aG9kcyA9IHN0cmF0cy5pbmplY3QgPSBzdHJhdHMuY29tcHV0ZWQgPSBmdW5jdGlvbiAocGFyZW50VmFsLCBjaGlsZFZhbCwgdm0sIGtleSkgewogIGlmIChjaGlsZFZhbCAmJiBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICBhc3NlcnRPYmplY3RUeXBlKGtleSwgY2hpbGRWYWwsIHZtKTsKICB9CgogIGlmICghcGFyZW50VmFsKSB7CiAgICByZXR1cm4gY2hpbGRWYWw7CiAgfQoKICB2YXIgcmV0ID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICBleHRlbmQocmV0LCBwYXJlbnRWYWwpOwoKICBpZiAoY2hpbGRWYWwpIHsKICAgIGV4dGVuZChyZXQsIGNoaWxkVmFsKTsKICB9CgogIHJldHVybiByZXQ7Cn07CgpzdHJhdHMucHJvdmlkZSA9IG1lcmdlRGF0YU9yRm47Ci8qKgogKiBEZWZhdWx0IHN0cmF0ZWd5LgogKi8KCnZhciBkZWZhdWx0U3RyYXQgPSBmdW5jdGlvbiBkZWZhdWx0U3RyYXQocGFyZW50VmFsLCBjaGlsZFZhbCkgewogIHJldHVybiBjaGlsZFZhbCA9PT0gdW5kZWZpbmVkID8gcGFyZW50VmFsIDogY2hpbGRWYWw7Cn07Ci8qKgogKiBWYWxpZGF0ZSBjb21wb25lbnQgbmFtZXMKICovCgoKZnVuY3Rpb24gY2hlY2tDb21wb25lbnRzKG9wdGlvbnMpIHsKICBmb3IgKHZhciBrZXkgaW4gb3B0aW9ucy5jb21wb25lbnRzKSB7CiAgICB2YWxpZGF0ZUNvbXBvbmVudE5hbWUoa2V5KTsKICB9Cn0KCmZ1bmN0aW9uIHZhbGlkYXRlQ29tcG9uZW50TmFtZShuYW1lKSB7CiAgaWYgKCFuZXcgUmVnRXhwKCJeW2EtekEtWl1bXFwtXFwuMC05XyIgKyB1bmljb2RlUmVnRXhwLnNvdXJjZSArICJdKiQiKS50ZXN0KG5hbWUpKSB7CiAgICB3YXJuKCdJbnZhbGlkIGNvbXBvbmVudCBuYW1lOiAiJyArIG5hbWUgKyAnIi4gQ29tcG9uZW50IG5hbWVzICcgKyAnc2hvdWxkIGNvbmZvcm0gdG8gdmFsaWQgY3VzdG9tIGVsZW1lbnQgbmFtZSBpbiBodG1sNSBzcGVjaWZpY2F0aW9uLicpOwogIH0KCiAgaWYgKGlzQnVpbHRJblRhZyhuYW1lKSB8fCBjb25maWcuaXNSZXNlcnZlZFRhZyhuYW1lKSkgewogICAgd2FybignRG8gbm90IHVzZSBidWlsdC1pbiBvciByZXNlcnZlZCBIVE1MIGVsZW1lbnRzIGFzIGNvbXBvbmVudCAnICsgJ2lkOiAnICsgbmFtZSk7CiAgfQp9Ci8qKgogKiBFbnN1cmUgYWxsIHByb3BzIG9wdGlvbiBzeW50YXggYXJlIG5vcm1hbGl6ZWQgaW50byB0aGUKICogT2JqZWN0LWJhc2VkIGZvcm1hdC4KICovCgoKZnVuY3Rpb24gbm9ybWFsaXplUHJvcHMob3B0aW9ucywgdm0pIHsKICB2YXIgcHJvcHMgPSBvcHRpb25zLnByb3BzOwoKICBpZiAoIXByb3BzKSB7CiAgICByZXR1cm47CiAgfQoKICB2YXIgcmVzID0ge307CiAgdmFyIGksIHZhbCwgbmFtZTsKCiAgaWYgKEFycmF5LmlzQXJyYXkocHJvcHMpKSB7CiAgICBpID0gcHJvcHMubGVuZ3RoOwoKICAgIHdoaWxlIChpLS0pIHsKICAgICAgdmFsID0gcHJvcHNbaV07CgogICAgICBpZiAodHlwZW9mIHZhbCA9PT0gJ3N0cmluZycpIHsKICAgICAgICBuYW1lID0gY2FtZWxpemUodmFsKTsKICAgICAgICByZXNbbmFtZV0gPSB7CiAgICAgICAgICB0eXBlOiBudWxsCiAgICAgICAgfTsKICAgICAgfSBlbHNlIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICAgICAgd2FybigncHJvcHMgbXVzdCBiZSBzdHJpbmdzIHdoZW4gdXNpbmcgYXJyYXkgc3ludGF4LicpOwogICAgICB9CiAgICB9CiAgfSBlbHNlIGlmIChpc1BsYWluT2JqZWN0KHByb3BzKSkgewogICAgZm9yICh2YXIga2V5IGluIHByb3BzKSB7CiAgICAgIHZhbCA9IHByb3BzW2tleV07CiAgICAgIG5hbWUgPSBjYW1lbGl6ZShrZXkpOwogICAgICByZXNbbmFtZV0gPSBpc1BsYWluT2JqZWN0KHZhbCkgPyB2YWwgOiB7CiAgICAgICAgdHlwZTogdmFsCiAgICAgIH07CiAgICB9CiAgfSBlbHNlIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICB3YXJuKCJJbnZhbGlkIHZhbHVlIGZvciBvcHRpb24gXCJwcm9wc1wiOiBleHBlY3RlZCBhbiBBcnJheSBvciBhbiBPYmplY3QsICIgKyAiYnV0IGdvdCAiICsgdG9SYXdUeXBlKHByb3BzKSArICIuIiwgdm0pOwogIH0KCiAgb3B0aW9ucy5wcm9wcyA9IHJlczsKfQovKioKICogTm9ybWFsaXplIGFsbCBpbmplY3Rpb25zIGludG8gT2JqZWN0LWJhc2VkIGZvcm1hdAogKi8KCgpmdW5jdGlvbiBub3JtYWxpemVJbmplY3Qob3B0aW9ucywgdm0pIHsKICB2YXIgaW5qZWN0ID0gb3B0aW9ucy5pbmplY3Q7CgogIGlmICghaW5qZWN0KSB7CiAgICByZXR1cm47CiAgfQoKICB2YXIgbm9ybWFsaXplZCA9IG9wdGlvbnMuaW5qZWN0ID0ge307CgogIGlmIChBcnJheS5pc0FycmF5KGluamVjdCkpIHsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaW5qZWN0Lmxlbmd0aDsgaSsrKSB7CiAgICAgIG5vcm1hbGl6ZWRbaW5qZWN0W2ldXSA9IHsKICAgICAgICBmcm9tOiBpbmplY3RbaV0KICAgICAgfTsKICAgIH0KICB9IGVsc2UgaWYgKGlzUGxhaW5PYmplY3QoaW5qZWN0KSkgewogICAgZm9yICh2YXIga2V5IGluIGluamVjdCkgewogICAgICB2YXIgdmFsID0gaW5qZWN0W2tleV07CiAgICAgIG5vcm1hbGl6ZWRba2V5XSA9IGlzUGxhaW5PYmplY3QodmFsKSA/IGV4dGVuZCh7CiAgICAgICAgZnJvbToga2V5CiAgICAgIH0sIHZhbCkgOiB7CiAgICAgICAgZnJvbTogdmFsCiAgICAgIH07CiAgICB9CiAgfSBlbHNlIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICB3YXJuKCJJbnZhbGlkIHZhbHVlIGZvciBvcHRpb24gXCJpbmplY3RcIjogZXhwZWN0ZWQgYW4gQXJyYXkgb3IgYW4gT2JqZWN0LCAiICsgImJ1dCBnb3QgIiArIHRvUmF3VHlwZShpbmplY3QpICsgIi4iLCB2bSk7CiAgfQp9Ci8qKgogKiBOb3JtYWxpemUgcmF3IGZ1bmN0aW9uIGRpcmVjdGl2ZXMgaW50byBvYmplY3QgZm9ybWF0LgogKi8KCgpmdW5jdGlvbiBub3JtYWxpemVEaXJlY3RpdmVzKG9wdGlvbnMpIHsKICB2YXIgZGlycyA9IG9wdGlvbnMuZGlyZWN0aXZlczsKCiAgaWYgKGRpcnMpIHsKICAgIGZvciAodmFyIGtleSBpbiBkaXJzKSB7CiAgICAgIHZhciBkZWYkJDEgPSBkaXJzW2tleV07CgogICAgICBpZiAodHlwZW9mIGRlZiQkMSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIGRpcnNba2V5XSA9IHsKICAgICAgICAgIGJpbmQ6IGRlZiQkMSwKICAgICAgICAgIHVwZGF0ZTogZGVmJCQxCiAgICAgICAgfTsKICAgICAgfQogICAgfQogIH0KfQoKZnVuY3Rpb24gYXNzZXJ0T2JqZWN0VHlwZShuYW1lLCB2YWx1ZSwgdm0pIHsKICBpZiAoIWlzUGxhaW5PYmplY3QodmFsdWUpKSB7CiAgICB3YXJuKCJJbnZhbGlkIHZhbHVlIGZvciBvcHRpb24gXCIiICsgbmFtZSArICJcIjogZXhwZWN0ZWQgYW4gT2JqZWN0LCAiICsgImJ1dCBnb3QgIiArIHRvUmF3VHlwZSh2YWx1ZSkgKyAiLiIsIHZtKTsKICB9Cn0KLyoqCiAqIE1lcmdlIHR3byBvcHRpb24gb2JqZWN0cyBpbnRvIGEgbmV3IG9uZS4KICogQ29yZSB1dGlsaXR5IHVzZWQgaW4gYm90aCBpbnN0YW50aWF0aW9uIGFuZCBpbmhlcml0YW5jZS4KICovCgoKZnVuY3Rpb24gbWVyZ2VPcHRpb25zKHBhcmVudCwgY2hpbGQsIHZtKSB7CiAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgIGNoZWNrQ29tcG9uZW50cyhjaGlsZCk7CiAgfQoKICBpZiAodHlwZW9mIGNoaWxkID09PSAnZnVuY3Rpb24nKSB7CiAgICBjaGlsZCA9IGNoaWxkLm9wdGlvbnM7CiAgfQoKICBub3JtYWxpemVQcm9wcyhjaGlsZCwgdm0pOwogIG5vcm1hbGl6ZUluamVjdChjaGlsZCwgdm0pOwogIG5vcm1hbGl6ZURpcmVjdGl2ZXMoY2hpbGQpOyAvLyBBcHBseSBleHRlbmRzIGFuZCBtaXhpbnMgb24gdGhlIGNoaWxkIG9wdGlvbnMsCiAgLy8gYnV0IG9ubHkgaWYgaXQgaXMgYSByYXcgb3B0aW9ucyBvYmplY3QgdGhhdCBpc24ndAogIC8vIHRoZSByZXN1bHQgb2YgYW5vdGhlciBtZXJnZU9wdGlvbnMgY2FsbC4KICAvLyBPbmx5IG1lcmdlZCBvcHRpb25zIGhhcyB0aGUgX2Jhc2UgcHJvcGVydHkuCgogIGlmICghY2hpbGQuX2Jhc2UpIHsKICAgIGlmIChjaGlsZFsiZXh0ZW5kcyJdKSB7CiAgICAgIHBhcmVudCA9IG1lcmdlT3B0aW9ucyhwYXJlbnQsIGNoaWxkWyJleHRlbmRzIl0sIHZtKTsKICAgIH0KCiAgICBpZiAoY2hpbGQubWl4aW5zKSB7CiAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gY2hpbGQubWl4aW5zLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIHBhcmVudCA9IG1lcmdlT3B0aW9ucyhwYXJlbnQsIGNoaWxkLm1peGluc1tpXSwgdm0pOwogICAgICB9CiAgICB9CiAgfQoKICB2YXIgb3B0aW9ucyA9IHt9OwogIHZhciBrZXk7CgogIGZvciAoa2V5IGluIHBhcmVudCkgewogICAgbWVyZ2VGaWVsZChrZXkpOwogIH0KCiAgZm9yIChrZXkgaW4gY2hpbGQpIHsKICAgIGlmICghaGFzT3duKHBhcmVudCwga2V5KSkgewogICAgICBtZXJnZUZpZWxkKGtleSk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBtZXJnZUZpZWxkKGtleSkgewogICAgdmFyIHN0cmF0ID0gc3RyYXRzW2tleV0gfHwgZGVmYXVsdFN0cmF0OwogICAgb3B0aW9uc1trZXldID0gc3RyYXQocGFyZW50W2tleV0sIGNoaWxkW2tleV0sIHZtLCBrZXkpOwogIH0KCiAgcmV0dXJuIG9wdGlvbnM7Cn0KLyoqCiAqIFJlc29sdmUgYW4gYXNzZXQuCiAqIFRoaXMgZnVuY3Rpb24gaXMgdXNlZCBiZWNhdXNlIGNoaWxkIGluc3RhbmNlcyBuZWVkIGFjY2VzcwogKiB0byBhc3NldHMgZGVmaW5lZCBpbiBpdHMgYW5jZXN0b3IgY2hhaW4uCiAqLwoKCmZ1bmN0aW9uIHJlc29sdmVBc3NldChvcHRpb25zLCB0eXBlLCBpZCwgd2Fybk1pc3NpbmcpIHsKICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICBpZiAodHlwZW9mIGlkICE9PSAnc3RyaW5nJykgewogICAgcmV0dXJuOwogIH0KCiAgdmFyIGFzc2V0cyA9IG9wdGlvbnNbdHlwZV07IC8vIGNoZWNrIGxvY2FsIHJlZ2lzdHJhdGlvbiB2YXJpYXRpb25zIGZpcnN0CgogIGlmIChoYXNPd24oYXNzZXRzLCBpZCkpIHsKICAgIHJldHVybiBhc3NldHNbaWRdOwogIH0KCiAgdmFyIGNhbWVsaXplZElkID0gY2FtZWxpemUoaWQpOwoKICBpZiAoaGFzT3duKGFzc2V0cywgY2FtZWxpemVkSWQpKSB7CiAgICByZXR1cm4gYXNzZXRzW2NhbWVsaXplZElkXTsKICB9CgogIHZhciBQYXNjYWxDYXNlSWQgPSBjYXBpdGFsaXplKGNhbWVsaXplZElkKTsKCiAgaWYgKGhhc093bihhc3NldHMsIFBhc2NhbENhc2VJZCkpIHsKICAgIHJldHVybiBhc3NldHNbUGFzY2FsQ2FzZUlkXTsKICB9IC8vIGZhbGxiYWNrIHRvIHByb3RvdHlwZSBjaGFpbgoKCiAgdmFyIHJlcyA9IGFzc2V0c1tpZF0gfHwgYXNzZXRzW2NhbWVsaXplZElkXSB8fCBhc3NldHNbUGFzY2FsQ2FzZUlkXTsKCiAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgd2Fybk1pc3NpbmcgJiYgIXJlcykgewogICAgd2FybignRmFpbGVkIHRvIHJlc29sdmUgJyArIHR5cGUuc2xpY2UoMCwgLTEpICsgJzogJyArIGlkLCBvcHRpb25zKTsKICB9CgogIHJldHVybiByZXM7Cn0KLyogICovCgoKZnVuY3Rpb24gdmFsaWRhdGVQcm9wKGtleSwgcHJvcE9wdGlvbnMsIHByb3BzRGF0YSwgdm0pIHsKICB2YXIgcHJvcCA9IHByb3BPcHRpb25zW2tleV07CiAgdmFyIGFic2VudCA9ICFoYXNPd24ocHJvcHNEYXRhLCBrZXkpOwogIHZhciB2YWx1ZSA9IHByb3BzRGF0YVtrZXldOyAvLyBib29sZWFuIGNhc3RpbmcKCiAgdmFyIGJvb2xlYW5JbmRleCA9IGdldFR5cGVJbmRleChCb29sZWFuLCBwcm9wLnR5cGUpOwoKICBpZiAoYm9vbGVhbkluZGV4ID4gLTEpIHsKICAgIGlmIChhYnNlbnQgJiYgIWhhc093bihwcm9wLCAnZGVmYXVsdCcpKSB7CiAgICAgIHZhbHVlID0gZmFsc2U7CiAgICB9IGVsc2UgaWYgKHZhbHVlID09PSAnJyB8fCB2YWx1ZSA9PT0gaHlwaGVuYXRlKGtleSkpIHsKICAgICAgLy8gb25seSBjYXN0IGVtcHR5IHN0cmluZyAvIHNhbWUgbmFtZSB0byBib29sZWFuIGlmCiAgICAgIC8vIGJvb2xlYW4gaGFzIGhpZ2hlciBwcmlvcml0eQogICAgICB2YXIgc3RyaW5nSW5kZXggPSBnZXRUeXBlSW5kZXgoU3RyaW5nLCBwcm9wLnR5cGUpOwoKICAgICAgaWYgKHN0cmluZ0luZGV4IDwgMCB8fCBib29sZWFuSW5kZXggPCBzdHJpbmdJbmRleCkgewogICAgICAgIHZhbHVlID0gdHJ1ZTsKICAgICAgfQogICAgfQogIH0gLy8gY2hlY2sgZGVmYXVsdCB2YWx1ZQoKCiAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQpIHsKICAgIHZhbHVlID0gZ2V0UHJvcERlZmF1bHRWYWx1ZSh2bSwgcHJvcCwga2V5KTsgLy8gc2luY2UgdGhlIGRlZmF1bHQgdmFsdWUgaXMgYSBmcmVzaCBjb3B5LAogICAgLy8gbWFrZSBzdXJlIHRvIG9ic2VydmUgaXQuCgogICAgdmFyIHByZXZTaG91bGRPYnNlcnZlID0gc2hvdWxkT2JzZXJ2ZTsKICAgIHRvZ2dsZU9ic2VydmluZyh0cnVlKTsKICAgIG9ic2VydmUodmFsdWUpOwogICAgdG9nZ2xlT2JzZXJ2aW5nKHByZXZTaG91bGRPYnNlcnZlKTsKICB9CgogIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIC8vIHNraXAgdmFsaWRhdGlvbiBmb3Igd2VleCByZWN5Y2xlLWxpc3QgY2hpbGQgY29tcG9uZW50IHByb3BzCiAgIWZhbHNlKSB7CiAgICBhc3NlcnRQcm9wKHByb3AsIGtleSwgdmFsdWUsIHZtLCBhYnNlbnQpOwogIH0KCiAgcmV0dXJuIHZhbHVlOwp9Ci8qKgogKiBHZXQgdGhlIGRlZmF1bHQgdmFsdWUgb2YgYSBwcm9wLgogKi8KCgpmdW5jdGlvbiBnZXRQcm9wRGVmYXVsdFZhbHVlKHZtLCBwcm9wLCBrZXkpIHsKICAvLyBubyBkZWZhdWx0LCByZXR1cm4gdW5kZWZpbmVkCiAgaWYgKCFoYXNPd24ocHJvcCwgJ2RlZmF1bHQnKSkgewogICAgcmV0dXJuIHVuZGVmaW5lZDsKICB9CgogIHZhciBkZWYgPSBwcm9wWyJkZWZhdWx0Il07IC8vIHdhcm4gYWdhaW5zdCBub24tZmFjdG9yeSBkZWZhdWx0cyBmb3IgT2JqZWN0ICYgQXJyYXkKCiAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgaXNPYmplY3QoZGVmKSkgewogICAgd2FybignSW52YWxpZCBkZWZhdWx0IHZhbHVlIGZvciBwcm9wICInICsga2V5ICsgJyI6ICcgKyAnUHJvcHMgd2l0aCB0eXBlIE9iamVjdC9BcnJheSBtdXN0IHVzZSBhIGZhY3RvcnkgZnVuY3Rpb24gJyArICd0byByZXR1cm4gdGhlIGRlZmF1bHQgdmFsdWUuJywgdm0pOwogIH0gLy8gdGhlIHJhdyBwcm9wIHZhbHVlIHdhcyBhbHNvIHVuZGVmaW5lZCBmcm9tIHByZXZpb3VzIHJlbmRlciwKICAvLyByZXR1cm4gcHJldmlvdXMgZGVmYXVsdCB2YWx1ZSB0byBhdm9pZCB1bm5lY2Vzc2FyeSB3YXRjaGVyIHRyaWdnZXIKCgogIGlmICh2bSAmJiB2bS4kb3B0aW9ucy5wcm9wc0RhdGEgJiYgdm0uJG9wdGlvbnMucHJvcHNEYXRhW2tleV0gPT09IHVuZGVmaW5lZCAmJiB2bS5fcHJvcHNba2V5XSAhPT0gdW5kZWZpbmVkKSB7CiAgICByZXR1cm4gdm0uX3Byb3BzW2tleV07CiAgfSAvLyBjYWxsIGZhY3RvcnkgZnVuY3Rpb24gZm9yIG5vbi1GdW5jdGlvbiB0eXBlcwogIC8vIGEgdmFsdWUgaXMgRnVuY3Rpb24gaWYgaXRzIHByb3RvdHlwZSBpcyBmdW5jdGlvbiBldmVuIGFjcm9zcyBkaWZmZXJlbnQgZXhlY3V0aW9uIGNvbnRleHQKCgogIHJldHVybiB0eXBlb2YgZGVmID09PSAnZnVuY3Rpb24nICYmIGdldFR5cGUocHJvcC50eXBlKSAhPT0gJ0Z1bmN0aW9uJyA/IGRlZi5jYWxsKHZtKSA6IGRlZjsKfQovKioKICogQXNzZXJ0IHdoZXRoZXIgYSBwcm9wIGlzIHZhbGlkLgogKi8KCgpmdW5jdGlvbiBhc3NlcnRQcm9wKHByb3AsIG5hbWUsIHZhbHVlLCB2bSwgYWJzZW50KSB7CiAgaWYgKHByb3AucmVxdWlyZWQgJiYgYWJzZW50KSB7CiAgICB3YXJuKCdNaXNzaW5nIHJlcXVpcmVkIHByb3A6ICInICsgbmFtZSArICciJywgdm0pOwogICAgcmV0dXJuOwogIH0KCiAgaWYgKHZhbHVlID09IG51bGwgJiYgIXByb3AucmVxdWlyZWQpIHsKICAgIHJldHVybjsKICB9CgogIHZhciB0eXBlID0gcHJvcC50eXBlOwogIHZhciB2YWxpZCA9ICF0eXBlIHx8IHR5cGUgPT09IHRydWU7CiAgdmFyIGV4cGVjdGVkVHlwZXMgPSBbXTsKCiAgaWYgKHR5cGUpIHsKICAgIGlmICghQXJyYXkuaXNBcnJheSh0eXBlKSkgewogICAgICB0eXBlID0gW3R5cGVdOwogICAgfQoKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdHlwZS5sZW5ndGggJiYgIXZhbGlkOyBpKyspIHsKICAgICAgdmFyIGFzc2VydGVkVHlwZSA9IGFzc2VydFR5cGUodmFsdWUsIHR5cGVbaV0pOwogICAgICBleHBlY3RlZFR5cGVzLnB1c2goYXNzZXJ0ZWRUeXBlLmV4cGVjdGVkVHlwZSB8fCAnJyk7CiAgICAgIHZhbGlkID0gYXNzZXJ0ZWRUeXBlLnZhbGlkOwogICAgfQogIH0KCiAgaWYgKCF2YWxpZCkgewogICAgd2FybihnZXRJbnZhbGlkVHlwZU1lc3NhZ2UobmFtZSwgdmFsdWUsIGV4cGVjdGVkVHlwZXMpLCB2bSk7CiAgICByZXR1cm47CiAgfQoKICB2YXIgdmFsaWRhdG9yID0gcHJvcC52YWxpZGF0b3I7CgogIGlmICh2YWxpZGF0b3IpIHsKICAgIGlmICghdmFsaWRhdG9yKHZhbHVlKSkgewogICAgICB3YXJuKCdJbnZhbGlkIHByb3A6IGN1c3RvbSB2YWxpZGF0b3IgY2hlY2sgZmFpbGVkIGZvciBwcm9wICInICsgbmFtZSArICciLicsIHZtKTsKICAgIH0KICB9Cn0KCnZhciBzaW1wbGVDaGVja1JFID0gL14oU3RyaW5nfE51bWJlcnxCb29sZWFufEZ1bmN0aW9ufFN5bWJvbCkkLzsKCmZ1bmN0aW9uIGFzc2VydFR5cGUodmFsdWUsIHR5cGUpIHsKICB2YXIgdmFsaWQ7CiAgdmFyIGV4cGVjdGVkVHlwZSA9IGdldFR5cGUodHlwZSk7CgogIGlmIChzaW1wbGVDaGVja1JFLnRlc3QoZXhwZWN0ZWRUeXBlKSkgewogICAgdmFyIHQgPSBfdHlwZW9mKHZhbHVlKTsKCiAgICB2YWxpZCA9IHQgPT09IGV4cGVjdGVkVHlwZS50b0xvd2VyQ2FzZSgpOyAvLyBmb3IgcHJpbWl0aXZlIHdyYXBwZXIgb2JqZWN0cwoKICAgIGlmICghdmFsaWQgJiYgdCA9PT0gJ29iamVjdCcpIHsKICAgICAgdmFsaWQgPSB2YWx1ZSBpbnN0YW5jZW9mIHR5cGU7CiAgICB9CiAgfSBlbHNlIGlmIChleHBlY3RlZFR5cGUgPT09ICdPYmplY3QnKSB7CiAgICB2YWxpZCA9IGlzUGxhaW5PYmplY3QodmFsdWUpOwogIH0gZWxzZSBpZiAoZXhwZWN0ZWRUeXBlID09PSAnQXJyYXknKSB7CiAgICB2YWxpZCA9IEFycmF5LmlzQXJyYXkodmFsdWUpOwogIH0gZWxzZSB7CiAgICB2YWxpZCA9IHZhbHVlIGluc3RhbmNlb2YgdHlwZTsKICB9CgogIHJldHVybiB7CiAgICB2YWxpZDogdmFsaWQsCiAgICBleHBlY3RlZFR5cGU6IGV4cGVjdGVkVHlwZQogIH07Cn0KLyoqCiAqIFVzZSBmdW5jdGlvbiBzdHJpbmcgbmFtZSB0byBjaGVjayBidWlsdC1pbiB0eXBlcywKICogYmVjYXVzZSBhIHNpbXBsZSBlcXVhbGl0eSBjaGVjayB3aWxsIGZhaWwgd2hlbiBydW5uaW5nCiAqIGFjcm9zcyBkaWZmZXJlbnQgdm1zIC8gaWZyYW1lcy4KICovCgoKZnVuY3Rpb24gZ2V0VHlwZShmbikgewogIHZhciBtYXRjaCA9IGZuICYmIGZuLnRvU3RyaW5nKCkubWF0Y2goL15ccypmdW5jdGlvbiAoXHcrKS8pOwogIHJldHVybiBtYXRjaCA/IG1hdGNoWzFdIDogJyc7Cn0KCmZ1bmN0aW9uIGlzU2FtZVR5cGUoYSwgYikgewogIHJldHVybiBnZXRUeXBlKGEpID09PSBnZXRUeXBlKGIpOwp9CgpmdW5jdGlvbiBnZXRUeXBlSW5kZXgodHlwZSwgZXhwZWN0ZWRUeXBlcykgewogIGlmICghQXJyYXkuaXNBcnJheShleHBlY3RlZFR5cGVzKSkgewogICAgcmV0dXJuIGlzU2FtZVR5cGUoZXhwZWN0ZWRUeXBlcywgdHlwZSkgPyAwIDogLTE7CiAgfQoKICBmb3IgKHZhciBpID0gMCwgbGVuID0gZXhwZWN0ZWRUeXBlcy5sZW5ndGg7IGkgPCBsZW47IGkrKykgewogICAgaWYgKGlzU2FtZVR5cGUoZXhwZWN0ZWRUeXBlc1tpXSwgdHlwZSkpIHsKICAgICAgcmV0dXJuIGk7CiAgICB9CiAgfQoKICByZXR1cm4gLTE7Cn0KCmZ1bmN0aW9uIGdldEludmFsaWRUeXBlTWVzc2FnZShuYW1lLCB2YWx1ZSwgZXhwZWN0ZWRUeXBlcykgewogIHZhciBtZXNzYWdlID0gIkludmFsaWQgcHJvcDogdHlwZSBjaGVjayBmYWlsZWQgZm9yIHByb3AgXCIiICsgbmFtZSArICJcIi4iICsgIiBFeHBlY3RlZCAiICsgZXhwZWN0ZWRUeXBlcy5tYXAoY2FwaXRhbGl6ZSkuam9pbignLCAnKTsKICB2YXIgZXhwZWN0ZWRUeXBlID0gZXhwZWN0ZWRUeXBlc1swXTsKICB2YXIgcmVjZWl2ZWRUeXBlID0gdG9SYXdUeXBlKHZhbHVlKTsKICB2YXIgZXhwZWN0ZWRWYWx1ZSA9IHN0eWxlVmFsdWUodmFsdWUsIGV4cGVjdGVkVHlwZSk7CiAgdmFyIHJlY2VpdmVkVmFsdWUgPSBzdHlsZVZhbHVlKHZhbHVlLCByZWNlaXZlZFR5cGUpOyAvLyBjaGVjayBpZiB3ZSBuZWVkIHRvIHNwZWNpZnkgZXhwZWN0ZWQgdmFsdWUKCiAgaWYgKGV4cGVjdGVkVHlwZXMubGVuZ3RoID09PSAxICYmIGlzRXhwbGljYWJsZShleHBlY3RlZFR5cGUpICYmICFpc0Jvb2xlYW4oZXhwZWN0ZWRUeXBlLCByZWNlaXZlZFR5cGUpKSB7CiAgICBtZXNzYWdlICs9ICIgd2l0aCB2YWx1ZSAiICsgZXhwZWN0ZWRWYWx1ZTsKICB9CgogIG1lc3NhZ2UgKz0gIiwgZ290ICIgKyByZWNlaXZlZFR5cGUgKyAiICI7IC8vIGNoZWNrIGlmIHdlIG5lZWQgdG8gc3BlY2lmeSByZWNlaXZlZCB2YWx1ZQoKICBpZiAoaXNFeHBsaWNhYmxlKHJlY2VpdmVkVHlwZSkpIHsKICAgIG1lc3NhZ2UgKz0gIndpdGggdmFsdWUgIiArIHJlY2VpdmVkVmFsdWUgKyAiLiI7CiAgfQoKICByZXR1cm4gbWVzc2FnZTsKfQoKZnVuY3Rpb24gc3R5bGVWYWx1ZSh2YWx1ZSwgdHlwZSkgewogIGlmICh0eXBlID09PSAnU3RyaW5nJykgewogICAgcmV0dXJuICJcIiIgKyB2YWx1ZSArICJcIiI7CiAgfSBlbHNlIGlmICh0eXBlID09PSAnTnVtYmVyJykgewogICAgcmV0dXJuICIiICsgTnVtYmVyKHZhbHVlKTsKICB9IGVsc2UgewogICAgcmV0dXJuICIiICsgdmFsdWU7CiAgfQp9CgpmdW5jdGlvbiBpc0V4cGxpY2FibGUodmFsdWUpIHsKICB2YXIgZXhwbGljaXRUeXBlcyA9IFsnc3RyaW5nJywgJ251bWJlcicsICdib29sZWFuJ107CiAgcmV0dXJuIGV4cGxpY2l0VHlwZXMuc29tZShmdW5jdGlvbiAoZWxlbSkgewogICAgcmV0dXJuIHZhbHVlLnRvTG93ZXJDYXNlKCkgPT09IGVsZW07CiAgfSk7Cn0KCmZ1bmN0aW9uIGlzQm9vbGVhbigpIHsKICB2YXIgYXJncyA9IFtdLAogICAgICBsZW4gPSBhcmd1bWVudHMubGVuZ3RoOwoKICB3aGlsZSAobGVuLS0pIHsKICAgIGFyZ3NbbGVuXSA9IGFyZ3VtZW50c1tsZW5dOwogIH0KCiAgcmV0dXJuIGFyZ3Muc29tZShmdW5jdGlvbiAoZWxlbSkgewogICAgcmV0dXJuIGVsZW0udG9Mb3dlckNhc2UoKSA9PT0gJ2Jvb2xlYW4nOwogIH0pOwp9Ci8qICAqLwoKCmZ1bmN0aW9uIGhhbmRsZUVycm9yKGVyciwgdm0sIGluZm8pIHsKICAvLyBEZWFjdGl2YXRlIGRlcHMgdHJhY2tpbmcgd2hpbGUgcHJvY2Vzc2luZyBlcnJvciBoYW5kbGVyIHRvIGF2b2lkIHBvc3NpYmxlIGluZmluaXRlIHJlbmRlcmluZy4KICAvLyBTZWU6IGh0dHBzOi8vZ2l0aHViLmNvbS92dWVqcy92dWV4L2lzc3Vlcy8xNTA1CiAgcHVzaFRhcmdldCgpOwoKICB0cnkgewogICAgaWYgKHZtKSB7CiAgICAgIHZhciBjdXIgPSB2bTsKCiAgICAgIHdoaWxlIChjdXIgPSBjdXIuJHBhcmVudCkgewogICAgICAgIHZhciBob29rcyA9IGN1ci4kb3B0aW9ucy5lcnJvckNhcHR1cmVkOwoKICAgICAgICBpZiAoaG9va3MpIHsKICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaG9va3MubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICB2YXIgY2FwdHVyZSA9IGhvb2tzW2ldLmNhbGwoY3VyLCBlcnIsIHZtLCBpbmZvKSA9PT0gZmFsc2U7CgogICAgICAgICAgICAgIGlmIChjYXB0dXJlKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgZ2xvYmFsSGFuZGxlRXJyb3IoZSwgY3VyLCAnZXJyb3JDYXB0dXJlZCBob29rJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBnbG9iYWxIYW5kbGVFcnJvcihlcnIsIHZtLCBpbmZvKTsKICB9IGZpbmFsbHkgewogICAgcG9wVGFyZ2V0KCk7CiAgfQp9CgpmdW5jdGlvbiBpbnZva2VXaXRoRXJyb3JIYW5kbGluZyhoYW5kbGVyLCBjb250ZXh0LCBhcmdzLCB2bSwgaW5mbykgewogIHZhciByZXM7CgogIHRyeSB7CiAgICByZXMgPSBhcmdzID8gaGFuZGxlci5hcHBseShjb250ZXh0LCBhcmdzKSA6IGhhbmRsZXIuY2FsbChjb250ZXh0KTsKCiAgICBpZiAocmVzICYmICFyZXMuX2lzVnVlICYmIGlzUHJvbWlzZShyZXMpICYmICFyZXMuX2hhbmRsZWQpIHsKICAgICAgcmVzWyJjYXRjaCJdKGZ1bmN0aW9uIChlKSB7CiAgICAgICAgcmV0dXJuIGhhbmRsZUVycm9yKGUsIHZtLCBpbmZvICsgIiAoUHJvbWlzZS9hc3luYykiKTsKICAgICAgfSk7IC8vIGlzc3VlICM5NTExCiAgICAgIC8vIGF2b2lkIGNhdGNoIHRyaWdnZXJpbmcgbXVsdGlwbGUgdGltZXMgd2hlbiBuZXN0ZWQgY2FsbHMKCiAgICAgIHJlcy5faGFuZGxlZCA9IHRydWU7CiAgICB9CiAgfSBjYXRjaCAoZSkgewogICAgaGFuZGxlRXJyb3IoZSwgdm0sIGluZm8pOwogIH0KCiAgcmV0dXJuIHJlczsKfQoKZnVuY3Rpb24gZ2xvYmFsSGFuZGxlRXJyb3IoZXJyLCB2bSwgaW5mbykgewogIGlmIChjb25maWcuZXJyb3JIYW5kbGVyKSB7CiAgICB0cnkgewogICAgICByZXR1cm4gY29uZmlnLmVycm9ySGFuZGxlci5jYWxsKG51bGwsIGVyciwgdm0sIGluZm8pOwogICAgfSBjYXRjaCAoZSkgewogICAgICAvLyBpZiB0aGUgdXNlciBpbnRlbnRpb25hbGx5IHRocm93cyB0aGUgb3JpZ2luYWwgZXJyb3IgaW4gdGhlIGhhbmRsZXIsCiAgICAgIC8vIGRvIG5vdCBsb2cgaXQgdHdpY2UKICAgICAgaWYgKGUgIT09IGVycikgewogICAgICAgIGxvZ0Vycm9yKGUsIG51bGwsICdjb25maWcuZXJyb3JIYW5kbGVyJyk7CiAgICAgIH0KICAgIH0KICB9CgogIGxvZ0Vycm9yKGVyciwgdm0sIGluZm8pOwp9CgpmdW5jdGlvbiBsb2dFcnJvcihlcnIsIHZtLCBpbmZvKSB7CiAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgIHdhcm4oIkVycm9yIGluICIgKyBpbmZvICsgIjogXCIiICsgZXJyLnRvU3RyaW5nKCkgKyAiXCIiLCB2bSk7CiAgfQogIC8qIGlzdGFuYnVsIGlnbm9yZSBlbHNlICovCgoKICBpZiAoKGluQnJvd3NlciB8fCBpbldlZXgpICYmIHR5cGVvZiBjb25zb2xlICE9PSAndW5kZWZpbmVkJykgewogICAgY29uc29sZS5lcnJvcihlcnIpOwogIH0gZWxzZSB7CiAgICB0aHJvdyBlcnI7CiAgfQp9Ci8qICAqLwoKCnZhciBpc1VzaW5nTWljcm9UYXNrID0gZmFsc2U7CnZhciBjYWxsYmFja3MgPSBbXTsKdmFyIHBlbmRpbmcgPSBmYWxzZTsKCmZ1bmN0aW9uIGZsdXNoQ2FsbGJhY2tzKCkgewogIHBlbmRpbmcgPSBmYWxzZTsKICB2YXIgY29waWVzID0gY2FsbGJhY2tzLnNsaWNlKDApOwogIGNhbGxiYWNrcy5sZW5ndGggPSAwOwoKICBmb3IgKHZhciBpID0gMDsgaSA8IGNvcGllcy5sZW5ndGg7IGkrKykgewogICAgY29waWVzW2ldKCk7CiAgfQp9IC8vIEhlcmUgd2UgaGF2ZSBhc3luYyBkZWZlcnJpbmcgd3JhcHBlcnMgdXNpbmcgbWljcm90YXNrcy4KLy8gSW4gMi41IHdlIHVzZWQgKG1hY3JvKSB0YXNrcyAoaW4gY29tYmluYXRpb24gd2l0aCBtaWNyb3Rhc2tzKS4KLy8gSG93ZXZlciwgaXQgaGFzIHN1YnRsZSBwcm9ibGVtcyB3aGVuIHN0YXRlIGlzIGNoYW5nZWQgcmlnaHQgYmVmb3JlIHJlcGFpbnQKLy8gKGUuZy4gIzY4MTMsIG91dC1pbiB0cmFuc2l0aW9ucykuCi8vIEFsc28sIHVzaW5nIChtYWNybykgdGFza3MgaW4gZXZlbnQgaGFuZGxlciB3b3VsZCBjYXVzZSBzb21lIHdlaXJkIGJlaGF2aW9ycwovLyB0aGF0IGNhbm5vdCBiZSBjaXJjdW12ZW50ZWQgKGUuZy4gIzcxMDksICM3MTUzLCAjNzU0NiwgIzc4MzQsICM4MTA5KS4KLy8gU28gd2Ugbm93IHVzZSBtaWNyb3Rhc2tzIGV2ZXJ5d2hlcmUsIGFnYWluLgovLyBBIG1ham9yIGRyYXdiYWNrIG9mIHRoaXMgdHJhZGVvZmYgaXMgdGhhdCB0aGVyZSBhcmUgc29tZSBzY2VuYXJpb3MKLy8gd2hlcmUgbWljcm90YXNrcyBoYXZlIHRvbyBoaWdoIGEgcHJpb3JpdHkgYW5kIGZpcmUgaW4gYmV0d2VlbiBzdXBwb3NlZGx5Ci8vIHNlcXVlbnRpYWwgZXZlbnRzIChlLmcuICM0NTIxLCAjNjY5MCwgd2hpY2ggaGF2ZSB3b3JrYXJvdW5kcykKLy8gb3IgZXZlbiBiZXR3ZWVuIGJ1YmJsaW5nIG9mIHRoZSBzYW1lIGV2ZW50ICgjNjU2NikuCgoKdmFyIHRpbWVyRnVuYzsgLy8gVGhlIG5leHRUaWNrIGJlaGF2aW9yIGxldmVyYWdlcyB0aGUgbWljcm90YXNrIHF1ZXVlLCB3aGljaCBjYW4gYmUgYWNjZXNzZWQKLy8gdmlhIGVpdGhlciBuYXRpdmUgUHJvbWlzZS50aGVuIG9yIE11dGF0aW9uT2JzZXJ2ZXIuCi8vIE11dGF0aW9uT2JzZXJ2ZXIgaGFzIHdpZGVyIHN1cHBvcnQsIGhvd2V2ZXIgaXQgaXMgc2VyaW91c2x5IGJ1Z2dlZCBpbgovLyBVSVdlYlZpZXcgaW4gaU9TID49IDkuMy4zIHdoZW4gdHJpZ2dlcmVkIGluIHRvdWNoIGV2ZW50IGhhbmRsZXJzLiBJdAovLyBjb21wbGV0ZWx5IHN0b3BzIHdvcmtpbmcgYWZ0ZXIgdHJpZ2dlcmluZyBhIGZldyB0aW1lcy4uLiBzbywgaWYgbmF0aXZlCi8vIFByb21pc2UgaXMgYXZhaWxhYmxlLCB3ZSB3aWxsIHVzZSBpdDoKCi8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0LCAkZmxvdy1kaXNhYmxlLWxpbmUgKi8KCmlmICh0eXBlb2YgUHJvbWlzZSAhPT0gJ3VuZGVmaW5lZCcgJiYgaXNOYXRpdmUoUHJvbWlzZSkpIHsKICB2YXIgcCA9IFByb21pc2UucmVzb2x2ZSgpOwoKICB0aW1lckZ1bmMgPSBmdW5jdGlvbiB0aW1lckZ1bmMoKSB7CiAgICBwLnRoZW4oZmx1c2hDYWxsYmFja3MpOyAvLyBJbiBwcm9ibGVtYXRpYyBVSVdlYlZpZXdzLCBQcm9taXNlLnRoZW4gZG9lc24ndCBjb21wbGV0ZWx5IGJyZWFrLCBidXQKICAgIC8vIGl0IGNhbiBnZXQgc3R1Y2sgaW4gYSB3ZWlyZCBzdGF0ZSB3aGVyZSBjYWxsYmFja3MgYXJlIHB1c2hlZCBpbnRvIHRoZQogICAgLy8gbWljcm90YXNrIHF1ZXVlIGJ1dCB0aGUgcXVldWUgaXNuJ3QgYmVpbmcgZmx1c2hlZCwgdW50aWwgdGhlIGJyb3dzZXIKICAgIC8vIG5lZWRzIHRvIGRvIHNvbWUgb3RoZXIgd29yaywgZS5nLiBoYW5kbGUgYSB0aW1lci4gVGhlcmVmb3JlIHdlIGNhbgogICAgLy8gImZvcmNlIiB0aGUgbWljcm90YXNrIHF1ZXVlIHRvIGJlIGZsdXNoZWQgYnkgYWRkaW5nIGFuIGVtcHR5IHRpbWVyLgoKICAgIGlmIChpc0lPUykgewogICAgICBzZXRUaW1lb3V0KG5vb3ApOwogICAgfQogIH07CgogIGlzVXNpbmdNaWNyb1Rhc2sgPSB0cnVlOwp9IGVsc2UgaWYgKCFpc0lFICYmIHR5cGVvZiBNdXRhdGlvbk9ic2VydmVyICE9PSAndW5kZWZpbmVkJyAmJiAoaXNOYXRpdmUoTXV0YXRpb25PYnNlcnZlcikgfHwgLy8gUGhhbnRvbUpTIGFuZCBpT1MgNy54Ck11dGF0aW9uT2JzZXJ2ZXIudG9TdHJpbmcoKSA9PT0gJ1tvYmplY3QgTXV0YXRpb25PYnNlcnZlckNvbnN0cnVjdG9yXScpKSB7CiAgLy8gVXNlIE11dGF0aW9uT2JzZXJ2ZXIgd2hlcmUgbmF0aXZlIFByb21pc2UgaXMgbm90IGF2YWlsYWJsZSwKICAvLyBlLmcuIFBoYW50b21KUywgaU9TNywgQW5kcm9pZCA0LjQKICAvLyAoIzY0NjYgTXV0YXRpb25PYnNlcnZlciBpcyB1bnJlbGlhYmxlIGluIElFMTEpCiAgdmFyIGNvdW50ZXIgPSAxOwogIHZhciBvYnNlcnZlciA9IG5ldyBNdXRhdGlvbk9ic2VydmVyKGZsdXNoQ2FsbGJhY2tzKTsKICB2YXIgdGV4dE5vZGUgPSBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShTdHJpbmcoY291bnRlcikpOwogIG9ic2VydmVyLm9ic2VydmUodGV4dE5vZGUsIHsKICAgIGNoYXJhY3RlckRhdGE6IHRydWUKICB9KTsKCiAgdGltZXJGdW5jID0gZnVuY3Rpb24gdGltZXJGdW5jKCkgewogICAgY291bnRlciA9IChjb3VudGVyICsgMSkgJSAyOwogICAgdGV4dE5vZGUuZGF0YSA9IFN0cmluZyhjb3VudGVyKTsKICB9OwoKICBpc1VzaW5nTWljcm9UYXNrID0gdHJ1ZTsKfSBlbHNlIGlmICh0eXBlb2Ygc2V0SW1tZWRpYXRlICE9PSAndW5kZWZpbmVkJyAmJiBpc05hdGl2ZShzZXRJbW1lZGlhdGUpKSB7CiAgLy8gRmFsbGJhY2sgdG8gc2V0SW1tZWRpYXRlLgogIC8vIFRlY2hpbmljYWxseSBpdCBsZXZlcmFnZXMgdGhlIChtYWNybykgdGFzayBxdWV1ZSwKICAvLyBidXQgaXQgaXMgc3RpbGwgYSBiZXR0ZXIgY2hvaWNlIHRoYW4gc2V0VGltZW91dC4KICB0aW1lckZ1bmMgPSBmdW5jdGlvbiB0aW1lckZ1bmMoKSB7CiAgICBzZXRJbW1lZGlhdGUoZmx1c2hDYWxsYmFja3MpOwogIH07Cn0gZWxzZSB7CiAgLy8gRmFsbGJhY2sgdG8gc2V0VGltZW91dC4KICB0aW1lckZ1bmMgPSBmdW5jdGlvbiB0aW1lckZ1bmMoKSB7CiAgICBzZXRUaW1lb3V0KGZsdXNoQ2FsbGJhY2tzLCAwKTsKICB9Owp9CgpmdW5jdGlvbiBuZXh0VGljayhjYiwgY3R4KSB7CiAgdmFyIF9yZXNvbHZlOwoKICBjYWxsYmFja3MucHVzaChmdW5jdGlvbiAoKSB7CiAgICBpZiAoY2IpIHsKICAgICAgdHJ5IHsKICAgICAgICBjYi5jYWxsKGN0eCk7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBoYW5kbGVFcnJvcihlLCBjdHgsICduZXh0VGljaycpOwogICAgICB9CiAgICB9IGVsc2UgaWYgKF9yZXNvbHZlKSB7CiAgICAgIF9yZXNvbHZlKGN0eCk7CiAgICB9CiAgfSk7CgogIGlmICghcGVuZGluZykgewogICAgcGVuZGluZyA9IHRydWU7CiAgICB0aW1lckZ1bmMoKTsKICB9IC8vICRmbG93LWRpc2FibGUtbGluZQoKCiAgaWYgKCFjYiAmJiB0eXBlb2YgUHJvbWlzZSAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSkgewogICAgICBfcmVzb2x2ZSA9IHJlc29sdmU7CiAgICB9KTsKICB9Cn0KLyogICovCgovKiBub3QgdHlwZSBjaGVja2luZyB0aGlzIGZpbGUgYmVjYXVzZSBmbG93IGRvZXNuJ3QgcGxheSB3ZWxsIHdpdGggUHJveHkgKi8KCgp2YXIgaW5pdFByb3h5OwoKaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICB2YXIgYWxsb3dlZEdsb2JhbHMgPSBtYWtlTWFwKCdJbmZpbml0eSx1bmRlZmluZWQsTmFOLGlzRmluaXRlLGlzTmFOLCcgKyAncGFyc2VGbG9hdCxwYXJzZUludCxkZWNvZGVVUkksZGVjb2RlVVJJQ29tcG9uZW50LGVuY29kZVVSSSxlbmNvZGVVUklDb21wb25lbnQsJyArICdNYXRoLE51bWJlcixEYXRlLEFycmF5LE9iamVjdCxCb29sZWFuLFN0cmluZyxSZWdFeHAsTWFwLFNldCxKU09OLEludGwsJyArICdyZXF1aXJlJyAvLyBmb3IgV2VicGFjay9Ccm93c2VyaWZ5CiAgKTsKCiAgdmFyIHdhcm5Ob25QcmVzZW50ID0gZnVuY3Rpb24gd2Fybk5vblByZXNlbnQodGFyZ2V0LCBrZXkpIHsKICAgIHdhcm4oIlByb3BlcnR5IG9yIG1ldGhvZCBcIiIgKyBrZXkgKyAiXCIgaXMgbm90IGRlZmluZWQgb24gdGhlIGluc3RhbmNlIGJ1dCAiICsgJ3JlZmVyZW5jZWQgZHVyaW5nIHJlbmRlci4gTWFrZSBzdXJlIHRoYXQgdGhpcyBwcm9wZXJ0eSBpcyByZWFjdGl2ZSwgJyArICdlaXRoZXIgaW4gdGhlIGRhdGEgb3B0aW9uLCBvciBmb3IgY2xhc3MtYmFzZWQgY29tcG9uZW50cywgYnkgJyArICdpbml0aWFsaXppbmcgdGhlIHByb3BlcnR5LiAnICsgJ1NlZTogaHR0cHM6Ly92dWVqcy5vcmcvdjIvZ3VpZGUvcmVhY3Rpdml0eS5odG1sI0RlY2xhcmluZy1SZWFjdGl2ZS1Qcm9wZXJ0aWVzLicsIHRhcmdldCk7CiAgfTsKCiAgdmFyIHdhcm5SZXNlcnZlZFByZWZpeCA9IGZ1bmN0aW9uIHdhcm5SZXNlcnZlZFByZWZpeCh0YXJnZXQsIGtleSkgewogICAgd2FybigiUHJvcGVydHkgXCIiICsga2V5ICsgIlwiIG11c3QgYmUgYWNjZXNzZWQgd2l0aCBcIiRkYXRhLiIgKyBrZXkgKyAiXCIgYmVjYXVzZSAiICsgJ3Byb3BlcnRpZXMgc3RhcnRpbmcgd2l0aCAiJCIgb3IgIl8iIGFyZSBub3QgcHJveGllZCBpbiB0aGUgVnVlIGluc3RhbmNlIHRvICcgKyAncHJldmVudCBjb25mbGljdHMgd2l0aCBWdWUgaW50ZXJuYWxzJyArICdTZWU6IGh0dHBzOi8vdnVlanMub3JnL3YyL2FwaS8jZGF0YScsIHRhcmdldCk7CiAgfTsKCiAgdmFyIGhhc1Byb3h5ID0gdHlwZW9mIFByb3h5ICE9PSAndW5kZWZpbmVkJyAmJiBpc05hdGl2ZShQcm94eSk7CgogIGlmIChoYXNQcm94eSkgewogICAgdmFyIGlzQnVpbHRJbk1vZGlmaWVyID0gbWFrZU1hcCgnc3RvcCxwcmV2ZW50LHNlbGYsY3RybCxzaGlmdCxhbHQsbWV0YSxleGFjdCcpOwogICAgY29uZmlnLmtleUNvZGVzID0gbmV3IFByb3h5KGNvbmZpZy5rZXlDb2RlcywgewogICAgICBzZXQ6IGZ1bmN0aW9uIHNldCh0YXJnZXQsIGtleSwgdmFsdWUpIHsKICAgICAgICBpZiAoaXNCdWlsdEluTW9kaWZpZXIoa2V5KSkgewogICAgICAgICAgd2FybigiQXZvaWQgb3ZlcndyaXRpbmcgYnVpbHQtaW4gbW9kaWZpZXIgaW4gY29uZmlnLmtleUNvZGVzOiAuIiArIGtleSk7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRhcmdldFtrZXldID0gdmFsdWU7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogIH0KCiAgdmFyIGhhc0hhbmRsZXIgPSB7CiAgICBoYXM6IGZ1bmN0aW9uIGhhcyh0YXJnZXQsIGtleSkgewogICAgICB2YXIgaGFzID0ga2V5IGluIHRhcmdldDsKICAgICAgdmFyIGlzQWxsb3dlZCA9IGFsbG93ZWRHbG9iYWxzKGtleSkgfHwgdHlwZW9mIGtleSA9PT0gJ3N0cmluZycgJiYga2V5LmNoYXJBdCgwKSA9PT0gJ18nICYmICEoa2V5IGluIHRhcmdldC4kZGF0YSk7CgogICAgICBpZiAoIWhhcyAmJiAhaXNBbGxvd2VkKSB7CiAgICAgICAgaWYgKGtleSBpbiB0YXJnZXQuJGRhdGEpIHsKICAgICAgICAgIHdhcm5SZXNlcnZlZFByZWZpeCh0YXJnZXQsIGtleSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHdhcm5Ob25QcmVzZW50KHRhcmdldCwga2V5KTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiBoYXMgfHwgIWlzQWxsb3dlZDsKICAgIH0KICB9OwogIHZhciBnZXRIYW5kbGVyID0gewogICAgZ2V0OiBmdW5jdGlvbiBnZXQodGFyZ2V0LCBrZXkpIHsKICAgICAgaWYgKHR5cGVvZiBrZXkgPT09ICdzdHJpbmcnICYmICEoa2V5IGluIHRhcmdldCkpIHsKICAgICAgICBpZiAoa2V5IGluIHRhcmdldC4kZGF0YSkgewogICAgICAgICAgd2FyblJlc2VydmVkUHJlZml4KHRhcmdldCwga2V5KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgd2Fybk5vblByZXNlbnQodGFyZ2V0LCBrZXkpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIHRhcmdldFtrZXldOwogICAgfQogIH07CgogIGluaXRQcm94eSA9IGZ1bmN0aW9uIGluaXRQcm94eSh2bSkgewogICAgaWYgKGhhc1Byb3h5KSB7CiAgICAgIC8vIGRldGVybWluZSB3aGljaCBwcm94eSBoYW5kbGVyIHRvIHVzZQogICAgICB2YXIgb3B0aW9ucyA9IHZtLiRvcHRpb25zOwogICAgICB2YXIgaGFuZGxlcnMgPSBvcHRpb25zLnJlbmRlciAmJiBvcHRpb25zLnJlbmRlci5fd2l0aFN0cmlwcGVkID8gZ2V0SGFuZGxlciA6IGhhc0hhbmRsZXI7CiAgICAgIHZtLl9yZW5kZXJQcm94eSA9IG5ldyBQcm94eSh2bSwgaGFuZGxlcnMpOwogICAgfSBlbHNlIHsKICAgICAgdm0uX3JlbmRlclByb3h5ID0gdm07CiAgICB9CiAgfTsKfQovKiAgKi8KCgp2YXIgc2Vlbk9iamVjdHMgPSBuZXcgX1NldCgpOwovKioKICogUmVjdXJzaXZlbHkgdHJhdmVyc2UgYW4gb2JqZWN0IHRvIGV2b2tlIGFsbCBjb252ZXJ0ZWQKICogZ2V0dGVycywgc28gdGhhdCBldmVyeSBuZXN0ZWQgcHJvcGVydHkgaW5zaWRlIHRoZSBvYmplY3QKICogaXMgY29sbGVjdGVkIGFzIGEgImRlZXAiIGRlcGVuZGVuY3kuCiAqLwoKZnVuY3Rpb24gdHJhdmVyc2UodmFsKSB7CiAgX3RyYXZlcnNlKHZhbCwgc2Vlbk9iamVjdHMpOwoKICBzZWVuT2JqZWN0cy5jbGVhcigpOwp9CgpmdW5jdGlvbiBfdHJhdmVyc2UodmFsLCBzZWVuKSB7CiAgdmFyIGksIGtleXM7CiAgdmFyIGlzQSA9IEFycmF5LmlzQXJyYXkodmFsKTsKCiAgaWYgKCFpc0EgJiYgIWlzT2JqZWN0KHZhbCkgfHwgT2JqZWN0LmlzRnJvemVuKHZhbCkgfHwgdmFsIGluc3RhbmNlb2YgVk5vZGUpIHsKICAgIHJldHVybjsKICB9CgogIGlmICh2YWwuX19vYl9fKSB7CiAgICB2YXIgZGVwSWQgPSB2YWwuX19vYl9fLmRlcC5pZDsKCiAgICBpZiAoc2Vlbi5oYXMoZGVwSWQpKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBzZWVuLmFkZChkZXBJZCk7CiAgfQoKICBpZiAoaXNBKSB7CiAgICBpID0gdmFsLmxlbmd0aDsKCiAgICB3aGlsZSAoaS0tKSB7CiAgICAgIF90cmF2ZXJzZSh2YWxbaV0sIHNlZW4pOwogICAgfQogIH0gZWxzZSB7CiAgICBrZXlzID0gT2JqZWN0LmtleXModmFsKTsKICAgIGkgPSBrZXlzLmxlbmd0aDsKCiAgICB3aGlsZSAoaS0tKSB7CiAgICAgIF90cmF2ZXJzZSh2YWxba2V5c1tpXV0sIHNlZW4pOwogICAgfQogIH0KfQoKdmFyIG1hcms7CnZhciBtZWFzdXJlOwoKaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICB2YXIgcGVyZiA9IGluQnJvd3NlciAmJiB3aW5kb3cucGVyZm9ybWFuY2U7CiAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCgogIGlmIChwZXJmICYmIHBlcmYubWFyayAmJiBwZXJmLm1lYXN1cmUgJiYgcGVyZi5jbGVhck1hcmtzICYmIHBlcmYuY2xlYXJNZWFzdXJlcykgewogICAgbWFyayA9IGZ1bmN0aW9uIG1hcmsodGFnKSB7CiAgICAgIHJldHVybiBwZXJmLm1hcmsodGFnKTsKICAgIH07CgogICAgbWVhc3VyZSA9IGZ1bmN0aW9uIG1lYXN1cmUobmFtZSwgc3RhcnRUYWcsIGVuZFRhZykgewogICAgICBwZXJmLm1lYXN1cmUobmFtZSwgc3RhcnRUYWcsIGVuZFRhZyk7CiAgICAgIHBlcmYuY2xlYXJNYXJrcyhzdGFydFRhZyk7CiAgICAgIHBlcmYuY2xlYXJNYXJrcyhlbmRUYWcpOyAvLyBwZXJmLmNsZWFyTWVhc3VyZXMobmFtZSkKICAgIH07CiAgfQp9Ci8qICAqLwoKCnZhciBub3JtYWxpemVFdmVudCA9IGNhY2hlZChmdW5jdGlvbiAobmFtZSkgewogIHZhciBwYXNzaXZlID0gbmFtZS5jaGFyQXQoMCkgPT09ICcmJzsKICBuYW1lID0gcGFzc2l2ZSA/IG5hbWUuc2xpY2UoMSkgOiBuYW1lOwogIHZhciBvbmNlJCQxID0gbmFtZS5jaGFyQXQoMCkgPT09ICd+JzsgLy8gUHJlZml4ZWQgbGFzdCwgY2hlY2tlZCBmaXJzdAoKICBuYW1lID0gb25jZSQkMSA/IG5hbWUuc2xpY2UoMSkgOiBuYW1lOwogIHZhciBjYXB0dXJlID0gbmFtZS5jaGFyQXQoMCkgPT09ICchJzsKICBuYW1lID0gY2FwdHVyZSA/IG5hbWUuc2xpY2UoMSkgOiBuYW1lOwogIHJldHVybiB7CiAgICBuYW1lOiBuYW1lLAogICAgb25jZTogb25jZSQkMSwKICAgIGNhcHR1cmU6IGNhcHR1cmUsCiAgICBwYXNzaXZlOiBwYXNzaXZlCiAgfTsKfSk7CgpmdW5jdGlvbiBjcmVhdGVGbkludm9rZXIoZm5zLCB2bSkgewogIGZ1bmN0aW9uIGludm9rZXIoKSB7CiAgICB2YXIgYXJndW1lbnRzJDEgPSBhcmd1bWVudHM7CiAgICB2YXIgZm5zID0gaW52b2tlci5mbnM7CgogICAgaWYgKEFycmF5LmlzQXJyYXkoZm5zKSkgewogICAgICB2YXIgY2xvbmVkID0gZm5zLnNsaWNlKCk7CgogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNsb25lZC5sZW5ndGg7IGkrKykgewogICAgICAgIGludm9rZVdpdGhFcnJvckhhbmRsaW5nKGNsb25lZFtpXSwgbnVsbCwgYXJndW1lbnRzJDEsIHZtLCAidi1vbiBoYW5kbGVyIik7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIC8vIHJldHVybiBoYW5kbGVyIHJldHVybiB2YWx1ZSBmb3Igc2luZ2xlIGhhbmRsZXJzCiAgICAgIHJldHVybiBpbnZva2VXaXRoRXJyb3JIYW5kbGluZyhmbnMsIG51bGwsIGFyZ3VtZW50cywgdm0sICJ2LW9uIGhhbmRsZXIiKTsKICAgIH0KICB9CgogIGludm9rZXIuZm5zID0gZm5zOwogIHJldHVybiBpbnZva2VyOwp9CgpmdW5jdGlvbiB1cGRhdGVMaXN0ZW5lcnMob24sIG9sZE9uLCBhZGQsIHJlbW92ZSQkMSwgY3JlYXRlT25jZUhhbmRsZXIsIHZtKSB7CiAgdmFyIG5hbWUsIGRlZiQkMSwgY3VyLCBvbGQsIGV2ZW50OwoKICBmb3IgKG5hbWUgaW4gb24pIHsKICAgIGRlZiQkMSA9IGN1ciA9IG9uW25hbWVdOwogICAgb2xkID0gb2xkT25bbmFtZV07CiAgICBldmVudCA9IG5vcm1hbGl6ZUV2ZW50KG5hbWUpOwoKICAgIGlmIChpc1VuZGVmKGN1cikpIHsKICAgICAgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiB3YXJuKCJJbnZhbGlkIGhhbmRsZXIgZm9yIGV2ZW50IFwiIiArIGV2ZW50Lm5hbWUgKyAiXCI6IGdvdCAiICsgU3RyaW5nKGN1ciksIHZtKTsKICAgIH0gZWxzZSBpZiAoaXNVbmRlZihvbGQpKSB7CiAgICAgIGlmIChpc1VuZGVmKGN1ci5mbnMpKSB7CiAgICAgICAgY3VyID0gb25bbmFtZV0gPSBjcmVhdGVGbkludm9rZXIoY3VyLCB2bSk7CiAgICAgIH0KCiAgICAgIGlmIChpc1RydWUoZXZlbnQub25jZSkpIHsKICAgICAgICBjdXIgPSBvbltuYW1lXSA9IGNyZWF0ZU9uY2VIYW5kbGVyKGV2ZW50Lm5hbWUsIGN1ciwgZXZlbnQuY2FwdHVyZSk7CiAgICAgIH0KCiAgICAgIGFkZChldmVudC5uYW1lLCBjdXIsIGV2ZW50LmNhcHR1cmUsIGV2ZW50LnBhc3NpdmUsIGV2ZW50LnBhcmFtcyk7CiAgICB9IGVsc2UgaWYgKGN1ciAhPT0gb2xkKSB7CiAgICAgIG9sZC5mbnMgPSBjdXI7CiAgICAgIG9uW25hbWVdID0gb2xkOwogICAgfQogIH0KCiAgZm9yIChuYW1lIGluIG9sZE9uKSB7CiAgICBpZiAoaXNVbmRlZihvbltuYW1lXSkpIHsKICAgICAgZXZlbnQgPSBub3JtYWxpemVFdmVudChuYW1lKTsKICAgICAgcmVtb3ZlJCQxKGV2ZW50Lm5hbWUsIG9sZE9uW25hbWVdLCBldmVudC5jYXB0dXJlKTsKICAgIH0KICB9Cn0KLyogICovCgoKZnVuY3Rpb24gbWVyZ2VWTm9kZUhvb2soZGVmLCBob29rS2V5LCBob29rKSB7CiAgaWYgKGRlZiBpbnN0YW5jZW9mIFZOb2RlKSB7CiAgICBkZWYgPSBkZWYuZGF0YS5ob29rIHx8IChkZWYuZGF0YS5ob29rID0ge30pOwogIH0KCiAgdmFyIGludm9rZXI7CiAgdmFyIG9sZEhvb2sgPSBkZWZbaG9va0tleV07CgogIGZ1bmN0aW9uIHdyYXBwZWRIb29rKCkgewogICAgaG9vay5hcHBseSh0aGlzLCBhcmd1bWVudHMpOyAvLyBpbXBvcnRhbnQ6IHJlbW92ZSBtZXJnZWQgaG9vayB0byBlbnN1cmUgaXQncyBjYWxsZWQgb25seSBvbmNlCiAgICAvLyBhbmQgcHJldmVudCBtZW1vcnkgbGVhawoKICAgIHJlbW92ZShpbnZva2VyLmZucywgd3JhcHBlZEhvb2spOwogIH0KCiAgaWYgKGlzVW5kZWYob2xkSG9vaykpIHsKICAgIC8vIG5vIGV4aXN0aW5nIGhvb2sKICAgIGludm9rZXIgPSBjcmVhdGVGbkludm9rZXIoW3dyYXBwZWRIb29rXSk7CiAgfSBlbHNlIHsKICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogICAgaWYgKGlzRGVmKG9sZEhvb2suZm5zKSAmJiBpc1RydWUob2xkSG9vay5tZXJnZWQpKSB7CiAgICAgIC8vIGFscmVhZHkgYSBtZXJnZWQgaW52b2tlcgogICAgICBpbnZva2VyID0gb2xkSG9vazsKICAgICAgaW52b2tlci5mbnMucHVzaCh3cmFwcGVkSG9vayk7CiAgICB9IGVsc2UgewogICAgICAvLyBleGlzdGluZyBwbGFpbiBob29rCiAgICAgIGludm9rZXIgPSBjcmVhdGVGbkludm9rZXIoW29sZEhvb2ssIHdyYXBwZWRIb29rXSk7CiAgICB9CiAgfQoKICBpbnZva2VyLm1lcmdlZCA9IHRydWU7CiAgZGVmW2hvb2tLZXldID0gaW52b2tlcjsKfQovKiAgKi8KCgpmdW5jdGlvbiBleHRyYWN0UHJvcHNGcm9tVk5vZGVEYXRhKGRhdGEsIEN0b3IsIHRhZykgewogIC8vIHdlIGFyZSBvbmx5IGV4dHJhY3RpbmcgcmF3IHZhbHVlcyBoZXJlLgogIC8vIHZhbGlkYXRpb24gYW5kIGRlZmF1bHQgdmFsdWVzIGFyZSBoYW5kbGVkIGluIHRoZSBjaGlsZAogIC8vIGNvbXBvbmVudCBpdHNlbGYuCiAgdmFyIHByb3BPcHRpb25zID0gQ3Rvci5vcHRpb25zLnByb3BzOwoKICBpZiAoaXNVbmRlZihwcm9wT3B0aW9ucykpIHsKICAgIHJldHVybjsKICB9CgogIHZhciByZXMgPSB7fTsKICB2YXIgYXR0cnMgPSBkYXRhLmF0dHJzOwogIHZhciBwcm9wcyA9IGRhdGEucHJvcHM7CgogIGlmIChpc0RlZihhdHRycykgfHwgaXNEZWYocHJvcHMpKSB7CiAgICBmb3IgKHZhciBrZXkgaW4gcHJvcE9wdGlvbnMpIHsKICAgICAgdmFyIGFsdEtleSA9IGh5cGhlbmF0ZShrZXkpOwoKICAgICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgICAgICB2YXIga2V5SW5Mb3dlckNhc2UgPSBrZXkudG9Mb3dlckNhc2UoKTsKCiAgICAgICAgaWYgKGtleSAhPT0ga2V5SW5Mb3dlckNhc2UgJiYgYXR0cnMgJiYgaGFzT3duKGF0dHJzLCBrZXlJbkxvd2VyQ2FzZSkpIHsKICAgICAgICAgIHRpcCgiUHJvcCBcIiIgKyBrZXlJbkxvd2VyQ2FzZSArICJcIiBpcyBwYXNzZWQgdG8gY29tcG9uZW50ICIgKyBmb3JtYXRDb21wb25lbnROYW1lKHRhZyB8fCBDdG9yKSArICIsIGJ1dCB0aGUgZGVjbGFyZWQgcHJvcCBuYW1lIGlzIiArICIgXCIiICsga2V5ICsgIlwiLiAiICsgIk5vdGUgdGhhdCBIVE1MIGF0dHJpYnV0ZXMgYXJlIGNhc2UtaW5zZW5zaXRpdmUgYW5kIGNhbWVsQ2FzZWQgIiArICJwcm9wcyBuZWVkIHRvIHVzZSB0aGVpciBrZWJhYi1jYXNlIGVxdWl2YWxlbnRzIHdoZW4gdXNpbmcgaW4tRE9NICIgKyAidGVtcGxhdGVzLiBZb3Ugc2hvdWxkIHByb2JhYmx5IHVzZSBcIiIgKyBhbHRLZXkgKyAiXCIgaW5zdGVhZCBvZiBcIiIgKyBrZXkgKyAiXCIuIik7CiAgICAgICAgfQogICAgICB9CgogICAgICBjaGVja1Byb3AocmVzLCBwcm9wcywga2V5LCBhbHRLZXksIHRydWUpIHx8IGNoZWNrUHJvcChyZXMsIGF0dHJzLCBrZXksIGFsdEtleSwgZmFsc2UpOwogICAgfQogIH0KCiAgcmV0dXJuIHJlczsKfQoKZnVuY3Rpb24gY2hlY2tQcm9wKHJlcywgaGFzaCwga2V5LCBhbHRLZXksIHByZXNlcnZlKSB7CiAgaWYgKGlzRGVmKGhhc2gpKSB7CiAgICBpZiAoaGFzT3duKGhhc2gsIGtleSkpIHsKICAgICAgcmVzW2tleV0gPSBoYXNoW2tleV07CgogICAgICBpZiAoIXByZXNlcnZlKSB7CiAgICAgICAgZGVsZXRlIGhhc2hba2V5XTsKICAgICAgfQoKICAgICAgcmV0dXJuIHRydWU7CiAgICB9IGVsc2UgaWYgKGhhc093bihoYXNoLCBhbHRLZXkpKSB7CiAgICAgIHJlc1trZXldID0gaGFzaFthbHRLZXldOwoKICAgICAgaWYgKCFwcmVzZXJ2ZSkgewogICAgICAgIGRlbGV0ZSBoYXNoW2FsdEtleV07CiAgICAgIH0KCiAgICAgIHJldHVybiB0cnVlOwogICAgfQogIH0KCiAgcmV0dXJuIGZhbHNlOwp9Ci8qICAqLwovLyBUaGUgdGVtcGxhdGUgY29tcGlsZXIgYXR0ZW1wdHMgdG8gbWluaW1pemUgdGhlIG5lZWQgZm9yIG5vcm1hbGl6YXRpb24gYnkKLy8gc3RhdGljYWxseSBhbmFseXppbmcgdGhlIHRlbXBsYXRlIGF0IGNvbXBpbGUgdGltZS4KLy8KLy8gRm9yIHBsYWluIEhUTUwgbWFya3VwLCBub3JtYWxpemF0aW9uIGNhbiBiZSBjb21wbGV0ZWx5IHNraXBwZWQgYmVjYXVzZSB0aGUKLy8gZ2VuZXJhdGVkIHJlbmRlciBmdW5jdGlvbiBpcyBndWFyYW50ZWVkIHRvIHJldHVybiBBcnJheTxWTm9kZT4uIFRoZXJlIGFyZQovLyB0d28gY2FzZXMgd2hlcmUgZXh0cmEgbm9ybWFsaXphdGlvbiBpcyBuZWVkZWQ6Ci8vIDEuIFdoZW4gdGhlIGNoaWxkcmVuIGNvbnRhaW5zIGNvbXBvbmVudHMgLSBiZWNhdXNlIGEgZnVuY3Rpb25hbCBjb21wb25lbnQKLy8gbWF5IHJldHVybiBhbiBBcnJheSBpbnN0ZWFkIG9mIGEgc2luZ2xlIHJvb3QuIEluIHRoaXMgY2FzZSwganVzdCBhIHNpbXBsZQovLyBub3JtYWxpemF0aW9uIGlzIG5lZWRlZCAtIGlmIGFueSBjaGlsZCBpcyBhbiBBcnJheSwgd2UgZmxhdHRlbiB0aGUgd2hvbGUKLy8gdGhpbmcgd2l0aCBBcnJheS5wcm90b3R5cGUuY29uY2F0LiBJdCBpcyBndWFyYW50ZWVkIHRvIGJlIG9ubHkgMS1sZXZlbCBkZWVwCi8vIGJlY2F1c2UgZnVuY3Rpb25hbCBjb21wb25lbnRzIGFscmVhZHkgbm9ybWFsaXplIHRoZWlyIG93biBjaGlsZHJlbi4KCgpmdW5jdGlvbiBzaW1wbGVOb3JtYWxpemVDaGlsZHJlbihjaGlsZHJlbikgewogIGZvciAodmFyIGkgPSAwOyBpIDwgY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgIGlmIChBcnJheS5pc0FycmF5KGNoaWxkcmVuW2ldKSkgewogICAgICByZXR1cm4gQXJyYXkucHJvdG90eXBlLmNvbmNhdC5hcHBseShbXSwgY2hpbGRyZW4pOwogICAgfQogIH0KCiAgcmV0dXJuIGNoaWxkcmVuOwp9IC8vIDIuIFdoZW4gdGhlIGNoaWxkcmVuIGNvbnRhaW5zIGNvbnN0cnVjdHMgdGhhdCBhbHdheXMgZ2VuZXJhdGVkIG5lc3RlZCBBcnJheXMsCi8vIGUuZy4gPHRlbXBsYXRlPiwgPHNsb3Q+LCB2LWZvciwgb3Igd2hlbiB0aGUgY2hpbGRyZW4gaXMgcHJvdmlkZWQgYnkgdXNlcgovLyB3aXRoIGhhbmQtd3JpdHRlbiByZW5kZXIgZnVuY3Rpb25zIC8gSlNYLiBJbiBzdWNoIGNhc2VzIGEgZnVsbCBub3JtYWxpemF0aW9uCi8vIGlzIG5lZWRlZCB0byBjYXRlciB0byBhbGwgcG9zc2libGUgdHlwZXMgb2YgY2hpbGRyZW4gdmFsdWVzLgoKCmZ1bmN0aW9uIG5vcm1hbGl6ZUNoaWxkcmVuKGNoaWxkcmVuKSB7CiAgcmV0dXJuIGlzUHJpbWl0aXZlKGNoaWxkcmVuKSA/IFtjcmVhdGVUZXh0Vk5vZGUoY2hpbGRyZW4pXSA6IEFycmF5LmlzQXJyYXkoY2hpbGRyZW4pID8gbm9ybWFsaXplQXJyYXlDaGlsZHJlbihjaGlsZHJlbikgOiB1bmRlZmluZWQ7Cn0KCmZ1bmN0aW9uIGlzVGV4dE5vZGUobm9kZSkgewogIHJldHVybiBpc0RlZihub2RlKSAmJiBpc0RlZihub2RlLnRleHQpICYmIGlzRmFsc2Uobm9kZS5pc0NvbW1lbnQpOwp9CgpmdW5jdGlvbiBub3JtYWxpemVBcnJheUNoaWxkcmVuKGNoaWxkcmVuLCBuZXN0ZWRJbmRleCkgewogIHZhciByZXMgPSBbXTsKICB2YXIgaSwgYywgbGFzdEluZGV4LCBsYXN0OwoKICBmb3IgKGkgPSAwOyBpIDwgY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgIGMgPSBjaGlsZHJlbltpXTsKCiAgICBpZiAoaXNVbmRlZihjKSB8fCB0eXBlb2YgYyA9PT0gJ2Jvb2xlYW4nKSB7CiAgICAgIGNvbnRpbnVlOwogICAgfQoKICAgIGxhc3RJbmRleCA9IHJlcy5sZW5ndGggLSAxOwogICAgbGFzdCA9IHJlc1tsYXN0SW5kZXhdOyAvLyAgbmVzdGVkCgogICAgaWYgKEFycmF5LmlzQXJyYXkoYykpIHsKICAgICAgaWYgKGMubGVuZ3RoID4gMCkgewogICAgICAgIGMgPSBub3JtYWxpemVBcnJheUNoaWxkcmVuKGMsIChuZXN0ZWRJbmRleCB8fCAnJykgKyAiXyIgKyBpKTsgLy8gbWVyZ2UgYWRqYWNlbnQgdGV4dCBub2RlcwoKICAgICAgICBpZiAoaXNUZXh0Tm9kZShjWzBdKSAmJiBpc1RleHROb2RlKGxhc3QpKSB7CiAgICAgICAgICByZXNbbGFzdEluZGV4XSA9IGNyZWF0ZVRleHRWTm9kZShsYXN0LnRleHQgKyBjWzBdLnRleHQpOwogICAgICAgICAgYy5zaGlmdCgpOwogICAgICAgIH0KCiAgICAgICAgcmVzLnB1c2guYXBwbHkocmVzLCBjKTsKICAgICAgfQogICAgfSBlbHNlIGlmIChpc1ByaW1pdGl2ZShjKSkgewogICAgICBpZiAoaXNUZXh0Tm9kZShsYXN0KSkgewogICAgICAgIC8vIG1lcmdlIGFkamFjZW50IHRleHQgbm9kZXMKICAgICAgICAvLyB0aGlzIGlzIG5lY2Vzc2FyeSBmb3IgU1NSIGh5ZHJhdGlvbiBiZWNhdXNlIHRleHQgbm9kZXMgYXJlCiAgICAgICAgLy8gZXNzZW50aWFsbHkgbWVyZ2VkIHdoZW4gcmVuZGVyZWQgdG8gSFRNTCBzdHJpbmdzCiAgICAgICAgcmVzW2xhc3RJbmRleF0gPSBjcmVhdGVUZXh0Vk5vZGUobGFzdC50ZXh0ICsgYyk7CiAgICAgIH0gZWxzZSBpZiAoYyAhPT0gJycpIHsKICAgICAgICAvLyBjb252ZXJ0IHByaW1pdGl2ZSB0byB2bm9kZQogICAgICAgIHJlcy5wdXNoKGNyZWF0ZVRleHRWTm9kZShjKSk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGlmIChpc1RleHROb2RlKGMpICYmIGlzVGV4dE5vZGUobGFzdCkpIHsKICAgICAgICAvLyBtZXJnZSBhZGphY2VudCB0ZXh0IG5vZGVzCiAgICAgICAgcmVzW2xhc3RJbmRleF0gPSBjcmVhdGVUZXh0Vk5vZGUobGFzdC50ZXh0ICsgYy50ZXh0KTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBkZWZhdWx0IGtleSBmb3IgbmVzdGVkIGFycmF5IGNoaWxkcmVuIChsaWtlbHkgZ2VuZXJhdGVkIGJ5IHYtZm9yKQogICAgICAgIGlmIChpc1RydWUoY2hpbGRyZW4uX2lzVkxpc3QpICYmIGlzRGVmKGMudGFnKSAmJiBpc1VuZGVmKGMua2V5KSAmJiBpc0RlZihuZXN0ZWRJbmRleCkpIHsKICAgICAgICAgIGMua2V5ID0gIl9fdmxpc3QiICsgbmVzdGVkSW5kZXggKyAiXyIgKyBpICsgIl9fIjsKICAgICAgICB9CgogICAgICAgIHJlcy5wdXNoKGMpOwogICAgICB9CiAgICB9CiAgfQoKICByZXR1cm4gcmVzOwp9Ci8qICAqLwoKCmZ1bmN0aW9uIGluaXRQcm92aWRlKHZtKSB7CiAgdmFyIHByb3ZpZGUgPSB2bS4kb3B0aW9ucy5wcm92aWRlOwoKICBpZiAocHJvdmlkZSkgewogICAgdm0uX3Byb3ZpZGVkID0gdHlwZW9mIHByb3ZpZGUgPT09ICdmdW5jdGlvbicgPyBwcm92aWRlLmNhbGwodm0pIDogcHJvdmlkZTsKICB9Cn0KCmZ1bmN0aW9uIGluaXRJbmplY3Rpb25zKHZtKSB7CiAgdmFyIHJlc3VsdCA9IHJlc29sdmVJbmplY3Qodm0uJG9wdGlvbnMuaW5qZWN0LCB2bSk7CgogIGlmIChyZXN1bHQpIHsKICAgIHRvZ2dsZU9ic2VydmluZyhmYWxzZSk7CiAgICBPYmplY3Qua2V5cyhyZXN1bHQpLmZvckVhY2goZnVuY3Rpb24gKGtleSkgewogICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgZWxzZSAqLwogICAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgICAgIGRlZmluZVJlYWN0aXZlJCQxKHZtLCBrZXksIHJlc3VsdFtrZXldLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICB3YXJuKCJBdm9pZCBtdXRhdGluZyBhbiBpbmplY3RlZCB2YWx1ZSBkaXJlY3RseSBzaW5jZSB0aGUgY2hhbmdlcyB3aWxsIGJlICIgKyAib3ZlcndyaXR0ZW4gd2hlbmV2ZXIgdGhlIHByb3ZpZGVkIGNvbXBvbmVudCByZS1yZW5kZXJzLiAiICsgImluamVjdGlvbiBiZWluZyBtdXRhdGVkOiBcIiIgKyBrZXkgKyAiXCIiLCB2bSk7CiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZGVmaW5lUmVhY3RpdmUkJDEodm0sIGtleSwgcmVzdWx0W2tleV0pOwogICAgICB9CiAgICB9KTsKICAgIHRvZ2dsZU9ic2VydmluZyh0cnVlKTsKICB9Cn0KCmZ1bmN0aW9uIHJlc29sdmVJbmplY3QoaW5qZWN0LCB2bSkgewogIGlmIChpbmplY3QpIHsKICAgIC8vIGluamVjdCBpcyA6YW55IGJlY2F1c2UgZmxvdyBpcyBub3Qgc21hcnQgZW5vdWdoIHRvIGZpZ3VyZSBvdXQgY2FjaGVkCiAgICB2YXIgcmVzdWx0ID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgIHZhciBrZXlzID0gaGFzU3ltYm9sID8gUmVmbGVjdC5vd25LZXlzKGluamVjdCkgOiBPYmplY3Qua2V5cyhpbmplY3QpOwoKICAgIGZvciAodmFyIGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykgewogICAgICB2YXIga2V5ID0ga2V5c1tpXTsgLy8gIzY1NzQgaW4gY2FzZSB0aGUgaW5qZWN0IG9iamVjdCBpcyBvYnNlcnZlZC4uLgoKICAgICAgaWYgKGtleSA9PT0gJ19fb2JfXycpIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQoKICAgICAgdmFyIHByb3ZpZGVLZXkgPSBpbmplY3Rba2V5XS5mcm9tOwogICAgICB2YXIgc291cmNlID0gdm07CgogICAgICB3aGlsZSAoc291cmNlKSB7CiAgICAgICAgaWYgKHNvdXJjZS5fcHJvdmlkZWQgJiYgaGFzT3duKHNvdXJjZS5fcHJvdmlkZWQsIHByb3ZpZGVLZXkpKSB7CiAgICAgICAgICByZXN1bHRba2V5XSA9IHNvdXJjZS5fcHJvdmlkZWRbcHJvdmlkZUtleV07CiAgICAgICAgICBicmVhazsKICAgICAgICB9CgogICAgICAgIHNvdXJjZSA9IHNvdXJjZS4kcGFyZW50OwogICAgICB9CgogICAgICBpZiAoIXNvdXJjZSkgewogICAgICAgIGlmICgnZGVmYXVsdCcgaW4gaW5qZWN0W2tleV0pIHsKICAgICAgICAgIHZhciBwcm92aWRlRGVmYXVsdCA9IGluamVjdFtrZXldWyJkZWZhdWx0Il07CiAgICAgICAgICByZXN1bHRba2V5XSA9IHR5cGVvZiBwcm92aWRlRGVmYXVsdCA9PT0gJ2Z1bmN0aW9uJyA/IHByb3ZpZGVEZWZhdWx0LmNhbGwodm0pIDogcHJvdmlkZURlZmF1bHQ7CiAgICAgICAgfSBlbHNlIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICAgICAgICB3YXJuKCJJbmplY3Rpb24gXCIiICsga2V5ICsgIlwiIG5vdCBmb3VuZCIsIHZtKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gcmVzdWx0OwogIH0KfQovKiAgKi8KCi8qKgogKiBSdW50aW1lIGhlbHBlciBmb3IgcmVzb2x2aW5nIHJhdyBjaGlsZHJlbiBWTm9kZXMgaW50byBhIHNsb3Qgb2JqZWN0LgogKi8KCgpmdW5jdGlvbiByZXNvbHZlU2xvdHMoY2hpbGRyZW4sIGNvbnRleHQpIHsKICBpZiAoIWNoaWxkcmVuIHx8ICFjaGlsZHJlbi5sZW5ndGgpIHsKICAgIHJldHVybiB7fTsKICB9CgogIHZhciBzbG90cyA9IHt9OwoKICBmb3IgKHZhciBpID0gMCwgbCA9IGNoaWxkcmVuLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgdmFyIGNoaWxkID0gY2hpbGRyZW5baV07CiAgICB2YXIgZGF0YSA9IGNoaWxkLmRhdGE7IC8vIHJlbW92ZSBzbG90IGF0dHJpYnV0ZSBpZiB0aGUgbm9kZSBpcyByZXNvbHZlZCBhcyBhIFZ1ZSBzbG90IG5vZGUKCiAgICBpZiAoZGF0YSAmJiBkYXRhLmF0dHJzICYmIGRhdGEuYXR0cnMuc2xvdCkgewogICAgICBkZWxldGUgZGF0YS5hdHRycy5zbG90OwogICAgfSAvLyBuYW1lZCBzbG90cyBzaG91bGQgb25seSBiZSByZXNwZWN0ZWQgaWYgdGhlIHZub2RlIHdhcyByZW5kZXJlZCBpbiB0aGUKICAgIC8vIHNhbWUgY29udGV4dC4KCgogICAgaWYgKChjaGlsZC5jb250ZXh0ID09PSBjb250ZXh0IHx8IGNoaWxkLmZuQ29udGV4dCA9PT0gY29udGV4dCkgJiYgZGF0YSAmJiBkYXRhLnNsb3QgIT0gbnVsbCkgewogICAgICB2YXIgbmFtZSA9IGRhdGEuc2xvdDsKICAgICAgdmFyIHNsb3QgPSBzbG90c1tuYW1lXSB8fCAoc2xvdHNbbmFtZV0gPSBbXSk7CgogICAgICBpZiAoY2hpbGQudGFnID09PSAndGVtcGxhdGUnKSB7CiAgICAgICAgc2xvdC5wdXNoLmFwcGx5KHNsb3QsIGNoaWxkLmNoaWxkcmVuIHx8IFtdKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBzbG90LnB1c2goY2hpbGQpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICAoc2xvdHNbImRlZmF1bHQiXSB8fCAoc2xvdHNbImRlZmF1bHQiXSA9IFtdKSkucHVzaChjaGlsZCk7CiAgICB9CiAgfSAvLyBpZ25vcmUgc2xvdHMgdGhhdCBjb250YWlucyBvbmx5IHdoaXRlc3BhY2UKCgogIGZvciAodmFyIG5hbWUkMSBpbiBzbG90cykgewogICAgaWYgKHNsb3RzW25hbWUkMV0uZXZlcnkoaXNXaGl0ZXNwYWNlKSkgewogICAgICBkZWxldGUgc2xvdHNbbmFtZSQxXTsKICAgIH0KICB9CgogIHJldHVybiBzbG90czsKfQoKZnVuY3Rpb24gaXNXaGl0ZXNwYWNlKG5vZGUpIHsKICByZXR1cm4gbm9kZS5pc0NvbW1lbnQgJiYgIW5vZGUuYXN5bmNGYWN0b3J5IHx8IG5vZGUudGV4dCA9PT0gJyAnOwp9Ci8qICAqLwoKCmZ1bmN0aW9uIG5vcm1hbGl6ZVNjb3BlZFNsb3RzKHNsb3RzLCBub3JtYWxTbG90cywgcHJldlNsb3RzKSB7CiAgdmFyIHJlczsKICB2YXIgaGFzTm9ybWFsU2xvdHMgPSBPYmplY3Qua2V5cyhub3JtYWxTbG90cykubGVuZ3RoID4gMDsKICB2YXIgaXNTdGFibGUgPSBzbG90cyA/ICEhc2xvdHMuJHN0YWJsZSA6ICFoYXNOb3JtYWxTbG90czsKICB2YXIga2V5ID0gc2xvdHMgJiYgc2xvdHMuJGtleTsKCiAgaWYgKCFzbG90cykgewogICAgcmVzID0ge307CiAgfSBlbHNlIGlmIChzbG90cy5fbm9ybWFsaXplZCkgewogICAgLy8gZmFzdCBwYXRoIDE6IGNoaWxkIGNvbXBvbmVudCByZS1yZW5kZXIgb25seSwgcGFyZW50IGRpZCBub3QgY2hhbmdlCiAgICByZXR1cm4gc2xvdHMuX25vcm1hbGl6ZWQ7CiAgfSBlbHNlIGlmIChpc1N0YWJsZSAmJiBwcmV2U2xvdHMgJiYgcHJldlNsb3RzICE9PSBlbXB0eU9iamVjdCAmJiBrZXkgPT09IHByZXZTbG90cy4ka2V5ICYmICFoYXNOb3JtYWxTbG90cyAmJiAhcHJldlNsb3RzLiRoYXNOb3JtYWwpIHsKICAgIC8vIGZhc3QgcGF0aCAyOiBzdGFibGUgc2NvcGVkIHNsb3RzIHcvIG5vIG5vcm1hbCBzbG90cyB0byBwcm94eSwKICAgIC8vIG9ubHkgbmVlZCB0byBub3JtYWxpemUgb25jZQogICAgcmV0dXJuIHByZXZTbG90czsKICB9IGVsc2UgewogICAgcmVzID0ge307CgogICAgZm9yICh2YXIga2V5JDEgaW4gc2xvdHMpIHsKICAgICAgaWYgKHNsb3RzW2tleSQxXSAmJiBrZXkkMVswXSAhPT0gJyQnKSB7CiAgICAgICAgcmVzW2tleSQxXSA9IG5vcm1hbGl6ZVNjb3BlZFNsb3Qobm9ybWFsU2xvdHMsIGtleSQxLCBzbG90c1trZXkkMV0pOwogICAgICB9CiAgICB9CiAgfSAvLyBleHBvc2Ugbm9ybWFsIHNsb3RzIG9uIHNjb3BlZFNsb3RzCgoKICBmb3IgKHZhciBrZXkkMiBpbiBub3JtYWxTbG90cykgewogICAgaWYgKCEoa2V5JDIgaW4gcmVzKSkgewogICAgICByZXNba2V5JDJdID0gcHJveHlOb3JtYWxTbG90KG5vcm1hbFNsb3RzLCBrZXkkMik7CiAgICB9CiAgfSAvLyBhdm9yaWF6IHNlZW1zIHRvIG1vY2sgYSBub24tZXh0ZW5zaWJsZSAkc2NvcGVkU2xvdHMgb2JqZWN0CiAgLy8gYW5kIHdoZW4gdGhhdCBpcyBwYXNzZWQgZG93biB0aGlzIHdvdWxkIGNhdXNlIGFuIGVycm9yCgoKICBpZiAoc2xvdHMgJiYgT2JqZWN0LmlzRXh0ZW5zaWJsZShzbG90cykpIHsKICAgIHNsb3RzLl9ub3JtYWxpemVkID0gcmVzOwogIH0KCiAgZGVmKHJlcywgJyRzdGFibGUnLCBpc1N0YWJsZSk7CiAgZGVmKHJlcywgJyRrZXknLCBrZXkpOwogIGRlZihyZXMsICckaGFzTm9ybWFsJywgaGFzTm9ybWFsU2xvdHMpOwogIHJldHVybiByZXM7Cn0KCmZ1bmN0aW9uIG5vcm1hbGl6ZVNjb3BlZFNsb3Qobm9ybWFsU2xvdHMsIGtleSwgZm4pIHsKICB2YXIgbm9ybWFsaXplZCA9IGZ1bmN0aW9uIG5vcm1hbGl6ZWQoKSB7CiAgICB2YXIgcmVzID0gYXJndW1lbnRzLmxlbmd0aCA/IGZuLmFwcGx5KG51bGwsIGFyZ3VtZW50cykgOiBmbih7fSk7CiAgICByZXMgPSByZXMgJiYgX3R5cGVvZihyZXMpID09PSAnb2JqZWN0JyAmJiAhQXJyYXkuaXNBcnJheShyZXMpID8gW3Jlc10gLy8gc2luZ2xlIHZub2RlCiAgICA6IG5vcm1hbGl6ZUNoaWxkcmVuKHJlcyk7CiAgICByZXR1cm4gcmVzICYmIChyZXMubGVuZ3RoID09PSAwIHx8IHJlcy5sZW5ndGggPT09IDEgJiYgcmVzWzBdLmlzQ29tbWVudCAvLyAjOTY1OAogICAgKSA/IHVuZGVmaW5lZCA6IHJlczsKICB9OyAvLyB0aGlzIGlzIGEgc2xvdCB1c2luZyB0aGUgbmV3IHYtc2xvdCBzeW50YXggd2l0aG91dCBzY29wZS4gYWx0aG91Z2ggaXQgaXMKICAvLyBjb21waWxlZCBhcyBhIHNjb3BlZCBzbG90LCByZW5kZXIgZm4gdXNlcnMgd291bGQgZXhwZWN0IGl0IHRvIGJlIHByZXNlbnQKICAvLyBvbiB0aGlzLiRzbG90cyBiZWNhdXNlIHRoZSB1c2FnZSBpcyBzZW1hbnRpY2FsbHkgYSBub3JtYWwgc2xvdC4KCgogIGlmIChmbi5wcm94eSkgewogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG5vcm1hbFNsb3RzLCBrZXksIHsKICAgICAgZ2V0OiBub3JtYWxpemVkLAogICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICBjb25maWd1cmFibGU6IHRydWUKICAgIH0pOwogIH0KCiAgcmV0dXJuIG5vcm1hbGl6ZWQ7Cn0KCmZ1bmN0aW9uIHByb3h5Tm9ybWFsU2xvdChzbG90cywga2V5KSB7CiAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBzbG90c1trZXldOwogIH07Cn0KLyogICovCgovKioKICogUnVudGltZSBoZWxwZXIgZm9yIHJlbmRlcmluZyB2LWZvciBsaXN0cy4KICovCgoKZnVuY3Rpb24gcmVuZGVyTGlzdCh2YWwsIHJlbmRlcikgewogIHZhciByZXQsIGksIGwsIGtleXMsIGtleTsKCiAgaWYgKEFycmF5LmlzQXJyYXkodmFsKSB8fCB0eXBlb2YgdmFsID09PSAnc3RyaW5nJykgewogICAgcmV0ID0gbmV3IEFycmF5KHZhbC5sZW5ndGgpOwoKICAgIGZvciAoaSA9IDAsIGwgPSB2YWwubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgIHJldFtpXSA9IHJlbmRlcih2YWxbaV0sIGkpOwogICAgfQogIH0gZWxzZSBpZiAodHlwZW9mIHZhbCA9PT0gJ251bWJlcicpIHsKICAgIHJldCA9IG5ldyBBcnJheSh2YWwpOwoKICAgIGZvciAoaSA9IDA7IGkgPCB2YWw7IGkrKykgewogICAgICByZXRbaV0gPSByZW5kZXIoaSArIDEsIGkpOwogICAgfQogIH0gZWxzZSBpZiAoaXNPYmplY3QodmFsKSkgewogICAgaWYgKGhhc1N5bWJvbCAmJiB2YWxbU3ltYm9sLml0ZXJhdG9yXSkgewogICAgICByZXQgPSBbXTsKICAgICAgdmFyIGl0ZXJhdG9yID0gdmFsW1N5bWJvbC5pdGVyYXRvcl0oKTsKICAgICAgdmFyIHJlc3VsdCA9IGl0ZXJhdG9yLm5leHQoKTsKCiAgICAgIHdoaWxlICghcmVzdWx0LmRvbmUpIHsKICAgICAgICByZXQucHVzaChyZW5kZXIocmVzdWx0LnZhbHVlLCByZXQubGVuZ3RoKSk7CiAgICAgICAgcmVzdWx0ID0gaXRlcmF0b3IubmV4dCgpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBrZXlzID0gT2JqZWN0LmtleXModmFsKTsKICAgICAgcmV0ID0gbmV3IEFycmF5KGtleXMubGVuZ3RoKTsKCiAgICAgIGZvciAoaSA9IDAsIGwgPSBrZXlzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIGtleSA9IGtleXNbaV07CiAgICAgICAgcmV0W2ldID0gcmVuZGVyKHZhbFtrZXldLCBrZXksIGkpOwogICAgICB9CiAgICB9CiAgfQoKICBpZiAoIWlzRGVmKHJldCkpIHsKICAgIHJldCA9IFtdOwogIH0KCiAgcmV0Ll9pc1ZMaXN0ID0gdHJ1ZTsKICByZXR1cm4gcmV0Owp9Ci8qICAqLwoKLyoqCiAqIFJ1bnRpbWUgaGVscGVyIGZvciByZW5kZXJpbmcgPHNsb3Q+CiAqLwoKCmZ1bmN0aW9uIHJlbmRlclNsb3QobmFtZSwgZmFsbGJhY2ssIHByb3BzLCBiaW5kT2JqZWN0KSB7CiAgdmFyIHNjb3BlZFNsb3RGbiA9IHRoaXMuJHNjb3BlZFNsb3RzW25hbWVdOwogIHZhciBub2RlczsKCiAgaWYgKHNjb3BlZFNsb3RGbikgewogICAgLy8gc2NvcGVkIHNsb3QKICAgIHByb3BzID0gcHJvcHMgfHwge307CgogICAgaWYgKGJpbmRPYmplY3QpIHsKICAgICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgIWlzT2JqZWN0KGJpbmRPYmplY3QpKSB7CiAgICAgICAgd2Fybignc2xvdCB2LWJpbmQgd2l0aG91dCBhcmd1bWVudCBleHBlY3RzIGFuIE9iamVjdCcsIHRoaXMpOwogICAgICB9CgogICAgICBwcm9wcyA9IGV4dGVuZChleHRlbmQoe30sIGJpbmRPYmplY3QpLCBwcm9wcyk7CiAgICB9CgogICAgbm9kZXMgPSBzY29wZWRTbG90Rm4ocHJvcHMpIHx8IGZhbGxiYWNrOwogIH0gZWxzZSB7CiAgICBub2RlcyA9IHRoaXMuJHNsb3RzW25hbWVdIHx8IGZhbGxiYWNrOwogIH0KCiAgdmFyIHRhcmdldCA9IHByb3BzICYmIHByb3BzLnNsb3Q7CgogIGlmICh0YXJnZXQpIHsKICAgIHJldHVybiB0aGlzLiRjcmVhdGVFbGVtZW50KCd0ZW1wbGF0ZScsIHsKICAgICAgc2xvdDogdGFyZ2V0CiAgICB9LCBub2Rlcyk7CiAgfSBlbHNlIHsKICAgIHJldHVybiBub2RlczsKICB9Cn0KLyogICovCgovKioKICogUnVudGltZSBoZWxwZXIgZm9yIHJlc29sdmluZyBmaWx0ZXJzCiAqLwoKCmZ1bmN0aW9uIHJlc29sdmVGaWx0ZXIoaWQpIHsKICByZXR1cm4gcmVzb2x2ZUFzc2V0KHRoaXMuJG9wdGlvbnMsICdmaWx0ZXJzJywgaWQsIHRydWUpIHx8IGlkZW50aXR5Owp9Ci8qICAqLwoKCmZ1bmN0aW9uIGlzS2V5Tm90TWF0Y2goZXhwZWN0LCBhY3R1YWwpIHsKICBpZiAoQXJyYXkuaXNBcnJheShleHBlY3QpKSB7CiAgICByZXR1cm4gZXhwZWN0LmluZGV4T2YoYWN0dWFsKSA9PT0gLTE7CiAgfSBlbHNlIHsKICAgIHJldHVybiBleHBlY3QgIT09IGFjdHVhbDsKICB9Cn0KLyoqCiAqIFJ1bnRpbWUgaGVscGVyIGZvciBjaGVja2luZyBrZXlDb2RlcyBmcm9tIGNvbmZpZy4KICogZXhwb3NlZCBhcyBWdWUucHJvdG90eXBlLl9rCiAqIHBhc3NpbmcgaW4gZXZlbnRLZXlOYW1lIGFzIGxhc3QgYXJndW1lbnQgc2VwYXJhdGVseSBmb3IgYmFja3dhcmRzIGNvbXBhdAogKi8KCgpmdW5jdGlvbiBjaGVja0tleUNvZGVzKGV2ZW50S2V5Q29kZSwga2V5LCBidWlsdEluS2V5Q29kZSwgZXZlbnRLZXlOYW1lLCBidWlsdEluS2V5TmFtZSkgewogIHZhciBtYXBwZWRLZXlDb2RlID0gY29uZmlnLmtleUNvZGVzW2tleV0gfHwgYnVpbHRJbktleUNvZGU7CgogIGlmIChidWlsdEluS2V5TmFtZSAmJiBldmVudEtleU5hbWUgJiYgIWNvbmZpZy5rZXlDb2Rlc1trZXldKSB7CiAgICByZXR1cm4gaXNLZXlOb3RNYXRjaChidWlsdEluS2V5TmFtZSwgZXZlbnRLZXlOYW1lKTsKICB9IGVsc2UgaWYgKG1hcHBlZEtleUNvZGUpIHsKICAgIHJldHVybiBpc0tleU5vdE1hdGNoKG1hcHBlZEtleUNvZGUsIGV2ZW50S2V5Q29kZSk7CiAgfSBlbHNlIGlmIChldmVudEtleU5hbWUpIHsKICAgIHJldHVybiBoeXBoZW5hdGUoZXZlbnRLZXlOYW1lKSAhPT0ga2V5OwogIH0KfQovKiAgKi8KCi8qKgogKiBSdW50aW1lIGhlbHBlciBmb3IgbWVyZ2luZyB2LWJpbmQ9Im9iamVjdCIgaW50byBhIFZOb2RlJ3MgZGF0YS4KICovCgoKZnVuY3Rpb24gYmluZE9iamVjdFByb3BzKGRhdGEsIHRhZywgdmFsdWUsIGFzUHJvcCwgaXNTeW5jKSB7CiAgaWYgKHZhbHVlKSB7CiAgICBpZiAoIWlzT2JqZWN0KHZhbHVlKSkgewogICAgICBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIHdhcm4oJ3YtYmluZCB3aXRob3V0IGFyZ3VtZW50IGV4cGVjdHMgYW4gT2JqZWN0IG9yIEFycmF5IHZhbHVlJywgdGhpcyk7CiAgICB9IGVsc2UgewogICAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICB2YWx1ZSA9IHRvT2JqZWN0KHZhbHVlKTsKICAgICAgfQoKICAgICAgdmFyIGhhc2g7CgogICAgICB2YXIgbG9vcCA9IGZ1bmN0aW9uIGxvb3Aoa2V5KSB7CiAgICAgICAgaWYgKGtleSA9PT0gJ2NsYXNzJyB8fCBrZXkgPT09ICdzdHlsZScgfHwgaXNSZXNlcnZlZEF0dHJpYnV0ZShrZXkpKSB7CiAgICAgICAgICBoYXNoID0gZGF0YTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmFyIHR5cGUgPSBkYXRhLmF0dHJzICYmIGRhdGEuYXR0cnMudHlwZTsKICAgICAgICAgIGhhc2ggPSBhc1Byb3AgfHwgY29uZmlnLm11c3RVc2VQcm9wKHRhZywgdHlwZSwga2V5KSA/IGRhdGEuZG9tUHJvcHMgfHwgKGRhdGEuZG9tUHJvcHMgPSB7fSkgOiBkYXRhLmF0dHJzIHx8IChkYXRhLmF0dHJzID0ge30pOwogICAgICAgIH0KCiAgICAgICAgdmFyIGNhbWVsaXplZEtleSA9IGNhbWVsaXplKGtleSk7CiAgICAgICAgdmFyIGh5cGhlbmF0ZWRLZXkgPSBoeXBoZW5hdGUoa2V5KTsKCiAgICAgICAgaWYgKCEoY2FtZWxpemVkS2V5IGluIGhhc2gpICYmICEoaHlwaGVuYXRlZEtleSBpbiBoYXNoKSkgewogICAgICAgICAgaGFzaFtrZXldID0gdmFsdWVba2V5XTsKCiAgICAgICAgICBpZiAoaXNTeW5jKSB7CiAgICAgICAgICAgIHZhciBvbiA9IGRhdGEub24gfHwgKGRhdGEub24gPSB7fSk7CgogICAgICAgICAgICBvblsidXBkYXRlOiIgKyBrZXldID0gZnVuY3Rpb24gKCRldmVudCkgewogICAgICAgICAgICAgIHZhbHVlW2tleV0gPSAkZXZlbnQ7CiAgICAgICAgICAgIH07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9OwoKICAgICAgZm9yICh2YXIga2V5IGluIHZhbHVlKSB7CiAgICAgICAgbG9vcChrZXkpOwogICAgICB9CiAgICB9CiAgfQoKICByZXR1cm4gZGF0YTsKfQovKiAgKi8KCi8qKgogKiBSdW50aW1lIGhlbHBlciBmb3IgcmVuZGVyaW5nIHN0YXRpYyB0cmVlcy4KICovCgoKZnVuY3Rpb24gcmVuZGVyU3RhdGljKGluZGV4LCBpc0luRm9yKSB7CiAgdmFyIGNhY2hlZCA9IHRoaXMuX3N0YXRpY1RyZWVzIHx8ICh0aGlzLl9zdGF0aWNUcmVlcyA9IFtdKTsKICB2YXIgdHJlZSA9IGNhY2hlZFtpbmRleF07IC8vIGlmIGhhcyBhbHJlYWR5LXJlbmRlcmVkIHN0YXRpYyB0cmVlIGFuZCBub3QgaW5zaWRlIHYtZm9yLAogIC8vIHdlIGNhbiByZXVzZSB0aGUgc2FtZSB0cmVlLgoKICBpZiAodHJlZSAmJiAhaXNJbkZvcikgewogICAgcmV0dXJuIHRyZWU7CiAgfSAvLyBvdGhlcndpc2UsIHJlbmRlciBhIGZyZXNoIHRyZWUuCgoKICB0cmVlID0gY2FjaGVkW2luZGV4XSA9IHRoaXMuJG9wdGlvbnMuc3RhdGljUmVuZGVyRm5zW2luZGV4XS5jYWxsKHRoaXMuX3JlbmRlclByb3h5LCBudWxsLCB0aGlzIC8vIGZvciByZW5kZXIgZm5zIGdlbmVyYXRlZCBmb3IgZnVuY3Rpb25hbCBjb21wb25lbnQgdGVtcGxhdGVzCiAgKTsKICBtYXJrU3RhdGljKHRyZWUsICJfX3N0YXRpY19fIiArIGluZGV4LCBmYWxzZSk7CiAgcmV0dXJuIHRyZWU7Cn0KLyoqCiAqIFJ1bnRpbWUgaGVscGVyIGZvciB2LW9uY2UuCiAqIEVmZmVjdGl2ZWx5IGl0IG1lYW5zIG1hcmtpbmcgdGhlIG5vZGUgYXMgc3RhdGljIHdpdGggYSB1bmlxdWUga2V5LgogKi8KCgpmdW5jdGlvbiBtYXJrT25jZSh0cmVlLCBpbmRleCwga2V5KSB7CiAgbWFya1N0YXRpYyh0cmVlLCAiX19vbmNlX18iICsgaW5kZXggKyAoa2V5ID8gIl8iICsga2V5IDogIiIpLCB0cnVlKTsKICByZXR1cm4gdHJlZTsKfQoKZnVuY3Rpb24gbWFya1N0YXRpYyh0cmVlLCBrZXksIGlzT25jZSkgewogIGlmIChBcnJheS5pc0FycmF5KHRyZWUpKSB7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRyZWUubGVuZ3RoOyBpKyspIHsKICAgICAgaWYgKHRyZWVbaV0gJiYgdHlwZW9mIHRyZWVbaV0gIT09ICdzdHJpbmcnKSB7CiAgICAgICAgbWFya1N0YXRpY05vZGUodHJlZVtpXSwga2V5ICsgIl8iICsgaSwgaXNPbmNlKTsKICAgICAgfQogICAgfQogIH0gZWxzZSB7CiAgICBtYXJrU3RhdGljTm9kZSh0cmVlLCBrZXksIGlzT25jZSk7CiAgfQp9CgpmdW5jdGlvbiBtYXJrU3RhdGljTm9kZShub2RlLCBrZXksIGlzT25jZSkgewogIG5vZGUuaXNTdGF0aWMgPSB0cnVlOwogIG5vZGUua2V5ID0ga2V5OwogIG5vZGUuaXNPbmNlID0gaXNPbmNlOwp9Ci8qICAqLwoKCmZ1bmN0aW9uIGJpbmRPYmplY3RMaXN0ZW5lcnMoZGF0YSwgdmFsdWUpIHsKICBpZiAodmFsdWUpIHsKICAgIGlmICghaXNQbGFpbk9iamVjdCh2YWx1ZSkpIHsKICAgICAgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiB3YXJuKCd2LW9uIHdpdGhvdXQgYXJndW1lbnQgZXhwZWN0cyBhbiBPYmplY3QgdmFsdWUnLCB0aGlzKTsKICAgIH0gZWxzZSB7CiAgICAgIHZhciBvbiA9IGRhdGEub24gPSBkYXRhLm9uID8gZXh0ZW5kKHt9LCBkYXRhLm9uKSA6IHt9OwoKICAgICAgZm9yICh2YXIga2V5IGluIHZhbHVlKSB7CiAgICAgICAgdmFyIGV4aXN0aW5nID0gb25ba2V5XTsKICAgICAgICB2YXIgb3VycyA9IHZhbHVlW2tleV07CiAgICAgICAgb25ba2V5XSA9IGV4aXN0aW5nID8gW10uY29uY2F0KGV4aXN0aW5nLCBvdXJzKSA6IG91cnM7CiAgICAgIH0KICAgIH0KICB9CgogIHJldHVybiBkYXRhOwp9Ci8qICAqLwoKCmZ1bmN0aW9uIHJlc29sdmVTY29wZWRTbG90cyhmbnMsIC8vIHNlZSBmbG93L3Zub2RlCnJlcywgLy8gdGhlIGZvbGxvd2luZyBhcmUgYWRkZWQgaW4gMi42Cmhhc0R5bmFtaWNLZXlzLCBjb250ZW50SGFzaEtleSkgewogIHJlcyA9IHJlcyB8fCB7CiAgICAkc3RhYmxlOiAhaGFzRHluYW1pY0tleXMKICB9OwoKICBmb3IgKHZhciBpID0gMDsgaSA8IGZucy5sZW5ndGg7IGkrKykgewogICAgdmFyIHNsb3QgPSBmbnNbaV07CgogICAgaWYgKEFycmF5LmlzQXJyYXkoc2xvdCkpIHsKICAgICAgcmVzb2x2ZVNjb3BlZFNsb3RzKHNsb3QsIHJlcywgaGFzRHluYW1pY0tleXMpOwogICAgfSBlbHNlIGlmIChzbG90KSB7CiAgICAgIC8vIG1hcmtlciBmb3IgcmV2ZXJzZSBwcm94eWluZyB2LXNsb3Qgd2l0aG91dCBzY29wZSBvbiB0aGlzLiRzbG90cwogICAgICBpZiAoc2xvdC5wcm94eSkgewogICAgICAgIHNsb3QuZm4ucHJveHkgPSB0cnVlOwogICAgICB9CgogICAgICByZXNbc2xvdC5rZXldID0gc2xvdC5mbjsKICAgIH0KICB9CgogIGlmIChjb250ZW50SGFzaEtleSkgewogICAgcmVzLiRrZXkgPSBjb250ZW50SGFzaEtleTsKICB9CgogIHJldHVybiByZXM7Cn0KLyogICovCgoKZnVuY3Rpb24gYmluZER5bmFtaWNLZXlzKGJhc2VPYmosIHZhbHVlcykgewogIGZvciAodmFyIGkgPSAwOyBpIDwgdmFsdWVzLmxlbmd0aDsgaSArPSAyKSB7CiAgICB2YXIga2V5ID0gdmFsdWVzW2ldOwoKICAgIGlmICh0eXBlb2Yga2V5ID09PSAnc3RyaW5nJyAmJiBrZXkpIHsKICAgICAgYmFzZU9ialt2YWx1ZXNbaV1dID0gdmFsdWVzW2kgKyAxXTsKICAgIH0gZWxzZSBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiBrZXkgIT09ICcnICYmIGtleSAhPT0gbnVsbCkgewogICAgICAvLyBudWxsIGlzIGEgc3BlaWNhbCB2YWx1ZSBmb3IgZXhwbGljaXRseSByZW1vdmluZyBhIGJpbmRpbmcKICAgICAgd2FybigiSW52YWxpZCB2YWx1ZSBmb3IgZHluYW1pYyBkaXJlY3RpdmUgYXJndW1lbnQgKGV4cGVjdGVkIHN0cmluZyBvciBudWxsKTogIiArIGtleSwgdGhpcyk7CiAgICB9CiAgfQoKICByZXR1cm4gYmFzZU9iajsKfSAvLyBoZWxwZXIgdG8gZHluYW1pY2FsbHkgYXBwZW5kIG1vZGlmaWVyIHJ1bnRpbWUgbWFya2VycyB0byBldmVudCBuYW1lcy4KLy8gZW5zdXJlIG9ubHkgYXBwZW5kIHdoZW4gdmFsdWUgaXMgYWxyZWFkeSBzdHJpbmcsIG90aGVyd2lzZSBpdCB3aWxsIGJlIGNhc3QKLy8gdG8gc3RyaW5nIGFuZCBjYXVzZSB0aGUgdHlwZSBjaGVjayB0byBtaXNzLgoKCmZ1bmN0aW9uIHByZXBlbmRNb2RpZmllcih2YWx1ZSwgc3ltYm9sKSB7CiAgcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycgPyBzeW1ib2wgKyB2YWx1ZSA6IHZhbHVlOwp9Ci8qICAqLwoKCmZ1bmN0aW9uIGluc3RhbGxSZW5kZXJIZWxwZXJzKHRhcmdldCkgewogIHRhcmdldC5fbyA9IG1hcmtPbmNlOwogIHRhcmdldC5fbiA9IHRvTnVtYmVyOwogIHRhcmdldC5fcyA9IHRvU3RyaW5nOwogIHRhcmdldC5fbCA9IHJlbmRlckxpc3Q7CiAgdGFyZ2V0Ll90ID0gcmVuZGVyU2xvdDsKICB0YXJnZXQuX3EgPSBsb29zZUVxdWFsOwogIHRhcmdldC5faSA9IGxvb3NlSW5kZXhPZjsKICB0YXJnZXQuX20gPSByZW5kZXJTdGF0aWM7CiAgdGFyZ2V0Ll9mID0gcmVzb2x2ZUZpbHRlcjsKICB0YXJnZXQuX2sgPSBjaGVja0tleUNvZGVzOwogIHRhcmdldC5fYiA9IGJpbmRPYmplY3RQcm9wczsKICB0YXJnZXQuX3YgPSBjcmVhdGVUZXh0Vk5vZGU7CiAgdGFyZ2V0Ll9lID0gY3JlYXRlRW1wdHlWTm9kZTsKICB0YXJnZXQuX3UgPSByZXNvbHZlU2NvcGVkU2xvdHM7CiAgdGFyZ2V0Ll9nID0gYmluZE9iamVjdExpc3RlbmVyczsKICB0YXJnZXQuX2QgPSBiaW5kRHluYW1pY0tleXM7CiAgdGFyZ2V0Ll9wID0gcHJlcGVuZE1vZGlmaWVyOwp9Ci8qICAqLwoKCmZ1bmN0aW9uIEZ1bmN0aW9uYWxSZW5kZXJDb250ZXh0KGRhdGEsIHByb3BzLCBjaGlsZHJlbiwgcGFyZW50LCBDdG9yKSB7CiAgdmFyIHRoaXMkMSA9IHRoaXM7CiAgdmFyIG9wdGlvbnMgPSBDdG9yLm9wdGlvbnM7IC8vIGVuc3VyZSB0aGUgY3JlYXRlRWxlbWVudCBmdW5jdGlvbiBpbiBmdW5jdGlvbmFsIGNvbXBvbmVudHMKICAvLyBnZXRzIGEgdW5pcXVlIGNvbnRleHQgLSB0aGlzIGlzIG5lY2Vzc2FyeSBmb3IgY29ycmVjdCBuYW1lZCBzbG90IGNoZWNrCgogIHZhciBjb250ZXh0Vm07CgogIGlmIChoYXNPd24ocGFyZW50LCAnX3VpZCcpKSB7CiAgICBjb250ZXh0Vm0gPSBPYmplY3QuY3JlYXRlKHBhcmVudCk7IC8vICRmbG93LWRpc2FibGUtbGluZQoKICAgIGNvbnRleHRWbS5fb3JpZ2luYWwgPSBwYXJlbnQ7CiAgfSBlbHNlIHsKICAgIC8vIHRoZSBjb250ZXh0IHZtIHBhc3NlZCBpbiBpcyBhIGZ1bmN0aW9uYWwgY29udGV4dCBhcyB3ZWxsLgogICAgLy8gaW4gdGhpcyBjYXNlIHdlIHdhbnQgdG8gbWFrZSBzdXJlIHdlIGFyZSBhYmxlIHRvIGdldCBhIGhvbGQgdG8gdGhlCiAgICAvLyByZWFsIGNvbnRleHQgaW5zdGFuY2UuCiAgICBjb250ZXh0Vm0gPSBwYXJlbnQ7IC8vICRmbG93LWRpc2FibGUtbGluZQoKICAgIHBhcmVudCA9IHBhcmVudC5fb3JpZ2luYWw7CiAgfQoKICB2YXIgaXNDb21waWxlZCA9IGlzVHJ1ZShvcHRpb25zLl9jb21waWxlZCk7CiAgdmFyIG5lZWROb3JtYWxpemF0aW9uID0gIWlzQ29tcGlsZWQ7CiAgdGhpcy5kYXRhID0gZGF0YTsKICB0aGlzLnByb3BzID0gcHJvcHM7CiAgdGhpcy5jaGlsZHJlbiA9IGNoaWxkcmVuOwogIHRoaXMucGFyZW50ID0gcGFyZW50OwogIHRoaXMubGlzdGVuZXJzID0gZGF0YS5vbiB8fCBlbXB0eU9iamVjdDsKICB0aGlzLmluamVjdGlvbnMgPSByZXNvbHZlSW5qZWN0KG9wdGlvbnMuaW5qZWN0LCBwYXJlbnQpOwoKICB0aGlzLnNsb3RzID0gZnVuY3Rpb24gKCkgewogICAgaWYgKCF0aGlzJDEuJHNsb3RzKSB7CiAgICAgIG5vcm1hbGl6ZVNjb3BlZFNsb3RzKGRhdGEuc2NvcGVkU2xvdHMsIHRoaXMkMS4kc2xvdHMgPSByZXNvbHZlU2xvdHMoY2hpbGRyZW4sIHBhcmVudCkpOwogICAgfQoKICAgIHJldHVybiB0aGlzJDEuJHNsb3RzOwogIH07CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCAnc2NvcGVkU2xvdHMnLCB7CiAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBub3JtYWxpemVTY29wZWRTbG90cyhkYXRhLnNjb3BlZFNsb3RzLCB0aGlzLnNsb3RzKCkpOwogICAgfQogIH0pOyAvLyBzdXBwb3J0IGZvciBjb21waWxlZCBmdW5jdGlvbmFsIHRlbXBsYXRlCgogIGlmIChpc0NvbXBpbGVkKSB7CiAgICAvLyBleHBvc2luZyAkb3B0aW9ucyBmb3IgcmVuZGVyU3RhdGljKCkKICAgIHRoaXMuJG9wdGlvbnMgPSBvcHRpb25zOyAvLyBwcmUtcmVzb2x2ZSBzbG90cyBmb3IgcmVuZGVyU2xvdCgpCgogICAgdGhpcy4kc2xvdHMgPSB0aGlzLnNsb3RzKCk7CiAgICB0aGlzLiRzY29wZWRTbG90cyA9IG5vcm1hbGl6ZVNjb3BlZFNsb3RzKGRhdGEuc2NvcGVkU2xvdHMsIHRoaXMuJHNsb3RzKTsKICB9CgogIGlmIChvcHRpb25zLl9zY29wZUlkKSB7CiAgICB0aGlzLl9jID0gZnVuY3Rpb24gKGEsIGIsIGMsIGQpIHsKICAgICAgdmFyIHZub2RlID0gY3JlYXRlRWxlbWVudChjb250ZXh0Vm0sIGEsIGIsIGMsIGQsIG5lZWROb3JtYWxpemF0aW9uKTsKCiAgICAgIGlmICh2bm9kZSAmJiAhQXJyYXkuaXNBcnJheSh2bm9kZSkpIHsKICAgICAgICB2bm9kZS5mblNjb3BlSWQgPSBvcHRpb25zLl9zY29wZUlkOwogICAgICAgIHZub2RlLmZuQ29udGV4dCA9IHBhcmVudDsKICAgICAgfQoKICAgICAgcmV0dXJuIHZub2RlOwogICAgfTsKICB9IGVsc2UgewogICAgdGhpcy5fYyA9IGZ1bmN0aW9uIChhLCBiLCBjLCBkKSB7CiAgICAgIHJldHVybiBjcmVhdGVFbGVtZW50KGNvbnRleHRWbSwgYSwgYiwgYywgZCwgbmVlZE5vcm1hbGl6YXRpb24pOwogICAgfTsKICB9Cn0KCmluc3RhbGxSZW5kZXJIZWxwZXJzKEZ1bmN0aW9uYWxSZW5kZXJDb250ZXh0LnByb3RvdHlwZSk7CgpmdW5jdGlvbiBjcmVhdGVGdW5jdGlvbmFsQ29tcG9uZW50KEN0b3IsIHByb3BzRGF0YSwgZGF0YSwgY29udGV4dFZtLCBjaGlsZHJlbikgewogIHZhciBvcHRpb25zID0gQ3Rvci5vcHRpb25zOwogIHZhciBwcm9wcyA9IHt9OwogIHZhciBwcm9wT3B0aW9ucyA9IG9wdGlvbnMucHJvcHM7CgogIGlmIChpc0RlZihwcm9wT3B0aW9ucykpIHsKICAgIGZvciAodmFyIGtleSBpbiBwcm9wT3B0aW9ucykgewogICAgICBwcm9wc1trZXldID0gdmFsaWRhdGVQcm9wKGtleSwgcHJvcE9wdGlvbnMsIHByb3BzRGF0YSB8fCBlbXB0eU9iamVjdCk7CiAgICB9CiAgfSBlbHNlIHsKICAgIGlmIChpc0RlZihkYXRhLmF0dHJzKSkgewogICAgICBtZXJnZVByb3BzKHByb3BzLCBkYXRhLmF0dHJzKTsKICAgIH0KCiAgICBpZiAoaXNEZWYoZGF0YS5wcm9wcykpIHsKICAgICAgbWVyZ2VQcm9wcyhwcm9wcywgZGF0YS5wcm9wcyk7CiAgICB9CiAgfQoKICB2YXIgcmVuZGVyQ29udGV4dCA9IG5ldyBGdW5jdGlvbmFsUmVuZGVyQ29udGV4dChkYXRhLCBwcm9wcywgY2hpbGRyZW4sIGNvbnRleHRWbSwgQ3Rvcik7CiAgdmFyIHZub2RlID0gb3B0aW9ucy5yZW5kZXIuY2FsbChudWxsLCByZW5kZXJDb250ZXh0Ll9jLCByZW5kZXJDb250ZXh0KTsKCiAgaWYgKHZub2RlIGluc3RhbmNlb2YgVk5vZGUpIHsKICAgIHJldHVybiBjbG9uZUFuZE1hcmtGdW5jdGlvbmFsUmVzdWx0KHZub2RlLCBkYXRhLCByZW5kZXJDb250ZXh0LnBhcmVudCwgb3B0aW9ucywgcmVuZGVyQ29udGV4dCk7CiAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KHZub2RlKSkgewogICAgdmFyIHZub2RlcyA9IG5vcm1hbGl6ZUNoaWxkcmVuKHZub2RlKSB8fCBbXTsKICAgIHZhciByZXMgPSBuZXcgQXJyYXkodm5vZGVzLmxlbmd0aCk7CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCB2bm9kZXMubGVuZ3RoOyBpKyspIHsKICAgICAgcmVzW2ldID0gY2xvbmVBbmRNYXJrRnVuY3Rpb25hbFJlc3VsdCh2bm9kZXNbaV0sIGRhdGEsIHJlbmRlckNvbnRleHQucGFyZW50LCBvcHRpb25zLCByZW5kZXJDb250ZXh0KTsKICAgIH0KCiAgICByZXR1cm4gcmVzOwogIH0KfQoKZnVuY3Rpb24gY2xvbmVBbmRNYXJrRnVuY3Rpb25hbFJlc3VsdCh2bm9kZSwgZGF0YSwgY29udGV4dFZtLCBvcHRpb25zLCByZW5kZXJDb250ZXh0KSB7CiAgLy8gIzc4MTcgY2xvbmUgbm9kZSBiZWZvcmUgc2V0dGluZyBmbkNvbnRleHQsIG90aGVyd2lzZSBpZiB0aGUgbm9kZSBpcyByZXVzZWQKICAvLyAoZS5nLiBpdCB3YXMgZnJvbSBhIGNhY2hlZCBub3JtYWwgc2xvdCkgdGhlIGZuQ29udGV4dCBjYXVzZXMgbmFtZWQgc2xvdHMKICAvLyB0aGF0IHNob3VsZCBub3QgYmUgbWF0Y2hlZCB0byBtYXRjaC4KICB2YXIgY2xvbmUgPSBjbG9uZVZOb2RlKHZub2RlKTsKICBjbG9uZS5mbkNvbnRleHQgPSBjb250ZXh0Vm07CiAgY2xvbmUuZm5PcHRpb25zID0gb3B0aW9uczsKCiAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgIChjbG9uZS5kZXZ0b29sc01ldGEgPSBjbG9uZS5kZXZ0b29sc01ldGEgfHwge30pLnJlbmRlckNvbnRleHQgPSByZW5kZXJDb250ZXh0OwogIH0KCiAgaWYgKGRhdGEuc2xvdCkgewogICAgKGNsb25lLmRhdGEgfHwgKGNsb25lLmRhdGEgPSB7fSkpLnNsb3QgPSBkYXRhLnNsb3Q7CiAgfQoKICByZXR1cm4gY2xvbmU7Cn0KCmZ1bmN0aW9uIG1lcmdlUHJvcHModG8sIGZyb20pIHsKICBmb3IgKHZhciBrZXkgaW4gZnJvbSkgewogICAgdG9bY2FtZWxpemUoa2V5KV0gPSBmcm9tW2tleV07CiAgfQp9Ci8qICAqLwoKLyogICovCgovKiAgKi8KCi8qICAqLwovLyBpbmxpbmUgaG9va3MgdG8gYmUgaW52b2tlZCBvbiBjb21wb25lbnQgVk5vZGVzIGR1cmluZyBwYXRjaAoKCnZhciBjb21wb25lbnRWTm9kZUhvb2tzID0gewogIGluaXQ6IGZ1bmN0aW9uIGluaXQodm5vZGUsIGh5ZHJhdGluZykgewogICAgaWYgKHZub2RlLmNvbXBvbmVudEluc3RhbmNlICYmICF2bm9kZS5jb21wb25lbnRJbnN0YW5jZS5faXNEZXN0cm95ZWQgJiYgdm5vZGUuZGF0YS5rZWVwQWxpdmUpIHsKICAgICAgLy8ga2VwdC1hbGl2ZSBjb21wb25lbnRzLCB0cmVhdCBhcyBhIHBhdGNoCiAgICAgIHZhciBtb3VudGVkTm9kZSA9IHZub2RlOyAvLyB3b3JrIGFyb3VuZCBmbG93CgogICAgICBjb21wb25lbnRWTm9kZUhvb2tzLnByZXBhdGNoKG1vdW50ZWROb2RlLCBtb3VudGVkTm9kZSk7CiAgICB9IGVsc2UgewogICAgICB2YXIgY2hpbGQgPSB2bm9kZS5jb21wb25lbnRJbnN0YW5jZSA9IGNyZWF0ZUNvbXBvbmVudEluc3RhbmNlRm9yVm5vZGUodm5vZGUsIGFjdGl2ZUluc3RhbmNlKTsKICAgICAgY2hpbGQuJG1vdW50KGh5ZHJhdGluZyA/IHZub2RlLmVsbSA6IHVuZGVmaW5lZCwgaHlkcmF0aW5nKTsKICAgIH0KICB9LAogIHByZXBhdGNoOiBmdW5jdGlvbiBwcmVwYXRjaChvbGRWbm9kZSwgdm5vZGUpIHsKICAgIHZhciBvcHRpb25zID0gdm5vZGUuY29tcG9uZW50T3B0aW9uczsKICAgIHZhciBjaGlsZCA9IHZub2RlLmNvbXBvbmVudEluc3RhbmNlID0gb2xkVm5vZGUuY29tcG9uZW50SW5zdGFuY2U7CiAgICB1cGRhdGVDaGlsZENvbXBvbmVudChjaGlsZCwgb3B0aW9ucy5wcm9wc0RhdGEsIC8vIHVwZGF0ZWQgcHJvcHMKICAgIG9wdGlvbnMubGlzdGVuZXJzLCAvLyB1cGRhdGVkIGxpc3RlbmVycwogICAgdm5vZGUsIC8vIG5ldyBwYXJlbnQgdm5vZGUKICAgIG9wdGlvbnMuY2hpbGRyZW4gLy8gbmV3IGNoaWxkcmVuCiAgICApOwogIH0sCiAgaW5zZXJ0OiBmdW5jdGlvbiBpbnNlcnQodm5vZGUpIHsKICAgIHZhciBjb250ZXh0ID0gdm5vZGUuY29udGV4dDsKICAgIHZhciBjb21wb25lbnRJbnN0YW5jZSA9IHZub2RlLmNvbXBvbmVudEluc3RhbmNlOwoKICAgIGlmICghY29tcG9uZW50SW5zdGFuY2UuX2lzTW91bnRlZCkgewogICAgICBjb21wb25lbnRJbnN0YW5jZS5faXNNb3VudGVkID0gdHJ1ZTsKICAgICAgY2FsbEhvb2soY29tcG9uZW50SW5zdGFuY2UsICdtb3VudGVkJyk7CiAgICB9CgogICAgaWYgKHZub2RlLmRhdGEua2VlcEFsaXZlKSB7CiAgICAgIGlmIChjb250ZXh0Ll9pc01vdW50ZWQpIHsKICAgICAgICAvLyB2dWUtcm91dGVyIzEyMTIKICAgICAgICAvLyBEdXJpbmcgdXBkYXRlcywgYSBrZXB0LWFsaXZlIGNvbXBvbmVudCdzIGNoaWxkIGNvbXBvbmVudHMgbWF5CiAgICAgICAgLy8gY2hhbmdlLCBzbyBkaXJlY3RseSB3YWxraW5nIHRoZSB0cmVlIGhlcmUgbWF5IGNhbGwgYWN0aXZhdGVkIGhvb2tzCiAgICAgICAgLy8gb24gaW5jb3JyZWN0IGNoaWxkcmVuLiBJbnN0ZWFkIHdlIHB1c2ggdGhlbSBpbnRvIGEgcXVldWUgd2hpY2ggd2lsbAogICAgICAgIC8vIGJlIHByb2Nlc3NlZCBhZnRlciB0aGUgd2hvbGUgcGF0Y2ggcHJvY2VzcyBlbmRlZC4KICAgICAgICBxdWV1ZUFjdGl2YXRlZENvbXBvbmVudChjb21wb25lbnRJbnN0YW5jZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgYWN0aXZhdGVDaGlsZENvbXBvbmVudChjb21wb25lbnRJbnN0YW5jZSwgdHJ1ZQogICAgICAgIC8qIGRpcmVjdCAqLwogICAgICAgICk7CiAgICAgIH0KICAgIH0KICB9LAogIGRlc3Ryb3k6IGZ1bmN0aW9uIGRlc3Ryb3kodm5vZGUpIHsKICAgIHZhciBjb21wb25lbnRJbnN0YW5jZSA9IHZub2RlLmNvbXBvbmVudEluc3RhbmNlOwoKICAgIGlmICghY29tcG9uZW50SW5zdGFuY2UuX2lzRGVzdHJveWVkKSB7CiAgICAgIGlmICghdm5vZGUuZGF0YS5rZWVwQWxpdmUpIHsKICAgICAgICBjb21wb25lbnRJbnN0YW5jZS4kZGVzdHJveSgpOwogICAgICB9IGVsc2UgewogICAgICAgIGRlYWN0aXZhdGVDaGlsZENvbXBvbmVudChjb21wb25lbnRJbnN0YW5jZSwgdHJ1ZQogICAgICAgIC8qIGRpcmVjdCAqLwogICAgICAgICk7CiAgICAgIH0KICAgIH0KICB9Cn07CnZhciBob29rc1RvTWVyZ2UgPSBPYmplY3Qua2V5cyhjb21wb25lbnRWTm9kZUhvb2tzKTsKCmZ1bmN0aW9uIGNyZWF0ZUNvbXBvbmVudChDdG9yLCBkYXRhLCBjb250ZXh0LCBjaGlsZHJlbiwgdGFnKSB7CiAgaWYgKGlzVW5kZWYoQ3RvcikpIHsKICAgIHJldHVybjsKICB9CgogIHZhciBiYXNlQ3RvciA9IGNvbnRleHQuJG9wdGlvbnMuX2Jhc2U7IC8vIHBsYWluIG9wdGlvbnMgb2JqZWN0OiB0dXJuIGl0IGludG8gYSBjb25zdHJ1Y3RvcgoKICBpZiAoaXNPYmplY3QoQ3RvcikpIHsKICAgIEN0b3IgPSBiYXNlQ3Rvci5leHRlbmQoQ3Rvcik7CiAgfSAvLyBpZiBhdCB0aGlzIHN0YWdlIGl0J3Mgbm90IGEgY29uc3RydWN0b3Igb3IgYW4gYXN5bmMgY29tcG9uZW50IGZhY3RvcnksCiAgLy8gcmVqZWN0LgoKCiAgaWYgKHR5cGVvZiBDdG9yICE9PSAnZnVuY3Rpb24nKSB7CiAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgICB3YXJuKCJJbnZhbGlkIENvbXBvbmVudCBkZWZpbml0aW9uOiAiICsgU3RyaW5nKEN0b3IpLCBjb250ZXh0KTsKICAgIH0KCiAgICByZXR1cm47CiAgfSAvLyBhc3luYyBjb21wb25lbnQKCgogIHZhciBhc3luY0ZhY3Rvcnk7CgogIGlmIChpc1VuZGVmKEN0b3IuY2lkKSkgewogICAgYXN5bmNGYWN0b3J5ID0gQ3RvcjsKICAgIEN0b3IgPSByZXNvbHZlQXN5bmNDb21wb25lbnQoYXN5bmNGYWN0b3J5LCBiYXNlQ3Rvcik7CgogICAgaWYgKEN0b3IgPT09IHVuZGVmaW5lZCkgewogICAgICAvLyByZXR1cm4gYSBwbGFjZWhvbGRlciBub2RlIGZvciBhc3luYyBjb21wb25lbnQsIHdoaWNoIGlzIHJlbmRlcmVkCiAgICAgIC8vIGFzIGEgY29tbWVudCBub2RlIGJ1dCBwcmVzZXJ2ZXMgYWxsIHRoZSByYXcgaW5mb3JtYXRpb24gZm9yIHRoZSBub2RlLgogICAgICAvLyB0aGUgaW5mb3JtYXRpb24gd2lsbCBiZSB1c2VkIGZvciBhc3luYyBzZXJ2ZXItcmVuZGVyaW5nIGFuZCBoeWRyYXRpb24uCiAgICAgIHJldHVybiBjcmVhdGVBc3luY1BsYWNlaG9sZGVyKGFzeW5jRmFjdG9yeSwgZGF0YSwgY29udGV4dCwgY2hpbGRyZW4sIHRhZyk7CiAgICB9CiAgfQoKICBkYXRhID0gZGF0YSB8fCB7fTsgLy8gcmVzb2x2ZSBjb25zdHJ1Y3RvciBvcHRpb25zIGluIGNhc2UgZ2xvYmFsIG1peGlucyBhcmUgYXBwbGllZCBhZnRlcgogIC8vIGNvbXBvbmVudCBjb25zdHJ1Y3RvciBjcmVhdGlvbgoKICByZXNvbHZlQ29uc3RydWN0b3JPcHRpb25zKEN0b3IpOyAvLyB0cmFuc2Zvcm0gY29tcG9uZW50IHYtbW9kZWwgZGF0YSBpbnRvIHByb3BzICYgZXZlbnRzCgogIGlmIChpc0RlZihkYXRhLm1vZGVsKSkgewogICAgdHJhbnNmb3JtTW9kZWwoQ3Rvci5vcHRpb25zLCBkYXRhKTsKICB9IC8vIGV4dHJhY3QgcHJvcHMKCgogIHZhciBwcm9wc0RhdGEgPSBleHRyYWN0UHJvcHNGcm9tVk5vZGVEYXRhKGRhdGEsIEN0b3IsIHRhZyk7IC8vIGZ1bmN0aW9uYWwgY29tcG9uZW50CgogIGlmIChpc1RydWUoQ3Rvci5vcHRpb25zLmZ1bmN0aW9uYWwpKSB7CiAgICByZXR1cm4gY3JlYXRlRnVuY3Rpb25hbENvbXBvbmVudChDdG9yLCBwcm9wc0RhdGEsIGRhdGEsIGNvbnRleHQsIGNoaWxkcmVuKTsKICB9IC8vIGV4dHJhY3QgbGlzdGVuZXJzLCBzaW5jZSB0aGVzZSBuZWVkcyB0byBiZSB0cmVhdGVkIGFzCiAgLy8gY2hpbGQgY29tcG9uZW50IGxpc3RlbmVycyBpbnN0ZWFkIG9mIERPTSBsaXN0ZW5lcnMKCgogIHZhciBsaXN0ZW5lcnMgPSBkYXRhLm9uOyAvLyByZXBsYWNlIHdpdGggbGlzdGVuZXJzIHdpdGggLm5hdGl2ZSBtb2RpZmllcgogIC8vIHNvIGl0IGdldHMgcHJvY2Vzc2VkIGR1cmluZyBwYXJlbnQgY29tcG9uZW50IHBhdGNoLgoKICBkYXRhLm9uID0gZGF0YS5uYXRpdmVPbjsKCiAgaWYgKGlzVHJ1ZShDdG9yLm9wdGlvbnNbImFic3RyYWN0Il0pKSB7CiAgICAvLyBhYnN0cmFjdCBjb21wb25lbnRzIGRvIG5vdCBrZWVwIGFueXRoaW5nCiAgICAvLyBvdGhlciB0aGFuIHByb3BzICYgbGlzdGVuZXJzICYgc2xvdAogICAgLy8gd29yayBhcm91bmQgZmxvdwogICAgdmFyIHNsb3QgPSBkYXRhLnNsb3Q7CiAgICBkYXRhID0ge307CgogICAgaWYgKHNsb3QpIHsKICAgICAgZGF0YS5zbG90ID0gc2xvdDsKICAgIH0KICB9IC8vIGluc3RhbGwgY29tcG9uZW50IG1hbmFnZW1lbnQgaG9va3Mgb250byB0aGUgcGxhY2Vob2xkZXIgbm9kZQoKCiAgaW5zdGFsbENvbXBvbmVudEhvb2tzKGRhdGEpOyAvLyByZXR1cm4gYSBwbGFjZWhvbGRlciB2bm9kZQoKICB2YXIgbmFtZSA9IEN0b3Iub3B0aW9ucy5uYW1lIHx8IHRhZzsKICB2YXIgdm5vZGUgPSBuZXcgVk5vZGUoInZ1ZS1jb21wb25lbnQtIiArIEN0b3IuY2lkICsgKG5hbWUgPyAiLSIgKyBuYW1lIDogJycpLCBkYXRhLCB1bmRlZmluZWQsIHVuZGVmaW5lZCwgdW5kZWZpbmVkLCBjb250ZXh0LCB7CiAgICBDdG9yOiBDdG9yLAogICAgcHJvcHNEYXRhOiBwcm9wc0RhdGEsCiAgICBsaXN0ZW5lcnM6IGxpc3RlbmVycywKICAgIHRhZzogdGFnLAogICAgY2hpbGRyZW46IGNoaWxkcmVuCiAgfSwgYXN5bmNGYWN0b3J5KTsKICByZXR1cm4gdm5vZGU7Cn0KCmZ1bmN0aW9uIGNyZWF0ZUNvbXBvbmVudEluc3RhbmNlRm9yVm5vZGUodm5vZGUsIC8vIHdlIGtub3cgaXQncyBNb3VudGVkQ29tcG9uZW50Vk5vZGUgYnV0IGZsb3cgZG9lc24ndApwYXJlbnQgLy8gYWN0aXZlSW5zdGFuY2UgaW4gbGlmZWN5Y2xlIHN0YXRlCikgewogIHZhciBvcHRpb25zID0gewogICAgX2lzQ29tcG9uZW50OiB0cnVlLAogICAgX3BhcmVudFZub2RlOiB2bm9kZSwKICAgIHBhcmVudDogcGFyZW50CiAgfTsgLy8gY2hlY2sgaW5saW5lLXRlbXBsYXRlIHJlbmRlciBmdW5jdGlvbnMKCiAgdmFyIGlubGluZVRlbXBsYXRlID0gdm5vZGUuZGF0YS5pbmxpbmVUZW1wbGF0ZTsKCiAgaWYgKGlzRGVmKGlubGluZVRlbXBsYXRlKSkgewogICAgb3B0aW9ucy5yZW5kZXIgPSBpbmxpbmVUZW1wbGF0ZS5yZW5kZXI7CiAgICBvcHRpb25zLnN0YXRpY1JlbmRlckZucyA9IGlubGluZVRlbXBsYXRlLnN0YXRpY1JlbmRlckZuczsKICB9CgogIHJldHVybiBuZXcgdm5vZGUuY29tcG9uZW50T3B0aW9ucy5DdG9yKG9wdGlvbnMpOwp9CgpmdW5jdGlvbiBpbnN0YWxsQ29tcG9uZW50SG9va3MoZGF0YSkgewogIHZhciBob29rcyA9IGRhdGEuaG9vayB8fCAoZGF0YS5ob29rID0ge30pOwoKICBmb3IgKHZhciBpID0gMDsgaSA8IGhvb2tzVG9NZXJnZS5sZW5ndGg7IGkrKykgewogICAgdmFyIGtleSA9IGhvb2tzVG9NZXJnZVtpXTsKICAgIHZhciBleGlzdGluZyA9IGhvb2tzW2tleV07CiAgICB2YXIgdG9NZXJnZSA9IGNvbXBvbmVudFZOb2RlSG9va3Nba2V5XTsKCiAgICBpZiAoZXhpc3RpbmcgIT09IHRvTWVyZ2UgJiYgIShleGlzdGluZyAmJiBleGlzdGluZy5fbWVyZ2VkKSkgewogICAgICBob29rc1trZXldID0gZXhpc3RpbmcgPyBtZXJnZUhvb2skMSh0b01lcmdlLCBleGlzdGluZykgOiB0b01lcmdlOwogICAgfQogIH0KfQoKZnVuY3Rpb24gbWVyZ2VIb29rJDEoZjEsIGYyKSB7CiAgdmFyIG1lcmdlZCA9IGZ1bmN0aW9uIG1lcmdlZChhLCBiKSB7CiAgICAvLyBmbG93IGNvbXBsYWlucyBhYm91dCBleHRyYSBhcmdzIHdoaWNoIGlzIHdoeSB3ZSB1c2UgYW55CiAgICBmMShhLCBiKTsKICAgIGYyKGEsIGIpOwogIH07CgogIG1lcmdlZC5fbWVyZ2VkID0gdHJ1ZTsKICByZXR1cm4gbWVyZ2VkOwp9IC8vIHRyYW5zZm9ybSBjb21wb25lbnQgdi1tb2RlbCBpbmZvICh2YWx1ZSBhbmQgY2FsbGJhY2spIGludG8KLy8gcHJvcCBhbmQgZXZlbnQgaGFuZGxlciByZXNwZWN0aXZlbHkuCgoKZnVuY3Rpb24gdHJhbnNmb3JtTW9kZWwob3B0aW9ucywgZGF0YSkgewogIHZhciBwcm9wID0gb3B0aW9ucy5tb2RlbCAmJiBvcHRpb25zLm1vZGVsLnByb3AgfHwgJ3ZhbHVlJzsKICB2YXIgZXZlbnQgPSBvcHRpb25zLm1vZGVsICYmIG9wdGlvbnMubW9kZWwuZXZlbnQgfHwgJ2lucHV0JzsKICAoZGF0YS5hdHRycyB8fCAoZGF0YS5hdHRycyA9IHt9KSlbcHJvcF0gPSBkYXRhLm1vZGVsLnZhbHVlOwogIHZhciBvbiA9IGRhdGEub24gfHwgKGRhdGEub24gPSB7fSk7CiAgdmFyIGV4aXN0aW5nID0gb25bZXZlbnRdOwogIHZhciBjYWxsYmFjayA9IGRhdGEubW9kZWwuY2FsbGJhY2s7CgogIGlmIChpc0RlZihleGlzdGluZykpIHsKICAgIGlmIChBcnJheS5pc0FycmF5KGV4aXN0aW5nKSA/IGV4aXN0aW5nLmluZGV4T2YoY2FsbGJhY2spID09PSAtMSA6IGV4aXN0aW5nICE9PSBjYWxsYmFjaykgewogICAgICBvbltldmVudF0gPSBbY2FsbGJhY2tdLmNvbmNhdChleGlzdGluZyk7CiAgICB9CiAgfSBlbHNlIHsKICAgIG9uW2V2ZW50XSA9IGNhbGxiYWNrOwogIH0KfQovKiAgKi8KCgp2YXIgU0lNUExFX05PUk1BTElaRSA9IDE7CnZhciBBTFdBWVNfTk9STUFMSVpFID0gMjsgLy8gd3JhcHBlciBmdW5jdGlvbiBmb3IgcHJvdmlkaW5nIGEgbW9yZSBmbGV4aWJsZSBpbnRlcmZhY2UKLy8gd2l0aG91dCBnZXR0aW5nIHllbGxlZCBhdCBieSBmbG93CgpmdW5jdGlvbiBjcmVhdGVFbGVtZW50KGNvbnRleHQsIHRhZywgZGF0YSwgY2hpbGRyZW4sIG5vcm1hbGl6YXRpb25UeXBlLCBhbHdheXNOb3JtYWxpemUpIHsKICBpZiAoQXJyYXkuaXNBcnJheShkYXRhKSB8fCBpc1ByaW1pdGl2ZShkYXRhKSkgewogICAgbm9ybWFsaXphdGlvblR5cGUgPSBjaGlsZHJlbjsKICAgIGNoaWxkcmVuID0gZGF0YTsKICAgIGRhdGEgPSB1bmRlZmluZWQ7CiAgfQoKICBpZiAoaXNUcnVlKGFsd2F5c05vcm1hbGl6ZSkpIHsKICAgIG5vcm1hbGl6YXRpb25UeXBlID0gQUxXQVlTX05PUk1BTElaRTsKICB9CgogIHJldHVybiBfY3JlYXRlRWxlbWVudChjb250ZXh0LCB0YWcsIGRhdGEsIGNoaWxkcmVuLCBub3JtYWxpemF0aW9uVHlwZSk7Cn0KCmZ1bmN0aW9uIF9jcmVhdGVFbGVtZW50KGNvbnRleHQsIHRhZywgZGF0YSwgY2hpbGRyZW4sIG5vcm1hbGl6YXRpb25UeXBlKSB7CiAgaWYgKGlzRGVmKGRhdGEpICYmIGlzRGVmKGRhdGEuX19vYl9fKSkgewogICAgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiB3YXJuKCJBdm9pZCB1c2luZyBvYnNlcnZlZCBkYXRhIG9iamVjdCBhcyB2bm9kZSBkYXRhOiAiICsgSlNPTi5zdHJpbmdpZnkoZGF0YSkgKyAiXG4iICsgJ0Fsd2F5cyBjcmVhdGUgZnJlc2ggdm5vZGUgZGF0YSBvYmplY3RzIGluIGVhY2ggcmVuZGVyIScsIGNvbnRleHQpOwogICAgcmV0dXJuIGNyZWF0ZUVtcHR5Vk5vZGUoKTsKICB9IC8vIG9iamVjdCBzeW50YXggaW4gdi1iaW5kCgoKICBpZiAoaXNEZWYoZGF0YSkgJiYgaXNEZWYoZGF0YS5pcykpIHsKICAgIHRhZyA9IGRhdGEuaXM7CiAgfQoKICBpZiAoIXRhZykgewogICAgLy8gaW4gY2FzZSBvZiBjb21wb25lbnQgOmlzIHNldCB0byBmYWxzeSB2YWx1ZQogICAgcmV0dXJuIGNyZWF0ZUVtcHR5Vk5vZGUoKTsKICB9IC8vIHdhcm4gYWdhaW5zdCBub24tcHJpbWl0aXZlIGtleQoKCiAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgaXNEZWYoZGF0YSkgJiYgaXNEZWYoZGF0YS5rZXkpICYmICFpc1ByaW1pdGl2ZShkYXRhLmtleSkpIHsKICAgIHsKICAgICAgd2FybignQXZvaWQgdXNpbmcgbm9uLXByaW1pdGl2ZSB2YWx1ZSBhcyBrZXksICcgKyAndXNlIHN0cmluZy9udW1iZXIgdmFsdWUgaW5zdGVhZC4nLCBjb250ZXh0KTsKICAgIH0KICB9IC8vIHN1cHBvcnQgc2luZ2xlIGZ1bmN0aW9uIGNoaWxkcmVuIGFzIGRlZmF1bHQgc2NvcGVkIHNsb3QKCgogIGlmIChBcnJheS5pc0FycmF5KGNoaWxkcmVuKSAmJiB0eXBlb2YgY2hpbGRyZW5bMF0gPT09ICdmdW5jdGlvbicpIHsKICAgIGRhdGEgPSBkYXRhIHx8IHt9OwogICAgZGF0YS5zY29wZWRTbG90cyA9IHsKICAgICAgImRlZmF1bHQiOiBjaGlsZHJlblswXQogICAgfTsKICAgIGNoaWxkcmVuLmxlbmd0aCA9IDA7CiAgfQoKICBpZiAobm9ybWFsaXphdGlvblR5cGUgPT09IEFMV0FZU19OT1JNQUxJWkUpIHsKICAgIGNoaWxkcmVuID0gbm9ybWFsaXplQ2hpbGRyZW4oY2hpbGRyZW4pOwogIH0gZWxzZSBpZiAobm9ybWFsaXphdGlvblR5cGUgPT09IFNJTVBMRV9OT1JNQUxJWkUpIHsKICAgIGNoaWxkcmVuID0gc2ltcGxlTm9ybWFsaXplQ2hpbGRyZW4oY2hpbGRyZW4pOwogIH0KCiAgdmFyIHZub2RlLCBuczsKCiAgaWYgKHR5cGVvZiB0YWcgPT09ICdzdHJpbmcnKSB7CiAgICB2YXIgQ3RvcjsKICAgIG5zID0gY29udGV4dC4kdm5vZGUgJiYgY29udGV4dC4kdm5vZGUubnMgfHwgY29uZmlnLmdldFRhZ05hbWVzcGFjZSh0YWcpOwoKICAgIGlmIChjb25maWcuaXNSZXNlcnZlZFRhZyh0YWcpKSB7CiAgICAgIC8vIHBsYXRmb3JtIGJ1aWx0LWluIGVsZW1lbnRzCiAgICAgIHZub2RlID0gbmV3IFZOb2RlKGNvbmZpZy5wYXJzZVBsYXRmb3JtVGFnTmFtZSh0YWcpLCBkYXRhLCBjaGlsZHJlbiwgdW5kZWZpbmVkLCB1bmRlZmluZWQsIGNvbnRleHQpOwogICAgfSBlbHNlIGlmICgoIWRhdGEgfHwgIWRhdGEucHJlKSAmJiBpc0RlZihDdG9yID0gcmVzb2x2ZUFzc2V0KGNvbnRleHQuJG9wdGlvbnMsICdjb21wb25lbnRzJywgdGFnKSkpIHsKICAgICAgLy8gY29tcG9uZW50CiAgICAgIHZub2RlID0gY3JlYXRlQ29tcG9uZW50KEN0b3IsIGRhdGEsIGNvbnRleHQsIGNoaWxkcmVuLCB0YWcpOwogICAgfSBlbHNlIHsKICAgICAgLy8gdW5rbm93biBvciB1bmxpc3RlZCBuYW1lc3BhY2VkIGVsZW1lbnRzCiAgICAgIC8vIGNoZWNrIGF0IHJ1bnRpbWUgYmVjYXVzZSBpdCBtYXkgZ2V0IGFzc2lnbmVkIGEgbmFtZXNwYWNlIHdoZW4gaXRzCiAgICAgIC8vIHBhcmVudCBub3JtYWxpemVzIGNoaWxkcmVuCiAgICAgIHZub2RlID0gbmV3IFZOb2RlKHRhZywgZGF0YSwgY2hpbGRyZW4sIHVuZGVmaW5lZCwgdW5kZWZpbmVkLCBjb250ZXh0KTsKICAgIH0KICB9IGVsc2UgewogICAgLy8gZGlyZWN0IGNvbXBvbmVudCBvcHRpb25zIC8gY29uc3RydWN0b3IKICAgIHZub2RlID0gY3JlYXRlQ29tcG9uZW50KHRhZywgZGF0YSwgY29udGV4dCwgY2hpbGRyZW4pOwogIH0KCiAgaWYgKEFycmF5LmlzQXJyYXkodm5vZGUpKSB7CiAgICByZXR1cm4gdm5vZGU7CiAgfSBlbHNlIGlmIChpc0RlZih2bm9kZSkpIHsKICAgIGlmIChpc0RlZihucykpIHsKICAgICAgYXBwbHlOUyh2bm9kZSwgbnMpOwogICAgfQoKICAgIGlmIChpc0RlZihkYXRhKSkgewogICAgICByZWdpc3RlckRlZXBCaW5kaW5ncyhkYXRhKTsKICAgIH0KCiAgICByZXR1cm4gdm5vZGU7CiAgfSBlbHNlIHsKICAgIHJldHVybiBjcmVhdGVFbXB0eVZOb2RlKCk7CiAgfQp9CgpmdW5jdGlvbiBhcHBseU5TKHZub2RlLCBucywgZm9yY2UpIHsKICB2bm9kZS5ucyA9IG5zOwoKICBpZiAodm5vZGUudGFnID09PSAnZm9yZWlnbk9iamVjdCcpIHsKICAgIC8vIHVzZSBkZWZhdWx0IG5hbWVzcGFjZSBpbnNpZGUgZm9yZWlnbk9iamVjdAogICAgbnMgPSB1bmRlZmluZWQ7CiAgICBmb3JjZSA9IHRydWU7CiAgfQoKICBpZiAoaXNEZWYodm5vZGUuY2hpbGRyZW4pKSB7CiAgICBmb3IgKHZhciBpID0gMCwgbCA9IHZub2RlLmNoaWxkcmVuLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICB2YXIgY2hpbGQgPSB2bm9kZS5jaGlsZHJlbltpXTsKCiAgICAgIGlmIChpc0RlZihjaGlsZC50YWcpICYmIChpc1VuZGVmKGNoaWxkLm5zKSB8fCBpc1RydWUoZm9yY2UpICYmIGNoaWxkLnRhZyAhPT0gJ3N2ZycpKSB7CiAgICAgICAgYXBwbHlOUyhjaGlsZCwgbnMsIGZvcmNlKTsKICAgICAgfQogICAgfQogIH0KfSAvLyByZWYgIzUzMTgKLy8gbmVjZXNzYXJ5IHRvIGVuc3VyZSBwYXJlbnQgcmUtcmVuZGVyIHdoZW4gZGVlcCBiaW5kaW5ncyBsaWtlIDpzdHlsZSBhbmQKLy8gOmNsYXNzIGFyZSB1c2VkIG9uIHNsb3Qgbm9kZXMKCgpmdW5jdGlvbiByZWdpc3RlckRlZXBCaW5kaW5ncyhkYXRhKSB7CiAgaWYgKGlzT2JqZWN0KGRhdGEuc3R5bGUpKSB7CiAgICB0cmF2ZXJzZShkYXRhLnN0eWxlKTsKICB9CgogIGlmIChpc09iamVjdChkYXRhWyJjbGFzcyJdKSkgewogICAgdHJhdmVyc2UoZGF0YVsiY2xhc3MiXSk7CiAgfQp9Ci8qICAqLwoKCmZ1bmN0aW9uIGluaXRSZW5kZXIodm0pIHsKICB2bS5fdm5vZGUgPSBudWxsOyAvLyB0aGUgcm9vdCBvZiB0aGUgY2hpbGQgdHJlZQoKICB2bS5fc3RhdGljVHJlZXMgPSBudWxsOyAvLyB2LW9uY2UgY2FjaGVkIHRyZWVzCgogIHZhciBvcHRpb25zID0gdm0uJG9wdGlvbnM7CiAgdmFyIHBhcmVudFZub2RlID0gdm0uJHZub2RlID0gb3B0aW9ucy5fcGFyZW50Vm5vZGU7IC8vIHRoZSBwbGFjZWhvbGRlciBub2RlIGluIHBhcmVudCB0cmVlCgogIHZhciByZW5kZXJDb250ZXh0ID0gcGFyZW50Vm5vZGUgJiYgcGFyZW50Vm5vZGUuY29udGV4dDsKICB2bS4kc2xvdHMgPSByZXNvbHZlU2xvdHMob3B0aW9ucy5fcmVuZGVyQ2hpbGRyZW4sIHJlbmRlckNvbnRleHQpOwogIHZtLiRzY29wZWRTbG90cyA9IGVtcHR5T2JqZWN0OyAvLyBiaW5kIHRoZSBjcmVhdGVFbGVtZW50IGZuIHRvIHRoaXMgaW5zdGFuY2UKICAvLyBzbyB0aGF0IHdlIGdldCBwcm9wZXIgcmVuZGVyIGNvbnRleHQgaW5zaWRlIGl0LgogIC8vIGFyZ3Mgb3JkZXI6IHRhZywgZGF0YSwgY2hpbGRyZW4sIG5vcm1hbGl6YXRpb25UeXBlLCBhbHdheXNOb3JtYWxpemUKICAvLyBpbnRlcm5hbCB2ZXJzaW9uIGlzIHVzZWQgYnkgcmVuZGVyIGZ1bmN0aW9ucyBjb21waWxlZCBmcm9tIHRlbXBsYXRlcwoKICB2bS5fYyA9IGZ1bmN0aW9uIChhLCBiLCBjLCBkKSB7CiAgICByZXR1cm4gY3JlYXRlRWxlbWVudCh2bSwgYSwgYiwgYywgZCwgZmFsc2UpOwogIH07IC8vIG5vcm1hbGl6YXRpb24gaXMgYWx3YXlzIGFwcGxpZWQgZm9yIHRoZSBwdWJsaWMgdmVyc2lvbiwgdXNlZCBpbgogIC8vIHVzZXItd3JpdHRlbiByZW5kZXIgZnVuY3Rpb25zLgoKCiAgdm0uJGNyZWF0ZUVsZW1lbnQgPSBmdW5jdGlvbiAoYSwgYiwgYywgZCkgewogICAgcmV0dXJuIGNyZWF0ZUVsZW1lbnQodm0sIGEsIGIsIGMsIGQsIHRydWUpOwogIH07IC8vICRhdHRycyAmICRsaXN0ZW5lcnMgYXJlIGV4cG9zZWQgZm9yIGVhc2llciBIT0MgY3JlYXRpb24uCiAgLy8gdGhleSBuZWVkIHRvIGJlIHJlYWN0aXZlIHNvIHRoYXQgSE9DcyB1c2luZyB0aGVtIGFyZSBhbHdheXMgdXBkYXRlZAoKCiAgdmFyIHBhcmVudERhdGEgPSBwYXJlbnRWbm9kZSAmJiBwYXJlbnRWbm9kZS5kYXRhOwogIC8qIGlzdGFuYnVsIGlnbm9yZSBlbHNlICovCgogIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICBkZWZpbmVSZWFjdGl2ZSQkMSh2bSwgJyRhdHRycycsIHBhcmVudERhdGEgJiYgcGFyZW50RGF0YS5hdHRycyB8fCBlbXB0eU9iamVjdCwgZnVuY3Rpb24gKCkgewogICAgICAhaXNVcGRhdGluZ0NoaWxkQ29tcG9uZW50ICYmIHdhcm4oIiRhdHRycyBpcyByZWFkb25seS4iLCB2bSk7CiAgICB9LCB0cnVlKTsKICAgIGRlZmluZVJlYWN0aXZlJCQxKHZtLCAnJGxpc3RlbmVycycsIG9wdGlvbnMuX3BhcmVudExpc3RlbmVycyB8fCBlbXB0eU9iamVjdCwgZnVuY3Rpb24gKCkgewogICAgICAhaXNVcGRhdGluZ0NoaWxkQ29tcG9uZW50ICYmIHdhcm4oIiRsaXN0ZW5lcnMgaXMgcmVhZG9ubHkuIiwgdm0pOwogICAgfSwgdHJ1ZSk7CiAgfSBlbHNlIHsKICAgIGRlZmluZVJlYWN0aXZlJCQxKHZtLCAnJGF0dHJzJywgcGFyZW50RGF0YSAmJiBwYXJlbnREYXRhLmF0dHJzIHx8IGVtcHR5T2JqZWN0LCBudWxsLCB0cnVlKTsKICAgIGRlZmluZVJlYWN0aXZlJCQxKHZtLCAnJGxpc3RlbmVycycsIG9wdGlvbnMuX3BhcmVudExpc3RlbmVycyB8fCBlbXB0eU9iamVjdCwgbnVsbCwgdHJ1ZSk7CiAgfQp9Cgp2YXIgY3VycmVudFJlbmRlcmluZ0luc3RhbmNlID0gbnVsbDsKCmZ1bmN0aW9uIHJlbmRlck1peGluKFZ1ZSkgewogIC8vIGluc3RhbGwgcnVudGltZSBjb252ZW5pZW5jZSBoZWxwZXJzCiAgaW5zdGFsbFJlbmRlckhlbHBlcnMoVnVlLnByb3RvdHlwZSk7CgogIFZ1ZS5wcm90b3R5cGUuJG5leHRUaWNrID0gZnVuY3Rpb24gKGZuKSB7CiAgICByZXR1cm4gbmV4dFRpY2soZm4sIHRoaXMpOwogIH07CgogIFZ1ZS5wcm90b3R5cGUuX3JlbmRlciA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciB2bSA9IHRoaXM7CiAgICB2YXIgcmVmID0gdm0uJG9wdGlvbnM7CiAgICB2YXIgcmVuZGVyID0gcmVmLnJlbmRlcjsKICAgIHZhciBfcGFyZW50Vm5vZGUgPSByZWYuX3BhcmVudFZub2RlOwoKICAgIGlmIChfcGFyZW50Vm5vZGUpIHsKICAgICAgdm0uJHNjb3BlZFNsb3RzID0gbm9ybWFsaXplU2NvcGVkU2xvdHMoX3BhcmVudFZub2RlLmRhdGEuc2NvcGVkU2xvdHMsIHZtLiRzbG90cywgdm0uJHNjb3BlZFNsb3RzKTsKICAgIH0gLy8gc2V0IHBhcmVudCB2bm9kZS4gdGhpcyBhbGxvd3MgcmVuZGVyIGZ1bmN0aW9ucyB0byBoYXZlIGFjY2VzcwogICAgLy8gdG8gdGhlIGRhdGEgb24gdGhlIHBsYWNlaG9sZGVyIG5vZGUuCgoKICAgIHZtLiR2bm9kZSA9IF9wYXJlbnRWbm9kZTsgLy8gcmVuZGVyIHNlbGYKCiAgICB2YXIgdm5vZGU7CgogICAgdHJ5IHsKICAgICAgLy8gVGhlcmUncyBubyBuZWVkIHRvIG1haW50YWluIGEgc3RhY2sgYmVjYXVlcyBhbGwgcmVuZGVyIGZucyBhcmUgY2FsbGVkCiAgICAgIC8vIHNlcGFyYXRlbHkgZnJvbSBvbmUgYW5vdGhlci4gTmVzdGVkIGNvbXBvbmVudCdzIHJlbmRlciBmbnMgYXJlIGNhbGxlZAogICAgICAvLyB3aGVuIHBhcmVudCBjb21wb25lbnQgaXMgcGF0Y2hlZC4KICAgICAgY3VycmVudFJlbmRlcmluZ0luc3RhbmNlID0gdm07CiAgICAgIHZub2RlID0gcmVuZGVyLmNhbGwodm0uX3JlbmRlclByb3h5LCB2bS4kY3JlYXRlRWxlbWVudCk7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIGhhbmRsZUVycm9yKGUsIHZtLCAicmVuZGVyIik7IC8vIHJldHVybiBlcnJvciByZW5kZXIgcmVzdWx0LAogICAgICAvLyBvciBwcmV2aW91cyB2bm9kZSB0byBwcmV2ZW50IHJlbmRlciBlcnJvciBjYXVzaW5nIGJsYW5rIGNvbXBvbmVudAoKICAgICAgLyogaXN0YW5idWwgaWdub3JlIGVsc2UgKi8KCiAgICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIHZtLiRvcHRpb25zLnJlbmRlckVycm9yKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHZub2RlID0gdm0uJG9wdGlvbnMucmVuZGVyRXJyb3IuY2FsbCh2bS5fcmVuZGVyUHJveHksIHZtLiRjcmVhdGVFbGVtZW50LCBlKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICBoYW5kbGVFcnJvcihlLCB2bSwgInJlbmRlckVycm9yIik7CiAgICAgICAgICB2bm9kZSA9IHZtLl92bm9kZTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdm5vZGUgPSB2bS5fdm5vZGU7CiAgICAgIH0KICAgIH0gZmluYWxseSB7CiAgICAgIGN1cnJlbnRSZW5kZXJpbmdJbnN0YW5jZSA9IG51bGw7CiAgICB9IC8vIGlmIHRoZSByZXR1cm5lZCBhcnJheSBjb250YWlucyBvbmx5IGEgc2luZ2xlIG5vZGUsIGFsbG93IGl0CgoKICAgIGlmIChBcnJheS5pc0FycmF5KHZub2RlKSAmJiB2bm9kZS5sZW5ndGggPT09IDEpIHsKICAgICAgdm5vZGUgPSB2bm9kZVswXTsKICAgIH0gLy8gcmV0dXJuIGVtcHR5IHZub2RlIGluIGNhc2UgdGhlIHJlbmRlciBmdW5jdGlvbiBlcnJvcmVkIG91dAoKCiAgICBpZiAoISh2bm9kZSBpbnN0YW5jZW9mIFZOb2RlKSkgewogICAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiBBcnJheS5pc0FycmF5KHZub2RlKSkgewogICAgICAgIHdhcm4oJ011bHRpcGxlIHJvb3Qgbm9kZXMgcmV0dXJuZWQgZnJvbSByZW5kZXIgZnVuY3Rpb24uIFJlbmRlciBmdW5jdGlvbiAnICsgJ3Nob3VsZCByZXR1cm4gYSBzaW5nbGUgcm9vdCBub2RlLicsIHZtKTsKICAgICAgfQoKICAgICAgdm5vZGUgPSBjcmVhdGVFbXB0eVZOb2RlKCk7CiAgICB9IC8vIHNldCBwYXJlbnQKCgogICAgdm5vZGUucGFyZW50ID0gX3BhcmVudFZub2RlOwogICAgcmV0dXJuIHZub2RlOwogIH07Cn0KLyogICovCgoKZnVuY3Rpb24gZW5zdXJlQ3Rvcihjb21wLCBiYXNlKSB7CiAgaWYgKGNvbXAuX19lc01vZHVsZSB8fCBoYXNTeW1ib2wgJiYgY29tcFtTeW1ib2wudG9TdHJpbmdUYWddID09PSAnTW9kdWxlJykgewogICAgY29tcCA9IGNvbXBbImRlZmF1bHQiXTsKICB9CgogIHJldHVybiBpc09iamVjdChjb21wKSA/IGJhc2UuZXh0ZW5kKGNvbXApIDogY29tcDsKfQoKZnVuY3Rpb24gY3JlYXRlQXN5bmNQbGFjZWhvbGRlcihmYWN0b3J5LCBkYXRhLCBjb250ZXh0LCBjaGlsZHJlbiwgdGFnKSB7CiAgdmFyIG5vZGUgPSBjcmVhdGVFbXB0eVZOb2RlKCk7CiAgbm9kZS5hc3luY0ZhY3RvcnkgPSBmYWN0b3J5OwogIG5vZGUuYXN5bmNNZXRhID0gewogICAgZGF0YTogZGF0YSwKICAgIGNvbnRleHQ6IGNvbnRleHQsCiAgICBjaGlsZHJlbjogY2hpbGRyZW4sCiAgICB0YWc6IHRhZwogIH07CiAgcmV0dXJuIG5vZGU7Cn0KCmZ1bmN0aW9uIHJlc29sdmVBc3luY0NvbXBvbmVudChmYWN0b3J5LCBiYXNlQ3RvcikgewogIGlmIChpc1RydWUoZmFjdG9yeS5lcnJvcikgJiYgaXNEZWYoZmFjdG9yeS5lcnJvckNvbXApKSB7CiAgICByZXR1cm4gZmFjdG9yeS5lcnJvckNvbXA7CiAgfQoKICBpZiAoaXNEZWYoZmFjdG9yeS5yZXNvbHZlZCkpIHsKICAgIHJldHVybiBmYWN0b3J5LnJlc29sdmVkOwogIH0KCiAgdmFyIG93bmVyID0gY3VycmVudFJlbmRlcmluZ0luc3RhbmNlOwoKICBpZiAob3duZXIgJiYgaXNEZWYoZmFjdG9yeS5vd25lcnMpICYmIGZhY3Rvcnkub3duZXJzLmluZGV4T2Yob3duZXIpID09PSAtMSkgewogICAgLy8gYWxyZWFkeSBwZW5kaW5nCiAgICBmYWN0b3J5Lm93bmVycy5wdXNoKG93bmVyKTsKICB9CgogIGlmIChpc1RydWUoZmFjdG9yeS5sb2FkaW5nKSAmJiBpc0RlZihmYWN0b3J5LmxvYWRpbmdDb21wKSkgewogICAgcmV0dXJuIGZhY3RvcnkubG9hZGluZ0NvbXA7CiAgfQoKICBpZiAob3duZXIgJiYgIWlzRGVmKGZhY3Rvcnkub3duZXJzKSkgewogICAgdmFyIG93bmVycyA9IGZhY3Rvcnkub3duZXJzID0gW293bmVyXTsKICAgIHZhciBzeW5jID0gdHJ1ZTsKICAgIHZhciB0aW1lckxvYWRpbmcgPSBudWxsOwogICAgdmFyIHRpbWVyVGltZW91dCA9IG51bGw7CiAgICBvd25lci4kb24oJ2hvb2s6ZGVzdHJveWVkJywgZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gcmVtb3ZlKG93bmVycywgb3duZXIpOwogICAgfSk7CgogICAgdmFyIGZvcmNlUmVuZGVyID0gZnVuY3Rpb24gZm9yY2VSZW5kZXIocmVuZGVyQ29tcGxldGVkKSB7CiAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gb3duZXJzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIG93bmVyc1tpXS4kZm9yY2VVcGRhdGUoKTsKICAgICAgfQoKICAgICAgaWYgKHJlbmRlckNvbXBsZXRlZCkgewogICAgICAgIG93bmVycy5sZW5ndGggPSAwOwoKICAgICAgICBpZiAodGltZXJMb2FkaW5nICE9PSBudWxsKSB7CiAgICAgICAgICBjbGVhclRpbWVvdXQodGltZXJMb2FkaW5nKTsKICAgICAgICAgIHRpbWVyTG9hZGluZyA9IG51bGw7CiAgICAgICAgfQoKICAgICAgICBpZiAodGltZXJUaW1lb3V0ICE9PSBudWxsKSB7CiAgICAgICAgICBjbGVhclRpbWVvdXQodGltZXJUaW1lb3V0KTsKICAgICAgICAgIHRpbWVyVGltZW91dCA9IG51bGw7CiAgICAgICAgfQogICAgICB9CiAgICB9OwoKICAgIHZhciByZXNvbHZlID0gb25jZShmdW5jdGlvbiAocmVzKSB7CiAgICAgIC8vIGNhY2hlIHJlc29sdmVkCiAgICAgIGZhY3RvcnkucmVzb2x2ZWQgPSBlbnN1cmVDdG9yKHJlcywgYmFzZUN0b3IpOyAvLyBpbnZva2UgY2FsbGJhY2tzIG9ubHkgaWYgdGhpcyBpcyBub3QgYSBzeW5jaHJvbm91cyByZXNvbHZlCiAgICAgIC8vIChhc3luYyByZXNvbHZlcyBhcmUgc2hpbW1lZCBhcyBzeW5jaHJvbm91cyBkdXJpbmcgU1NSKQoKICAgICAgaWYgKCFzeW5jKSB7CiAgICAgICAgZm9yY2VSZW5kZXIodHJ1ZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgb3duZXJzLmxlbmd0aCA9IDA7CiAgICAgIH0KICAgIH0pOwogICAgdmFyIHJlamVjdCA9IG9uY2UoZnVuY3Rpb24gKHJlYXNvbikgewogICAgICBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIHdhcm4oIkZhaWxlZCB0byByZXNvbHZlIGFzeW5jIGNvbXBvbmVudDogIiArIFN0cmluZyhmYWN0b3J5KSArIChyZWFzb24gPyAiXG5SZWFzb246ICIgKyByZWFzb24gOiAnJykpOwoKICAgICAgaWYgKGlzRGVmKGZhY3RvcnkuZXJyb3JDb21wKSkgewogICAgICAgIGZhY3RvcnkuZXJyb3IgPSB0cnVlOwogICAgICAgIGZvcmNlUmVuZGVyKHRydWUpOwogICAgICB9CiAgICB9KTsKICAgIHZhciByZXMgPSBmYWN0b3J5KHJlc29sdmUsIHJlamVjdCk7CgogICAgaWYgKGlzT2JqZWN0KHJlcykpIHsKICAgICAgaWYgKGlzUHJvbWlzZShyZXMpKSB7CiAgICAgICAgLy8gKCkgPT4gUHJvbWlzZQogICAgICAgIGlmIChpc1VuZGVmKGZhY3RvcnkucmVzb2x2ZWQpKSB7CiAgICAgICAgICByZXMudGhlbihyZXNvbHZlLCByZWplY3QpOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChpc1Byb21pc2UocmVzLmNvbXBvbmVudCkpIHsKICAgICAgICByZXMuY29tcG9uZW50LnRoZW4ocmVzb2x2ZSwgcmVqZWN0KTsKCiAgICAgICAgaWYgKGlzRGVmKHJlcy5lcnJvcikpIHsKICAgICAgICAgIGZhY3RvcnkuZXJyb3JDb21wID0gZW5zdXJlQ3RvcihyZXMuZXJyb3IsIGJhc2VDdG9yKTsKICAgICAgICB9CgogICAgICAgIGlmIChpc0RlZihyZXMubG9hZGluZykpIHsKICAgICAgICAgIGZhY3RvcnkubG9hZGluZ0NvbXAgPSBlbnN1cmVDdG9yKHJlcy5sb2FkaW5nLCBiYXNlQ3Rvcik7CgogICAgICAgICAgaWYgKHJlcy5kZWxheSA9PT0gMCkgewogICAgICAgICAgICBmYWN0b3J5LmxvYWRpbmcgPSB0cnVlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGltZXJMb2FkaW5nID0gc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgdGltZXJMb2FkaW5nID0gbnVsbDsKCiAgICAgICAgICAgICAgaWYgKGlzVW5kZWYoZmFjdG9yeS5yZXNvbHZlZCkgJiYgaXNVbmRlZihmYWN0b3J5LmVycm9yKSkgewogICAgICAgICAgICAgICAgZmFjdG9yeS5sb2FkaW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGZvcmNlUmVuZGVyKGZhbHNlKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIHJlcy5kZWxheSB8fCAyMDApOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKGlzRGVmKHJlcy50aW1lb3V0KSkgewogICAgICAgICAgdGltZXJUaW1lb3V0ID0gc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHRpbWVyVGltZW91dCA9IG51bGw7CgogICAgICAgICAgICBpZiAoaXNVbmRlZihmYWN0b3J5LnJlc29sdmVkKSkgewogICAgICAgICAgICAgIHJlamVjdChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nID8gInRpbWVvdXQgKCIgKyByZXMudGltZW91dCArICJtcykiIDogbnVsbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sIHJlcy50aW1lb3V0KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBzeW5jID0gZmFsc2U7IC8vIHJldHVybiBpbiBjYXNlIHJlc29sdmVkIHN5bmNocm9ub3VzbHkKCiAgICByZXR1cm4gZmFjdG9yeS5sb2FkaW5nID8gZmFjdG9yeS5sb2FkaW5nQ29tcCA6IGZhY3RvcnkucmVzb2x2ZWQ7CiAgfQp9Ci8qICAqLwoKCmZ1bmN0aW9uIGlzQXN5bmNQbGFjZWhvbGRlcihub2RlKSB7CiAgcmV0dXJuIG5vZGUuaXNDb21tZW50ICYmIG5vZGUuYXN5bmNGYWN0b3J5Owp9Ci8qICAqLwoKCmZ1bmN0aW9uIGdldEZpcnN0Q29tcG9uZW50Q2hpbGQoY2hpbGRyZW4pIHsKICBpZiAoQXJyYXkuaXNBcnJheShjaGlsZHJlbikpIHsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHsKICAgICAgdmFyIGMgPSBjaGlsZHJlbltpXTsKCiAgICAgIGlmIChpc0RlZihjKSAmJiAoaXNEZWYoYy5jb21wb25lbnRPcHRpb25zKSB8fCBpc0FzeW5jUGxhY2Vob2xkZXIoYykpKSB7CiAgICAgICAgcmV0dXJuIGM7CiAgICAgIH0KICAgIH0KICB9Cn0KLyogICovCgovKiAgKi8KCgpmdW5jdGlvbiBpbml0RXZlbnRzKHZtKSB7CiAgdm0uX2V2ZW50cyA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgdm0uX2hhc0hvb2tFdmVudCA9IGZhbHNlOyAvLyBpbml0IHBhcmVudCBhdHRhY2hlZCBldmVudHMKCiAgdmFyIGxpc3RlbmVycyA9IHZtLiRvcHRpb25zLl9wYXJlbnRMaXN0ZW5lcnM7CgogIGlmIChsaXN0ZW5lcnMpIHsKICAgIHVwZGF0ZUNvbXBvbmVudExpc3RlbmVycyh2bSwgbGlzdGVuZXJzKTsKICB9Cn0KCnZhciB0YXJnZXQ7CgpmdW5jdGlvbiBhZGQoZXZlbnQsIGZuKSB7CiAgdGFyZ2V0LiRvbihldmVudCwgZm4pOwp9CgpmdW5jdGlvbiByZW1vdmUkMShldmVudCwgZm4pIHsKICB0YXJnZXQuJG9mZihldmVudCwgZm4pOwp9CgpmdW5jdGlvbiBjcmVhdGVPbmNlSGFuZGxlcihldmVudCwgZm4pIHsKICB2YXIgX3RhcmdldCA9IHRhcmdldDsKICByZXR1cm4gZnVuY3Rpb24gb25jZUhhbmRsZXIoKSB7CiAgICB2YXIgcmVzID0gZm4uYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKCiAgICBpZiAocmVzICE9PSBudWxsKSB7CiAgICAgIF90YXJnZXQuJG9mZihldmVudCwgb25jZUhhbmRsZXIpOwogICAgfQogIH07Cn0KCmZ1bmN0aW9uIHVwZGF0ZUNvbXBvbmVudExpc3RlbmVycyh2bSwgbGlzdGVuZXJzLCBvbGRMaXN0ZW5lcnMpIHsKICB0YXJnZXQgPSB2bTsKICB1cGRhdGVMaXN0ZW5lcnMobGlzdGVuZXJzLCBvbGRMaXN0ZW5lcnMgfHwge30sIGFkZCwgcmVtb3ZlJDEsIGNyZWF0ZU9uY2VIYW5kbGVyLCB2bSk7CiAgdGFyZ2V0ID0gdW5kZWZpbmVkOwp9CgpmdW5jdGlvbiBldmVudHNNaXhpbihWdWUpIHsKICB2YXIgaG9va1JFID0gL15ob29rOi87CgogIFZ1ZS5wcm90b3R5cGUuJG9uID0gZnVuY3Rpb24gKGV2ZW50LCBmbikgewogICAgdmFyIHZtID0gdGhpczsKCiAgICBpZiAoQXJyYXkuaXNBcnJheShldmVudCkpIHsKICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBldmVudC5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICB2bS4kb24oZXZlbnRbaV0sIGZuKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgKHZtLl9ldmVudHNbZXZlbnRdIHx8ICh2bS5fZXZlbnRzW2V2ZW50XSA9IFtdKSkucHVzaChmbik7IC8vIG9wdGltaXplIGhvb2s6ZXZlbnQgY29zdCBieSB1c2luZyBhIGJvb2xlYW4gZmxhZyBtYXJrZWQgYXQgcmVnaXN0cmF0aW9uCiAgICAgIC8vIGluc3RlYWQgb2YgYSBoYXNoIGxvb2t1cAoKICAgICAgaWYgKGhvb2tSRS50ZXN0KGV2ZW50KSkgewogICAgICAgIHZtLl9oYXNIb29rRXZlbnQgPSB0cnVlOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHZtOwogIH07CgogIFZ1ZS5wcm90b3R5cGUuJG9uY2UgPSBmdW5jdGlvbiAoZXZlbnQsIGZuKSB7CiAgICB2YXIgdm0gPSB0aGlzOwoKICAgIGZ1bmN0aW9uIG9uKCkgewogICAgICB2bS4kb2ZmKGV2ZW50LCBvbik7CiAgICAgIGZuLmFwcGx5KHZtLCBhcmd1bWVudHMpOwogICAgfQoKICAgIG9uLmZuID0gZm47CiAgICB2bS4kb24oZXZlbnQsIG9uKTsKICAgIHJldHVybiB2bTsKICB9OwoKICBWdWUucHJvdG90eXBlLiRvZmYgPSBmdW5jdGlvbiAoZXZlbnQsIGZuKSB7CiAgICB2YXIgdm0gPSB0aGlzOyAvLyBhbGwKCiAgICBpZiAoIWFyZ3VtZW50cy5sZW5ndGgpIHsKICAgICAgdm0uX2V2ZW50cyA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgICAgIHJldHVybiB2bTsKICAgIH0gLy8gYXJyYXkgb2YgZXZlbnRzCgoKICAgIGlmIChBcnJheS5pc0FycmF5KGV2ZW50KSkgewogICAgICBmb3IgKHZhciBpJDEgPSAwLCBsID0gZXZlbnQubGVuZ3RoOyBpJDEgPCBsOyBpJDErKykgewogICAgICAgIHZtLiRvZmYoZXZlbnRbaSQxXSwgZm4pOwogICAgICB9CgogICAgICByZXR1cm4gdm07CiAgICB9IC8vIHNwZWNpZmljIGV2ZW50CgoKICAgIHZhciBjYnMgPSB2bS5fZXZlbnRzW2V2ZW50XTsKCiAgICBpZiAoIWNicykgewogICAgICByZXR1cm4gdm07CiAgICB9CgogICAgaWYgKCFmbikgewogICAgICB2bS5fZXZlbnRzW2V2ZW50XSA9IG51bGw7CiAgICAgIHJldHVybiB2bTsKICAgIH0gLy8gc3BlY2lmaWMgaGFuZGxlcgoKCiAgICB2YXIgY2I7CiAgICB2YXIgaSA9IGNicy5sZW5ndGg7CgogICAgd2hpbGUgKGktLSkgewogICAgICBjYiA9IGNic1tpXTsKCiAgICAgIGlmIChjYiA9PT0gZm4gfHwgY2IuZm4gPT09IGZuKSB7CiAgICAgICAgY2JzLnNwbGljZShpLCAxKTsKICAgICAgICBicmVhazsKICAgICAgfQogICAgfQoKICAgIHJldHVybiB2bTsKICB9OwoKICBWdWUucHJvdG90eXBlLiRlbWl0ID0gZnVuY3Rpb24gKGV2ZW50KSB7CiAgICB2YXIgdm0gPSB0aGlzOwoKICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICAgIHZhciBsb3dlckNhc2VFdmVudCA9IGV2ZW50LnRvTG93ZXJDYXNlKCk7CgogICAgICBpZiAobG93ZXJDYXNlRXZlbnQgIT09IGV2ZW50ICYmIHZtLl9ldmVudHNbbG93ZXJDYXNlRXZlbnRdKSB7CiAgICAgICAgdGlwKCJFdmVudCBcIiIgKyBsb3dlckNhc2VFdmVudCArICJcIiBpcyBlbWl0dGVkIGluIGNvbXBvbmVudCAiICsgZm9ybWF0Q29tcG9uZW50TmFtZSh2bSkgKyAiIGJ1dCB0aGUgaGFuZGxlciBpcyByZWdpc3RlcmVkIGZvciBcIiIgKyBldmVudCArICJcIi4gIiArICJOb3RlIHRoYXQgSFRNTCBhdHRyaWJ1dGVzIGFyZSBjYXNlLWluc2Vuc2l0aXZlIGFuZCB5b3UgY2Fubm90IHVzZSAiICsgInYtb24gdG8gbGlzdGVuIHRvIGNhbWVsQ2FzZSBldmVudHMgd2hlbiB1c2luZyBpbi1ET00gdGVtcGxhdGVzLiAiICsgIllvdSBzaG91bGQgcHJvYmFibHkgdXNlIFwiIiArIGh5cGhlbmF0ZShldmVudCkgKyAiXCIgaW5zdGVhZCBvZiBcIiIgKyBldmVudCArICJcIi4iKTsKICAgICAgfQogICAgfQoKICAgIHZhciBjYnMgPSB2bS5fZXZlbnRzW2V2ZW50XTsKCiAgICBpZiAoY2JzKSB7CiAgICAgIGNicyA9IGNicy5sZW5ndGggPiAxID8gdG9BcnJheShjYnMpIDogY2JzOwogICAgICB2YXIgYXJncyA9IHRvQXJyYXkoYXJndW1lbnRzLCAxKTsKICAgICAgdmFyIGluZm8gPSAiZXZlbnQgaGFuZGxlciBmb3IgXCIiICsgZXZlbnQgKyAiXCIiOwoKICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBjYnMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgaW52b2tlV2l0aEVycm9ySGFuZGxpbmcoY2JzW2ldLCB2bSwgYXJncywgdm0sIGluZm8pOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHZtOwogIH07Cn0KLyogICovCgoKdmFyIGFjdGl2ZUluc3RhbmNlID0gbnVsbDsKdmFyIGlzVXBkYXRpbmdDaGlsZENvbXBvbmVudCA9IGZhbHNlOwoKZnVuY3Rpb24gc2V0QWN0aXZlSW5zdGFuY2Uodm0pIHsKICB2YXIgcHJldkFjdGl2ZUluc3RhbmNlID0gYWN0aXZlSW5zdGFuY2U7CiAgYWN0aXZlSW5zdGFuY2UgPSB2bTsKICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgYWN0aXZlSW5zdGFuY2UgPSBwcmV2QWN0aXZlSW5zdGFuY2U7CiAgfTsKfQoKZnVuY3Rpb24gaW5pdExpZmVjeWNsZSh2bSkgewogIHZhciBvcHRpb25zID0gdm0uJG9wdGlvbnM7IC8vIGxvY2F0ZSBmaXJzdCBub24tYWJzdHJhY3QgcGFyZW50CgogIHZhciBwYXJlbnQgPSBvcHRpb25zLnBhcmVudDsKCiAgaWYgKHBhcmVudCAmJiAhb3B0aW9uc1siYWJzdHJhY3QiXSkgewogICAgd2hpbGUgKHBhcmVudC4kb3B0aW9uc1siYWJzdHJhY3QiXSAmJiBwYXJlbnQuJHBhcmVudCkgewogICAgICBwYXJlbnQgPSBwYXJlbnQuJHBhcmVudDsKICAgIH0KCiAgICBwYXJlbnQuJGNoaWxkcmVuLnB1c2godm0pOwogIH0KCiAgdm0uJHBhcmVudCA9IHBhcmVudDsKICB2bS4kcm9vdCA9IHBhcmVudCA/IHBhcmVudC4kcm9vdCA6IHZtOwogIHZtLiRjaGlsZHJlbiA9IFtdOwogIHZtLiRyZWZzID0ge307CiAgdm0uX3dhdGNoZXIgPSBudWxsOwogIHZtLl9pbmFjdGl2ZSA9IG51bGw7CiAgdm0uX2RpcmVjdEluYWN0aXZlID0gZmFsc2U7CiAgdm0uX2lzTW91bnRlZCA9IGZhbHNlOwogIHZtLl9pc0Rlc3Ryb3llZCA9IGZhbHNlOwogIHZtLl9pc0JlaW5nRGVzdHJveWVkID0gZmFsc2U7Cn0KCmZ1bmN0aW9uIGxpZmVjeWNsZU1peGluKFZ1ZSkgewogIFZ1ZS5wcm90b3R5cGUuX3VwZGF0ZSA9IGZ1bmN0aW9uICh2bm9kZSwgaHlkcmF0aW5nKSB7CiAgICB2YXIgdm0gPSB0aGlzOwogICAgdmFyIHByZXZFbCA9IHZtLiRlbDsKICAgIHZhciBwcmV2Vm5vZGUgPSB2bS5fdm5vZGU7CiAgICB2YXIgcmVzdG9yZUFjdGl2ZUluc3RhbmNlID0gc2V0QWN0aXZlSW5zdGFuY2Uodm0pOwogICAgdm0uX3Zub2RlID0gdm5vZGU7IC8vIFZ1ZS5wcm90b3R5cGUuX19wYXRjaF9fIGlzIGluamVjdGVkIGluIGVudHJ5IHBvaW50cwogICAgLy8gYmFzZWQgb24gdGhlIHJlbmRlcmluZyBiYWNrZW5kIHVzZWQuCgogICAgaWYgKCFwcmV2Vm5vZGUpIHsKICAgICAgLy8gaW5pdGlhbCByZW5kZXIKICAgICAgdm0uJGVsID0gdm0uX19wYXRjaF9fKHZtLiRlbCwgdm5vZGUsIGh5ZHJhdGluZywgZmFsc2UKICAgICAgLyogcmVtb3ZlT25seSAqLwogICAgICApOwogICAgfSBlbHNlIHsKICAgICAgLy8gdXBkYXRlcwogICAgICB2bS4kZWwgPSB2bS5fX3BhdGNoX18ocHJldlZub2RlLCB2bm9kZSk7CiAgICB9CgogICAgcmVzdG9yZUFjdGl2ZUluc3RhbmNlKCk7IC8vIHVwZGF0ZSBfX3Z1ZV9fIHJlZmVyZW5jZQoKICAgIGlmIChwcmV2RWwpIHsKICAgICAgcHJldkVsLl9fdnVlX18gPSBudWxsOwogICAgfQoKICAgIGlmICh2bS4kZWwpIHsKICAgICAgdm0uJGVsLl9fdnVlX18gPSB2bTsKICAgIH0gLy8gaWYgcGFyZW50IGlzIGFuIEhPQywgdXBkYXRlIGl0cyAkZWwgYXMgd2VsbAoKCiAgICBpZiAodm0uJHZub2RlICYmIHZtLiRwYXJlbnQgJiYgdm0uJHZub2RlID09PSB2bS4kcGFyZW50Ll92bm9kZSkgewogICAgICB2bS4kcGFyZW50LiRlbCA9IHZtLiRlbDsKICAgIH0gLy8gdXBkYXRlZCBob29rIGlzIGNhbGxlZCBieSB0aGUgc2NoZWR1bGVyIHRvIGVuc3VyZSB0aGF0IGNoaWxkcmVuIGFyZQogICAgLy8gdXBkYXRlZCBpbiBhIHBhcmVudCdzIHVwZGF0ZWQgaG9vay4KCiAgfTsKCiAgVnVlLnByb3RvdHlwZS4kZm9yY2VVcGRhdGUgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgdm0gPSB0aGlzOwoKICAgIGlmICh2bS5fd2F0Y2hlcikgewogICAgICB2bS5fd2F0Y2hlci51cGRhdGUoKTsKICAgIH0KICB9OwoKICBWdWUucHJvdG90eXBlLiRkZXN0cm95ID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHZtID0gdGhpczsKCiAgICBpZiAodm0uX2lzQmVpbmdEZXN0cm95ZWQpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIGNhbGxIb29rKHZtLCAnYmVmb3JlRGVzdHJveScpOwogICAgdm0uX2lzQmVpbmdEZXN0cm95ZWQgPSB0cnVlOyAvLyByZW1vdmUgc2VsZiBmcm9tIHBhcmVudAoKICAgIHZhciBwYXJlbnQgPSB2bS4kcGFyZW50OwoKICAgIGlmIChwYXJlbnQgJiYgIXBhcmVudC5faXNCZWluZ0Rlc3Ryb3llZCAmJiAhdm0uJG9wdGlvbnNbImFic3RyYWN0Il0pIHsKICAgICAgcmVtb3ZlKHBhcmVudC4kY2hpbGRyZW4sIHZtKTsKICAgIH0gLy8gdGVhcmRvd24gd2F0Y2hlcnMKCgogICAgaWYgKHZtLl93YXRjaGVyKSB7CiAgICAgIHZtLl93YXRjaGVyLnRlYXJkb3duKCk7CiAgICB9CgogICAgdmFyIGkgPSB2bS5fd2F0Y2hlcnMubGVuZ3RoOwoKICAgIHdoaWxlIChpLS0pIHsKICAgICAgdm0uX3dhdGNoZXJzW2ldLnRlYXJkb3duKCk7CiAgICB9IC8vIHJlbW92ZSByZWZlcmVuY2UgZnJvbSBkYXRhIG9iCiAgICAvLyBmcm96ZW4gb2JqZWN0IG1heSBub3QgaGF2ZSBvYnNlcnZlci4KCgogICAgaWYgKHZtLl9kYXRhLl9fb2JfXykgewogICAgICB2bS5fZGF0YS5fX29iX18udm1Db3VudC0tOwogICAgfSAvLyBjYWxsIHRoZSBsYXN0IGhvb2suLi4KCgogICAgdm0uX2lzRGVzdHJveWVkID0gdHJ1ZTsgLy8gaW52b2tlIGRlc3Ryb3kgaG9va3Mgb24gY3VycmVudCByZW5kZXJlZCB0cmVlCgogICAgdm0uX19wYXRjaF9fKHZtLl92bm9kZSwgbnVsbCk7IC8vIGZpcmUgZGVzdHJveWVkIGhvb2sKCgogICAgY2FsbEhvb2sodm0sICdkZXN0cm95ZWQnKTsgLy8gdHVybiBvZmYgYWxsIGluc3RhbmNlIGxpc3RlbmVycy4KCiAgICB2bS4kb2ZmKCk7IC8vIHJlbW92ZSBfX3Z1ZV9fIHJlZmVyZW5jZQoKICAgIGlmICh2bS4kZWwpIHsKICAgICAgdm0uJGVsLl9fdnVlX18gPSBudWxsOwogICAgfSAvLyByZWxlYXNlIGNpcmN1bGFyIHJlZmVyZW5jZSAoIzY3NTkpCgoKICAgIGlmICh2bS4kdm5vZGUpIHsKICAgICAgdm0uJHZub2RlLnBhcmVudCA9IG51bGw7CiAgICB9CiAgfTsKfQoKZnVuY3Rpb24gbW91bnRDb21wb25lbnQodm0sIGVsLCBoeWRyYXRpbmcpIHsKICB2bS4kZWwgPSBlbDsKCiAgaWYgKCF2bS4kb3B0aW9ucy5yZW5kZXIpIHsKICAgIHZtLiRvcHRpb25zLnJlbmRlciA9IGNyZWF0ZUVtcHR5Vk5vZGU7CgogICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgICAgIGlmICh2bS4kb3B0aW9ucy50ZW1wbGF0ZSAmJiB2bS4kb3B0aW9ucy50ZW1wbGF0ZS5jaGFyQXQoMCkgIT09ICcjJyB8fCB2bS4kb3B0aW9ucy5lbCB8fCBlbCkgewogICAgICAgIHdhcm4oJ1lvdSBhcmUgdXNpbmcgdGhlIHJ1bnRpbWUtb25seSBidWlsZCBvZiBWdWUgd2hlcmUgdGhlIHRlbXBsYXRlICcgKyAnY29tcGlsZXIgaXMgbm90IGF2YWlsYWJsZS4gRWl0aGVyIHByZS1jb21waWxlIHRoZSB0ZW1wbGF0ZXMgaW50byAnICsgJ3JlbmRlciBmdW5jdGlvbnMsIG9yIHVzZSB0aGUgY29tcGlsZXItaW5jbHVkZWQgYnVpbGQuJywgdm0pOwogICAgICB9IGVsc2UgewogICAgICAgIHdhcm4oJ0ZhaWxlZCB0byBtb3VudCBjb21wb25lbnQ6IHRlbXBsYXRlIG9yIHJlbmRlciBmdW5jdGlvbiBub3QgZGVmaW5lZC4nLCB2bSk7CiAgICAgIH0KICAgIH0KICB9CgogIGNhbGxIb29rKHZtLCAnYmVmb3JlTW91bnQnKTsKICB2YXIgdXBkYXRlQ29tcG9uZW50OwogIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwoKICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiBjb25maWcucGVyZm9ybWFuY2UgJiYgbWFyaykgewogICAgdXBkYXRlQ29tcG9uZW50ID0gZnVuY3Rpb24gdXBkYXRlQ29tcG9uZW50KCkgewogICAgICB2YXIgbmFtZSA9IHZtLl9uYW1lOwogICAgICB2YXIgaWQgPSB2bS5fdWlkOwogICAgICB2YXIgc3RhcnRUYWcgPSAidnVlLXBlcmYtc3RhcnQ6IiArIGlkOwogICAgICB2YXIgZW5kVGFnID0gInZ1ZS1wZXJmLWVuZDoiICsgaWQ7CiAgICAgIG1hcmsoc3RhcnRUYWcpOwoKICAgICAgdmFyIHZub2RlID0gdm0uX3JlbmRlcigpOwoKICAgICAgbWFyayhlbmRUYWcpOwogICAgICBtZWFzdXJlKCJ2dWUgIiArIG5hbWUgKyAiIHJlbmRlciIsIHN0YXJ0VGFnLCBlbmRUYWcpOwogICAgICBtYXJrKHN0YXJ0VGFnKTsKCiAgICAgIHZtLl91cGRhdGUodm5vZGUsIGh5ZHJhdGluZyk7CgogICAgICBtYXJrKGVuZFRhZyk7CiAgICAgIG1lYXN1cmUoInZ1ZSAiICsgbmFtZSArICIgcGF0Y2giLCBzdGFydFRhZywgZW5kVGFnKTsKICAgIH07CiAgfSBlbHNlIHsKICAgIHVwZGF0ZUNvbXBvbmVudCA9IGZ1bmN0aW9uIHVwZGF0ZUNvbXBvbmVudCgpIHsKICAgICAgdm0uX3VwZGF0ZSh2bS5fcmVuZGVyKCksIGh5ZHJhdGluZyk7CiAgICB9OwogIH0gLy8gd2Ugc2V0IHRoaXMgdG8gdm0uX3dhdGNoZXIgaW5zaWRlIHRoZSB3YXRjaGVyJ3MgY29uc3RydWN0b3IKICAvLyBzaW5jZSB0aGUgd2F0Y2hlcidzIGluaXRpYWwgcGF0Y2ggbWF5IGNhbGwgJGZvcmNlVXBkYXRlIChlLmcuIGluc2lkZSBjaGlsZAogIC8vIGNvbXBvbmVudCdzIG1vdW50ZWQgaG9vayksIHdoaWNoIHJlbGllcyBvbiB2bS5fd2F0Y2hlciBiZWluZyBhbHJlYWR5IGRlZmluZWQKCgogIG5ldyBXYXRjaGVyKHZtLCB1cGRhdGVDb21wb25lbnQsIG5vb3AsIHsKICAgIGJlZm9yZTogZnVuY3Rpb24gYmVmb3JlKCkgewogICAgICBpZiAodm0uX2lzTW91bnRlZCAmJiAhdm0uX2lzRGVzdHJveWVkKSB7CiAgICAgICAgY2FsbEhvb2sodm0sICdiZWZvcmVVcGRhdGUnKTsKICAgICAgfQogICAgfQogIH0sIHRydWUKICAvKiBpc1JlbmRlcldhdGNoZXIgKi8KICApOwogIGh5ZHJhdGluZyA9IGZhbHNlOyAvLyBtYW51YWxseSBtb3VudGVkIGluc3RhbmNlLCBjYWxsIG1vdW50ZWQgb24gc2VsZgogIC8vIG1vdW50ZWQgaXMgY2FsbGVkIGZvciByZW5kZXItY3JlYXRlZCBjaGlsZCBjb21wb25lbnRzIGluIGl0cyBpbnNlcnRlZCBob29rCgogIGlmICh2bS4kdm5vZGUgPT0gbnVsbCkgewogICAgdm0uX2lzTW91bnRlZCA9IHRydWU7CiAgICBjYWxsSG9vayh2bSwgJ21vdW50ZWQnKTsKICB9CgogIHJldHVybiB2bTsKfQoKZnVuY3Rpb24gdXBkYXRlQ2hpbGRDb21wb25lbnQodm0sIHByb3BzRGF0YSwgbGlzdGVuZXJzLCBwYXJlbnRWbm9kZSwgcmVuZGVyQ2hpbGRyZW4pIHsKICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgaXNVcGRhdGluZ0NoaWxkQ29tcG9uZW50ID0gdHJ1ZTsKICB9IC8vIGRldGVybWluZSB3aGV0aGVyIGNvbXBvbmVudCBoYXMgc2xvdCBjaGlsZHJlbgogIC8vIHdlIG5lZWQgdG8gZG8gdGhpcyBiZWZvcmUgb3ZlcndyaXRpbmcgJG9wdGlvbnMuX3JlbmRlckNoaWxkcmVuLgogIC8vIGNoZWNrIGlmIHRoZXJlIGFyZSBkeW5hbWljIHNjb3BlZFNsb3RzIChoYW5kLXdyaXR0ZW4gb3IgY29tcGlsZWQgYnV0IHdpdGgKICAvLyBkeW5hbWljIHNsb3QgbmFtZXMpLiBTdGF0aWMgc2NvcGVkIHNsb3RzIGNvbXBpbGVkIGZyb20gdGVtcGxhdGUgaGFzIHRoZQogIC8vICIkc3RhYmxlIiBtYXJrZXIuCgoKICB2YXIgbmV3U2NvcGVkU2xvdHMgPSBwYXJlbnRWbm9kZS5kYXRhLnNjb3BlZFNsb3RzOwogIHZhciBvbGRTY29wZWRTbG90cyA9IHZtLiRzY29wZWRTbG90czsKICB2YXIgaGFzRHluYW1pY1Njb3BlZFNsb3QgPSAhIShuZXdTY29wZWRTbG90cyAmJiAhbmV3U2NvcGVkU2xvdHMuJHN0YWJsZSB8fCBvbGRTY29wZWRTbG90cyAhPT0gZW1wdHlPYmplY3QgJiYgIW9sZFNjb3BlZFNsb3RzLiRzdGFibGUgfHwgbmV3U2NvcGVkU2xvdHMgJiYgdm0uJHNjb3BlZFNsb3RzLiRrZXkgIT09IG5ld1Njb3BlZFNsb3RzLiRrZXkpOyAvLyBBbnkgc3RhdGljIHNsb3QgY2hpbGRyZW4gZnJvbSB0aGUgcGFyZW50IG1heSBoYXZlIGNoYW5nZWQgZHVyaW5nIHBhcmVudCdzCiAgLy8gdXBkYXRlLiBEeW5hbWljIHNjb3BlZCBzbG90cyBtYXkgYWxzbyBoYXZlIGNoYW5nZWQuIEluIHN1Y2ggY2FzZXMsIGEgZm9yY2VkCiAgLy8gdXBkYXRlIGlzIG5lY2Vzc2FyeSB0byBlbnN1cmUgY29ycmVjdG5lc3MuCgogIHZhciBuZWVkc0ZvcmNlVXBkYXRlID0gISEocmVuZGVyQ2hpbGRyZW4gfHwgLy8gaGFzIG5ldyBzdGF0aWMgc2xvdHMKICB2bS4kb3B0aW9ucy5fcmVuZGVyQ2hpbGRyZW4gfHwgLy8gaGFzIG9sZCBzdGF0aWMgc2xvdHMKICBoYXNEeW5hbWljU2NvcGVkU2xvdCk7CiAgdm0uJG9wdGlvbnMuX3BhcmVudFZub2RlID0gcGFyZW50Vm5vZGU7CiAgdm0uJHZub2RlID0gcGFyZW50Vm5vZGU7IC8vIHVwZGF0ZSB2bSdzIHBsYWNlaG9sZGVyIG5vZGUgd2l0aG91dCByZS1yZW5kZXIKCiAgaWYgKHZtLl92bm9kZSkgewogICAgLy8gdXBkYXRlIGNoaWxkIHRyZWUncyBwYXJlbnQKICAgIHZtLl92bm9kZS5wYXJlbnQgPSBwYXJlbnRWbm9kZTsKICB9CgogIHZtLiRvcHRpb25zLl9yZW5kZXJDaGlsZHJlbiA9IHJlbmRlckNoaWxkcmVuOyAvLyB1cGRhdGUgJGF0dHJzIGFuZCAkbGlzdGVuZXJzIGhhc2gKICAvLyB0aGVzZSBhcmUgYWxzbyByZWFjdGl2ZSBzbyB0aGV5IG1heSB0cmlnZ2VyIGNoaWxkIHVwZGF0ZSBpZiB0aGUgY2hpbGQKICAvLyB1c2VkIHRoZW0gZHVyaW5nIHJlbmRlcgoKICB2bS4kYXR0cnMgPSBwYXJlbnRWbm9kZS5kYXRhLmF0dHJzIHx8IGVtcHR5T2JqZWN0OwogIHZtLiRsaXN0ZW5lcnMgPSBsaXN0ZW5lcnMgfHwgZW1wdHlPYmplY3Q7IC8vIHVwZGF0ZSBwcm9wcwoKICBpZiAocHJvcHNEYXRhICYmIHZtLiRvcHRpb25zLnByb3BzKSB7CiAgICB0b2dnbGVPYnNlcnZpbmcoZmFsc2UpOwogICAgdmFyIHByb3BzID0gdm0uX3Byb3BzOwogICAgdmFyIHByb3BLZXlzID0gdm0uJG9wdGlvbnMuX3Byb3BLZXlzIHx8IFtdOwoKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcEtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgdmFyIGtleSA9IHByb3BLZXlzW2ldOwogICAgICB2YXIgcHJvcE9wdGlvbnMgPSB2bS4kb3B0aW9ucy5wcm9wczsgLy8gd3RmIGZsb3c/CgogICAgICBwcm9wc1trZXldID0gdmFsaWRhdGVQcm9wKGtleSwgcHJvcE9wdGlvbnMsIHByb3BzRGF0YSwgdm0pOwogICAgfQoKICAgIHRvZ2dsZU9ic2VydmluZyh0cnVlKTsgLy8ga2VlcCBhIGNvcHkgb2YgcmF3IHByb3BzRGF0YQoKICAgIHZtLiRvcHRpb25zLnByb3BzRGF0YSA9IHByb3BzRGF0YTsKICB9IC8vIHVwZGF0ZSBsaXN0ZW5lcnMKCgogIGxpc3RlbmVycyA9IGxpc3RlbmVycyB8fCBlbXB0eU9iamVjdDsKICB2YXIgb2xkTGlzdGVuZXJzID0gdm0uJG9wdGlvbnMuX3BhcmVudExpc3RlbmVyczsKICB2bS4kb3B0aW9ucy5fcGFyZW50TGlzdGVuZXJzID0gbGlzdGVuZXJzOwogIHVwZGF0ZUNvbXBvbmVudExpc3RlbmVycyh2bSwgbGlzdGVuZXJzLCBvbGRMaXN0ZW5lcnMpOyAvLyByZXNvbHZlIHNsb3RzICsgZm9yY2UgdXBkYXRlIGlmIGhhcyBjaGlsZHJlbgoKICBpZiAobmVlZHNGb3JjZVVwZGF0ZSkgewogICAgdm0uJHNsb3RzID0gcmVzb2x2ZVNsb3RzKHJlbmRlckNoaWxkcmVuLCBwYXJlbnRWbm9kZS5jb250ZXh0KTsKICAgIHZtLiRmb3JjZVVwZGF0ZSgpOwogIH0KCiAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgIGlzVXBkYXRpbmdDaGlsZENvbXBvbmVudCA9IGZhbHNlOwogIH0KfQoKZnVuY3Rpb24gaXNJbkluYWN0aXZlVHJlZSh2bSkgewogIHdoaWxlICh2bSAmJiAodm0gPSB2bS4kcGFyZW50KSkgewogICAgaWYgKHZtLl9pbmFjdGl2ZSkgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICB9CgogIHJldHVybiBmYWxzZTsKfQoKZnVuY3Rpb24gYWN0aXZhdGVDaGlsZENvbXBvbmVudCh2bSwgZGlyZWN0KSB7CiAgaWYgKGRpcmVjdCkgewogICAgdm0uX2RpcmVjdEluYWN0aXZlID0gZmFsc2U7CgogICAgaWYgKGlzSW5JbmFjdGl2ZVRyZWUodm0pKSB7CiAgICAgIHJldHVybjsKICAgIH0KICB9IGVsc2UgaWYgKHZtLl9kaXJlY3RJbmFjdGl2ZSkgewogICAgcmV0dXJuOwogIH0KCiAgaWYgKHZtLl9pbmFjdGl2ZSB8fCB2bS5faW5hY3RpdmUgPT09IG51bGwpIHsKICAgIHZtLl9pbmFjdGl2ZSA9IGZhbHNlOwoKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdm0uJGNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7CiAgICAgIGFjdGl2YXRlQ2hpbGRDb21wb25lbnQodm0uJGNoaWxkcmVuW2ldKTsKICAgIH0KCiAgICBjYWxsSG9vayh2bSwgJ2FjdGl2YXRlZCcpOwogIH0KfQoKZnVuY3Rpb24gZGVhY3RpdmF0ZUNoaWxkQ29tcG9uZW50KHZtLCBkaXJlY3QpIHsKICBpZiAoZGlyZWN0KSB7CiAgICB2bS5fZGlyZWN0SW5hY3RpdmUgPSB0cnVlOwoKICAgIGlmIChpc0luSW5hY3RpdmVUcmVlKHZtKSkgewogICAgICByZXR1cm47CiAgICB9CiAgfQoKICBpZiAoIXZtLl9pbmFjdGl2ZSkgewogICAgdm0uX2luYWN0aXZlID0gdHJ1ZTsKCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHZtLiRjaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICBkZWFjdGl2YXRlQ2hpbGRDb21wb25lbnQodm0uJGNoaWxkcmVuW2ldKTsKICAgIH0KCiAgICBjYWxsSG9vayh2bSwgJ2RlYWN0aXZhdGVkJyk7CiAgfQp9CgpmdW5jdGlvbiBjYWxsSG9vayh2bSwgaG9vaykgewogIC8vICM3NTczIGRpc2FibGUgZGVwIGNvbGxlY3Rpb24gd2hlbiBpbnZva2luZyBsaWZlY3ljbGUgaG9va3MKICBwdXNoVGFyZ2V0KCk7CiAgdmFyIGhhbmRsZXJzID0gdm0uJG9wdGlvbnNbaG9va107CiAgdmFyIGluZm8gPSBob29rICsgIiBob29rIjsKCiAgaWYgKGhhbmRsZXJzKSB7CiAgICBmb3IgKHZhciBpID0gMCwgaiA9IGhhbmRsZXJzLmxlbmd0aDsgaSA8IGo7IGkrKykgewogICAgICBpbnZva2VXaXRoRXJyb3JIYW5kbGluZyhoYW5kbGVyc1tpXSwgdm0sIG51bGwsIHZtLCBpbmZvKTsKICAgIH0KICB9CgogIGlmICh2bS5faGFzSG9va0V2ZW50KSB7CiAgICB2bS4kZW1pdCgnaG9vazonICsgaG9vayk7CiAgfQoKICBwb3BUYXJnZXQoKTsKfQovKiAgKi8KCgp2YXIgTUFYX1VQREFURV9DT1VOVCA9IDEwMDsKdmFyIHF1ZXVlID0gW107CnZhciBhY3RpdmF0ZWRDaGlsZHJlbiA9IFtdOwp2YXIgaGFzID0ge307CnZhciBjaXJjdWxhciA9IHt9Owp2YXIgd2FpdGluZyA9IGZhbHNlOwp2YXIgZmx1c2hpbmcgPSBmYWxzZTsKdmFyIGluZGV4ID0gMDsKLyoqCiAqIFJlc2V0IHRoZSBzY2hlZHVsZXIncyBzdGF0ZS4KICovCgpmdW5jdGlvbiByZXNldFNjaGVkdWxlclN0YXRlKCkgewogIGluZGV4ID0gcXVldWUubGVuZ3RoID0gYWN0aXZhdGVkQ2hpbGRyZW4ubGVuZ3RoID0gMDsKICBoYXMgPSB7fTsKCiAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgIGNpcmN1bGFyID0ge307CiAgfQoKICB3YWl0aW5nID0gZmx1c2hpbmcgPSBmYWxzZTsKfSAvLyBBc3luYyBlZGdlIGNhc2UgIzY1NjYgcmVxdWlyZXMgc2F2aW5nIHRoZSB0aW1lc3RhbXAgd2hlbiBldmVudCBsaXN0ZW5lcnMgYXJlCi8vIGF0dGFjaGVkLiBIb3dldmVyLCBjYWxsaW5nIHBlcmZvcm1hbmNlLm5vdygpIGhhcyBhIHBlcmYgb3ZlcmhlYWQgZXNwZWNpYWxseQovLyBpZiB0aGUgcGFnZSBoYXMgdGhvdXNhbmRzIG9mIGV2ZW50IGxpc3RlbmVycy4gSW5zdGVhZCwgd2UgdGFrZSBhIHRpbWVzdGFtcAovLyBldmVyeSB0aW1lIHRoZSBzY2hlZHVsZXIgZmx1c2hlcyBhbmQgdXNlIHRoYXQgZm9yIGFsbCBldmVudCBsaXN0ZW5lcnMKLy8gYXR0YWNoZWQgZHVyaW5nIHRoYXQgZmx1c2guCgoKdmFyIGN1cnJlbnRGbHVzaFRpbWVzdGFtcCA9IDA7IC8vIEFzeW5jIGVkZ2UgY2FzZSBmaXggcmVxdWlyZXMgc3RvcmluZyBhbiBldmVudCBsaXN0ZW5lcidzIGF0dGFjaCB0aW1lc3RhbXAuCgp2YXIgZ2V0Tm93ID0gRGF0ZS5ub3c7IC8vIERldGVybWluZSB3aGF0IGV2ZW50IHRpbWVzdGFtcCB0aGUgYnJvd3NlciBpcyB1c2luZy4gQW5ub3lpbmdseSwgdGhlCi8vIHRpbWVzdGFtcCBjYW4gZWl0aGVyIGJlIGhpLXJlcyAocmVsYXRpdmUgdG8gcGFnZSBsb2FkKSBvciBsb3ctcmVzCi8vIChyZWxhdGl2ZSB0byBVTklYIGVwb2NoKSwgc28gaW4gb3JkZXIgdG8gY29tcGFyZSB0aW1lIHdlIGhhdmUgdG8gdXNlIHRoZQovLyBzYW1lIHRpbWVzdGFtcCB0eXBlIHdoZW4gc2F2aW5nIHRoZSBmbHVzaCB0aW1lc3RhbXAuCi8vIEFsbCBJRSB2ZXJzaW9ucyB1c2UgbG93LXJlcyBldmVudCB0aW1lc3RhbXBzLCBhbmQgaGF2ZSBwcm9ibGVtYXRpYyBjbG9jawovLyBpbXBsZW1lbnRhdGlvbnMgKCM5NjMyKQoKaWYgKGluQnJvd3NlciAmJiAhaXNJRSkgewogIHZhciBwZXJmb3JtYW5jZSA9IHdpbmRvdy5wZXJmb3JtYW5jZTsKCiAgaWYgKHBlcmZvcm1hbmNlICYmIHR5cGVvZiBwZXJmb3JtYW5jZS5ub3cgPT09ICdmdW5jdGlvbicgJiYgZ2V0Tm93KCkgPiBkb2N1bWVudC5jcmVhdGVFdmVudCgnRXZlbnQnKS50aW1lU3RhbXApIHsKICAgIC8vIGlmIHRoZSBldmVudCB0aW1lc3RhbXAsIGFsdGhvdWdoIGV2YWx1YXRlZCBBRlRFUiB0aGUgRGF0ZS5ub3coKSwgaXMKICAgIC8vIHNtYWxsZXIgdGhhbiBpdCwgaXQgbWVhbnMgdGhlIGV2ZW50IGlzIHVzaW5nIGEgaGktcmVzIHRpbWVzdGFtcCwKICAgIC8vIGFuZCB3ZSBuZWVkIHRvIHVzZSB0aGUgaGktcmVzIHZlcnNpb24gZm9yIGV2ZW50IGxpc3RlbmVyIHRpbWVzdGFtcHMgYXMKICAgIC8vIHdlbGwuCiAgICBnZXROb3cgPSBmdW5jdGlvbiBnZXROb3coKSB7CiAgICAgIHJldHVybiBwZXJmb3JtYW5jZS5ub3coKTsKICAgIH07CiAgfQp9Ci8qKgogKiBGbHVzaCBib3RoIHF1ZXVlcyBhbmQgcnVuIHRoZSB3YXRjaGVycy4KICovCgoKZnVuY3Rpb24gZmx1c2hTY2hlZHVsZXJRdWV1ZSgpIHsKICBjdXJyZW50Rmx1c2hUaW1lc3RhbXAgPSBnZXROb3coKTsKICBmbHVzaGluZyA9IHRydWU7CiAgdmFyIHdhdGNoZXIsIGlkOyAvLyBTb3J0IHF1ZXVlIGJlZm9yZSBmbHVzaC4KICAvLyBUaGlzIGVuc3VyZXMgdGhhdDoKICAvLyAxLiBDb21wb25lbnRzIGFyZSB1cGRhdGVkIGZyb20gcGFyZW50IHRvIGNoaWxkLiAoYmVjYXVzZSBwYXJlbnQgaXMgYWx3YXlzCiAgLy8gICAgY3JlYXRlZCBiZWZvcmUgdGhlIGNoaWxkKQogIC8vIDIuIEEgY29tcG9uZW50J3MgdXNlciB3YXRjaGVycyBhcmUgcnVuIGJlZm9yZSBpdHMgcmVuZGVyIHdhdGNoZXIgKGJlY2F1c2UKICAvLyAgICB1c2VyIHdhdGNoZXJzIGFyZSBjcmVhdGVkIGJlZm9yZSB0aGUgcmVuZGVyIHdhdGNoZXIpCiAgLy8gMy4gSWYgYSBjb21wb25lbnQgaXMgZGVzdHJveWVkIGR1cmluZyBhIHBhcmVudCBjb21wb25lbnQncyB3YXRjaGVyIHJ1biwKICAvLyAgICBpdHMgd2F0Y2hlcnMgY2FuIGJlIHNraXBwZWQuCgogIHF1ZXVlLnNvcnQoZnVuY3Rpb24gKGEsIGIpIHsKICAgIHJldHVybiBhLmlkIC0gYi5pZDsKICB9KTsgLy8gZG8gbm90IGNhY2hlIGxlbmd0aCBiZWNhdXNlIG1vcmUgd2F0Y2hlcnMgbWlnaHQgYmUgcHVzaGVkCiAgLy8gYXMgd2UgcnVuIGV4aXN0aW5nIHdhdGNoZXJzCgogIGZvciAoaW5kZXggPSAwOyBpbmRleCA8IHF1ZXVlLmxlbmd0aDsgaW5kZXgrKykgewogICAgd2F0Y2hlciA9IHF1ZXVlW2luZGV4XTsKCiAgICBpZiAod2F0Y2hlci5iZWZvcmUpIHsKICAgICAgd2F0Y2hlci5iZWZvcmUoKTsKICAgIH0KCiAgICBpZCA9IHdhdGNoZXIuaWQ7CiAgICBoYXNbaWRdID0gbnVsbDsKICAgIHdhdGNoZXIucnVuKCk7IC8vIGluIGRldiBidWlsZCwgY2hlY2sgYW5kIHN0b3AgY2lyY3VsYXIgdXBkYXRlcy4KCiAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiBoYXNbaWRdICE9IG51bGwpIHsKICAgICAgY2lyY3VsYXJbaWRdID0gKGNpcmN1bGFyW2lkXSB8fCAwKSArIDE7CgogICAgICBpZiAoY2lyY3VsYXJbaWRdID4gTUFYX1VQREFURV9DT1VOVCkgewogICAgICAgIHdhcm4oJ1lvdSBtYXkgaGF2ZSBhbiBpbmZpbml0ZSB1cGRhdGUgbG9vcCAnICsgKHdhdGNoZXIudXNlciA/ICJpbiB3YXRjaGVyIHdpdGggZXhwcmVzc2lvbiBcIiIgKyB3YXRjaGVyLmV4cHJlc3Npb24gKyAiXCIiIDogImluIGEgY29tcG9uZW50IHJlbmRlciBmdW5jdGlvbi4iKSwgd2F0Y2hlci52bSk7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0KICB9IC8vIGtlZXAgY29waWVzIG9mIHBvc3QgcXVldWVzIGJlZm9yZSByZXNldHRpbmcgc3RhdGUKCgogIHZhciBhY3RpdmF0ZWRRdWV1ZSA9IGFjdGl2YXRlZENoaWxkcmVuLnNsaWNlKCk7CiAgdmFyIHVwZGF0ZWRRdWV1ZSA9IHF1ZXVlLnNsaWNlKCk7CiAgcmVzZXRTY2hlZHVsZXJTdGF0ZSgpOyAvLyBjYWxsIGNvbXBvbmVudCB1cGRhdGVkIGFuZCBhY3RpdmF0ZWQgaG9va3MKCiAgY2FsbEFjdGl2YXRlZEhvb2tzKGFjdGl2YXRlZFF1ZXVlKTsKICBjYWxsVXBkYXRlZEhvb2tzKHVwZGF0ZWRRdWV1ZSk7IC8vIGRldnRvb2wgaG9vawoKICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KCiAgaWYgKGRldnRvb2xzICYmIGNvbmZpZy5kZXZ0b29scykgewogICAgZGV2dG9vbHMuZW1pdCgnZmx1c2gnKTsKICB9Cn0KCmZ1bmN0aW9uIGNhbGxVcGRhdGVkSG9va3MocXVldWUpIHsKICB2YXIgaSA9IHF1ZXVlLmxlbmd0aDsKCiAgd2hpbGUgKGktLSkgewogICAgdmFyIHdhdGNoZXIgPSBxdWV1ZVtpXTsKICAgIHZhciB2bSA9IHdhdGNoZXIudm07CgogICAgaWYgKHZtLl93YXRjaGVyID09PSB3YXRjaGVyICYmIHZtLl9pc01vdW50ZWQgJiYgIXZtLl9pc0Rlc3Ryb3llZCkgewogICAgICBjYWxsSG9vayh2bSwgJ3VwZGF0ZWQnKTsKICAgIH0KICB9Cn0KLyoqCiAqIFF1ZXVlIGEga2VwdC1hbGl2ZSBjb21wb25lbnQgdGhhdCB3YXMgYWN0aXZhdGVkIGR1cmluZyBwYXRjaC4KICogVGhlIHF1ZXVlIHdpbGwgYmUgcHJvY2Vzc2VkIGFmdGVyIHRoZSBlbnRpcmUgdHJlZSBoYXMgYmVlbiBwYXRjaGVkLgogKi8KCgpmdW5jdGlvbiBxdWV1ZUFjdGl2YXRlZENvbXBvbmVudCh2bSkgewogIC8vIHNldHRpbmcgX2luYWN0aXZlIHRvIGZhbHNlIGhlcmUgc28gdGhhdCBhIHJlbmRlciBmdW5jdGlvbiBjYW4KICAvLyByZWx5IG9uIGNoZWNraW5nIHdoZXRoZXIgaXQncyBpbiBhbiBpbmFjdGl2ZSB0cmVlIChlLmcuIHJvdXRlci12aWV3KQogIHZtLl9pbmFjdGl2ZSA9IGZhbHNlOwogIGFjdGl2YXRlZENoaWxkcmVuLnB1c2godm0pOwp9CgpmdW5jdGlvbiBjYWxsQWN0aXZhdGVkSG9va3MocXVldWUpIHsKICBmb3IgKHZhciBpID0gMDsgaSA8IHF1ZXVlLmxlbmd0aDsgaSsrKSB7CiAgICBxdWV1ZVtpXS5faW5hY3RpdmUgPSB0cnVlOwogICAgYWN0aXZhdGVDaGlsZENvbXBvbmVudChxdWV1ZVtpXSwgdHJ1ZQogICAgLyogdHJ1ZSAqLwogICAgKTsKICB9Cn0KLyoqCiAqIFB1c2ggYSB3YXRjaGVyIGludG8gdGhlIHdhdGNoZXIgcXVldWUuCiAqIEpvYnMgd2l0aCBkdXBsaWNhdGUgSURzIHdpbGwgYmUgc2tpcHBlZCB1bmxlc3MgaXQncwogKiBwdXNoZWQgd2hlbiB0aGUgcXVldWUgaXMgYmVpbmcgZmx1c2hlZC4KICovCgoKZnVuY3Rpb24gcXVldWVXYXRjaGVyKHdhdGNoZXIpIHsKICB2YXIgaWQgPSB3YXRjaGVyLmlkOwoKICBpZiAoaGFzW2lkXSA9PSBudWxsKSB7CiAgICBoYXNbaWRdID0gdHJ1ZTsKCiAgICBpZiAoIWZsdXNoaW5nKSB7CiAgICAgIHF1ZXVlLnB1c2god2F0Y2hlcik7CiAgICB9IGVsc2UgewogICAgICAvLyBpZiBhbHJlYWR5IGZsdXNoaW5nLCBzcGxpY2UgdGhlIHdhdGNoZXIgYmFzZWQgb24gaXRzIGlkCiAgICAgIC8vIGlmIGFscmVhZHkgcGFzdCBpdHMgaWQsIGl0IHdpbGwgYmUgcnVuIG5leHQgaW1tZWRpYXRlbHkuCiAgICAgIHZhciBpID0gcXVldWUubGVuZ3RoIC0gMTsKCiAgICAgIHdoaWxlIChpID4gaW5kZXggJiYgcXVldWVbaV0uaWQgPiB3YXRjaGVyLmlkKSB7CiAgICAgICAgaS0tOwogICAgICB9CgogICAgICBxdWV1ZS5zcGxpY2UoaSArIDEsIDAsIHdhdGNoZXIpOwogICAgfSAvLyBxdWV1ZSB0aGUgZmx1c2gKCgogICAgaWYgKCF3YWl0aW5nKSB7CiAgICAgIHdhaXRpbmcgPSB0cnVlOwoKICAgICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgIWNvbmZpZy5hc3luYykgewogICAgICAgIGZsdXNoU2NoZWR1bGVyUXVldWUoKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIG5leHRUaWNrKGZsdXNoU2NoZWR1bGVyUXVldWUpOwogICAgfQogIH0KfQovKiAgKi8KCgp2YXIgdWlkJDIgPSAwOwovKioKICogQSB3YXRjaGVyIHBhcnNlcyBhbiBleHByZXNzaW9uLCBjb2xsZWN0cyBkZXBlbmRlbmNpZXMsCiAqIGFuZCBmaXJlcyBjYWxsYmFjayB3aGVuIHRoZSBleHByZXNzaW9uIHZhbHVlIGNoYW5nZXMuCiAqIFRoaXMgaXMgdXNlZCBmb3IgYm90aCB0aGUgJHdhdGNoKCkgYXBpIGFuZCBkaXJlY3RpdmVzLgogKi8KCnZhciBXYXRjaGVyID0gZnVuY3Rpb24gV2F0Y2hlcih2bSwgZXhwT3JGbiwgY2IsIG9wdGlvbnMsIGlzUmVuZGVyV2F0Y2hlcikgewogIHRoaXMudm0gPSB2bTsKCiAgaWYgKGlzUmVuZGVyV2F0Y2hlcikgewogICAgdm0uX3dhdGNoZXIgPSB0aGlzOwogIH0KCiAgdm0uX3dhdGNoZXJzLnB1c2godGhpcyk7IC8vIG9wdGlvbnMKCgogIGlmIChvcHRpb25zKSB7CiAgICB0aGlzLmRlZXAgPSAhIW9wdGlvbnMuZGVlcDsKICAgIHRoaXMudXNlciA9ICEhb3B0aW9ucy51c2VyOwogICAgdGhpcy5sYXp5ID0gISFvcHRpb25zLmxhenk7CiAgICB0aGlzLnN5bmMgPSAhIW9wdGlvbnMuc3luYzsKICAgIHRoaXMuYmVmb3JlID0gb3B0aW9ucy5iZWZvcmU7CiAgfSBlbHNlIHsKICAgIHRoaXMuZGVlcCA9IHRoaXMudXNlciA9IHRoaXMubGF6eSA9IHRoaXMuc3luYyA9IGZhbHNlOwogIH0KCiAgdGhpcy5jYiA9IGNiOwogIHRoaXMuaWQgPSArK3VpZCQyOyAvLyB1aWQgZm9yIGJhdGNoaW5nCgogIHRoaXMuYWN0aXZlID0gdHJ1ZTsKICB0aGlzLmRpcnR5ID0gdGhpcy5sYXp5OyAvLyBmb3IgbGF6eSB3YXRjaGVycwoKICB0aGlzLmRlcHMgPSBbXTsKICB0aGlzLm5ld0RlcHMgPSBbXTsKICB0aGlzLmRlcElkcyA9IG5ldyBfU2V0KCk7CiAgdGhpcy5uZXdEZXBJZHMgPSBuZXcgX1NldCgpOwogIHRoaXMuZXhwcmVzc2lvbiA9IHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgPyBleHBPckZuLnRvU3RyaW5nKCkgOiAnJzsgLy8gcGFyc2UgZXhwcmVzc2lvbiBmb3IgZ2V0dGVyCgogIGlmICh0eXBlb2YgZXhwT3JGbiA9PT0gJ2Z1bmN0aW9uJykgewogICAgdGhpcy5nZXR0ZXIgPSBleHBPckZuOwogIH0gZWxzZSB7CiAgICB0aGlzLmdldHRlciA9IHBhcnNlUGF0aChleHBPckZuKTsKCiAgICBpZiAoIXRoaXMuZ2V0dGVyKSB7CiAgICAgIHRoaXMuZ2V0dGVyID0gbm9vcDsKICAgICAgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiB3YXJuKCJGYWlsZWQgd2F0Y2hpbmcgcGF0aDogXCIiICsgZXhwT3JGbiArICJcIiAiICsgJ1dhdGNoZXIgb25seSBhY2NlcHRzIHNpbXBsZSBkb3QtZGVsaW1pdGVkIHBhdGhzLiAnICsgJ0ZvciBmdWxsIGNvbnRyb2wsIHVzZSBhIGZ1bmN0aW9uIGluc3RlYWQuJywgdm0pOwogICAgfQogIH0KCiAgdGhpcy52YWx1ZSA9IHRoaXMubGF6eSA/IHVuZGVmaW5lZCA6IHRoaXMuZ2V0KCk7Cn07Ci8qKgogKiBFdmFsdWF0ZSB0aGUgZ2V0dGVyLCBhbmQgcmUtY29sbGVjdCBkZXBlbmRlbmNpZXMuCiAqLwoKCldhdGNoZXIucHJvdG90eXBlLmdldCA9IGZ1bmN0aW9uIGdldCgpIHsKICBwdXNoVGFyZ2V0KHRoaXMpOwogIHZhciB2YWx1ZTsKICB2YXIgdm0gPSB0aGlzLnZtOwoKICB0cnkgewogICAgdmFsdWUgPSB0aGlzLmdldHRlci5jYWxsKHZtLCB2bSk7CiAgfSBjYXRjaCAoZSkgewogICAgaWYgKHRoaXMudXNlcikgewogICAgICBoYW5kbGVFcnJvcihlLCB2bSwgImdldHRlciBmb3Igd2F0Y2hlciBcIiIgKyB0aGlzLmV4cHJlc3Npb24gKyAiXCIiKTsKICAgIH0gZWxzZSB7CiAgICAgIHRocm93IGU7CiAgICB9CiAgfSBmaW5hbGx5IHsKICAgIC8vICJ0b3VjaCIgZXZlcnkgcHJvcGVydHkgc28gdGhleSBhcmUgYWxsIHRyYWNrZWQgYXMKICAgIC8vIGRlcGVuZGVuY2llcyBmb3IgZGVlcCB3YXRjaGluZwogICAgaWYgKHRoaXMuZGVlcCkgewogICAgICB0cmF2ZXJzZSh2YWx1ZSk7CiAgICB9CgogICAgcG9wVGFyZ2V0KCk7CiAgICB0aGlzLmNsZWFudXBEZXBzKCk7CiAgfQoKICByZXR1cm4gdmFsdWU7Cn07Ci8qKgogKiBBZGQgYSBkZXBlbmRlbmN5IHRvIHRoaXMgZGlyZWN0aXZlLgogKi8KCgpXYXRjaGVyLnByb3RvdHlwZS5hZGREZXAgPSBmdW5jdGlvbiBhZGREZXAoZGVwKSB7CiAgdmFyIGlkID0gZGVwLmlkOwoKICBpZiAoIXRoaXMubmV3RGVwSWRzLmhhcyhpZCkpIHsKICAgIHRoaXMubmV3RGVwSWRzLmFkZChpZCk7CiAgICB0aGlzLm5ld0RlcHMucHVzaChkZXApOwoKICAgIGlmICghdGhpcy5kZXBJZHMuaGFzKGlkKSkgewogICAgICBkZXAuYWRkU3ViKHRoaXMpOwogICAgfQogIH0KfTsKLyoqCiAqIENsZWFuIHVwIGZvciBkZXBlbmRlbmN5IGNvbGxlY3Rpb24uCiAqLwoKCldhdGNoZXIucHJvdG90eXBlLmNsZWFudXBEZXBzID0gZnVuY3Rpb24gY2xlYW51cERlcHMoKSB7CiAgdmFyIGkgPSB0aGlzLmRlcHMubGVuZ3RoOwoKICB3aGlsZSAoaS0tKSB7CiAgICB2YXIgZGVwID0gdGhpcy5kZXBzW2ldOwoKICAgIGlmICghdGhpcy5uZXdEZXBJZHMuaGFzKGRlcC5pZCkpIHsKICAgICAgZGVwLnJlbW92ZVN1Yih0aGlzKTsKICAgIH0KICB9CgogIHZhciB0bXAgPSB0aGlzLmRlcElkczsKICB0aGlzLmRlcElkcyA9IHRoaXMubmV3RGVwSWRzOwogIHRoaXMubmV3RGVwSWRzID0gdG1wOwogIHRoaXMubmV3RGVwSWRzLmNsZWFyKCk7CiAgdG1wID0gdGhpcy5kZXBzOwogIHRoaXMuZGVwcyA9IHRoaXMubmV3RGVwczsKICB0aGlzLm5ld0RlcHMgPSB0bXA7CiAgdGhpcy5uZXdEZXBzLmxlbmd0aCA9IDA7Cn07Ci8qKgogKiBTdWJzY3JpYmVyIGludGVyZmFjZS4KICogV2lsbCBiZSBjYWxsZWQgd2hlbiBhIGRlcGVuZGVuY3kgY2hhbmdlcy4KICovCgoKV2F0Y2hlci5wcm90b3R5cGUudXBkYXRlID0gZnVuY3Rpb24gdXBkYXRlKCkgewogIC8qIGlzdGFuYnVsIGlnbm9yZSBlbHNlICovCiAgaWYgKHRoaXMubGF6eSkgewogICAgdGhpcy5kaXJ0eSA9IHRydWU7CiAgfSBlbHNlIGlmICh0aGlzLnN5bmMpIHsKICAgIHRoaXMucnVuKCk7CiAgfSBlbHNlIHsKICAgIHF1ZXVlV2F0Y2hlcih0aGlzKTsKICB9Cn07Ci8qKgogKiBTY2hlZHVsZXIgam9iIGludGVyZmFjZS4KICogV2lsbCBiZSBjYWxsZWQgYnkgdGhlIHNjaGVkdWxlci4KICovCgoKV2F0Y2hlci5wcm90b3R5cGUucnVuID0gZnVuY3Rpb24gcnVuKCkgewogIGlmICh0aGlzLmFjdGl2ZSkgewogICAgdmFyIHZhbHVlID0gdGhpcy5nZXQoKTsKCiAgICBpZiAodmFsdWUgIT09IHRoaXMudmFsdWUgfHwgLy8gRGVlcCB3YXRjaGVycyBhbmQgd2F0Y2hlcnMgb24gT2JqZWN0L0FycmF5cyBzaG91bGQgZmlyZSBldmVuCiAgICAvLyB3aGVuIHRoZSB2YWx1ZSBpcyB0aGUgc2FtZSwgYmVjYXVzZSB0aGUgdmFsdWUgbWF5CiAgICAvLyBoYXZlIG11dGF0ZWQuCiAgICBpc09iamVjdCh2YWx1ZSkgfHwgdGhpcy5kZWVwKSB7CiAgICAgIC8vIHNldCBuZXcgdmFsdWUKICAgICAgdmFyIG9sZFZhbHVlID0gdGhpcy52YWx1ZTsKICAgICAgdGhpcy52YWx1ZSA9IHZhbHVlOwoKICAgICAgaWYgKHRoaXMudXNlcikgewogICAgICAgIHRyeSB7CiAgICAgICAgICB0aGlzLmNiLmNhbGwodGhpcy52bSwgdmFsdWUsIG9sZFZhbHVlKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICBoYW5kbGVFcnJvcihlLCB0aGlzLnZtLCAiY2FsbGJhY2sgZm9yIHdhdGNoZXIgXCIiICsgdGhpcy5leHByZXNzaW9uICsgIlwiIik7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuY2IuY2FsbCh0aGlzLnZtLCB2YWx1ZSwgb2xkVmFsdWUpOwogICAgICB9CiAgICB9CiAgfQp9OwovKioKICogRXZhbHVhdGUgdGhlIHZhbHVlIG9mIHRoZSB3YXRjaGVyLgogKiBUaGlzIG9ubHkgZ2V0cyBjYWxsZWQgZm9yIGxhenkgd2F0Y2hlcnMuCiAqLwoKCldhdGNoZXIucHJvdG90eXBlLmV2YWx1YXRlID0gZnVuY3Rpb24gZXZhbHVhdGUoKSB7CiAgdGhpcy52YWx1ZSA9IHRoaXMuZ2V0KCk7CiAgdGhpcy5kaXJ0eSA9IGZhbHNlOwp9OwovKioKICogRGVwZW5kIG9uIGFsbCBkZXBzIGNvbGxlY3RlZCBieSB0aGlzIHdhdGNoZXIuCiAqLwoKCldhdGNoZXIucHJvdG90eXBlLmRlcGVuZCA9IGZ1bmN0aW9uIGRlcGVuZCgpIHsKICB2YXIgaSA9IHRoaXMuZGVwcy5sZW5ndGg7CgogIHdoaWxlIChpLS0pIHsKICAgIHRoaXMuZGVwc1tpXS5kZXBlbmQoKTsKICB9Cn07Ci8qKgogKiBSZW1vdmUgc2VsZiBmcm9tIGFsbCBkZXBlbmRlbmNpZXMnIHN1YnNjcmliZXIgbGlzdC4KICovCgoKV2F0Y2hlci5wcm90b3R5cGUudGVhcmRvd24gPSBmdW5jdGlvbiB0ZWFyZG93bigpIHsKICBpZiAodGhpcy5hY3RpdmUpIHsKICAgIC8vIHJlbW92ZSBzZWxmIGZyb20gdm0ncyB3YXRjaGVyIGxpc3QKICAgIC8vIHRoaXMgaXMgYSBzb21ld2hhdCBleHBlbnNpdmUgb3BlcmF0aW9uIHNvIHdlIHNraXAgaXQKICAgIC8vIGlmIHRoZSB2bSBpcyBiZWluZyBkZXN0cm95ZWQuCiAgICBpZiAoIXRoaXMudm0uX2lzQmVpbmdEZXN0cm95ZWQpIHsKICAgICAgcmVtb3ZlKHRoaXMudm0uX3dhdGNoZXJzLCB0aGlzKTsKICAgIH0KCiAgICB2YXIgaSA9IHRoaXMuZGVwcy5sZW5ndGg7CgogICAgd2hpbGUgKGktLSkgewogICAgICB0aGlzLmRlcHNbaV0ucmVtb3ZlU3ViKHRoaXMpOwogICAgfQoKICAgIHRoaXMuYWN0aXZlID0gZmFsc2U7CiAgfQp9OwovKiAgKi8KCgp2YXIgc2hhcmVkUHJvcGVydHlEZWZpbml0aW9uID0gewogIGVudW1lcmFibGU6IHRydWUsCiAgY29uZmlndXJhYmxlOiB0cnVlLAogIGdldDogbm9vcCwKICBzZXQ6IG5vb3AKfTsKCmZ1bmN0aW9uIHByb3h5KHRhcmdldCwgc291cmNlS2V5LCBrZXkpIHsKICBzaGFyZWRQcm9wZXJ0eURlZmluaXRpb24uZ2V0ID0gZnVuY3Rpb24gcHJveHlHZXR0ZXIoKSB7CiAgICByZXR1cm4gdGhpc1tzb3VyY2VLZXldW2tleV07CiAgfTsKCiAgc2hhcmVkUHJvcGVydHlEZWZpbml0aW9uLnNldCA9IGZ1bmN0aW9uIHByb3h5U2V0dGVyKHZhbCkgewogICAgdGhpc1tzb3VyY2VLZXldW2tleV0gPSB2YWw7CiAgfTsKCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwga2V5LCBzaGFyZWRQcm9wZXJ0eURlZmluaXRpb24pOwp9CgpmdW5jdGlvbiBpbml0U3RhdGUodm0pIHsKICB2bS5fd2F0Y2hlcnMgPSBbXTsKICB2YXIgb3B0cyA9IHZtLiRvcHRpb25zOwoKICBpZiAob3B0cy5wcm9wcykgewogICAgaW5pdFByb3BzKHZtLCBvcHRzLnByb3BzKTsKICB9CgogIGlmIChvcHRzLm1ldGhvZHMpIHsKICAgIGluaXRNZXRob2RzKHZtLCBvcHRzLm1ldGhvZHMpOwogIH0KCiAgaWYgKG9wdHMuZGF0YSkgewogICAgaW5pdERhdGEodm0pOwogIH0gZWxzZSB7CiAgICBvYnNlcnZlKHZtLl9kYXRhID0ge30sIHRydWUKICAgIC8qIGFzUm9vdERhdGEgKi8KICAgICk7CiAgfQoKICBpZiAob3B0cy5jb21wdXRlZCkgewogICAgaW5pdENvbXB1dGVkKHZtLCBvcHRzLmNvbXB1dGVkKTsKICB9CgogIGlmIChvcHRzLndhdGNoICYmIG9wdHMud2F0Y2ggIT09IG5hdGl2ZVdhdGNoKSB7CiAgICBpbml0V2F0Y2godm0sIG9wdHMud2F0Y2gpOwogIH0KfQoKZnVuY3Rpb24gaW5pdFByb3BzKHZtLCBwcm9wc09wdGlvbnMpIHsKICB2YXIgcHJvcHNEYXRhID0gdm0uJG9wdGlvbnMucHJvcHNEYXRhIHx8IHt9OwogIHZhciBwcm9wcyA9IHZtLl9wcm9wcyA9IHt9OyAvLyBjYWNoZSBwcm9wIGtleXMgc28gdGhhdCBmdXR1cmUgcHJvcHMgdXBkYXRlcyBjYW4gaXRlcmF0ZSB1c2luZyBBcnJheQogIC8vIGluc3RlYWQgb2YgZHluYW1pYyBvYmplY3Qga2V5IGVudW1lcmF0aW9uLgoKICB2YXIga2V5cyA9IHZtLiRvcHRpb25zLl9wcm9wS2V5cyA9IFtdOwogIHZhciBpc1Jvb3QgPSAhdm0uJHBhcmVudDsgLy8gcm9vdCBpbnN0YW5jZSBwcm9wcyBzaG91bGQgYmUgY29udmVydGVkCgogIGlmICghaXNSb290KSB7CiAgICB0b2dnbGVPYnNlcnZpbmcoZmFsc2UpOwogIH0KCiAgdmFyIGxvb3AgPSBmdW5jdGlvbiBsb29wKGtleSkgewogICAga2V5cy5wdXNoKGtleSk7CiAgICB2YXIgdmFsdWUgPSB2YWxpZGF0ZVByb3Aoa2V5LCBwcm9wc09wdGlvbnMsIHByb3BzRGF0YSwgdm0pOwogICAgLyogaXN0YW5idWwgaWdub3JlIGVsc2UgKi8KCiAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgICB2YXIgaHlwaGVuYXRlZEtleSA9IGh5cGhlbmF0ZShrZXkpOwoKICAgICAgaWYgKGlzUmVzZXJ2ZWRBdHRyaWJ1dGUoaHlwaGVuYXRlZEtleSkgfHwgY29uZmlnLmlzUmVzZXJ2ZWRBdHRyKGh5cGhlbmF0ZWRLZXkpKSB7CiAgICAgICAgd2FybigiXCIiICsgaHlwaGVuYXRlZEtleSArICJcIiBpcyBhIHJlc2VydmVkIGF0dHJpYnV0ZSBhbmQgY2Fubm90IGJlIHVzZWQgYXMgY29tcG9uZW50IHByb3AuIiwgdm0pOwogICAgICB9CgogICAgICBkZWZpbmVSZWFjdGl2ZSQkMShwcm9wcywga2V5LCB2YWx1ZSwgZnVuY3Rpb24gKCkgewogICAgICAgIGlmICghaXNSb290ICYmICFpc1VwZGF0aW5nQ2hpbGRDb21wb25lbnQpIHsKICAgICAgICAgIHdhcm4oIkF2b2lkIG11dGF0aW5nIGEgcHJvcCBkaXJlY3RseSBzaW5jZSB0aGUgdmFsdWUgd2lsbCBiZSAiICsgIm92ZXJ3cml0dGVuIHdoZW5ldmVyIHRoZSBwYXJlbnQgY29tcG9uZW50IHJlLXJlbmRlcnMuICIgKyAiSW5zdGVhZCwgdXNlIGEgZGF0YSBvciBjb21wdXRlZCBwcm9wZXJ0eSBiYXNlZCBvbiB0aGUgcHJvcCdzICIgKyAidmFsdWUuIFByb3AgYmVpbmcgbXV0YXRlZDogXCIiICsga2V5ICsgIlwiIiwgdm0pOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9IGVsc2UgewogICAgICBkZWZpbmVSZWFjdGl2ZSQkMShwcm9wcywga2V5LCB2YWx1ZSk7CiAgICB9IC8vIHN0YXRpYyBwcm9wcyBhcmUgYWxyZWFkeSBwcm94aWVkIG9uIHRoZSBjb21wb25lbnQncyBwcm90b3R5cGUKICAgIC8vIGR1cmluZyBWdWUuZXh0ZW5kKCkuIFdlIG9ubHkgbmVlZCB0byBwcm94eSBwcm9wcyBkZWZpbmVkIGF0CiAgICAvLyBpbnN0YW50aWF0aW9uIGhlcmUuCgoKICAgIGlmICghKGtleSBpbiB2bSkpIHsKICAgICAgcHJveHkodm0sICJfcHJvcHMiLCBrZXkpOwogICAgfQogIH07CgogIGZvciAodmFyIGtleSBpbiBwcm9wc09wdGlvbnMpIHsKICAgIGxvb3Aoa2V5KTsKICB9CgogIHRvZ2dsZU9ic2VydmluZyh0cnVlKTsKfQoKZnVuY3Rpb24gaW5pdERhdGEodm0pIHsKICB2YXIgZGF0YSA9IHZtLiRvcHRpb25zLmRhdGE7CiAgZGF0YSA9IHZtLl9kYXRhID0gdHlwZW9mIGRhdGEgPT09ICdmdW5jdGlvbicgPyBnZXREYXRhKGRhdGEsIHZtKSA6IGRhdGEgfHwge307CgogIGlmICghaXNQbGFpbk9iamVjdChkYXRhKSkgewogICAgZGF0YSA9IHt9OwogICAgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiB3YXJuKCdkYXRhIGZ1bmN0aW9ucyBzaG91bGQgcmV0dXJuIGFuIG9iamVjdDpcbicgKyAnaHR0cHM6Ly92dWVqcy5vcmcvdjIvZ3VpZGUvY29tcG9uZW50cy5odG1sI2RhdGEtTXVzdC1CZS1hLUZ1bmN0aW9uJywgdm0pOwogIH0gLy8gcHJveHkgZGF0YSBvbiBpbnN0YW5jZQoKCiAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyhkYXRhKTsKICB2YXIgcHJvcHMgPSB2bS4kb3B0aW9ucy5wcm9wczsKICB2YXIgbWV0aG9kcyA9IHZtLiRvcHRpb25zLm1ldGhvZHM7CiAgdmFyIGkgPSBrZXlzLmxlbmd0aDsKCiAgd2hpbGUgKGktLSkgewogICAgdmFyIGtleSA9IGtleXNbaV07CgogICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgICAgaWYgKG1ldGhvZHMgJiYgaGFzT3duKG1ldGhvZHMsIGtleSkpIHsKICAgICAgICB3YXJuKCJNZXRob2QgXCIiICsga2V5ICsgIlwiIGhhcyBhbHJlYWR5IGJlZW4gZGVmaW5lZCBhcyBhIGRhdGEgcHJvcGVydHkuIiwgdm0pOwogICAgICB9CiAgICB9CgogICAgaWYgKHByb3BzICYmIGhhc093bihwcm9wcywga2V5KSkgewogICAgICBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIHdhcm4oIlRoZSBkYXRhIHByb3BlcnR5IFwiIiArIGtleSArICJcIiBpcyBhbHJlYWR5IGRlY2xhcmVkIGFzIGEgcHJvcC4gIiArICJVc2UgcHJvcCBkZWZhdWx0IHZhbHVlIGluc3RlYWQuIiwgdm0pOwogICAgfSBlbHNlIGlmICghaXNSZXNlcnZlZChrZXkpKSB7CiAgICAgIHByb3h5KHZtLCAiX2RhdGEiLCBrZXkpOwogICAgfQogIH0gLy8gb2JzZXJ2ZSBkYXRhCgoKICBvYnNlcnZlKGRhdGEsIHRydWUKICAvKiBhc1Jvb3REYXRhICovCiAgKTsKfQoKZnVuY3Rpb24gZ2V0RGF0YShkYXRhLCB2bSkgewogIC8vICM3NTczIGRpc2FibGUgZGVwIGNvbGxlY3Rpb24gd2hlbiBpbnZva2luZyBkYXRhIGdldHRlcnMKICBwdXNoVGFyZ2V0KCk7CgogIHRyeSB7CiAgICByZXR1cm4gZGF0YS5jYWxsKHZtLCB2bSk7CiAgfSBjYXRjaCAoZSkgewogICAgaGFuZGxlRXJyb3IoZSwgdm0sICJkYXRhKCkiKTsKICAgIHJldHVybiB7fTsKICB9IGZpbmFsbHkgewogICAgcG9wVGFyZ2V0KCk7CiAgfQp9Cgp2YXIgY29tcHV0ZWRXYXRjaGVyT3B0aW9ucyA9IHsKICBsYXp5OiB0cnVlCn07CgpmdW5jdGlvbiBpbml0Q29tcHV0ZWQodm0sIGNvbXB1dGVkKSB7CiAgLy8gJGZsb3ctZGlzYWJsZS1saW5lCiAgdmFyIHdhdGNoZXJzID0gdm0uX2NvbXB1dGVkV2F0Y2hlcnMgPSBPYmplY3QuY3JlYXRlKG51bGwpOyAvLyBjb21wdXRlZCBwcm9wZXJ0aWVzIGFyZSBqdXN0IGdldHRlcnMgZHVyaW5nIFNTUgoKICB2YXIgaXNTU1IgPSBpc1NlcnZlclJlbmRlcmluZygpOwoKICBmb3IgKHZhciBrZXkgaW4gY29tcHV0ZWQpIHsKICAgIHZhciB1c2VyRGVmID0gY29tcHV0ZWRba2V5XTsKICAgIHZhciBnZXR0ZXIgPSB0eXBlb2YgdXNlckRlZiA9PT0gJ2Z1bmN0aW9uJyA/IHVzZXJEZWYgOiB1c2VyRGVmLmdldDsKCiAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiBnZXR0ZXIgPT0gbnVsbCkgewogICAgICB3YXJuKCJHZXR0ZXIgaXMgbWlzc2luZyBmb3IgY29tcHV0ZWQgcHJvcGVydHkgXCIiICsga2V5ICsgIlwiLiIsIHZtKTsKICAgIH0KCiAgICBpZiAoIWlzU1NSKSB7CiAgICAgIC8vIGNyZWF0ZSBpbnRlcm5hbCB3YXRjaGVyIGZvciB0aGUgY29tcHV0ZWQgcHJvcGVydHkuCiAgICAgIHdhdGNoZXJzW2tleV0gPSBuZXcgV2F0Y2hlcih2bSwgZ2V0dGVyIHx8IG5vb3AsIG5vb3AsIGNvbXB1dGVkV2F0Y2hlck9wdGlvbnMpOwogICAgfSAvLyBjb21wb25lbnQtZGVmaW5lZCBjb21wdXRlZCBwcm9wZXJ0aWVzIGFyZSBhbHJlYWR5IGRlZmluZWQgb24gdGhlCiAgICAvLyBjb21wb25lbnQgcHJvdG90eXBlLiBXZSBvbmx5IG5lZWQgdG8gZGVmaW5lIGNvbXB1dGVkIHByb3BlcnRpZXMgZGVmaW5lZAogICAgLy8gYXQgaW5zdGFudGlhdGlvbiBoZXJlLgoKCiAgICBpZiAoIShrZXkgaW4gdm0pKSB7CiAgICAgIGRlZmluZUNvbXB1dGVkKHZtLCBrZXksIHVzZXJEZWYpOwogICAgfSBlbHNlIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICAgIGlmIChrZXkgaW4gdm0uJGRhdGEpIHsKICAgICAgICB3YXJuKCJUaGUgY29tcHV0ZWQgcHJvcGVydHkgXCIiICsga2V5ICsgIlwiIGlzIGFscmVhZHkgZGVmaW5lZCBpbiBkYXRhLiIsIHZtKTsKICAgICAgfSBlbHNlIGlmICh2bS4kb3B0aW9ucy5wcm9wcyAmJiBrZXkgaW4gdm0uJG9wdGlvbnMucHJvcHMpIHsKICAgICAgICB3YXJuKCJUaGUgY29tcHV0ZWQgcHJvcGVydHkgXCIiICsga2V5ICsgIlwiIGlzIGFscmVhZHkgZGVmaW5lZCBhcyBhIHByb3AuIiwgdm0pOwogICAgICB9CiAgICB9CiAgfQp9CgpmdW5jdGlvbiBkZWZpbmVDb21wdXRlZCh0YXJnZXQsIGtleSwgdXNlckRlZikgewogIHZhciBzaG91bGRDYWNoZSA9ICFpc1NlcnZlclJlbmRlcmluZygpOwoKICBpZiAodHlwZW9mIHVzZXJEZWYgPT09ICdmdW5jdGlvbicpIHsKICAgIHNoYXJlZFByb3BlcnR5RGVmaW5pdGlvbi5nZXQgPSBzaG91bGRDYWNoZSA/IGNyZWF0ZUNvbXB1dGVkR2V0dGVyKGtleSkgOiBjcmVhdGVHZXR0ZXJJbnZva2VyKHVzZXJEZWYpOwogICAgc2hhcmVkUHJvcGVydHlEZWZpbml0aW9uLnNldCA9IG5vb3A7CiAgfSBlbHNlIHsKICAgIHNoYXJlZFByb3BlcnR5RGVmaW5pdGlvbi5nZXQgPSB1c2VyRGVmLmdldCA/IHNob3VsZENhY2hlICYmIHVzZXJEZWYuY2FjaGUgIT09IGZhbHNlID8gY3JlYXRlQ29tcHV0ZWRHZXR0ZXIoa2V5KSA6IGNyZWF0ZUdldHRlckludm9rZXIodXNlckRlZi5nZXQpIDogbm9vcDsKICAgIHNoYXJlZFByb3BlcnR5RGVmaW5pdGlvbi5zZXQgPSB1c2VyRGVmLnNldCB8fCBub29wOwogIH0KCiAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgc2hhcmVkUHJvcGVydHlEZWZpbml0aW9uLnNldCA9PT0gbm9vcCkgewogICAgc2hhcmVkUHJvcGVydHlEZWZpbml0aW9uLnNldCA9IGZ1bmN0aW9uICgpIHsKICAgICAgd2FybigiQ29tcHV0ZWQgcHJvcGVydHkgXCIiICsga2V5ICsgIlwiIHdhcyBhc3NpZ25lZCB0byBidXQgaXQgaGFzIG5vIHNldHRlci4iLCB0aGlzKTsKICAgIH07CiAgfQoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBrZXksIHNoYXJlZFByb3BlcnR5RGVmaW5pdGlvbik7Cn0KCmZ1bmN0aW9uIGNyZWF0ZUNvbXB1dGVkR2V0dGVyKGtleSkgewogIHJldHVybiBmdW5jdGlvbiBjb21wdXRlZEdldHRlcigpIHsKICAgIHZhciB3YXRjaGVyID0gdGhpcy5fY29tcHV0ZWRXYXRjaGVycyAmJiB0aGlzLl9jb21wdXRlZFdhdGNoZXJzW2tleV07CgogICAgaWYgKHdhdGNoZXIpIHsKICAgICAgaWYgKHdhdGNoZXIuZGlydHkpIHsKICAgICAgICB3YXRjaGVyLmV2YWx1YXRlKCk7CiAgICAgIH0KCiAgICAgIGlmIChEZXAudGFyZ2V0KSB7CiAgICAgICAgd2F0Y2hlci5kZXBlbmQoKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHdhdGNoZXIudmFsdWU7CiAgICB9CiAgfTsKfQoKZnVuY3Rpb24gY3JlYXRlR2V0dGVySW52b2tlcihmbikgewogIHJldHVybiBmdW5jdGlvbiBjb21wdXRlZEdldHRlcigpIHsKICAgIHJldHVybiBmbi5jYWxsKHRoaXMsIHRoaXMpOwogIH07Cn0KCmZ1bmN0aW9uIGluaXRNZXRob2RzKHZtLCBtZXRob2RzKSB7CiAgdmFyIHByb3BzID0gdm0uJG9wdGlvbnMucHJvcHM7CgogIGZvciAodmFyIGtleSBpbiBtZXRob2RzKSB7CiAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgICBpZiAodHlwZW9mIG1ldGhvZHNba2V5XSAhPT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHdhcm4oIk1ldGhvZCBcIiIgKyBrZXkgKyAiXCIgaGFzIHR5cGUgXCIiICsgX3R5cGVvZihtZXRob2RzW2tleV0pICsgIlwiIGluIHRoZSBjb21wb25lbnQgZGVmaW5pdGlvbi4gIiArICJEaWQgeW91IHJlZmVyZW5jZSB0aGUgZnVuY3Rpb24gY29ycmVjdGx5PyIsIHZtKTsKICAgICAgfQoKICAgICAgaWYgKHByb3BzICYmIGhhc093bihwcm9wcywga2V5KSkgewogICAgICAgIHdhcm4oIk1ldGhvZCBcIiIgKyBrZXkgKyAiXCIgaGFzIGFscmVhZHkgYmVlbiBkZWZpbmVkIGFzIGEgcHJvcC4iLCB2bSk7CiAgICAgIH0KCiAgICAgIGlmIChrZXkgaW4gdm0gJiYgaXNSZXNlcnZlZChrZXkpKSB7CiAgICAgICAgd2FybigiTWV0aG9kIFwiIiArIGtleSArICJcIiBjb25mbGljdHMgd2l0aCBhbiBleGlzdGluZyBWdWUgaW5zdGFuY2UgbWV0aG9kLiAiICsgIkF2b2lkIGRlZmluaW5nIGNvbXBvbmVudCBtZXRob2RzIHRoYXQgc3RhcnQgd2l0aCBfIG9yICQuIik7CiAgICAgIH0KICAgIH0KCiAgICB2bVtrZXldID0gdHlwZW9mIG1ldGhvZHNba2V5XSAhPT0gJ2Z1bmN0aW9uJyA/IG5vb3AgOiBiaW5kKG1ldGhvZHNba2V5XSwgdm0pOwogIH0KfQoKZnVuY3Rpb24gaW5pdFdhdGNoKHZtLCB3YXRjaCkgewogIGZvciAodmFyIGtleSBpbiB3YXRjaCkgewogICAgdmFyIGhhbmRsZXIgPSB3YXRjaFtrZXldOwoKICAgIGlmIChBcnJheS5pc0FycmF5KGhhbmRsZXIpKSB7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaGFuZGxlci5sZW5ndGg7IGkrKykgewogICAgICAgIGNyZWF0ZVdhdGNoZXIodm0sIGtleSwgaGFuZGxlcltpXSk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGNyZWF0ZVdhdGNoZXIodm0sIGtleSwgaGFuZGxlcik7CiAgICB9CiAgfQp9CgpmdW5jdGlvbiBjcmVhdGVXYXRjaGVyKHZtLCBleHBPckZuLCBoYW5kbGVyLCBvcHRpb25zKSB7CiAgaWYgKGlzUGxhaW5PYmplY3QoaGFuZGxlcikpIHsKICAgIG9wdGlvbnMgPSBoYW5kbGVyOwogICAgaGFuZGxlciA9IGhhbmRsZXIuaGFuZGxlcjsKICB9CgogIGlmICh0eXBlb2YgaGFuZGxlciA9PT0gJ3N0cmluZycpIHsKICAgIGhhbmRsZXIgPSB2bVtoYW5kbGVyXTsKICB9CgogIHJldHVybiB2bS4kd2F0Y2goZXhwT3JGbiwgaGFuZGxlciwgb3B0aW9ucyk7Cn0KCmZ1bmN0aW9uIHN0YXRlTWl4aW4oVnVlKSB7CiAgLy8gZmxvdyBzb21laG93IGhhcyBwcm9ibGVtcyB3aXRoIGRpcmVjdGx5IGRlY2xhcmVkIGRlZmluaXRpb24gb2JqZWN0CiAgLy8gd2hlbiB1c2luZyBPYmplY3QuZGVmaW5lUHJvcGVydHksIHNvIHdlIGhhdmUgdG8gcHJvY2VkdXJhbGx5IGJ1aWxkIHVwCiAgLy8gdGhlIG9iamVjdCBoZXJlLgogIHZhciBkYXRhRGVmID0ge307CgogIGRhdGFEZWYuZ2V0ID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2RhdGE7CiAgfTsKCiAgdmFyIHByb3BzRGVmID0ge307CgogIHByb3BzRGVmLmdldCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9wcm9wczsKICB9OwoKICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgZGF0YURlZi5zZXQgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHdhcm4oJ0F2b2lkIHJlcGxhY2luZyBpbnN0YW5jZSByb290ICRkYXRhLiAnICsgJ1VzZSBuZXN0ZWQgZGF0YSBwcm9wZXJ0aWVzIGluc3RlYWQuJywgdGhpcyk7CiAgICB9OwoKICAgIHByb3BzRGVmLnNldCA9IGZ1bmN0aW9uICgpIHsKICAgICAgd2FybigiJHByb3BzIGlzIHJlYWRvbmx5LiIsIHRoaXMpOwogICAgfTsKICB9CgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShWdWUucHJvdG90eXBlLCAnJGRhdGEnLCBkYXRhRGVmKTsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoVnVlLnByb3RvdHlwZSwgJyRwcm9wcycsIHByb3BzRGVmKTsKICBWdWUucHJvdG90eXBlLiRzZXQgPSBzZXQ7CiAgVnVlLnByb3RvdHlwZS4kZGVsZXRlID0gZGVsOwoKICBWdWUucHJvdG90eXBlLiR3YXRjaCA9IGZ1bmN0aW9uIChleHBPckZuLCBjYiwgb3B0aW9ucykgewogICAgdmFyIHZtID0gdGhpczsKCiAgICBpZiAoaXNQbGFpbk9iamVjdChjYikpIHsKICAgICAgcmV0dXJuIGNyZWF0ZVdhdGNoZXIodm0sIGV4cE9yRm4sIGNiLCBvcHRpb25zKTsKICAgIH0KCiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgIG9wdGlvbnMudXNlciA9IHRydWU7CiAgICB2YXIgd2F0Y2hlciA9IG5ldyBXYXRjaGVyKHZtLCBleHBPckZuLCBjYiwgb3B0aW9ucyk7CgogICAgaWYgKG9wdGlvbnMuaW1tZWRpYXRlKSB7CiAgICAgIHRyeSB7CiAgICAgICAgY2IuY2FsbCh2bSwgd2F0Y2hlci52YWx1ZSk7CiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgaGFuZGxlRXJyb3IoZXJyb3IsIHZtLCAiY2FsbGJhY2sgZm9yIGltbWVkaWF0ZSB3YXRjaGVyIFwiIiArIHdhdGNoZXIuZXhwcmVzc2lvbiArICJcIiIpOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGZ1bmN0aW9uIHVud2F0Y2hGbigpIHsKICAgICAgd2F0Y2hlci50ZWFyZG93bigpOwogICAgfTsKICB9Owp9Ci8qICAqLwoKCnZhciB1aWQkMyA9IDA7CgpmdW5jdGlvbiBpbml0TWl4aW4oVnVlKSB7CiAgVnVlLnByb3RvdHlwZS5faW5pdCA9IGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgICB2YXIgdm0gPSB0aGlzOyAvLyBhIHVpZAoKICAgIHZtLl91aWQgPSB1aWQkMysrOwogICAgdmFyIHN0YXJ0VGFnLCBlbmRUYWc7CiAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KCiAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiBjb25maWcucGVyZm9ybWFuY2UgJiYgbWFyaykgewogICAgICBzdGFydFRhZyA9ICJ2dWUtcGVyZi1zdGFydDoiICsgdm0uX3VpZDsKICAgICAgZW5kVGFnID0gInZ1ZS1wZXJmLWVuZDoiICsgdm0uX3VpZDsKICAgICAgbWFyayhzdGFydFRhZyk7CiAgICB9IC8vIGEgZmxhZyB0byBhdm9pZCB0aGlzIGJlaW5nIG9ic2VydmVkCgoKICAgIHZtLl9pc1Z1ZSA9IHRydWU7IC8vIG1lcmdlIG9wdGlvbnMKCiAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLl9pc0NvbXBvbmVudCkgewogICAgICAvLyBvcHRpbWl6ZSBpbnRlcm5hbCBjb21wb25lbnQgaW5zdGFudGlhdGlvbgogICAgICAvLyBzaW5jZSBkeW5hbWljIG9wdGlvbnMgbWVyZ2luZyBpcyBwcmV0dHkgc2xvdywgYW5kIG5vbmUgb2YgdGhlCiAgICAgIC8vIGludGVybmFsIGNvbXBvbmVudCBvcHRpb25zIG5lZWRzIHNwZWNpYWwgdHJlYXRtZW50LgogICAgICBpbml0SW50ZXJuYWxDb21wb25lbnQodm0sIG9wdGlvbnMpOwogICAgfSBlbHNlIHsKICAgICAgdm0uJG9wdGlvbnMgPSBtZXJnZU9wdGlvbnMocmVzb2x2ZUNvbnN0cnVjdG9yT3B0aW9ucyh2bS5jb25zdHJ1Y3RvciksIG9wdGlvbnMgfHwge30sIHZtKTsKICAgIH0KICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBlbHNlICovCgoKICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICAgIGluaXRQcm94eSh2bSk7CiAgICB9IGVsc2UgewogICAgICB2bS5fcmVuZGVyUHJveHkgPSB2bTsKICAgIH0gLy8gZXhwb3NlIHJlYWwgc2VsZgoKCiAgICB2bS5fc2VsZiA9IHZtOwogICAgaW5pdExpZmVjeWNsZSh2bSk7CiAgICBpbml0RXZlbnRzKHZtKTsKICAgIGluaXRSZW5kZXIodm0pOwogICAgY2FsbEhvb2sodm0sICdiZWZvcmVDcmVhdGUnKTsKICAgIGluaXRJbmplY3Rpb25zKHZtKTsgLy8gcmVzb2x2ZSBpbmplY3Rpb25zIGJlZm9yZSBkYXRhL3Byb3BzCgogICAgaW5pdFN0YXRlKHZtKTsKICAgIGluaXRQcm92aWRlKHZtKTsgLy8gcmVzb2x2ZSBwcm92aWRlIGFmdGVyIGRhdGEvcHJvcHMKCiAgICBjYWxsSG9vayh2bSwgJ2NyZWF0ZWQnKTsKICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwoKICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIGNvbmZpZy5wZXJmb3JtYW5jZSAmJiBtYXJrKSB7CiAgICAgIHZtLl9uYW1lID0gZm9ybWF0Q29tcG9uZW50TmFtZSh2bSwgZmFsc2UpOwogICAgICBtYXJrKGVuZFRhZyk7CiAgICAgIG1lYXN1cmUoInZ1ZSAiICsgdm0uX25hbWUgKyAiIGluaXQiLCBzdGFydFRhZywgZW5kVGFnKTsKICAgIH0KCiAgICBpZiAodm0uJG9wdGlvbnMuZWwpIHsKICAgICAgdm0uJG1vdW50KHZtLiRvcHRpb25zLmVsKTsKICAgIH0KICB9Owp9CgpmdW5jdGlvbiBpbml0SW50ZXJuYWxDb21wb25lbnQodm0sIG9wdGlvbnMpIHsKICB2YXIgb3B0cyA9IHZtLiRvcHRpb25zID0gT2JqZWN0LmNyZWF0ZSh2bS5jb25zdHJ1Y3Rvci5vcHRpb25zKTsgLy8gZG9pbmcgdGhpcyBiZWNhdXNlIGl0J3MgZmFzdGVyIHRoYW4gZHluYW1pYyBlbnVtZXJhdGlvbi4KCiAgdmFyIHBhcmVudFZub2RlID0gb3B0aW9ucy5fcGFyZW50Vm5vZGU7CiAgb3B0cy5wYXJlbnQgPSBvcHRpb25zLnBhcmVudDsKICBvcHRzLl9wYXJlbnRWbm9kZSA9IHBhcmVudFZub2RlOwogIHZhciB2bm9kZUNvbXBvbmVudE9wdGlvbnMgPSBwYXJlbnRWbm9kZS5jb21wb25lbnRPcHRpb25zOwogIG9wdHMucHJvcHNEYXRhID0gdm5vZGVDb21wb25lbnRPcHRpb25zLnByb3BzRGF0YTsKICBvcHRzLl9wYXJlbnRMaXN0ZW5lcnMgPSB2bm9kZUNvbXBvbmVudE9wdGlvbnMubGlzdGVuZXJzOwogIG9wdHMuX3JlbmRlckNoaWxkcmVuID0gdm5vZGVDb21wb25lbnRPcHRpb25zLmNoaWxkcmVuOwogIG9wdHMuX2NvbXBvbmVudFRhZyA9IHZub2RlQ29tcG9uZW50T3B0aW9ucy50YWc7CgogIGlmIChvcHRpb25zLnJlbmRlcikgewogICAgb3B0cy5yZW5kZXIgPSBvcHRpb25zLnJlbmRlcjsKICAgIG9wdHMuc3RhdGljUmVuZGVyRm5zID0gb3B0aW9ucy5zdGF0aWNSZW5kZXJGbnM7CiAgfQp9CgpmdW5jdGlvbiByZXNvbHZlQ29uc3RydWN0b3JPcHRpb25zKEN0b3IpIHsKICB2YXIgb3B0aW9ucyA9IEN0b3Iub3B0aW9uczsKCiAgaWYgKEN0b3JbInN1cGVyIl0pIHsKICAgIHZhciBzdXBlck9wdGlvbnMgPSByZXNvbHZlQ29uc3RydWN0b3JPcHRpb25zKEN0b3JbInN1cGVyIl0pOwogICAgdmFyIGNhY2hlZFN1cGVyT3B0aW9ucyA9IEN0b3Iuc3VwZXJPcHRpb25zOwoKICAgIGlmIChzdXBlck9wdGlvbnMgIT09IGNhY2hlZFN1cGVyT3B0aW9ucykgewogICAgICAvLyBzdXBlciBvcHRpb24gY2hhbmdlZCwKICAgICAgLy8gbmVlZCB0byByZXNvbHZlIG5ldyBvcHRpb25zLgogICAgICBDdG9yLnN1cGVyT3B0aW9ucyA9IHN1cGVyT3B0aW9uczsgLy8gY2hlY2sgaWYgdGhlcmUgYXJlIGFueSBsYXRlLW1vZGlmaWVkL2F0dGFjaGVkIG9wdGlvbnMgKCM0OTc2KQoKICAgICAgdmFyIG1vZGlmaWVkT3B0aW9ucyA9IHJlc29sdmVNb2RpZmllZE9wdGlvbnMoQ3Rvcik7IC8vIHVwZGF0ZSBiYXNlIGV4dGVuZCBvcHRpb25zCgogICAgICBpZiAobW9kaWZpZWRPcHRpb25zKSB7CiAgICAgICAgZXh0ZW5kKEN0b3IuZXh0ZW5kT3B0aW9ucywgbW9kaWZpZWRPcHRpb25zKTsKICAgICAgfQoKICAgICAgb3B0aW9ucyA9IEN0b3Iub3B0aW9ucyA9IG1lcmdlT3B0aW9ucyhzdXBlck9wdGlvbnMsIEN0b3IuZXh0ZW5kT3B0aW9ucyk7CgogICAgICBpZiAob3B0aW9ucy5uYW1lKSB7CiAgICAgICAgb3B0aW9ucy5jb21wb25lbnRzW29wdGlvbnMubmFtZV0gPSBDdG9yOwogICAgICB9CiAgICB9CiAgfQoKICByZXR1cm4gb3B0aW9uczsKfQoKZnVuY3Rpb24gcmVzb2x2ZU1vZGlmaWVkT3B0aW9ucyhDdG9yKSB7CiAgdmFyIG1vZGlmaWVkOwogIHZhciBsYXRlc3QgPSBDdG9yLm9wdGlvbnM7CiAgdmFyIHNlYWxlZCA9IEN0b3Iuc2VhbGVkT3B0aW9uczsKCiAgZm9yICh2YXIga2V5IGluIGxhdGVzdCkgewogICAgaWYgKGxhdGVzdFtrZXldICE9PSBzZWFsZWRba2V5XSkgewogICAgICBpZiAoIW1vZGlmaWVkKSB7CiAgICAgICAgbW9kaWZpZWQgPSB7fTsKICAgICAgfQoKICAgICAgbW9kaWZpZWRba2V5XSA9IGxhdGVzdFtrZXldOwogICAgfQogIH0KCiAgcmV0dXJuIG1vZGlmaWVkOwp9CgpmdW5jdGlvbiBWdWUob3B0aW9ucykgewogIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmICEodGhpcyBpbnN0YW5jZW9mIFZ1ZSkpIHsKICAgIHdhcm4oJ1Z1ZSBpcyBhIGNvbnN0cnVjdG9yIGFuZCBzaG91bGQgYmUgY2FsbGVkIHdpdGggdGhlIGBuZXdgIGtleXdvcmQnKTsKICB9CgogIHRoaXMuX2luaXQob3B0aW9ucyk7Cn0KCmluaXRNaXhpbihWdWUpOwpzdGF0ZU1peGluKFZ1ZSk7CmV2ZW50c01peGluKFZ1ZSk7CmxpZmVjeWNsZU1peGluKFZ1ZSk7CnJlbmRlck1peGluKFZ1ZSk7Ci8qICAqLwoKZnVuY3Rpb24gaW5pdFVzZShWdWUpIHsKICBWdWUudXNlID0gZnVuY3Rpb24gKHBsdWdpbikgewogICAgdmFyIGluc3RhbGxlZFBsdWdpbnMgPSB0aGlzLl9pbnN0YWxsZWRQbHVnaW5zIHx8ICh0aGlzLl9pbnN0YWxsZWRQbHVnaW5zID0gW10pOwoKICAgIGlmIChpbnN0YWxsZWRQbHVnaW5zLmluZGV4T2YocGx1Z2luKSA+IC0xKSB7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSAvLyBhZGRpdGlvbmFsIHBhcmFtZXRlcnMKCgogICAgdmFyIGFyZ3MgPSB0b0FycmF5KGFyZ3VtZW50cywgMSk7CiAgICBhcmdzLnVuc2hpZnQodGhpcyk7CgogICAgaWYgKHR5cGVvZiBwbHVnaW4uaW5zdGFsbCA9PT0gJ2Z1bmN0aW9uJykgewogICAgICBwbHVnaW4uaW5zdGFsbC5hcHBseShwbHVnaW4sIGFyZ3MpOwogICAgfSBlbHNlIGlmICh0eXBlb2YgcGx1Z2luID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIHBsdWdpbi5hcHBseShudWxsLCBhcmdzKTsKICAgIH0KCiAgICBpbnN0YWxsZWRQbHVnaW5zLnB1c2gocGx1Z2luKTsKICAgIHJldHVybiB0aGlzOwogIH07Cn0KLyogICovCgoKZnVuY3Rpb24gaW5pdE1peGluJDEoVnVlKSB7CiAgVnVlLm1peGluID0gZnVuY3Rpb24gKG1peGluKSB7CiAgICB0aGlzLm9wdGlvbnMgPSBtZXJnZU9wdGlvbnModGhpcy5vcHRpb25zLCBtaXhpbik7CiAgICByZXR1cm4gdGhpczsKICB9Owp9Ci8qICAqLwoKCmZ1bmN0aW9uIGluaXRFeHRlbmQoVnVlKSB7CiAgLyoqCiAgICogRWFjaCBpbnN0YW5jZSBjb25zdHJ1Y3RvciwgaW5jbHVkaW5nIFZ1ZSwgaGFzIGEgdW5pcXVlCiAgICogY2lkLiBUaGlzIGVuYWJsZXMgdXMgdG8gY3JlYXRlIHdyYXBwZWQgImNoaWxkCiAgICogY29uc3RydWN0b3JzIiBmb3IgcHJvdG90eXBhbCBpbmhlcml0YW5jZSBhbmQgY2FjaGUgdGhlbS4KICAgKi8KICBWdWUuY2lkID0gMDsKICB2YXIgY2lkID0gMTsKICAvKioKICAgKiBDbGFzcyBpbmhlcml0YW5jZQogICAqLwoKICBWdWUuZXh0ZW5kID0gZnVuY3Rpb24gKGV4dGVuZE9wdGlvbnMpIHsKICAgIGV4dGVuZE9wdGlvbnMgPSBleHRlbmRPcHRpb25zIHx8IHt9OwogICAgdmFyIFN1cGVyID0gdGhpczsKICAgIHZhciBTdXBlcklkID0gU3VwZXIuY2lkOwogICAgdmFyIGNhY2hlZEN0b3JzID0gZXh0ZW5kT3B0aW9ucy5fQ3RvciB8fCAoZXh0ZW5kT3B0aW9ucy5fQ3RvciA9IHt9KTsKCiAgICBpZiAoY2FjaGVkQ3RvcnNbU3VwZXJJZF0pIHsKICAgICAgcmV0dXJuIGNhY2hlZEN0b3JzW1N1cGVySWRdOwogICAgfQoKICAgIHZhciBuYW1lID0gZXh0ZW5kT3B0aW9ucy5uYW1lIHx8IFN1cGVyLm9wdGlvbnMubmFtZTsKCiAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiBuYW1lKSB7CiAgICAgIHZhbGlkYXRlQ29tcG9uZW50TmFtZShuYW1lKTsKICAgIH0KCiAgICB2YXIgU3ViID0gZnVuY3Rpb24gVnVlQ29tcG9uZW50KG9wdGlvbnMpIHsKICAgICAgdGhpcy5faW5pdChvcHRpb25zKTsKICAgIH07CgogICAgU3ViLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoU3VwZXIucHJvdG90eXBlKTsKICAgIFN1Yi5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBTdWI7CiAgICBTdWIuY2lkID0gY2lkKys7CiAgICBTdWIub3B0aW9ucyA9IG1lcmdlT3B0aW9ucyhTdXBlci5vcHRpb25zLCBleHRlbmRPcHRpb25zKTsKICAgIFN1Ylsnc3VwZXInXSA9IFN1cGVyOyAvLyBGb3IgcHJvcHMgYW5kIGNvbXB1dGVkIHByb3BlcnRpZXMsIHdlIGRlZmluZSB0aGUgcHJveHkgZ2V0dGVycyBvbgogICAgLy8gdGhlIFZ1ZSBpbnN0YW5jZXMgYXQgZXh0ZW5zaW9uIHRpbWUsIG9uIHRoZSBleHRlbmRlZCBwcm90b3R5cGUuIFRoaXMKICAgIC8vIGF2b2lkcyBPYmplY3QuZGVmaW5lUHJvcGVydHkgY2FsbHMgZm9yIGVhY2ggaW5zdGFuY2UgY3JlYXRlZC4KCiAgICBpZiAoU3ViLm9wdGlvbnMucHJvcHMpIHsKICAgICAgaW5pdFByb3BzJDEoU3ViKTsKICAgIH0KCiAgICBpZiAoU3ViLm9wdGlvbnMuY29tcHV0ZWQpIHsKICAgICAgaW5pdENvbXB1dGVkJDEoU3ViKTsKICAgIH0gLy8gYWxsb3cgZnVydGhlciBleHRlbnNpb24vbWl4aW4vcGx1Z2luIHVzYWdlCgoKICAgIFN1Yi5leHRlbmQgPSBTdXBlci5leHRlbmQ7CiAgICBTdWIubWl4aW4gPSBTdXBlci5taXhpbjsKICAgIFN1Yi51c2UgPSBTdXBlci51c2U7IC8vIGNyZWF0ZSBhc3NldCByZWdpc3RlcnMsIHNvIGV4dGVuZGVkIGNsYXNzZXMKICAgIC8vIGNhbiBoYXZlIHRoZWlyIHByaXZhdGUgYXNzZXRzIHRvby4KCiAgICBBU1NFVF9UWVBFUy5mb3JFYWNoKGZ1bmN0aW9uICh0eXBlKSB7CiAgICAgIFN1Ylt0eXBlXSA9IFN1cGVyW3R5cGVdOwogICAgfSk7IC8vIGVuYWJsZSByZWN1cnNpdmUgc2VsZi1sb29rdXAKCiAgICBpZiAobmFtZSkgewogICAgICBTdWIub3B0aW9ucy5jb21wb25lbnRzW25hbWVdID0gU3ViOwogICAgfSAvLyBrZWVwIGEgcmVmZXJlbmNlIHRvIHRoZSBzdXBlciBvcHRpb25zIGF0IGV4dGVuc2lvbiB0aW1lLgogICAgLy8gbGF0ZXIgYXQgaW5zdGFudGlhdGlvbiB3ZSBjYW4gY2hlY2sgaWYgU3VwZXIncyBvcHRpb25zIGhhdmUKICAgIC8vIGJlZW4gdXBkYXRlZC4KCgogICAgU3ViLnN1cGVyT3B0aW9ucyA9IFN1cGVyLm9wdGlvbnM7CiAgICBTdWIuZXh0ZW5kT3B0aW9ucyA9IGV4dGVuZE9wdGlvbnM7CiAgICBTdWIuc2VhbGVkT3B0aW9ucyA9IGV4dGVuZCh7fSwgU3ViLm9wdGlvbnMpOyAvLyBjYWNoZSBjb25zdHJ1Y3RvcgoKICAgIGNhY2hlZEN0b3JzW1N1cGVySWRdID0gU3ViOwogICAgcmV0dXJuIFN1YjsKICB9Owp9CgpmdW5jdGlvbiBpbml0UHJvcHMkMShDb21wKSB7CiAgdmFyIHByb3BzID0gQ29tcC5vcHRpb25zLnByb3BzOwoKICBmb3IgKHZhciBrZXkgaW4gcHJvcHMpIHsKICAgIHByb3h5KENvbXAucHJvdG90eXBlLCAiX3Byb3BzIiwga2V5KTsKICB9Cn0KCmZ1bmN0aW9uIGluaXRDb21wdXRlZCQxKENvbXApIHsKICB2YXIgY29tcHV0ZWQgPSBDb21wLm9wdGlvbnMuY29tcHV0ZWQ7CgogIGZvciAodmFyIGtleSBpbiBjb21wdXRlZCkgewogICAgZGVmaW5lQ29tcHV0ZWQoQ29tcC5wcm90b3R5cGUsIGtleSwgY29tcHV0ZWRba2V5XSk7CiAgfQp9Ci8qICAqLwoKCmZ1bmN0aW9uIGluaXRBc3NldFJlZ2lzdGVycyhWdWUpIHsKICAvKioKICAgKiBDcmVhdGUgYXNzZXQgcmVnaXN0cmF0aW9uIG1ldGhvZHMuCiAgICovCiAgQVNTRVRfVFlQRVMuZm9yRWFjaChmdW5jdGlvbiAodHlwZSkgewogICAgVnVlW3R5cGVdID0gZnVuY3Rpb24gKGlkLCBkZWZpbml0aW9uKSB7CiAgICAgIGlmICghZGVmaW5pdGlvbikgewogICAgICAgIHJldHVybiB0aGlzLm9wdGlvbnNbdHlwZSArICdzJ11baWRdOwogICAgICB9IGVsc2UgewogICAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogICAgICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIHR5cGUgPT09ICdjb21wb25lbnQnKSB7CiAgICAgICAgICB2YWxpZGF0ZUNvbXBvbmVudE5hbWUoaWQpOwogICAgICAgIH0KCiAgICAgICAgaWYgKHR5cGUgPT09ICdjb21wb25lbnQnICYmIGlzUGxhaW5PYmplY3QoZGVmaW5pdGlvbikpIHsKICAgICAgICAgIGRlZmluaXRpb24ubmFtZSA9IGRlZmluaXRpb24ubmFtZSB8fCBpZDsKICAgICAgICAgIGRlZmluaXRpb24gPSB0aGlzLm9wdGlvbnMuX2Jhc2UuZXh0ZW5kKGRlZmluaXRpb24pOwogICAgICAgIH0KCiAgICAgICAgaWYgKHR5cGUgPT09ICdkaXJlY3RpdmUnICYmIHR5cGVvZiBkZWZpbml0aW9uID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICBkZWZpbml0aW9uID0gewogICAgICAgICAgICBiaW5kOiBkZWZpbml0aW9uLAogICAgICAgICAgICB1cGRhdGU6IGRlZmluaXRpb24KICAgICAgICAgIH07CiAgICAgICAgfQoKICAgICAgICB0aGlzLm9wdGlvbnNbdHlwZSArICdzJ11baWRdID0gZGVmaW5pdGlvbjsKICAgICAgICByZXR1cm4gZGVmaW5pdGlvbjsKICAgICAgfQogICAgfTsKICB9KTsKfQovKiAgKi8KCgpmdW5jdGlvbiBnZXRDb21wb25lbnROYW1lKG9wdHMpIHsKICByZXR1cm4gb3B0cyAmJiAob3B0cy5DdG9yLm9wdGlvbnMubmFtZSB8fCBvcHRzLnRhZyk7Cn0KCmZ1bmN0aW9uIG1hdGNoZXMocGF0dGVybiwgbmFtZSkgewogIGlmIChBcnJheS5pc0FycmF5KHBhdHRlcm4pKSB7CiAgICByZXR1cm4gcGF0dGVybi5pbmRleE9mKG5hbWUpID4gLTE7CiAgfSBlbHNlIGlmICh0eXBlb2YgcGF0dGVybiA9PT0gJ3N0cmluZycpIHsKICAgIHJldHVybiBwYXR0ZXJuLnNwbGl0KCcsJykuaW5kZXhPZihuYW1lKSA+IC0xOwogIH0gZWxzZSBpZiAoaXNSZWdFeHAocGF0dGVybikpIHsKICAgIHJldHVybiBwYXR0ZXJuLnRlc3QobmFtZSk7CiAgfQogIC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovCgoKICByZXR1cm4gZmFsc2U7Cn0KCmZ1bmN0aW9uIHBydW5lQ2FjaGUoa2VlcEFsaXZlSW5zdGFuY2UsIGZpbHRlcikgewogIHZhciBjYWNoZSA9IGtlZXBBbGl2ZUluc3RhbmNlLmNhY2hlOwogIHZhciBrZXlzID0ga2VlcEFsaXZlSW5zdGFuY2Uua2V5czsKICB2YXIgX3Zub2RlID0ga2VlcEFsaXZlSW5zdGFuY2UuX3Zub2RlOwoKICBmb3IgKHZhciBrZXkgaW4gY2FjaGUpIHsKICAgIHZhciBjYWNoZWROb2RlID0gY2FjaGVba2V5XTsKCiAgICBpZiAoY2FjaGVkTm9kZSkgewogICAgICB2YXIgbmFtZSA9IGdldENvbXBvbmVudE5hbWUoY2FjaGVkTm9kZS5jb21wb25lbnRPcHRpb25zKTsKCiAgICAgIGlmIChuYW1lICYmICFmaWx0ZXIobmFtZSkpIHsKICAgICAgICBwcnVuZUNhY2hlRW50cnkoY2FjaGUsIGtleSwga2V5cywgX3Zub2RlKTsKICAgICAgfQogICAgfQogIH0KfQoKZnVuY3Rpb24gcHJ1bmVDYWNoZUVudHJ5KGNhY2hlLCBrZXksIGtleXMsIGN1cnJlbnQpIHsKICB2YXIgY2FjaGVkJCQxID0gY2FjaGVba2V5XTsKCiAgaWYgKGNhY2hlZCQkMSAmJiAoIWN1cnJlbnQgfHwgY2FjaGVkJCQxLnRhZyAhPT0gY3VycmVudC50YWcpKSB7CiAgICBjYWNoZWQkJDEuY29tcG9uZW50SW5zdGFuY2UuJGRlc3Ryb3koKTsKICB9CgogIGNhY2hlW2tleV0gPSBudWxsOwogIHJlbW92ZShrZXlzLCBrZXkpOwp9Cgp2YXIgcGF0dGVyblR5cGVzID0gW1N0cmluZywgUmVnRXhwLCBBcnJheV07CnZhciBLZWVwQWxpdmUgPSB7CiAgbmFtZTogJ2tlZXAtYWxpdmUnLAogICJhYnN0cmFjdCI6IHRydWUsCiAgcHJvcHM6IHsKICAgIGluY2x1ZGU6IHBhdHRlcm5UeXBlcywKICAgIGV4Y2x1ZGU6IHBhdHRlcm5UeXBlcywKICAgIG1heDogW1N0cmluZywgTnVtYmVyXQogIH0sCiAgY3JlYXRlZDogZnVuY3Rpb24gY3JlYXRlZCgpIHsKICAgIHRoaXMuY2FjaGUgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgdGhpcy5rZXlzID0gW107CiAgfSwKICBkZXN0cm95ZWQ6IGZ1bmN0aW9uIGRlc3Ryb3llZCgpIHsKICAgIGZvciAodmFyIGtleSBpbiB0aGlzLmNhY2hlKSB7CiAgICAgIHBydW5lQ2FjaGVFbnRyeSh0aGlzLmNhY2hlLCBrZXksIHRoaXMua2V5cyk7CiAgICB9CiAgfSwKICBtb3VudGVkOiBmdW5jdGlvbiBtb3VudGVkKCkgewogICAgdmFyIHRoaXMkMSA9IHRoaXM7CiAgICB0aGlzLiR3YXRjaCgnaW5jbHVkZScsIGZ1bmN0aW9uICh2YWwpIHsKICAgICAgcHJ1bmVDYWNoZSh0aGlzJDEsIGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgcmV0dXJuIG1hdGNoZXModmFsLCBuYW1lKTsKICAgICAgfSk7CiAgICB9KTsKICAgIHRoaXMuJHdhdGNoKCdleGNsdWRlJywgZnVuY3Rpb24gKHZhbCkgewogICAgICBwcnVuZUNhY2hlKHRoaXMkMSwgZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICByZXR1cm4gIW1hdGNoZXModmFsLCBuYW1lKTsKICAgICAgfSk7CiAgICB9KTsKICB9LAogIHJlbmRlcjogZnVuY3Rpb24gcmVuZGVyKCkgewogICAgdmFyIHNsb3QgPSB0aGlzLiRzbG90c1siZGVmYXVsdCJdOwogICAgdmFyIHZub2RlID0gZ2V0Rmlyc3RDb21wb25lbnRDaGlsZChzbG90KTsKICAgIHZhciBjb21wb25lbnRPcHRpb25zID0gdm5vZGUgJiYgdm5vZGUuY29tcG9uZW50T3B0aW9uczsKCiAgICBpZiAoY29tcG9uZW50T3B0aW9ucykgewogICAgICAvLyBjaGVjayBwYXR0ZXJuCiAgICAgIHZhciBuYW1lID0gZ2V0Q29tcG9uZW50TmFtZShjb21wb25lbnRPcHRpb25zKTsKICAgICAgdmFyIHJlZiA9IHRoaXM7CiAgICAgIHZhciBpbmNsdWRlID0gcmVmLmluY2x1ZGU7CiAgICAgIHZhciBleGNsdWRlID0gcmVmLmV4Y2x1ZGU7CgogICAgICBpZiAoIC8vIG5vdCBpbmNsdWRlZAogICAgICBpbmNsdWRlICYmICghbmFtZSB8fCAhbWF0Y2hlcyhpbmNsdWRlLCBuYW1lKSkgfHwgLy8gZXhjbHVkZWQKICAgICAgZXhjbHVkZSAmJiBuYW1lICYmIG1hdGNoZXMoZXhjbHVkZSwgbmFtZSkpIHsKICAgICAgICByZXR1cm4gdm5vZGU7CiAgICAgIH0KCiAgICAgIHZhciByZWYkMSA9IHRoaXM7CiAgICAgIHZhciBjYWNoZSA9IHJlZiQxLmNhY2hlOwogICAgICB2YXIga2V5cyA9IHJlZiQxLmtleXM7CiAgICAgIHZhciBrZXkgPSB2bm9kZS5rZXkgPT0gbnVsbCAvLyBzYW1lIGNvbnN0cnVjdG9yIG1heSBnZXQgcmVnaXN0ZXJlZCBhcyBkaWZmZXJlbnQgbG9jYWwgY29tcG9uZW50cwogICAgICAvLyBzbyBjaWQgYWxvbmUgaXMgbm90IGVub3VnaCAoIzMyNjkpCiAgICAgID8gY29tcG9uZW50T3B0aW9ucy5DdG9yLmNpZCArIChjb21wb25lbnRPcHRpb25zLnRhZyA/ICI6OiIgKyBjb21wb25lbnRPcHRpb25zLnRhZyA6ICcnKSA6IHZub2RlLmtleTsKCiAgICAgIGlmIChjYWNoZVtrZXldKSB7CiAgICAgICAgdm5vZGUuY29tcG9uZW50SW5zdGFuY2UgPSBjYWNoZVtrZXldLmNvbXBvbmVudEluc3RhbmNlOyAvLyBtYWtlIGN1cnJlbnQga2V5IGZyZXNoZXN0CgogICAgICAgIHJlbW92ZShrZXlzLCBrZXkpOwogICAgICAgIGtleXMucHVzaChrZXkpOwogICAgICB9IGVsc2UgewogICAgICAgIGNhY2hlW2tleV0gPSB2bm9kZTsKICAgICAgICBrZXlzLnB1c2goa2V5KTsgLy8gcHJ1bmUgb2xkZXN0IGVudHJ5CgogICAgICAgIGlmICh0aGlzLm1heCAmJiBrZXlzLmxlbmd0aCA+IHBhcnNlSW50KHRoaXMubWF4KSkgewogICAgICAgICAgcHJ1bmVDYWNoZUVudHJ5KGNhY2hlLCBrZXlzWzBdLCBrZXlzLCB0aGlzLl92bm9kZSk7CiAgICAgICAgfQogICAgICB9CgogICAgICB2bm9kZS5kYXRhLmtlZXBBbGl2ZSA9IHRydWU7CiAgICB9CgogICAgcmV0dXJuIHZub2RlIHx8IHNsb3QgJiYgc2xvdFswXTsKICB9Cn07CnZhciBidWlsdEluQ29tcG9uZW50cyA9IHsKICBLZWVwQWxpdmU6IEtlZXBBbGl2ZQp9OwovKiAgKi8KCmZ1bmN0aW9uIGluaXRHbG9iYWxBUEkoVnVlKSB7CiAgLy8gY29uZmlnCiAgdmFyIGNvbmZpZ0RlZiA9IHt9OwoKICBjb25maWdEZWYuZ2V0ID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGNvbmZpZzsKICB9OwoKICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgY29uZmlnRGVmLnNldCA9IGZ1bmN0aW9uICgpIHsKICAgICAgd2FybignRG8gbm90IHJlcGxhY2UgdGhlIFZ1ZS5jb25maWcgb2JqZWN0LCBzZXQgaW5kaXZpZHVhbCBmaWVsZHMgaW5zdGVhZC4nKTsKICAgIH07CiAgfQoKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoVnVlLCAnY29uZmlnJywgY29uZmlnRGVmKTsgLy8gZXhwb3NlZCB1dGlsIG1ldGhvZHMuCiAgLy8gTk9URTogdGhlc2UgYXJlIG5vdCBjb25zaWRlcmVkIHBhcnQgb2YgdGhlIHB1YmxpYyBBUEkgLSBhdm9pZCByZWx5aW5nIG9uCiAgLy8gdGhlbSB1bmxlc3MgeW91IGFyZSBhd2FyZSBvZiB0aGUgcmlzay4KCiAgVnVlLnV0aWwgPSB7CiAgICB3YXJuOiB3YXJuLAogICAgZXh0ZW5kOiBleHRlbmQsCiAgICBtZXJnZU9wdGlvbnM6IG1lcmdlT3B0aW9ucywKICAgIGRlZmluZVJlYWN0aXZlOiBkZWZpbmVSZWFjdGl2ZSQkMQogIH07CiAgVnVlLnNldCA9IHNldDsKICBWdWVbImRlbGV0ZSJdID0gZGVsOwogIFZ1ZS5uZXh0VGljayA9IG5leHRUaWNrOyAvLyAyLjYgZXhwbGljaXQgb2JzZXJ2YWJsZSBBUEkKCiAgVnVlLm9ic2VydmFibGUgPSBmdW5jdGlvbiAob2JqKSB7CiAgICBvYnNlcnZlKG9iaik7CiAgICByZXR1cm4gb2JqOwogIH07CgogIFZ1ZS5vcHRpb25zID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICBBU1NFVF9UWVBFUy5mb3JFYWNoKGZ1bmN0aW9uICh0eXBlKSB7CiAgICBWdWUub3B0aW9uc1t0eXBlICsgJ3MnXSA9IE9iamVjdC5jcmVhdGUobnVsbCk7CiAgfSk7IC8vIHRoaXMgaXMgdXNlZCB0byBpZGVudGlmeSB0aGUgImJhc2UiIGNvbnN0cnVjdG9yIHRvIGV4dGVuZCBhbGwgcGxhaW4tb2JqZWN0CiAgLy8gY29tcG9uZW50cyB3aXRoIGluIFdlZXgncyBtdWx0aS1pbnN0YW5jZSBzY2VuYXJpb3MuCgogIFZ1ZS5vcHRpb25zLl9iYXNlID0gVnVlOwogIGV4dGVuZChWdWUub3B0aW9ucy5jb21wb25lbnRzLCBidWlsdEluQ29tcG9uZW50cyk7CiAgaW5pdFVzZShWdWUpOwogIGluaXRNaXhpbiQxKFZ1ZSk7CiAgaW5pdEV4dGVuZChWdWUpOwogIGluaXRBc3NldFJlZ2lzdGVycyhWdWUpOwp9Cgppbml0R2xvYmFsQVBJKFZ1ZSk7Ck9iamVjdC5kZWZpbmVQcm9wZXJ0eShWdWUucHJvdG90eXBlLCAnJGlzU2VydmVyJywgewogIGdldDogaXNTZXJ2ZXJSZW5kZXJpbmcKfSk7Ck9iamVjdC5kZWZpbmVQcm9wZXJ0eShWdWUucHJvdG90eXBlLCAnJHNzckNvbnRleHQnLCB7CiAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLwogICAgcmV0dXJuIHRoaXMuJHZub2RlICYmIHRoaXMuJHZub2RlLnNzckNvbnRleHQ7CiAgfQp9KTsgLy8gZXhwb3NlIEZ1bmN0aW9uYWxSZW5kZXJDb250ZXh0IGZvciBzc3IgcnVudGltZSBoZWxwZXIgaW5zdGFsbGF0aW9uCgpPYmplY3QuZGVmaW5lUHJvcGVydHkoVnVlLCAnRnVuY3Rpb25hbFJlbmRlckNvbnRleHQnLCB7CiAgdmFsdWU6IEZ1bmN0aW9uYWxSZW5kZXJDb250ZXh0Cn0pOwpWdWUudmVyc2lvbiA9ICcyLjYuMTAnOwovKiAgKi8KLy8gdGhlc2UgYXJlIHJlc2VydmVkIGZvciB3ZWIgYmVjYXVzZSB0aGV5IGFyZSBkaXJlY3RseSBjb21waWxlZCBhd2F5Ci8vIGR1cmluZyB0ZW1wbGF0ZSBjb21waWxhdGlvbgoKdmFyIGlzUmVzZXJ2ZWRBdHRyID0gbWFrZU1hcCgnc3R5bGUsY2xhc3MnKTsgLy8gYXR0cmlidXRlcyB0aGF0IHNob3VsZCBiZSB1c2luZyBwcm9wcyBmb3IgYmluZGluZwoKdmFyIGFjY2VwdFZhbHVlID0gbWFrZU1hcCgnaW5wdXQsdGV4dGFyZWEsb3B0aW9uLHNlbGVjdCxwcm9ncmVzcycpOwoKdmFyIG11c3RVc2VQcm9wID0gZnVuY3Rpb24gbXVzdFVzZVByb3AodGFnLCB0eXBlLCBhdHRyKSB7CiAgcmV0dXJuIGF0dHIgPT09ICd2YWx1ZScgJiYgYWNjZXB0VmFsdWUodGFnKSAmJiB0eXBlICE9PSAnYnV0dG9uJyB8fCBhdHRyID09PSAnc2VsZWN0ZWQnICYmIHRhZyA9PT0gJ29wdGlvbicgfHwgYXR0ciA9PT0gJ2NoZWNrZWQnICYmIHRhZyA9PT0gJ2lucHV0JyB8fCBhdHRyID09PSAnbXV0ZWQnICYmIHRhZyA9PT0gJ3ZpZGVvJzsKfTsKCnZhciBpc0VudW1lcmF0ZWRBdHRyID0gbWFrZU1hcCgnY29udGVudGVkaXRhYmxlLGRyYWdnYWJsZSxzcGVsbGNoZWNrJyk7CnZhciBpc1ZhbGlkQ29udGVudEVkaXRhYmxlVmFsdWUgPSBtYWtlTWFwKCdldmVudHMsY2FyZXQsdHlwaW5nLHBsYWludGV4dC1vbmx5Jyk7Cgp2YXIgY29udmVydEVudW1lcmF0ZWRWYWx1ZSA9IGZ1bmN0aW9uIGNvbnZlcnRFbnVtZXJhdGVkVmFsdWUoa2V5LCB2YWx1ZSkgewogIHJldHVybiBpc0ZhbHN5QXR0clZhbHVlKHZhbHVlKSB8fCB2YWx1ZSA9PT0gJ2ZhbHNlJyA/ICdmYWxzZScgLy8gYWxsb3cgYXJiaXRyYXJ5IHN0cmluZyB2YWx1ZSBmb3IgY29udGVudGVkaXRhYmxlCiAgOiBrZXkgPT09ICdjb250ZW50ZWRpdGFibGUnICYmIGlzVmFsaWRDb250ZW50RWRpdGFibGVWYWx1ZSh2YWx1ZSkgPyB2YWx1ZSA6ICd0cnVlJzsKfTsKCnZhciBpc0Jvb2xlYW5BdHRyID0gbWFrZU1hcCgnYWxsb3dmdWxsc2NyZWVuLGFzeW5jLGF1dG9mb2N1cyxhdXRvcGxheSxjaGVja2VkLGNvbXBhY3QsY29udHJvbHMsZGVjbGFyZSwnICsgJ2RlZmF1bHQsZGVmYXVsdGNoZWNrZWQsZGVmYXVsdG11dGVkLGRlZmF1bHRzZWxlY3RlZCxkZWZlcixkaXNhYmxlZCwnICsgJ2VuYWJsZWQsZm9ybW5vdmFsaWRhdGUsaGlkZGVuLGluZGV0ZXJtaW5hdGUsaW5lcnQsaXNtYXAsaXRlbXNjb3BlLGxvb3AsbXVsdGlwbGUsJyArICdtdXRlZCxub2hyZWYsbm9yZXNpemUsbm9zaGFkZSxub3ZhbGlkYXRlLG5vd3JhcCxvcGVuLHBhdXNlb25leGl0LHJlYWRvbmx5LCcgKyAncmVxdWlyZWQscmV2ZXJzZWQsc2NvcGVkLHNlYW1sZXNzLHNlbGVjdGVkLHNvcnRhYmxlLHRyYW5zbGF0ZSwnICsgJ3RydWVzcGVlZCx0eXBlbXVzdG1hdGNoLHZpc2libGUnKTsKdmFyIHhsaW5rTlMgPSAnaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayc7Cgp2YXIgaXNYbGluayA9IGZ1bmN0aW9uIGlzWGxpbmsobmFtZSkgewogIHJldHVybiBuYW1lLmNoYXJBdCg1KSA9PT0gJzonICYmIG5hbWUuc2xpY2UoMCwgNSkgPT09ICd4bGluayc7Cn07Cgp2YXIgZ2V0WGxpbmtQcm9wID0gZnVuY3Rpb24gZ2V0WGxpbmtQcm9wKG5hbWUpIHsKICByZXR1cm4gaXNYbGluayhuYW1lKSA/IG5hbWUuc2xpY2UoNiwgbmFtZS5sZW5ndGgpIDogJyc7Cn07Cgp2YXIgaXNGYWxzeUF0dHJWYWx1ZSA9IGZ1bmN0aW9uIGlzRmFsc3lBdHRyVmFsdWUodmFsKSB7CiAgcmV0dXJuIHZhbCA9PSBudWxsIHx8IHZhbCA9PT0gZmFsc2U7Cn07Ci8qICAqLwoKCmZ1bmN0aW9uIGdlbkNsYXNzRm9yVm5vZGUodm5vZGUpIHsKICB2YXIgZGF0YSA9IHZub2RlLmRhdGE7CiAgdmFyIHBhcmVudE5vZGUgPSB2bm9kZTsKICB2YXIgY2hpbGROb2RlID0gdm5vZGU7CgogIHdoaWxlIChpc0RlZihjaGlsZE5vZGUuY29tcG9uZW50SW5zdGFuY2UpKSB7CiAgICBjaGlsZE5vZGUgPSBjaGlsZE5vZGUuY29tcG9uZW50SW5zdGFuY2UuX3Zub2RlOwoKICAgIGlmIChjaGlsZE5vZGUgJiYgY2hpbGROb2RlLmRhdGEpIHsKICAgICAgZGF0YSA9IG1lcmdlQ2xhc3NEYXRhKGNoaWxkTm9kZS5kYXRhLCBkYXRhKTsKICAgIH0KICB9CgogIHdoaWxlIChpc0RlZihwYXJlbnROb2RlID0gcGFyZW50Tm9kZS5wYXJlbnQpKSB7CiAgICBpZiAocGFyZW50Tm9kZSAmJiBwYXJlbnROb2RlLmRhdGEpIHsKICAgICAgZGF0YSA9IG1lcmdlQ2xhc3NEYXRhKGRhdGEsIHBhcmVudE5vZGUuZGF0YSk7CiAgICB9CiAgfQoKICByZXR1cm4gcmVuZGVyQ2xhc3MoZGF0YS5zdGF0aWNDbGFzcywgZGF0YVsiY2xhc3MiXSk7Cn0KCmZ1bmN0aW9uIG1lcmdlQ2xhc3NEYXRhKGNoaWxkLCBwYXJlbnQpIHsKICByZXR1cm4gewogICAgc3RhdGljQ2xhc3M6IGNvbmNhdChjaGlsZC5zdGF0aWNDbGFzcywgcGFyZW50LnN0YXRpY0NsYXNzKSwKICAgICJjbGFzcyI6IGlzRGVmKGNoaWxkWyJjbGFzcyJdKSA/IFtjaGlsZFsiY2xhc3MiXSwgcGFyZW50WyJjbGFzcyJdXSA6IHBhcmVudFsiY2xhc3MiXQogIH07Cn0KCmZ1bmN0aW9uIHJlbmRlckNsYXNzKHN0YXRpY0NsYXNzLCBkeW5hbWljQ2xhc3MpIHsKICBpZiAoaXNEZWYoc3RhdGljQ2xhc3MpIHx8IGlzRGVmKGR5bmFtaWNDbGFzcykpIHsKICAgIHJldHVybiBjb25jYXQoc3RhdGljQ2xhc3MsIHN0cmluZ2lmeUNsYXNzKGR5bmFtaWNDbGFzcykpOwogIH0KICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLwoKCiAgcmV0dXJuICcnOwp9CgpmdW5jdGlvbiBjb25jYXQoYSwgYikgewogIHJldHVybiBhID8gYiA/IGEgKyAnICcgKyBiIDogYSA6IGIgfHwgJyc7Cn0KCmZ1bmN0aW9uIHN0cmluZ2lmeUNsYXNzKHZhbHVlKSB7CiAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7CiAgICByZXR1cm4gc3RyaW5naWZ5QXJyYXkodmFsdWUpOwogIH0KCiAgaWYgKGlzT2JqZWN0KHZhbHVlKSkgewogICAgcmV0dXJuIHN0cmluZ2lmeU9iamVjdCh2YWx1ZSk7CiAgfQoKICBpZiAodHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJykgewogICAgcmV0dXJuIHZhbHVlOwogIH0KICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLwoKCiAgcmV0dXJuICcnOwp9CgpmdW5jdGlvbiBzdHJpbmdpZnlBcnJheSh2YWx1ZSkgewogIHZhciByZXMgPSAnJzsKICB2YXIgc3RyaW5naWZpZWQ7CgogIGZvciAodmFyIGkgPSAwLCBsID0gdmFsdWUubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICBpZiAoaXNEZWYoc3RyaW5naWZpZWQgPSBzdHJpbmdpZnlDbGFzcyh2YWx1ZVtpXSkpICYmIHN0cmluZ2lmaWVkICE9PSAnJykgewogICAgICBpZiAocmVzKSB7CiAgICAgICAgcmVzICs9ICcgJzsKICAgICAgfQoKICAgICAgcmVzICs9IHN0cmluZ2lmaWVkOwogICAgfQogIH0KCiAgcmV0dXJuIHJlczsKfQoKZnVuY3Rpb24gc3RyaW5naWZ5T2JqZWN0KHZhbHVlKSB7CiAgdmFyIHJlcyA9ICcnOwoKICBmb3IgKHZhciBrZXkgaW4gdmFsdWUpIHsKICAgIGlmICh2YWx1ZVtrZXldKSB7CiAgICAgIGlmIChyZXMpIHsKICAgICAgICByZXMgKz0gJyAnOwogICAgICB9CgogICAgICByZXMgKz0ga2V5OwogICAgfQogIH0KCiAgcmV0dXJuIHJlczsKfQovKiAgKi8KCgp2YXIgbmFtZXNwYWNlTWFwID0gewogIHN2ZzogJ2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJywKICBtYXRoOiAnaHR0cDovL3d3dy53My5vcmcvMTk5OC9NYXRoL01hdGhNTCcKfTsKdmFyIGlzSFRNTFRhZyA9IG1ha2VNYXAoJ2h0bWwsYm9keSxiYXNlLGhlYWQsbGluayxtZXRhLHN0eWxlLHRpdGxlLCcgKyAnYWRkcmVzcyxhcnRpY2xlLGFzaWRlLGZvb3RlcixoZWFkZXIsaDEsaDIsaDMsaDQsaDUsaDYsaGdyb3VwLG5hdixzZWN0aW9uLCcgKyAnZGl2LGRkLGRsLGR0LGZpZ2NhcHRpb24sZmlndXJlLHBpY3R1cmUsaHIsaW1nLGxpLG1haW4sb2wscCxwcmUsdWwsJyArICdhLGIsYWJicixiZGksYmRvLGJyLGNpdGUsY29kZSxkYXRhLGRmbixlbSxpLGtiZCxtYXJrLHEscnAscnQscnRjLHJ1YnksJyArICdzLHNhbXAsc21hbGwsc3BhbixzdHJvbmcsc3ViLHN1cCx0aW1lLHUsdmFyLHdicixhcmVhLGF1ZGlvLG1hcCx0cmFjayx2aWRlbywnICsgJ2VtYmVkLG9iamVjdCxwYXJhbSxzb3VyY2UsY2FudmFzLHNjcmlwdCxub3NjcmlwdCxkZWwsaW5zLCcgKyAnY2FwdGlvbixjb2wsY29sZ3JvdXAsdGFibGUsdGhlYWQsdGJvZHksdGQsdGgsdHIsJyArICdidXR0b24sZGF0YWxpc3QsZmllbGRzZXQsZm9ybSxpbnB1dCxsYWJlbCxsZWdlbmQsbWV0ZXIsb3B0Z3JvdXAsb3B0aW9uLCcgKyAnb3V0cHV0LHByb2dyZXNzLHNlbGVjdCx0ZXh0YXJlYSwnICsgJ2RldGFpbHMsZGlhbG9nLG1lbnUsbWVudWl0ZW0sc3VtbWFyeSwnICsgJ2NvbnRlbnQsZWxlbWVudCxzaGFkb3csdGVtcGxhdGUsYmxvY2txdW90ZSxpZnJhbWUsdGZvb3QnKTsgLy8gdGhpcyBtYXAgaXMgaW50ZW50aW9uYWxseSBzZWxlY3RpdmUsIG9ubHkgY292ZXJpbmcgU1ZHIGVsZW1lbnRzIHRoYXQgbWF5Ci8vIGNvbnRhaW4gY2hpbGQgZWxlbWVudHMuCgp2YXIgaXNTVkcgPSBtYWtlTWFwKCdzdmcsYW5pbWF0ZSxjaXJjbGUsY2xpcHBhdGgsY3Vyc29yLGRlZnMsZGVzYyxlbGxpcHNlLGZpbHRlcixmb250LWZhY2UsJyArICdmb3JlaWduT2JqZWN0LGcsZ2x5cGgsaW1hZ2UsbGluZSxtYXJrZXIsbWFzayxtaXNzaW5nLWdseXBoLHBhdGgscGF0dGVybiwnICsgJ3BvbHlnb24scG9seWxpbmUscmVjdCxzd2l0Y2gsc3ltYm9sLHRleHQsdGV4dHBhdGgsdHNwYW4sdXNlLHZpZXcnLCB0cnVlKTsKCnZhciBpc1Jlc2VydmVkVGFnID0gZnVuY3Rpb24gaXNSZXNlcnZlZFRhZyh0YWcpIHsKICByZXR1cm4gaXNIVE1MVGFnKHRhZykgfHwgaXNTVkcodGFnKTsKfTsKCmZ1bmN0aW9uIGdldFRhZ05hbWVzcGFjZSh0YWcpIHsKICBpZiAoaXNTVkcodGFnKSkgewogICAgcmV0dXJuICdzdmcnOwogIH0gLy8gYmFzaWMgc3VwcG9ydCBmb3IgTWF0aE1MCiAgLy8gbm90ZSBpdCBkb2Vzbid0IHN1cHBvcnQgb3RoZXIgTWF0aE1MIGVsZW1lbnRzIGJlaW5nIGNvbXBvbmVudCByb290cwoKCiAgaWYgKHRhZyA9PT0gJ21hdGgnKSB7CiAgICByZXR1cm4gJ21hdGgnOwogIH0KfQoKdmFyIHVua25vd25FbGVtZW50Q2FjaGUgPSBPYmplY3QuY3JlYXRlKG51bGwpOwoKZnVuY3Rpb24gaXNVbmtub3duRWxlbWVudCh0YWcpIHsKICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICBpZiAoIWluQnJvd3NlcikgewogICAgcmV0dXJuIHRydWU7CiAgfQoKICBpZiAoaXNSZXNlcnZlZFRhZyh0YWcpKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQoKICB0YWcgPSB0YWcudG9Mb3dlckNhc2UoKTsKICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KCiAgaWYgKHVua25vd25FbGVtZW50Q2FjaGVbdGFnXSAhPSBudWxsKSB7CiAgICByZXR1cm4gdW5rbm93bkVsZW1lbnRDYWNoZVt0YWddOwogIH0KCiAgdmFyIGVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCh0YWcpOwoKICBpZiAodGFnLmluZGV4T2YoJy0nKSA+IC0xKSB7CiAgICAvLyBodHRwOi8vc3RhY2tvdmVyZmxvdy5jb20vYS8yODIxMDM2NC8xMDcwMjQ0CiAgICByZXR1cm4gdW5rbm93bkVsZW1lbnRDYWNoZVt0YWddID0gZWwuY29uc3RydWN0b3IgPT09IHdpbmRvdy5IVE1MVW5rbm93bkVsZW1lbnQgfHwgZWwuY29uc3RydWN0b3IgPT09IHdpbmRvdy5IVE1MRWxlbWVudDsKICB9IGVsc2UgewogICAgcmV0dXJuIHVua25vd25FbGVtZW50Q2FjaGVbdGFnXSA9IC9IVE1MVW5rbm93bkVsZW1lbnQvLnRlc3QoZWwudG9TdHJpbmcoKSk7CiAgfQp9Cgp2YXIgaXNUZXh0SW5wdXRUeXBlID0gbWFrZU1hcCgndGV4dCxudW1iZXIscGFzc3dvcmQsc2VhcmNoLGVtYWlsLHRlbCx1cmwnKTsKLyogICovCgovKioKICogUXVlcnkgYW4gZWxlbWVudCBzZWxlY3RvciBpZiBpdCdzIG5vdCBhbiBlbGVtZW50IGFscmVhZHkuCiAqLwoKZnVuY3Rpb24gcXVlcnkoZWwpIHsKICBpZiAodHlwZW9mIGVsID09PSAnc3RyaW5nJykgewogICAgdmFyIHNlbGVjdGVkID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihlbCk7CgogICAgaWYgKCFzZWxlY3RlZCkgewogICAgICBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIHdhcm4oJ0Nhbm5vdCBmaW5kIGVsZW1lbnQ6ICcgKyBlbCk7CiAgICAgIHJldHVybiBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgIH0KCiAgICByZXR1cm4gc2VsZWN0ZWQ7CiAgfSBlbHNlIHsKICAgIHJldHVybiBlbDsKICB9Cn0KLyogICovCgoKZnVuY3Rpb24gY3JlYXRlRWxlbWVudCQxKHRhZ05hbWUsIHZub2RlKSB7CiAgdmFyIGVsbSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQodGFnTmFtZSk7CgogIGlmICh0YWdOYW1lICE9PSAnc2VsZWN0JykgewogICAgcmV0dXJuIGVsbTsKICB9IC8vIGZhbHNlIG9yIG51bGwgd2lsbCByZW1vdmUgdGhlIGF0dHJpYnV0ZSBidXQgdW5kZWZpbmVkIHdpbGwgbm90CgoKICBpZiAodm5vZGUuZGF0YSAmJiB2bm9kZS5kYXRhLmF0dHJzICYmIHZub2RlLmRhdGEuYXR0cnMubXVsdGlwbGUgIT09IHVuZGVmaW5lZCkgewogICAgZWxtLnNldEF0dHJpYnV0ZSgnbXVsdGlwbGUnLCAnbXVsdGlwbGUnKTsKICB9CgogIHJldHVybiBlbG07Cn0KCmZ1bmN0aW9uIGNyZWF0ZUVsZW1lbnROUyhuYW1lc3BhY2UsIHRhZ05hbWUpIHsKICByZXR1cm4gZG9jdW1lbnQuY3JlYXRlRWxlbWVudE5TKG5hbWVzcGFjZU1hcFtuYW1lc3BhY2VdLCB0YWdOYW1lKTsKfQoKZnVuY3Rpb24gY3JlYXRlVGV4dE5vZGUodGV4dCkgewogIHJldHVybiBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSh0ZXh0KTsKfQoKZnVuY3Rpb24gY3JlYXRlQ29tbWVudCh0ZXh0KSB7CiAgcmV0dXJuIGRvY3VtZW50LmNyZWF0ZUNvbW1lbnQodGV4dCk7Cn0KCmZ1bmN0aW9uIGluc2VydEJlZm9yZShwYXJlbnROb2RlLCBuZXdOb2RlLCByZWZlcmVuY2VOb2RlKSB7CiAgcGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUobmV3Tm9kZSwgcmVmZXJlbmNlTm9kZSk7Cn0KCmZ1bmN0aW9uIHJlbW92ZUNoaWxkKG5vZGUsIGNoaWxkKSB7CiAgbm9kZS5yZW1vdmVDaGlsZChjaGlsZCk7Cn0KCmZ1bmN0aW9uIGFwcGVuZENoaWxkKG5vZGUsIGNoaWxkKSB7CiAgbm9kZS5hcHBlbmRDaGlsZChjaGlsZCk7Cn0KCmZ1bmN0aW9uIHBhcmVudE5vZGUobm9kZSkgewogIHJldHVybiBub2RlLnBhcmVudE5vZGU7Cn0KCmZ1bmN0aW9uIG5leHRTaWJsaW5nKG5vZGUpIHsKICByZXR1cm4gbm9kZS5uZXh0U2libGluZzsKfQoKZnVuY3Rpb24gdGFnTmFtZShub2RlKSB7CiAgcmV0dXJuIG5vZGUudGFnTmFtZTsKfQoKZnVuY3Rpb24gc2V0VGV4dENvbnRlbnQobm9kZSwgdGV4dCkgewogIG5vZGUudGV4dENvbnRlbnQgPSB0ZXh0Owp9CgpmdW5jdGlvbiBzZXRTdHlsZVNjb3BlKG5vZGUsIHNjb3BlSWQpIHsKICBub2RlLnNldEF0dHJpYnV0ZShzY29wZUlkLCAnJyk7Cn0KCnZhciBub2RlT3BzID0KLyojX19QVVJFX18qLwpPYmplY3QuZnJlZXplKHsKICBjcmVhdGVFbGVtZW50OiBjcmVhdGVFbGVtZW50JDEsCiAgY3JlYXRlRWxlbWVudE5TOiBjcmVhdGVFbGVtZW50TlMsCiAgY3JlYXRlVGV4dE5vZGU6IGNyZWF0ZVRleHROb2RlLAogIGNyZWF0ZUNvbW1lbnQ6IGNyZWF0ZUNvbW1lbnQsCiAgaW5zZXJ0QmVmb3JlOiBpbnNlcnRCZWZvcmUsCiAgcmVtb3ZlQ2hpbGQ6IHJlbW92ZUNoaWxkLAogIGFwcGVuZENoaWxkOiBhcHBlbmRDaGlsZCwKICBwYXJlbnROb2RlOiBwYXJlbnROb2RlLAogIG5leHRTaWJsaW5nOiBuZXh0U2libGluZywKICB0YWdOYW1lOiB0YWdOYW1lLAogIHNldFRleHRDb250ZW50OiBzZXRUZXh0Q29udGVudCwKICBzZXRTdHlsZVNjb3BlOiBzZXRTdHlsZVNjb3BlCn0pOwovKiAgKi8KCnZhciByZWYgPSB7CiAgY3JlYXRlOiBmdW5jdGlvbiBjcmVhdGUoXywgdm5vZGUpIHsKICAgIHJlZ2lzdGVyUmVmKHZub2RlKTsKICB9LAogIHVwZGF0ZTogZnVuY3Rpb24gdXBkYXRlKG9sZFZub2RlLCB2bm9kZSkgewogICAgaWYgKG9sZFZub2RlLmRhdGEucmVmICE9PSB2bm9kZS5kYXRhLnJlZikgewogICAgICByZWdpc3RlclJlZihvbGRWbm9kZSwgdHJ1ZSk7CiAgICAgIHJlZ2lzdGVyUmVmKHZub2RlKTsKICAgIH0KICB9LAogIGRlc3Ryb3k6IGZ1bmN0aW9uIGRlc3Ryb3kodm5vZGUpIHsKICAgIHJlZ2lzdGVyUmVmKHZub2RlLCB0cnVlKTsKICB9Cn07CgpmdW5jdGlvbiByZWdpc3RlclJlZih2bm9kZSwgaXNSZW1vdmFsKSB7CiAgdmFyIGtleSA9IHZub2RlLmRhdGEucmVmOwoKICBpZiAoIWlzRGVmKGtleSkpIHsKICAgIHJldHVybjsKICB9CgogIHZhciB2bSA9IHZub2RlLmNvbnRleHQ7CiAgdmFyIHJlZiA9IHZub2RlLmNvbXBvbmVudEluc3RhbmNlIHx8IHZub2RlLmVsbTsKICB2YXIgcmVmcyA9IHZtLiRyZWZzOwoKICBpZiAoaXNSZW1vdmFsKSB7CiAgICBpZiAoQXJyYXkuaXNBcnJheShyZWZzW2tleV0pKSB7CiAgICAgIHJlbW92ZShyZWZzW2tleV0sIHJlZik7CiAgICB9IGVsc2UgaWYgKHJlZnNba2V5XSA9PT0gcmVmKSB7CiAgICAgIHJlZnNba2V5XSA9IHVuZGVmaW5lZDsKICAgIH0KICB9IGVsc2UgewogICAgaWYgKHZub2RlLmRhdGEucmVmSW5Gb3IpIHsKICAgICAgaWYgKCFBcnJheS5pc0FycmF5KHJlZnNba2V5XSkpIHsKICAgICAgICByZWZzW2tleV0gPSBbcmVmXTsKICAgICAgfSBlbHNlIGlmIChyZWZzW2tleV0uaW5kZXhPZihyZWYpIDwgMCkgewogICAgICAgIC8vICRmbG93LWRpc2FibGUtbGluZQogICAgICAgIHJlZnNba2V5XS5wdXNoKHJlZik7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHJlZnNba2V5XSA9IHJlZjsKICAgIH0KICB9Cn0KLyoqCiAqIFZpcnR1YWwgRE9NIHBhdGNoaW5nIGFsZ29yaXRobSBiYXNlZCBvbiBTbmFiYmRvbSBieQogKiBTaW1vbiBGcmlpcyBWaW5kdW0gKEBwYWxkZXBpbmQpCiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgTGljZW5zZQogKiBodHRwczovL2dpdGh1Yi5jb20vcGFsZGVwaW5kL3NuYWJiZG9tL2Jsb2IvbWFzdGVyL0xJQ0VOU0UKICoKICogbW9kaWZpZWQgYnkgRXZhbiBZb3UgKEB5eXg5OTA4MDMpCiAqCiAqIE5vdCB0eXBlLWNoZWNraW5nIHRoaXMgYmVjYXVzZSB0aGlzIGZpbGUgaXMgcGVyZi1jcml0aWNhbCBhbmQgdGhlIGNvc3QKICogb2YgbWFraW5nIGZsb3cgdW5kZXJzdGFuZCBpdCBpcyBub3Qgd29ydGggaXQuCiAqLwoKCnZhciBlbXB0eU5vZGUgPSBuZXcgVk5vZGUoJycsIHt9LCBbXSk7CnZhciBob29rcyA9IFsnY3JlYXRlJywgJ2FjdGl2YXRlJywgJ3VwZGF0ZScsICdyZW1vdmUnLCAnZGVzdHJveSddOwoKZnVuY3Rpb24gc2FtZVZub2RlKGEsIGIpIHsKICByZXR1cm4gYS5rZXkgPT09IGIua2V5ICYmIChhLnRhZyA9PT0gYi50YWcgJiYgYS5pc0NvbW1lbnQgPT09IGIuaXNDb21tZW50ICYmIGlzRGVmKGEuZGF0YSkgPT09IGlzRGVmKGIuZGF0YSkgJiYgc2FtZUlucHV0VHlwZShhLCBiKSB8fCBpc1RydWUoYS5pc0FzeW5jUGxhY2Vob2xkZXIpICYmIGEuYXN5bmNGYWN0b3J5ID09PSBiLmFzeW5jRmFjdG9yeSAmJiBpc1VuZGVmKGIuYXN5bmNGYWN0b3J5LmVycm9yKSk7Cn0KCmZ1bmN0aW9uIHNhbWVJbnB1dFR5cGUoYSwgYikgewogIGlmIChhLnRhZyAhPT0gJ2lucHV0JykgewogICAgcmV0dXJuIHRydWU7CiAgfQoKICB2YXIgaTsKICB2YXIgdHlwZUEgPSBpc0RlZihpID0gYS5kYXRhKSAmJiBpc0RlZihpID0gaS5hdHRycykgJiYgaS50eXBlOwogIHZhciB0eXBlQiA9IGlzRGVmKGkgPSBiLmRhdGEpICYmIGlzRGVmKGkgPSBpLmF0dHJzKSAmJiBpLnR5cGU7CiAgcmV0dXJuIHR5cGVBID09PSB0eXBlQiB8fCBpc1RleHRJbnB1dFR5cGUodHlwZUEpICYmIGlzVGV4dElucHV0VHlwZSh0eXBlQik7Cn0KCmZ1bmN0aW9uIGNyZWF0ZUtleVRvT2xkSWR4KGNoaWxkcmVuLCBiZWdpbklkeCwgZW5kSWR4KSB7CiAgdmFyIGksIGtleTsKICB2YXIgbWFwID0ge307CgogIGZvciAoaSA9IGJlZ2luSWR4OyBpIDw9IGVuZElkeDsgKytpKSB7CiAgICBrZXkgPSBjaGlsZHJlbltpXS5rZXk7CgogICAgaWYgKGlzRGVmKGtleSkpIHsKICAgICAgbWFwW2tleV0gPSBpOwogICAgfQogIH0KCiAgcmV0dXJuIG1hcDsKfQoKZnVuY3Rpb24gY3JlYXRlUGF0Y2hGdW5jdGlvbihiYWNrZW5kKSB7CiAgdmFyIGksIGo7CiAgdmFyIGNicyA9IHt9OwogIHZhciBtb2R1bGVzID0gYmFja2VuZC5tb2R1bGVzOwogIHZhciBub2RlT3BzID0gYmFja2VuZC5ub2RlT3BzOwoKICBmb3IgKGkgPSAwOyBpIDwgaG9va3MubGVuZ3RoOyArK2kpIHsKICAgIGNic1tob29rc1tpXV0gPSBbXTsKCiAgICBmb3IgKGogPSAwOyBqIDwgbW9kdWxlcy5sZW5ndGg7ICsraikgewogICAgICBpZiAoaXNEZWYobW9kdWxlc1tqXVtob29rc1tpXV0pKSB7CiAgICAgICAgY2JzW2hvb2tzW2ldXS5wdXNoKG1vZHVsZXNbal1baG9va3NbaV1dKTsKICAgICAgfQogICAgfQogIH0KCiAgZnVuY3Rpb24gZW1wdHlOb2RlQXQoZWxtKSB7CiAgICByZXR1cm4gbmV3IFZOb2RlKG5vZGVPcHMudGFnTmFtZShlbG0pLnRvTG93ZXJDYXNlKCksIHt9LCBbXSwgdW5kZWZpbmVkLCBlbG0pOwogIH0KCiAgZnVuY3Rpb24gY3JlYXRlUm1DYihjaGlsZEVsbSwgbGlzdGVuZXJzKSB7CiAgICBmdW5jdGlvbiByZW1vdmUkJDEoKSB7CiAgICAgIGlmICgtLXJlbW92ZSQkMS5saXN0ZW5lcnMgPT09IDApIHsKICAgICAgICByZW1vdmVOb2RlKGNoaWxkRWxtKTsKICAgICAgfQogICAgfQoKICAgIHJlbW92ZSQkMS5saXN0ZW5lcnMgPSBsaXN0ZW5lcnM7CiAgICByZXR1cm4gcmVtb3ZlJCQxOwogIH0KCiAgZnVuY3Rpb24gcmVtb3ZlTm9kZShlbCkgewogICAgdmFyIHBhcmVudCA9IG5vZGVPcHMucGFyZW50Tm9kZShlbCk7IC8vIGVsZW1lbnQgbWF5IGhhdmUgYWxyZWFkeSBiZWVuIHJlbW92ZWQgZHVlIHRvIHYtaHRtbCAvIHYtdGV4dAoKICAgIGlmIChpc0RlZihwYXJlbnQpKSB7CiAgICAgIG5vZGVPcHMucmVtb3ZlQ2hpbGQocGFyZW50LCBlbCk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBpc1Vua25vd25FbGVtZW50JCQxKHZub2RlLCBpblZQcmUpIHsKICAgIHJldHVybiAhaW5WUHJlICYmICF2bm9kZS5ucyAmJiAhKGNvbmZpZy5pZ25vcmVkRWxlbWVudHMubGVuZ3RoICYmIGNvbmZpZy5pZ25vcmVkRWxlbWVudHMuc29tZShmdW5jdGlvbiAoaWdub3JlKSB7CiAgICAgIHJldHVybiBpc1JlZ0V4cChpZ25vcmUpID8gaWdub3JlLnRlc3Qodm5vZGUudGFnKSA6IGlnbm9yZSA9PT0gdm5vZGUudGFnOwogICAgfSkpICYmIGNvbmZpZy5pc1Vua25vd25FbGVtZW50KHZub2RlLnRhZyk7CiAgfQoKICB2YXIgY3JlYXRpbmdFbG1JblZQcmUgPSAwOwoKICBmdW5jdGlvbiBjcmVhdGVFbG0odm5vZGUsIGluc2VydGVkVm5vZGVRdWV1ZSwgcGFyZW50RWxtLCByZWZFbG0sIG5lc3RlZCwgb3duZXJBcnJheSwgaW5kZXgpIHsKICAgIGlmIChpc0RlZih2bm9kZS5lbG0pICYmIGlzRGVmKG93bmVyQXJyYXkpKSB7CiAgICAgIC8vIFRoaXMgdm5vZGUgd2FzIHVzZWQgaW4gYSBwcmV2aW91cyByZW5kZXIhCiAgICAgIC8vIG5vdyBpdCdzIHVzZWQgYXMgYSBuZXcgbm9kZSwgb3ZlcndyaXRpbmcgaXRzIGVsbSB3b3VsZCBjYXVzZQogICAgICAvLyBwb3RlbnRpYWwgcGF0Y2ggZXJyb3JzIGRvd24gdGhlIHJvYWQgd2hlbiBpdCdzIHVzZWQgYXMgYW4gaW5zZXJ0aW9uCiAgICAgIC8vIHJlZmVyZW5jZSBub2RlLiBJbnN0ZWFkLCB3ZSBjbG9uZSB0aGUgbm9kZSBvbi1kZW1hbmQgYmVmb3JlIGNyZWF0aW5nCiAgICAgIC8vIGFzc29jaWF0ZWQgRE9NIGVsZW1lbnQgZm9yIGl0LgogICAgICB2bm9kZSA9IG93bmVyQXJyYXlbaW5kZXhdID0gY2xvbmVWTm9kZSh2bm9kZSk7CiAgICB9CgogICAgdm5vZGUuaXNSb290SW5zZXJ0ID0gIW5lc3RlZDsgLy8gZm9yIHRyYW5zaXRpb24gZW50ZXIgY2hlY2sKCiAgICBpZiAoY3JlYXRlQ29tcG9uZW50KHZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUsIHBhcmVudEVsbSwgcmVmRWxtKSkgewogICAgICByZXR1cm47CiAgICB9CgogICAgdmFyIGRhdGEgPSB2bm9kZS5kYXRhOwogICAgdmFyIGNoaWxkcmVuID0gdm5vZGUuY2hpbGRyZW47CiAgICB2YXIgdGFnID0gdm5vZGUudGFnOwoKICAgIGlmIChpc0RlZih0YWcpKSB7CiAgICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICAgICAgaWYgKGRhdGEgJiYgZGF0YS5wcmUpIHsKICAgICAgICAgIGNyZWF0aW5nRWxtSW5WUHJlKys7CiAgICAgICAgfQoKICAgICAgICBpZiAoaXNVbmtub3duRWxlbWVudCQkMSh2bm9kZSwgY3JlYXRpbmdFbG1JblZQcmUpKSB7CiAgICAgICAgICB3YXJuKCdVbmtub3duIGN1c3RvbSBlbGVtZW50OiA8JyArIHRhZyArICc+IC0gZGlkIHlvdSAnICsgJ3JlZ2lzdGVyIHRoZSBjb21wb25lbnQgY29ycmVjdGx5PyBGb3IgcmVjdXJzaXZlIGNvbXBvbmVudHMsICcgKyAnbWFrZSBzdXJlIHRvIHByb3ZpZGUgdGhlICJuYW1lIiBvcHRpb24uJywgdm5vZGUuY29udGV4dCk7CiAgICAgICAgfQogICAgICB9CgogICAgICB2bm9kZS5lbG0gPSB2bm9kZS5ucyA/IG5vZGVPcHMuY3JlYXRlRWxlbWVudE5TKHZub2RlLm5zLCB0YWcpIDogbm9kZU9wcy5jcmVhdGVFbGVtZW50KHRhZywgdm5vZGUpOwogICAgICBzZXRTY29wZSh2bm9kZSk7CiAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwoKICAgICAgewogICAgICAgIGNyZWF0ZUNoaWxkcmVuKHZub2RlLCBjaGlsZHJlbiwgaW5zZXJ0ZWRWbm9kZVF1ZXVlKTsKCiAgICAgICAgaWYgKGlzRGVmKGRhdGEpKSB7CiAgICAgICAgICBpbnZva2VDcmVhdGVIb29rcyh2bm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlKTsKICAgICAgICB9CgogICAgICAgIGluc2VydChwYXJlbnRFbG0sIHZub2RlLmVsbSwgcmVmRWxtKTsKICAgICAgfQoKICAgICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgZGF0YSAmJiBkYXRhLnByZSkgewogICAgICAgIGNyZWF0aW5nRWxtSW5WUHJlLS07CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoaXNUcnVlKHZub2RlLmlzQ29tbWVudCkpIHsKICAgICAgdm5vZGUuZWxtID0gbm9kZU9wcy5jcmVhdGVDb21tZW50KHZub2RlLnRleHQpOwogICAgICBpbnNlcnQocGFyZW50RWxtLCB2bm9kZS5lbG0sIHJlZkVsbSk7CiAgICB9IGVsc2UgewogICAgICB2bm9kZS5lbG0gPSBub2RlT3BzLmNyZWF0ZVRleHROb2RlKHZub2RlLnRleHQpOwogICAgICBpbnNlcnQocGFyZW50RWxtLCB2bm9kZS5lbG0sIHJlZkVsbSk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBjcmVhdGVDb21wb25lbnQodm5vZGUsIGluc2VydGVkVm5vZGVRdWV1ZSwgcGFyZW50RWxtLCByZWZFbG0pIHsKICAgIHZhciBpID0gdm5vZGUuZGF0YTsKCiAgICBpZiAoaXNEZWYoaSkpIHsKICAgICAgdmFyIGlzUmVhY3RpdmF0ZWQgPSBpc0RlZih2bm9kZS5jb21wb25lbnRJbnN0YW5jZSkgJiYgaS5rZWVwQWxpdmU7CgogICAgICBpZiAoaXNEZWYoaSA9IGkuaG9vaykgJiYgaXNEZWYoaSA9IGkuaW5pdCkpIHsKICAgICAgICBpKHZub2RlLCBmYWxzZQogICAgICAgIC8qIGh5ZHJhdGluZyAqLwogICAgICAgICk7CiAgICAgIH0gLy8gYWZ0ZXIgY2FsbGluZyB0aGUgaW5pdCBob29rLCBpZiB0aGUgdm5vZGUgaXMgYSBjaGlsZCBjb21wb25lbnQKICAgICAgLy8gaXQgc2hvdWxkJ3ZlIGNyZWF0ZWQgYSBjaGlsZCBpbnN0YW5jZSBhbmQgbW91bnRlZCBpdC4gdGhlIGNoaWxkCiAgICAgIC8vIGNvbXBvbmVudCBhbHNvIGhhcyBzZXQgdGhlIHBsYWNlaG9sZGVyIHZub2RlJ3MgZWxtLgogICAgICAvLyBpbiB0aGF0IGNhc2Ugd2UgY2FuIGp1c3QgcmV0dXJuIHRoZSBlbGVtZW50IGFuZCBiZSBkb25lLgoKCiAgICAgIGlmIChpc0RlZih2bm9kZS5jb21wb25lbnRJbnN0YW5jZSkpIHsKICAgICAgICBpbml0Q29tcG9uZW50KHZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUpOwogICAgICAgIGluc2VydChwYXJlbnRFbG0sIHZub2RlLmVsbSwgcmVmRWxtKTsKCiAgICAgICAgaWYgKGlzVHJ1ZShpc1JlYWN0aXZhdGVkKSkgewogICAgICAgICAgcmVhY3RpdmF0ZUNvbXBvbmVudCh2bm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlLCBwYXJlbnRFbG0sIHJlZkVsbSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgfQogIH0KCiAgZnVuY3Rpb24gaW5pdENvbXBvbmVudCh2bm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlKSB7CiAgICBpZiAoaXNEZWYodm5vZGUuZGF0YS5wZW5kaW5nSW5zZXJ0KSkgewogICAgICBpbnNlcnRlZFZub2RlUXVldWUucHVzaC5hcHBseShpbnNlcnRlZFZub2RlUXVldWUsIHZub2RlLmRhdGEucGVuZGluZ0luc2VydCk7CiAgICAgIHZub2RlLmRhdGEucGVuZGluZ0luc2VydCA9IG51bGw7CiAgICB9CgogICAgdm5vZGUuZWxtID0gdm5vZGUuY29tcG9uZW50SW5zdGFuY2UuJGVsOwoKICAgIGlmIChpc1BhdGNoYWJsZSh2bm9kZSkpIHsKICAgICAgaW52b2tlQ3JlYXRlSG9va3Modm5vZGUsIGluc2VydGVkVm5vZGVRdWV1ZSk7CiAgICAgIHNldFNjb3BlKHZub2RlKTsKICAgIH0gZWxzZSB7CiAgICAgIC8vIGVtcHR5IGNvbXBvbmVudCByb290LgogICAgICAvLyBza2lwIGFsbCBlbGVtZW50LXJlbGF0ZWQgbW9kdWxlcyBleGNlcHQgZm9yIHJlZiAoIzM0NTUpCiAgICAgIHJlZ2lzdGVyUmVmKHZub2RlKTsgLy8gbWFrZSBzdXJlIHRvIGludm9rZSB0aGUgaW5zZXJ0IGhvb2sKCiAgICAgIGluc2VydGVkVm5vZGVRdWV1ZS5wdXNoKHZub2RlKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIHJlYWN0aXZhdGVDb21wb25lbnQodm5vZGUsIGluc2VydGVkVm5vZGVRdWV1ZSwgcGFyZW50RWxtLCByZWZFbG0pIHsKICAgIHZhciBpOyAvLyBoYWNrIGZvciAjNDMzOTogYSByZWFjdGl2YXRlZCBjb21wb25lbnQgd2l0aCBpbm5lciB0cmFuc2l0aW9uCiAgICAvLyBkb2VzIG5vdCB0cmlnZ2VyIGJlY2F1c2UgdGhlIGlubmVyIG5vZGUncyBjcmVhdGVkIGhvb2tzIGFyZSBub3QgY2FsbGVkCiAgICAvLyBhZ2Fpbi4gSXQncyBub3QgaWRlYWwgdG8gaW52b2x2ZSBtb2R1bGUtc3BlY2lmaWMgbG9naWMgaW4gaGVyZSBidXQKICAgIC8vIHRoZXJlIGRvZXNuJ3Qgc2VlbSB0byBiZSBhIGJldHRlciB3YXkgdG8gZG8gaXQuCgogICAgdmFyIGlubmVyTm9kZSA9IHZub2RlOwoKICAgIHdoaWxlIChpbm5lck5vZGUuY29tcG9uZW50SW5zdGFuY2UpIHsKICAgICAgaW5uZXJOb2RlID0gaW5uZXJOb2RlLmNvbXBvbmVudEluc3RhbmNlLl92bm9kZTsKCiAgICAgIGlmIChpc0RlZihpID0gaW5uZXJOb2RlLmRhdGEpICYmIGlzRGVmKGkgPSBpLnRyYW5zaXRpb24pKSB7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGNicy5hY3RpdmF0ZS5sZW5ndGg7ICsraSkgewogICAgICAgICAgY2JzLmFjdGl2YXRlW2ldKGVtcHR5Tm9kZSwgaW5uZXJOb2RlKTsKICAgICAgICB9CgogICAgICAgIGluc2VydGVkVm5vZGVRdWV1ZS5wdXNoKGlubmVyTm9kZSk7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0gLy8gdW5saWtlIGEgbmV3bHkgY3JlYXRlZCBjb21wb25lbnQsCiAgICAvLyBhIHJlYWN0aXZhdGVkIGtlZXAtYWxpdmUgY29tcG9uZW50IGRvZXNuJ3QgaW5zZXJ0IGl0c2VsZgoKCiAgICBpbnNlcnQocGFyZW50RWxtLCB2bm9kZS5lbG0sIHJlZkVsbSk7CiAgfQoKICBmdW5jdGlvbiBpbnNlcnQocGFyZW50LCBlbG0sIHJlZiQkMSkgewogICAgaWYgKGlzRGVmKHBhcmVudCkpIHsKICAgICAgaWYgKGlzRGVmKHJlZiQkMSkpIHsKICAgICAgICBpZiAobm9kZU9wcy5wYXJlbnROb2RlKHJlZiQkMSkgPT09IHBhcmVudCkgewogICAgICAgICAgbm9kZU9wcy5pbnNlcnRCZWZvcmUocGFyZW50LCBlbG0sIHJlZiQkMSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIG5vZGVPcHMuYXBwZW5kQ2hpbGQocGFyZW50LCBlbG0pOwogICAgICB9CiAgICB9CiAgfQoKICBmdW5jdGlvbiBjcmVhdGVDaGlsZHJlbih2bm9kZSwgY2hpbGRyZW4sIGluc2VydGVkVm5vZGVRdWV1ZSkgewogICAgaWYgKEFycmF5LmlzQXJyYXkoY2hpbGRyZW4pKSB7CiAgICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICAgICAgY2hlY2tEdXBsaWNhdGVLZXlzKGNoaWxkcmVuKTsKICAgICAgfQoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjaGlsZHJlbi5sZW5ndGg7ICsraSkgewogICAgICAgIGNyZWF0ZUVsbShjaGlsZHJlbltpXSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlLCB2bm9kZS5lbG0sIG51bGwsIHRydWUsIGNoaWxkcmVuLCBpKTsKICAgICAgfQogICAgfSBlbHNlIGlmIChpc1ByaW1pdGl2ZSh2bm9kZS50ZXh0KSkgewogICAgICBub2RlT3BzLmFwcGVuZENoaWxkKHZub2RlLmVsbSwgbm9kZU9wcy5jcmVhdGVUZXh0Tm9kZShTdHJpbmcodm5vZGUudGV4dCkpKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGlzUGF0Y2hhYmxlKHZub2RlKSB7CiAgICB3aGlsZSAodm5vZGUuY29tcG9uZW50SW5zdGFuY2UpIHsKICAgICAgdm5vZGUgPSB2bm9kZS5jb21wb25lbnRJbnN0YW5jZS5fdm5vZGU7CiAgICB9CgogICAgcmV0dXJuIGlzRGVmKHZub2RlLnRhZyk7CiAgfQoKICBmdW5jdGlvbiBpbnZva2VDcmVhdGVIb29rcyh2bm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlKSB7CiAgICBmb3IgKHZhciBpJDEgPSAwOyBpJDEgPCBjYnMuY3JlYXRlLmxlbmd0aDsgKytpJDEpIHsKICAgICAgY2JzLmNyZWF0ZVtpJDFdKGVtcHR5Tm9kZSwgdm5vZGUpOwogICAgfQoKICAgIGkgPSB2bm9kZS5kYXRhLmhvb2s7IC8vIFJldXNlIHZhcmlhYmxlCgogICAgaWYgKGlzRGVmKGkpKSB7CiAgICAgIGlmIChpc0RlZihpLmNyZWF0ZSkpIHsKICAgICAgICBpLmNyZWF0ZShlbXB0eU5vZGUsIHZub2RlKTsKICAgICAgfQoKICAgICAgaWYgKGlzRGVmKGkuaW5zZXJ0KSkgewogICAgICAgIGluc2VydGVkVm5vZGVRdWV1ZS5wdXNoKHZub2RlKTsKICAgICAgfQogICAgfQogIH0gLy8gc2V0IHNjb3BlIGlkIGF0dHJpYnV0ZSBmb3Igc2NvcGVkIENTUy4KICAvLyB0aGlzIGlzIGltcGxlbWVudGVkIGFzIGEgc3BlY2lhbCBjYXNlIHRvIGF2b2lkIHRoZSBvdmVyaGVhZAogIC8vIG9mIGdvaW5nIHRocm91Z2ggdGhlIG5vcm1hbCBhdHRyaWJ1dGUgcGF0Y2hpbmcgcHJvY2Vzcy4KCgogIGZ1bmN0aW9uIHNldFNjb3BlKHZub2RlKSB7CiAgICB2YXIgaTsKCiAgICBpZiAoaXNEZWYoaSA9IHZub2RlLmZuU2NvcGVJZCkpIHsKICAgICAgbm9kZU9wcy5zZXRTdHlsZVNjb3BlKHZub2RlLmVsbSwgaSk7CiAgICB9IGVsc2UgewogICAgICB2YXIgYW5jZXN0b3IgPSB2bm9kZTsKCiAgICAgIHdoaWxlIChhbmNlc3RvcikgewogICAgICAgIGlmIChpc0RlZihpID0gYW5jZXN0b3IuY29udGV4dCkgJiYgaXNEZWYoaSA9IGkuJG9wdGlvbnMuX3Njb3BlSWQpKSB7CiAgICAgICAgICBub2RlT3BzLnNldFN0eWxlU2NvcGUodm5vZGUuZWxtLCBpKTsKICAgICAgICB9CgogICAgICAgIGFuY2VzdG9yID0gYW5jZXN0b3IucGFyZW50OwogICAgICB9CiAgICB9IC8vIGZvciBzbG90IGNvbnRlbnQgdGhleSBzaG91bGQgYWxzbyBnZXQgdGhlIHNjb3BlSWQgZnJvbSB0aGUgaG9zdCBpbnN0YW5jZS4KCgogICAgaWYgKGlzRGVmKGkgPSBhY3RpdmVJbnN0YW5jZSkgJiYgaSAhPT0gdm5vZGUuY29udGV4dCAmJiBpICE9PSB2bm9kZS5mbkNvbnRleHQgJiYgaXNEZWYoaSA9IGkuJG9wdGlvbnMuX3Njb3BlSWQpKSB7CiAgICAgIG5vZGVPcHMuc2V0U3R5bGVTY29wZSh2bm9kZS5lbG0sIGkpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gYWRkVm5vZGVzKHBhcmVudEVsbSwgcmVmRWxtLCB2bm9kZXMsIHN0YXJ0SWR4LCBlbmRJZHgsIGluc2VydGVkVm5vZGVRdWV1ZSkgewogICAgZm9yICg7IHN0YXJ0SWR4IDw9IGVuZElkeDsgKytzdGFydElkeCkgewogICAgICBjcmVhdGVFbG0odm5vZGVzW3N0YXJ0SWR4XSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlLCBwYXJlbnRFbG0sIHJlZkVsbSwgZmFsc2UsIHZub2Rlcywgc3RhcnRJZHgpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gaW52b2tlRGVzdHJveUhvb2sodm5vZGUpIHsKICAgIHZhciBpLCBqOwogICAgdmFyIGRhdGEgPSB2bm9kZS5kYXRhOwoKICAgIGlmIChpc0RlZihkYXRhKSkgewogICAgICBpZiAoaXNEZWYoaSA9IGRhdGEuaG9vaykgJiYgaXNEZWYoaSA9IGkuZGVzdHJveSkpIHsKICAgICAgICBpKHZub2RlKTsKICAgICAgfQoKICAgICAgZm9yIChpID0gMDsgaSA8IGNicy5kZXN0cm95Lmxlbmd0aDsgKytpKSB7CiAgICAgICAgY2JzLmRlc3Ryb3lbaV0odm5vZGUpOwogICAgICB9CiAgICB9CgogICAgaWYgKGlzRGVmKGkgPSB2bm9kZS5jaGlsZHJlbikpIHsKICAgICAgZm9yIChqID0gMDsgaiA8IHZub2RlLmNoaWxkcmVuLmxlbmd0aDsgKytqKSB7CiAgICAgICAgaW52b2tlRGVzdHJveUhvb2sodm5vZGUuY2hpbGRyZW5bal0pOwogICAgICB9CiAgICB9CiAgfQoKICBmdW5jdGlvbiByZW1vdmVWbm9kZXMocGFyZW50RWxtLCB2bm9kZXMsIHN0YXJ0SWR4LCBlbmRJZHgpIHsKICAgIGZvciAoOyBzdGFydElkeCA8PSBlbmRJZHg7ICsrc3RhcnRJZHgpIHsKICAgICAgdmFyIGNoID0gdm5vZGVzW3N0YXJ0SWR4XTsKCiAgICAgIGlmIChpc0RlZihjaCkpIHsKICAgICAgICBpZiAoaXNEZWYoY2gudGFnKSkgewogICAgICAgICAgcmVtb3ZlQW5kSW52b2tlUmVtb3ZlSG9vayhjaCk7CiAgICAgICAgICBpbnZva2VEZXN0cm95SG9vayhjaCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8vIFRleHQgbm9kZQogICAgICAgICAgcmVtb3ZlTm9kZShjaC5lbG0pOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KCiAgZnVuY3Rpb24gcmVtb3ZlQW5kSW52b2tlUmVtb3ZlSG9vayh2bm9kZSwgcm0pIHsKICAgIGlmIChpc0RlZihybSkgfHwgaXNEZWYodm5vZGUuZGF0YSkpIHsKICAgICAgdmFyIGk7CiAgICAgIHZhciBsaXN0ZW5lcnMgPSBjYnMucmVtb3ZlLmxlbmd0aCArIDE7CgogICAgICBpZiAoaXNEZWYocm0pKSB7CiAgICAgICAgLy8gd2UgaGF2ZSBhIHJlY3Vyc2l2ZWx5IHBhc3NlZCBkb3duIHJtIGNhbGxiYWNrCiAgICAgICAgLy8gaW5jcmVhc2UgdGhlIGxpc3RlbmVycyBjb3VudAogICAgICAgIHJtLmxpc3RlbmVycyArPSBsaXN0ZW5lcnM7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gZGlyZWN0bHkgcmVtb3ZpbmcKICAgICAgICBybSA9IGNyZWF0ZVJtQ2Iodm5vZGUuZWxtLCBsaXN0ZW5lcnMpOwogICAgICB9IC8vIHJlY3Vyc2l2ZWx5IGludm9rZSBob29rcyBvbiBjaGlsZCBjb21wb25lbnQgcm9vdCBub2RlCgoKICAgICAgaWYgKGlzRGVmKGkgPSB2bm9kZS5jb21wb25lbnRJbnN0YW5jZSkgJiYgaXNEZWYoaSA9IGkuX3Zub2RlKSAmJiBpc0RlZihpLmRhdGEpKSB7CiAgICAgICAgcmVtb3ZlQW5kSW52b2tlUmVtb3ZlSG9vayhpLCBybSk7CiAgICAgIH0KCiAgICAgIGZvciAoaSA9IDA7IGkgPCBjYnMucmVtb3ZlLmxlbmd0aDsgKytpKSB7CiAgICAgICAgY2JzLnJlbW92ZVtpXSh2bm9kZSwgcm0pOwogICAgICB9CgogICAgICBpZiAoaXNEZWYoaSA9IHZub2RlLmRhdGEuaG9vaykgJiYgaXNEZWYoaSA9IGkucmVtb3ZlKSkgewogICAgICAgIGkodm5vZGUsIHJtKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBybSgpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICByZW1vdmVOb2RlKHZub2RlLmVsbSk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiB1cGRhdGVDaGlsZHJlbihwYXJlbnRFbG0sIG9sZENoLCBuZXdDaCwgaW5zZXJ0ZWRWbm9kZVF1ZXVlLCByZW1vdmVPbmx5KSB7CiAgICB2YXIgb2xkU3RhcnRJZHggPSAwOwogICAgdmFyIG5ld1N0YXJ0SWR4ID0gMDsKICAgIHZhciBvbGRFbmRJZHggPSBvbGRDaC5sZW5ndGggLSAxOwogICAgdmFyIG9sZFN0YXJ0Vm5vZGUgPSBvbGRDaFswXTsKICAgIHZhciBvbGRFbmRWbm9kZSA9IG9sZENoW29sZEVuZElkeF07CiAgICB2YXIgbmV3RW5kSWR4ID0gbmV3Q2gubGVuZ3RoIC0gMTsKICAgIHZhciBuZXdTdGFydFZub2RlID0gbmV3Q2hbMF07CiAgICB2YXIgbmV3RW5kVm5vZGUgPSBuZXdDaFtuZXdFbmRJZHhdOwogICAgdmFyIG9sZEtleVRvSWR4LCBpZHhJbk9sZCwgdm5vZGVUb01vdmUsIHJlZkVsbTsgLy8gcmVtb3ZlT25seSBpcyBhIHNwZWNpYWwgZmxhZyB1c2VkIG9ubHkgYnkgPHRyYW5zaXRpb24tZ3JvdXA+CiAgICAvLyB0byBlbnN1cmUgcmVtb3ZlZCBlbGVtZW50cyBzdGF5IGluIGNvcnJlY3QgcmVsYXRpdmUgcG9zaXRpb25zCiAgICAvLyBkdXJpbmcgbGVhdmluZyB0cmFuc2l0aW9ucwoKICAgIHZhciBjYW5Nb3ZlID0gIXJlbW92ZU9ubHk7CgogICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgICAgY2hlY2tEdXBsaWNhdGVLZXlzKG5ld0NoKTsKICAgIH0KCiAgICB3aGlsZSAob2xkU3RhcnRJZHggPD0gb2xkRW5kSWR4ICYmIG5ld1N0YXJ0SWR4IDw9IG5ld0VuZElkeCkgewogICAgICBpZiAoaXNVbmRlZihvbGRTdGFydFZub2RlKSkgewogICAgICAgIG9sZFN0YXJ0Vm5vZGUgPSBvbGRDaFsrK29sZFN0YXJ0SWR4XTsgLy8gVm5vZGUgaGFzIGJlZW4gbW92ZWQgbGVmdAogICAgICB9IGVsc2UgaWYgKGlzVW5kZWYob2xkRW5kVm5vZGUpKSB7CiAgICAgICAgb2xkRW5kVm5vZGUgPSBvbGRDaFstLW9sZEVuZElkeF07CiAgICAgIH0gZWxzZSBpZiAoc2FtZVZub2RlKG9sZFN0YXJ0Vm5vZGUsIG5ld1N0YXJ0Vm5vZGUpKSB7CiAgICAgICAgcGF0Y2hWbm9kZShvbGRTdGFydFZub2RlLCBuZXdTdGFydFZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUsIG5ld0NoLCBuZXdTdGFydElkeCk7CiAgICAgICAgb2xkU3RhcnRWbm9kZSA9IG9sZENoWysrb2xkU3RhcnRJZHhdOwogICAgICAgIG5ld1N0YXJ0Vm5vZGUgPSBuZXdDaFsrK25ld1N0YXJ0SWR4XTsKICAgICAgfSBlbHNlIGlmIChzYW1lVm5vZGUob2xkRW5kVm5vZGUsIG5ld0VuZFZub2RlKSkgewogICAgICAgIHBhdGNoVm5vZGUob2xkRW5kVm5vZGUsIG5ld0VuZFZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUsIG5ld0NoLCBuZXdFbmRJZHgpOwogICAgICAgIG9sZEVuZFZub2RlID0gb2xkQ2hbLS1vbGRFbmRJZHhdOwogICAgICAgIG5ld0VuZFZub2RlID0gbmV3Q2hbLS1uZXdFbmRJZHhdOwogICAgICB9IGVsc2UgaWYgKHNhbWVWbm9kZShvbGRTdGFydFZub2RlLCBuZXdFbmRWbm9kZSkpIHsKICAgICAgICAvLyBWbm9kZSBtb3ZlZCByaWdodAogICAgICAgIHBhdGNoVm5vZGUob2xkU3RhcnRWbm9kZSwgbmV3RW5kVm5vZGUsIGluc2VydGVkVm5vZGVRdWV1ZSwgbmV3Q2gsIG5ld0VuZElkeCk7CiAgICAgICAgY2FuTW92ZSAmJiBub2RlT3BzLmluc2VydEJlZm9yZShwYXJlbnRFbG0sIG9sZFN0YXJ0Vm5vZGUuZWxtLCBub2RlT3BzLm5leHRTaWJsaW5nKG9sZEVuZFZub2RlLmVsbSkpOwogICAgICAgIG9sZFN0YXJ0Vm5vZGUgPSBvbGRDaFsrK29sZFN0YXJ0SWR4XTsKICAgICAgICBuZXdFbmRWbm9kZSA9IG5ld0NoWy0tbmV3RW5kSWR4XTsKICAgICAgfSBlbHNlIGlmIChzYW1lVm5vZGUob2xkRW5kVm5vZGUsIG5ld1N0YXJ0Vm5vZGUpKSB7CiAgICAgICAgLy8gVm5vZGUgbW92ZWQgbGVmdAogICAgICAgIHBhdGNoVm5vZGUob2xkRW5kVm5vZGUsIG5ld1N0YXJ0Vm5vZGUsIGluc2VydGVkVm5vZGVRdWV1ZSwgbmV3Q2gsIG5ld1N0YXJ0SWR4KTsKICAgICAgICBjYW5Nb3ZlICYmIG5vZGVPcHMuaW5zZXJ0QmVmb3JlKHBhcmVudEVsbSwgb2xkRW5kVm5vZGUuZWxtLCBvbGRTdGFydFZub2RlLmVsbSk7CiAgICAgICAgb2xkRW5kVm5vZGUgPSBvbGRDaFstLW9sZEVuZElkeF07CiAgICAgICAgbmV3U3RhcnRWbm9kZSA9IG5ld0NoWysrbmV3U3RhcnRJZHhdOwogICAgICB9IGVsc2UgewogICAgICAgIGlmIChpc1VuZGVmKG9sZEtleVRvSWR4KSkgewogICAgICAgICAgb2xkS2V5VG9JZHggPSBjcmVhdGVLZXlUb09sZElkeChvbGRDaCwgb2xkU3RhcnRJZHgsIG9sZEVuZElkeCk7CiAgICAgICAgfQoKICAgICAgICBpZHhJbk9sZCA9IGlzRGVmKG5ld1N0YXJ0Vm5vZGUua2V5KSA/IG9sZEtleVRvSWR4W25ld1N0YXJ0Vm5vZGUua2V5XSA6IGZpbmRJZHhJbk9sZChuZXdTdGFydFZub2RlLCBvbGRDaCwgb2xkU3RhcnRJZHgsIG9sZEVuZElkeCk7CgogICAgICAgIGlmIChpc1VuZGVmKGlkeEluT2xkKSkgewogICAgICAgICAgLy8gTmV3IGVsZW1lbnQKICAgICAgICAgIGNyZWF0ZUVsbShuZXdTdGFydFZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUsIHBhcmVudEVsbSwgb2xkU3RhcnRWbm9kZS5lbG0sIGZhbHNlLCBuZXdDaCwgbmV3U3RhcnRJZHgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2bm9kZVRvTW92ZSA9IG9sZENoW2lkeEluT2xkXTsKCiAgICAgICAgICBpZiAoc2FtZVZub2RlKHZub2RlVG9Nb3ZlLCBuZXdTdGFydFZub2RlKSkgewogICAgICAgICAgICBwYXRjaFZub2RlKHZub2RlVG9Nb3ZlLCBuZXdTdGFydFZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUsIG5ld0NoLCBuZXdTdGFydElkeCk7CiAgICAgICAgICAgIG9sZENoW2lkeEluT2xkXSA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgY2FuTW92ZSAmJiBub2RlT3BzLmluc2VydEJlZm9yZShwYXJlbnRFbG0sIHZub2RlVG9Nb3ZlLmVsbSwgb2xkU3RhcnRWbm9kZS5lbG0pOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gc2FtZSBrZXkgYnV0IGRpZmZlcmVudCBlbGVtZW50LiB0cmVhdCBhcyBuZXcgZWxlbWVudAogICAgICAgICAgICBjcmVhdGVFbG0obmV3U3RhcnRWbm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlLCBwYXJlbnRFbG0sIG9sZFN0YXJ0Vm5vZGUuZWxtLCBmYWxzZSwgbmV3Q2gsIG5ld1N0YXJ0SWR4KTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIG5ld1N0YXJ0Vm5vZGUgPSBuZXdDaFsrK25ld1N0YXJ0SWR4XTsKICAgICAgfQogICAgfQoKICAgIGlmIChvbGRTdGFydElkeCA+IG9sZEVuZElkeCkgewogICAgICByZWZFbG0gPSBpc1VuZGVmKG5ld0NoW25ld0VuZElkeCArIDFdKSA/IG51bGwgOiBuZXdDaFtuZXdFbmRJZHggKyAxXS5lbG07CiAgICAgIGFkZFZub2RlcyhwYXJlbnRFbG0sIHJlZkVsbSwgbmV3Q2gsIG5ld1N0YXJ0SWR4LCBuZXdFbmRJZHgsIGluc2VydGVkVm5vZGVRdWV1ZSk7CiAgICB9IGVsc2UgaWYgKG5ld1N0YXJ0SWR4ID4gbmV3RW5kSWR4KSB7CiAgICAgIHJlbW92ZVZub2RlcyhwYXJlbnRFbG0sIG9sZENoLCBvbGRTdGFydElkeCwgb2xkRW5kSWR4KTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGNoZWNrRHVwbGljYXRlS2V5cyhjaGlsZHJlbikgewogICAgdmFyIHNlZW5LZXlzID0ge307CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICB2YXIgdm5vZGUgPSBjaGlsZHJlbltpXTsKICAgICAgdmFyIGtleSA9IHZub2RlLmtleTsKCiAgICAgIGlmIChpc0RlZihrZXkpKSB7CiAgICAgICAgaWYgKHNlZW5LZXlzW2tleV0pIHsKICAgICAgICAgIHdhcm4oIkR1cGxpY2F0ZSBrZXlzIGRldGVjdGVkOiAnIiArIGtleSArICInLiBUaGlzIG1heSBjYXVzZSBhbiB1cGRhdGUgZXJyb3IuIiwgdm5vZGUuY29udGV4dCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHNlZW5LZXlzW2tleV0gPSB0cnVlOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KCiAgZnVuY3Rpb24gZmluZElkeEluT2xkKG5vZGUsIG9sZENoLCBzdGFydCwgZW5kKSB7CiAgICBmb3IgKHZhciBpID0gc3RhcnQ7IGkgPCBlbmQ7IGkrKykgewogICAgICB2YXIgYyA9IG9sZENoW2ldOwoKICAgICAgaWYgKGlzRGVmKGMpICYmIHNhbWVWbm9kZShub2RlLCBjKSkgewogICAgICAgIHJldHVybiBpOwogICAgICB9CiAgICB9CiAgfQoKICBmdW5jdGlvbiBwYXRjaFZub2RlKG9sZFZub2RlLCB2bm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlLCBvd25lckFycmF5LCBpbmRleCwgcmVtb3ZlT25seSkgewogICAgaWYgKG9sZFZub2RlID09PSB2bm9kZSkgewogICAgICByZXR1cm47CiAgICB9CgogICAgaWYgKGlzRGVmKHZub2RlLmVsbSkgJiYgaXNEZWYob3duZXJBcnJheSkpIHsKICAgICAgLy8gY2xvbmUgcmV1c2VkIHZub2RlCiAgICAgIHZub2RlID0gb3duZXJBcnJheVtpbmRleF0gPSBjbG9uZVZOb2RlKHZub2RlKTsKICAgIH0KCiAgICB2YXIgZWxtID0gdm5vZGUuZWxtID0gb2xkVm5vZGUuZWxtOwoKICAgIGlmIChpc1RydWUob2xkVm5vZGUuaXNBc3luY1BsYWNlaG9sZGVyKSkgewogICAgICBpZiAoaXNEZWYodm5vZGUuYXN5bmNGYWN0b3J5LnJlc29sdmVkKSkgewogICAgICAgIGh5ZHJhdGUob2xkVm5vZGUuZWxtLCB2bm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB2bm9kZS5pc0FzeW5jUGxhY2Vob2xkZXIgPSB0cnVlOwogICAgICB9CgogICAgICByZXR1cm47CiAgICB9IC8vIHJldXNlIGVsZW1lbnQgZm9yIHN0YXRpYyB0cmVlcy4KICAgIC8vIG5vdGUgd2Ugb25seSBkbyB0aGlzIGlmIHRoZSB2bm9kZSBpcyBjbG9uZWQgLQogICAgLy8gaWYgdGhlIG5ldyBub2RlIGlzIG5vdCBjbG9uZWQgaXQgbWVhbnMgdGhlIHJlbmRlciBmdW5jdGlvbnMgaGF2ZSBiZWVuCiAgICAvLyByZXNldCBieSB0aGUgaG90LXJlbG9hZC1hcGkgYW5kIHdlIG5lZWQgdG8gZG8gYSBwcm9wZXIgcmUtcmVuZGVyLgoKCiAgICBpZiAoaXNUcnVlKHZub2RlLmlzU3RhdGljKSAmJiBpc1RydWUob2xkVm5vZGUuaXNTdGF0aWMpICYmIHZub2RlLmtleSA9PT0gb2xkVm5vZGUua2V5ICYmIChpc1RydWUodm5vZGUuaXNDbG9uZWQpIHx8IGlzVHJ1ZSh2bm9kZS5pc09uY2UpKSkgewogICAgICB2bm9kZS5jb21wb25lbnRJbnN0YW5jZSA9IG9sZFZub2RlLmNvbXBvbmVudEluc3RhbmNlOwogICAgICByZXR1cm47CiAgICB9CgogICAgdmFyIGk7CiAgICB2YXIgZGF0YSA9IHZub2RlLmRhdGE7CgogICAgaWYgKGlzRGVmKGRhdGEpICYmIGlzRGVmKGkgPSBkYXRhLmhvb2spICYmIGlzRGVmKGkgPSBpLnByZXBhdGNoKSkgewogICAgICBpKG9sZFZub2RlLCB2bm9kZSk7CiAgICB9CgogICAgdmFyIG9sZENoID0gb2xkVm5vZGUuY2hpbGRyZW47CiAgICB2YXIgY2ggPSB2bm9kZS5jaGlsZHJlbjsKCiAgICBpZiAoaXNEZWYoZGF0YSkgJiYgaXNQYXRjaGFibGUodm5vZGUpKSB7CiAgICAgIGZvciAoaSA9IDA7IGkgPCBjYnMudXBkYXRlLmxlbmd0aDsgKytpKSB7CiAgICAgICAgY2JzLnVwZGF0ZVtpXShvbGRWbm9kZSwgdm5vZGUpOwogICAgICB9CgogICAgICBpZiAoaXNEZWYoaSA9IGRhdGEuaG9vaykgJiYgaXNEZWYoaSA9IGkudXBkYXRlKSkgewogICAgICAgIGkob2xkVm5vZGUsIHZub2RlKTsKICAgICAgfQogICAgfQoKICAgIGlmIChpc1VuZGVmKHZub2RlLnRleHQpKSB7CiAgICAgIGlmIChpc0RlZihvbGRDaCkgJiYgaXNEZWYoY2gpKSB7CiAgICAgICAgaWYgKG9sZENoICE9PSBjaCkgewogICAgICAgICAgdXBkYXRlQ2hpbGRyZW4oZWxtLCBvbGRDaCwgY2gsIGluc2VydGVkVm5vZGVRdWV1ZSwgcmVtb3ZlT25seSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKGlzRGVmKGNoKSkgewogICAgICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7CiAgICAgICAgICBjaGVja0R1cGxpY2F0ZUtleXMoY2gpOwogICAgICAgIH0KCiAgICAgICAgaWYgKGlzRGVmKG9sZFZub2RlLnRleHQpKSB7CiAgICAgICAgICBub2RlT3BzLnNldFRleHRDb250ZW50KGVsbSwgJycpOwogICAgICAgIH0KCiAgICAgICAgYWRkVm5vZGVzKGVsbSwgbnVsbCwgY2gsIDAsIGNoLmxlbmd0aCAtIDEsIGluc2VydGVkVm5vZGVRdWV1ZSk7CiAgICAgIH0gZWxzZSBpZiAoaXNEZWYob2xkQ2gpKSB7CiAgICAgICAgcmVtb3ZlVm5vZGVzKGVsbSwgb2xkQ2gsIDAsIG9sZENoLmxlbmd0aCAtIDEpOwogICAgICB9IGVsc2UgaWYgKGlzRGVmKG9sZFZub2RlLnRleHQpKSB7CiAgICAgICAgbm9kZU9wcy5zZXRUZXh0Q29udGVudChlbG0sICcnKTsKICAgICAgfQogICAgfSBlbHNlIGlmIChvbGRWbm9kZS50ZXh0ICE9PSB2bm9kZS50ZXh0KSB7CiAgICAgIG5vZGVPcHMuc2V0VGV4dENvbnRlbnQoZWxtLCB2bm9kZS50ZXh0KTsKICAgIH0KCiAgICBpZiAoaXNEZWYoZGF0YSkpIHsKICAgICAgaWYgKGlzRGVmKGkgPSBkYXRhLmhvb2spICYmIGlzRGVmKGkgPSBpLnBvc3RwYXRjaCkpIHsKICAgICAgICBpKG9sZFZub2RlLCB2bm9kZSk7CiAgICAgIH0KICAgIH0KICB9CgogIGZ1bmN0aW9uIGludm9rZUluc2VydEhvb2sodm5vZGUsIHF1ZXVlLCBpbml0aWFsKSB7CiAgICAvLyBkZWxheSBpbnNlcnQgaG9va3MgZm9yIGNvbXBvbmVudCByb290IG5vZGVzLCBpbnZva2UgdGhlbSBhZnRlciB0aGUKICAgIC8vIGVsZW1lbnQgaXMgcmVhbGx5IGluc2VydGVkCiAgICBpZiAoaXNUcnVlKGluaXRpYWwpICYmIGlzRGVmKHZub2RlLnBhcmVudCkpIHsKICAgICAgdm5vZGUucGFyZW50LmRhdGEucGVuZGluZ0luc2VydCA9IHF1ZXVlOwogICAgfSBlbHNlIHsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBxdWV1ZS5sZW5ndGg7ICsraSkgewogICAgICAgIHF1ZXVlW2ldLmRhdGEuaG9vay5pbnNlcnQocXVldWVbaV0pOwogICAgICB9CiAgICB9CiAgfQoKICB2YXIgaHlkcmF0aW9uQmFpbGVkID0gZmFsc2U7IC8vIGxpc3Qgb2YgbW9kdWxlcyB0aGF0IGNhbiBza2lwIGNyZWF0ZSBob29rIGR1cmluZyBoeWRyYXRpb24gYmVjYXVzZSB0aGV5CiAgLy8gYXJlIGFscmVhZHkgcmVuZGVyZWQgb24gdGhlIGNsaWVudCBvciBoYXMgbm8gbmVlZCBmb3IgaW5pdGlhbGl6YXRpb24KICAvLyBOb3RlOiBzdHlsZSBpcyBleGNsdWRlZCBiZWNhdXNlIGl0IHJlbGllcyBvbiBpbml0aWFsIGNsb25lIGZvciBmdXR1cmUKICAvLyBkZWVwIHVwZGF0ZXMgKCM3MDYzKS4KCiAgdmFyIGlzUmVuZGVyZWRNb2R1bGUgPSBtYWtlTWFwKCdhdHRycyxjbGFzcyxzdGF0aWNDbGFzcyxzdGF0aWNTdHlsZSxrZXknKTsgLy8gTm90ZTogdGhpcyBpcyBhIGJyb3dzZXItb25seSBmdW5jdGlvbiBzbyB3ZSBjYW4gYXNzdW1lIGVsbXMgYXJlIERPTSBub2Rlcy4KCiAgZnVuY3Rpb24gaHlkcmF0ZShlbG0sIHZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUsIGluVlByZSkgewogICAgdmFyIGk7CiAgICB2YXIgdGFnID0gdm5vZGUudGFnOwogICAgdmFyIGRhdGEgPSB2bm9kZS5kYXRhOwogICAgdmFyIGNoaWxkcmVuID0gdm5vZGUuY2hpbGRyZW47CiAgICBpblZQcmUgPSBpblZQcmUgfHwgZGF0YSAmJiBkYXRhLnByZTsKICAgIHZub2RlLmVsbSA9IGVsbTsKCiAgICBpZiAoaXNUcnVlKHZub2RlLmlzQ29tbWVudCkgJiYgaXNEZWYodm5vZGUuYXN5bmNGYWN0b3J5KSkgewogICAgICB2bm9kZS5pc0FzeW5jUGxhY2Vob2xkZXIgPSB0cnVlOwogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0gLy8gYXNzZXJ0IG5vZGUgbWF0Y2gKCgogICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgICAgaWYgKCFhc3NlcnROb2RlTWF0Y2goZWxtLCB2bm9kZSwgaW5WUHJlKSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgfQoKICAgIGlmIChpc0RlZihkYXRhKSkgewogICAgICBpZiAoaXNEZWYoaSA9IGRhdGEuaG9vaykgJiYgaXNEZWYoaSA9IGkuaW5pdCkpIHsKICAgICAgICBpKHZub2RlLCB0cnVlCiAgICAgICAgLyogaHlkcmF0aW5nICovCiAgICAgICAgKTsKICAgICAgfQoKICAgICAgaWYgKGlzRGVmKGkgPSB2bm9kZS5jb21wb25lbnRJbnN0YW5jZSkpIHsKICAgICAgICAvLyBjaGlsZCBjb21wb25lbnQuIGl0IHNob3VsZCBoYXZlIGh5ZHJhdGVkIGl0cyBvd24gdHJlZS4KICAgICAgICBpbml0Q29tcG9uZW50KHZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUpOwogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICB9CgogICAgaWYgKGlzRGVmKHRhZykpIHsKICAgICAgaWYgKGlzRGVmKGNoaWxkcmVuKSkgewogICAgICAgIC8vIGVtcHR5IGVsZW1lbnQsIGFsbG93IGNsaWVudCB0byBwaWNrIHVwIGFuZCBwb3B1bGF0ZSBjaGlsZHJlbgogICAgICAgIGlmICghZWxtLmhhc0NoaWxkTm9kZXMoKSkgewogICAgICAgICAgY3JlYXRlQ2hpbGRyZW4odm5vZGUsIGNoaWxkcmVuLCBpbnNlcnRlZFZub2RlUXVldWUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAvLyB2LWh0bWwgYW5kIGRvbVByb3BzOiBpbm5lckhUTUwKICAgICAgICAgIGlmIChpc0RlZihpID0gZGF0YSkgJiYgaXNEZWYoaSA9IGkuZG9tUHJvcHMpICYmIGlzRGVmKGkgPSBpLmlubmVySFRNTCkpIHsKICAgICAgICAgICAgaWYgKGkgIT09IGVsbS5pbm5lckhUTUwpIHsKICAgICAgICAgICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICAgICAgICAgICAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiB0eXBlb2YgY29uc29sZSAhPT0gJ3VuZGVmaW5lZCcgJiYgIWh5ZHJhdGlvbkJhaWxlZCkgewogICAgICAgICAgICAgICAgaHlkcmF0aW9uQmFpbGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybignUGFyZW50OiAnLCBlbG0pOwogICAgICAgICAgICAgICAgY29uc29sZS53YXJuKCdzZXJ2ZXIgaW5uZXJIVE1MOiAnLCBpKTsKICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybignY2xpZW50IGlubmVySFRNTDogJywgZWxtLmlubmVySFRNTCk7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIGl0ZXJhdGUgYW5kIGNvbXBhcmUgY2hpbGRyZW4gbGlzdHMKICAgICAgICAgICAgdmFyIGNoaWxkcmVuTWF0Y2ggPSB0cnVlOwogICAgICAgICAgICB2YXIgY2hpbGROb2RlID0gZWxtLmZpcnN0Q2hpbGQ7CgogICAgICAgICAgICBmb3IgKHZhciBpJDEgPSAwOyBpJDEgPCBjaGlsZHJlbi5sZW5ndGg7IGkkMSsrKSB7CiAgICAgICAgICAgICAgaWYgKCFjaGlsZE5vZGUgfHwgIWh5ZHJhdGUoY2hpbGROb2RlLCBjaGlsZHJlbltpJDFdLCBpbnNlcnRlZFZub2RlUXVldWUsIGluVlByZSkpIHsKICAgICAgICAgICAgICAgIGNoaWxkcmVuTWF0Y2ggPSBmYWxzZTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgY2hpbGROb2RlID0gY2hpbGROb2RlLm5leHRTaWJsaW5nOwogICAgICAgICAgICB9IC8vIGlmIGNoaWxkTm9kZSBpcyBub3QgbnVsbCwgaXQgbWVhbnMgdGhlIGFjdHVhbCBjaGlsZE5vZGVzIGxpc3QgaXMKICAgICAgICAgICAgLy8gbG9uZ2VyIHRoYW4gdGhlIHZpcnR1YWwgY2hpbGRyZW4gbGlzdC4KCgogICAgICAgICAgICBpZiAoIWNoaWxkcmVuTWF0Y2ggfHwgY2hpbGROb2RlKSB7CiAgICAgICAgICAgICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCiAgICAgICAgICAgICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgdHlwZW9mIGNvbnNvbGUgIT09ICd1bmRlZmluZWQnICYmICFoeWRyYXRpb25CYWlsZWQpIHsKICAgICAgICAgICAgICAgIGh5ZHJhdGlvbkJhaWxlZCA9IHRydWU7CiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oJ1BhcmVudDogJywgZWxtKTsKICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybignTWlzbWF0Y2hpbmcgY2hpbGROb2RlcyB2cy4gVk5vZGVzOiAnLCBlbG0uY2hpbGROb2RlcywgY2hpbGRyZW4pOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoaXNEZWYoZGF0YSkpIHsKICAgICAgICB2YXIgZnVsbEludm9rZSA9IGZhbHNlOwoKICAgICAgICBmb3IgKHZhciBrZXkgaW4gZGF0YSkgewogICAgICAgICAgaWYgKCFpc1JlbmRlcmVkTW9kdWxlKGtleSkpIHsKICAgICAgICAgICAgZnVsbEludm9rZSA9IHRydWU7CiAgICAgICAgICAgIGludm9rZUNyZWF0ZUhvb2tzKHZub2RlLCBpbnNlcnRlZFZub2RlUXVldWUpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmICghZnVsbEludm9rZSAmJiBkYXRhWydjbGFzcyddKSB7CiAgICAgICAgICAvLyBlbnN1cmUgY29sbGVjdGluZyBkZXBzIGZvciBkZWVwIGNsYXNzIGJpbmRpbmdzIGZvciBmdXR1cmUgdXBkYXRlcwogICAgICAgICAgdHJhdmVyc2UoZGF0YVsnY2xhc3MnXSk7CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgaWYgKGVsbS5kYXRhICE9PSB2bm9kZS50ZXh0KSB7CiAgICAgIGVsbS5kYXRhID0gdm5vZGUudGV4dDsKICAgIH0KCiAgICByZXR1cm4gdHJ1ZTsKICB9CgogIGZ1bmN0aW9uIGFzc2VydE5vZGVNYXRjaChub2RlLCB2bm9kZSwgaW5WUHJlKSB7CiAgICBpZiAoaXNEZWYodm5vZGUudGFnKSkgewogICAgICByZXR1cm4gdm5vZGUudGFnLmluZGV4T2YoJ3Z1ZS1jb21wb25lbnQnKSA9PT0gMCB8fCAhaXNVbmtub3duRWxlbWVudCQkMSh2bm9kZSwgaW5WUHJlKSAmJiB2bm9kZS50YWcudG9Mb3dlckNhc2UoKSA9PT0gKG5vZGUudGFnTmFtZSAmJiBub2RlLnRhZ05hbWUudG9Mb3dlckNhc2UoKSk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gbm9kZS5ub2RlVHlwZSA9PT0gKHZub2RlLmlzQ29tbWVudCA/IDggOiAzKTsKICAgIH0KICB9CgogIHJldHVybiBmdW5jdGlvbiBwYXRjaChvbGRWbm9kZSwgdm5vZGUsIGh5ZHJhdGluZywgcmVtb3ZlT25seSkgewogICAgaWYgKGlzVW5kZWYodm5vZGUpKSB7CiAgICAgIGlmIChpc0RlZihvbGRWbm9kZSkpIHsKICAgICAgICBpbnZva2VEZXN0cm95SG9vayhvbGRWbm9kZSk7CiAgICAgIH0KCiAgICAgIHJldHVybjsKICAgIH0KCiAgICB2YXIgaXNJbml0aWFsUGF0Y2ggPSBmYWxzZTsKICAgIHZhciBpbnNlcnRlZFZub2RlUXVldWUgPSBbXTsKCiAgICBpZiAoaXNVbmRlZihvbGRWbm9kZSkpIHsKICAgICAgLy8gZW1wdHkgbW91bnQgKGxpa2VseSBhcyBjb21wb25lbnQpLCBjcmVhdGUgbmV3IHJvb3QgZWxlbWVudAogICAgICBpc0luaXRpYWxQYXRjaCA9IHRydWU7CiAgICAgIGNyZWF0ZUVsbSh2bm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlKTsKICAgIH0gZWxzZSB7CiAgICAgIHZhciBpc1JlYWxFbGVtZW50ID0gaXNEZWYob2xkVm5vZGUubm9kZVR5cGUpOwoKICAgICAgaWYgKCFpc1JlYWxFbGVtZW50ICYmIHNhbWVWbm9kZShvbGRWbm9kZSwgdm5vZGUpKSB7CiAgICAgICAgLy8gcGF0Y2ggZXhpc3Rpbmcgcm9vdCBub2RlCiAgICAgICAgcGF0Y2hWbm9kZShvbGRWbm9kZSwgdm5vZGUsIGluc2VydGVkVm5vZGVRdWV1ZSwgbnVsbCwgbnVsbCwgcmVtb3ZlT25seSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKGlzUmVhbEVsZW1lbnQpIHsKICAgICAgICAgIC8vIG1vdW50aW5nIHRvIGEgcmVhbCBlbGVtZW50CiAgICAgICAgICAvLyBjaGVjayBpZiB0aGlzIGlzIHNlcnZlci1yZW5kZXJlZCBjb250ZW50IGFuZCBpZiB3ZSBjYW4gcGVyZm9ybQogICAgICAgICAgLy8gYSBzdWNjZXNzZnVsIGh5ZHJhdGlvbi4KICAgICAgICAgIGlmIChvbGRWbm9kZS5ub2RlVHlwZSA9PT0gMSAmJiBvbGRWbm9kZS5oYXNBdHRyaWJ1dGUoU1NSX0FUVFIpKSB7CiAgICAgICAgICAgIG9sZFZub2RlLnJlbW92ZUF0dHJpYnV0ZShTU1JfQVRUUik7CiAgICAgICAgICAgIGh5ZHJhdGluZyA9IHRydWU7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKGlzVHJ1ZShoeWRyYXRpbmcpKSB7CiAgICAgICAgICAgIGlmIChoeWRyYXRlKG9sZFZub2RlLCB2bm9kZSwgaW5zZXJ0ZWRWbm9kZVF1ZXVlKSkgewogICAgICAgICAgICAgIGludm9rZUluc2VydEhvb2sodm5vZGUsIGluc2VydGVkVm5vZGVRdWV1ZSwgdHJ1ZSk7CiAgICAgICAgICAgICAgcmV0dXJuIG9sZFZub2RlOwogICAgICAgICAgICB9IGVsc2UgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicpIHsKICAgICAgICAgICAgICB3YXJuKCdUaGUgY2xpZW50LXNpZGUgcmVuZGVyZWQgdmlydHVhbCBET00gdHJlZSBpcyBub3QgbWF0Y2hpbmcgJyArICdzZXJ2ZXItcmVuZGVyZWQgY29udGVudC4gVGhpcyBpcyBsaWtlbHkgY2F1c2VkIGJ5IGluY29ycmVjdCAnICsgJ0hUTUwgbWFya3VwLCBmb3IgZXhhbXBsZSBuZXN0aW5nIGJsb2NrLWxldmVsIGVsZW1lbnRzIGluc2lkZSAnICsgJzxwPiwgb3IgbWlzc2luZyA8dGJvZHk+LiBCYWlsaW5nIGh5ZHJhdGlvbiBhbmQgcGVyZm9ybWluZyAnICsgJ2Z1bGwgY2xpZW50LXNpZGUgcmVuZGVyLicpOwogICAgICAgICAgICB9CiAgICAgICAgICB9IC8vIGVpdGhlciBub3Qgc2VydmVyLXJlbmRlcmVkLCBvciBoeWRyYXRpb24gZmFpbGVkLgogICAgICAgICAgLy8gY3JlYXRlIGFuIGVtcHR5IG5vZGUgYW5kIHJlcGxhY2UgaXQKCgogICAgICAgICAgb2xkVm5vZGUgPSBlbXB0eU5vZGVBdChvbGRWbm9kZSk7CiAgICAgICAgfSAvLyByZXBsYWNpbmcgZXhpc3RpbmcgZWxlbWVudAoKCiAgICAgICAgdmFyIG9sZEVsbSA9IG9sZFZub2RlLmVsbTsKICAgICAgICB2YXIgcGFyZW50RWxtID0gbm9kZU9wcy5wYXJlbnROb2RlKG9sZEVsbSk7IC8vIGNyZWF0ZSBuZXcgbm9kZQoKICAgICAgICBjcmVhdGVFbG0odm5vZGUsIGluc2VydGVkVm5vZGVRdWV1ZSwgLy8gZXh0cmVtZWx5IHJhcmUgZWRnZSBjYXNlOiBkbyBub3QgaW5zZXJ0IGlmIG9sZCBlbGVtZW50IGlzIGluIGEKICAgICAgICAvLyBsZWF2aW5nIHRyYW5zaXRpb24uIE9ubHkgaGFwcGVucyB3aGVuIGNvbWJpbmluZyB0cmFuc2l0aW9uICsKICAgICAgICAvLyBrZWVwLWFsaXZlICsgSE9Dcy4gKCM0NTkwKQogICAgICAgIG9sZEVsbS5fbGVhdmVDYiA/IG51bGwgOiBwYXJlbnRFbG0sIG5vZGVPcHMubmV4dFNpYmxpbmcob2xkRWxtKSk7IC8vIHVwZGF0ZSBwYXJlbnQgcGxhY2Vob2xkZXIgbm9kZSBlbGVtZW50LCByZWN1cnNpdmVseQoKICAgICAgICBpZiAoaXNEZWYodm5vZGUucGFyZW50KSkgewogICAgICAgICAgdmFyIGFuY2VzdG9yID0gdm5vZGUucGFyZW50OwogICAgICAgICAgdmFyIHBhdGNoYWJsZSA9IGlzUGF0Y2hhYmxlKHZub2RlKTsKCiAgICAgICAgICB3aGlsZSAoYW5jZXN0b3IpIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjYnMuZGVzdHJveS5sZW5ndGg7ICsraSkgewogICAgICAgICAgICAgIGNicy5kZXN0cm95W2ldKGFuY2VzdG9yKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgYW5jZXN0b3IuZWxtID0gdm5vZGUuZWxtOwoKICAgICAgICAgICAgaWYgKHBhdGNoYWJsZSkgewogICAgICAgICAgICAgIGZvciAodmFyIGkkMSA9IDA7IGkkMSA8IGNicy5jcmVhdGUubGVuZ3RoOyArK2kkMSkgewogICAgICAgICAgICAgICAgY2JzLmNyZWF0ZVtpJDFdKGVtcHR5Tm9kZSwgYW5jZXN0b3IpOwogICAgICAgICAgICAgIH0gLy8gIzY1MTMKICAgICAgICAgICAgICAvLyBpbnZva2UgaW5zZXJ0IGhvb2tzIHRoYXQgbWF5IGhhdmUgYmVlbiBtZXJnZWQgYnkgY3JlYXRlIGhvb2tzLgogICAgICAgICAgICAgIC8vIGUuZy4gZm9yIGRpcmVjdGl2ZXMgdGhhdCB1c2VzIHRoZSAiaW5zZXJ0ZWQiIGhvb2suCgoKICAgICAgICAgICAgICB2YXIgaW5zZXJ0ID0gYW5jZXN0b3IuZGF0YS5ob29rLmluc2VydDsKCiAgICAgICAgICAgICAgaWYgKGluc2VydC5tZXJnZWQpIHsKICAgICAgICAgICAgICAgIC8vIHN0YXJ0IGF0IGluZGV4IDEgdG8gYXZvaWQgcmUtaW52b2tpbmcgY29tcG9uZW50IG1vdW50ZWQgaG9vawogICAgICAgICAgICAgICAgZm9yICh2YXIgaSQyID0gMTsgaSQyIDwgaW5zZXJ0LmZucy5sZW5ndGg7IGkkMisrKSB7CiAgICAgICAgICAgICAgICAgIGluc2VydC5mbnNbaSQyXSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICByZWdpc3RlclJlZihhbmNlc3Rvcik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGFuY2VzdG9yID0gYW5jZXN0b3IucGFyZW50OwogICAgICAgICAgfQogICAgICAgIH0gLy8gZGVzdHJveSBvbGQgbm9kZQoKCiAgICAgICAgaWYgKGlzRGVmKHBhcmVudEVsbSkpIHsKICAgICAgICAgIHJlbW92ZVZub2RlcyhwYXJlbnRFbG0sIFtvbGRWbm9kZV0sIDAsIDApOwogICAgICAgIH0gZWxzZSBpZiAoaXNEZWYob2xkVm5vZGUudGFnKSkgewogICAgICAgICAgaW52b2tlRGVzdHJveUhvb2sob2xkVm5vZGUpOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIGludm9rZUluc2VydEhvb2sodm5vZGUsIGluc2VydGVkVm5vZGVRdWV1ZSwgaXNJbml0aWFsUGF0Y2gpOwogICAgcmV0dXJuIHZub2RlLmVsbTsKICB9Owp9Ci8qICAqLwoKCnZhciBkaXJlY3RpdmVzID0gewogIGNyZWF0ZTogdXBkYXRlRGlyZWN0aXZlcywKICB1cGRhdGU6IHVwZGF0ZURpcmVjdGl2ZXMsCiAgZGVzdHJveTogZnVuY3Rpb24gdW5iaW5kRGlyZWN0aXZlcyh2bm9kZSkgewogICAgdXBkYXRlRGlyZWN0aXZlcyh2bm9kZSwgZW1wdHlOb2RlKTsKICB9Cn07CgpmdW5jdGlvbiB1cGRhdGVEaXJlY3RpdmVzKG9sZFZub2RlLCB2bm9kZSkgewogIGlmIChvbGRWbm9kZS5kYXRhLmRpcmVjdGl2ZXMgfHwgdm5vZGUuZGF0YS5kaXJlY3RpdmVzKSB7CiAgICBfdXBkYXRlKG9sZFZub2RlLCB2bm9kZSk7CiAgfQp9CgpmdW5jdGlvbiBfdXBkYXRlKG9sZFZub2RlLCB2bm9kZSkgewogIHZhciBpc0NyZWF0ZSA9IG9sZFZub2RlID09PSBlbXB0eU5vZGU7CiAgdmFyIGlzRGVzdHJveSA9IHZub2RlID09PSBlbXB0eU5vZGU7CiAgdmFyIG9sZERpcnMgPSBub3JtYWxpemVEaXJlY3RpdmVzJDEob2xkVm5vZGUuZGF0YS5kaXJlY3RpdmVzLCBvbGRWbm9kZS5jb250ZXh0KTsKICB2YXIgbmV3RGlycyA9IG5vcm1hbGl6ZURpcmVjdGl2ZXMkMSh2bm9kZS5kYXRhLmRpcmVjdGl2ZXMsIHZub2RlLmNvbnRleHQpOwogIHZhciBkaXJzV2l0aEluc2VydCA9IFtdOwogIHZhciBkaXJzV2l0aFBvc3RwYXRjaCA9IFtdOwogIHZhciBrZXksIG9sZERpciwgZGlyOwoKICBmb3IgKGtleSBpbiBuZXdEaXJzKSB7CiAgICBvbGREaXIgPSBvbGREaXJzW2tleV07CiAgICBkaXIgPSBuZXdEaXJzW2tleV07CgogICAgaWYgKCFvbGREaXIpIHsKICAgICAgLy8gbmV3IGRpcmVjdGl2ZSwgYmluZAogICAgICBjYWxsSG9vayQxKGRpciwgJ2JpbmQnLCB2bm9kZSwgb2xkVm5vZGUpOwoKICAgICAgaWYgKGRpci5kZWYgJiYgZGlyLmRlZi5pbnNlcnRlZCkgewogICAgICAgIGRpcnNXaXRoSW5zZXJ0LnB1c2goZGlyKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgLy8gZXhpc3RpbmcgZGlyZWN0aXZlLCB1cGRhdGUKICAgICAgZGlyLm9sZFZhbHVlID0gb2xkRGlyLnZhbHVlOwogICAgICBkaXIub2xkQXJnID0gb2xkRGlyLmFyZzsKICAgICAgY2FsbEhvb2skMShkaXIsICd1cGRhdGUnLCB2bm9kZSwgb2xkVm5vZGUpOwoKICAgICAgaWYgKGRpci5kZWYgJiYgZGlyLmRlZi5jb21wb25lbnRVcGRhdGVkKSB7CiAgICAgICAgZGlyc1dpdGhQb3N0cGF0Y2gucHVzaChkaXIpOwogICAgICB9CiAgICB9CiAgfQoKICBpZiAoZGlyc1dpdGhJbnNlcnQubGVuZ3RoKSB7CiAgICB2YXIgY2FsbEluc2VydCA9IGZ1bmN0aW9uIGNhbGxJbnNlcnQoKSB7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZGlyc1dpdGhJbnNlcnQubGVuZ3RoOyBpKyspIHsKICAgICAgICBjYWxsSG9vayQxKGRpcnNXaXRoSW5zZXJ0W2ldLCAnaW5zZXJ0ZWQnLCB2bm9kZSwgb2xkVm5vZGUpOwogICAgICB9CiAgICB9OwoKICAgIGlmIChpc0NyZWF0ZSkgewogICAgICBtZXJnZVZOb2RlSG9vayh2bm9kZSwgJ2luc2VydCcsIGNhbGxJbnNlcnQpOwogICAgfSBlbHNlIHsKICAgICAgY2FsbEluc2VydCgpOwogICAgfQogIH0KCiAgaWYgKGRpcnNXaXRoUG9zdHBhdGNoLmxlbmd0aCkgewogICAgbWVyZ2VWTm9kZUhvb2sodm5vZGUsICdwb3N0cGF0Y2gnLCBmdW5jdGlvbiAoKSB7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZGlyc1dpdGhQb3N0cGF0Y2gubGVuZ3RoOyBpKyspIHsKICAgICAgICBjYWxsSG9vayQxKGRpcnNXaXRoUG9zdHBhdGNoW2ldLCAnY29tcG9uZW50VXBkYXRlZCcsIHZub2RlLCBvbGRWbm9kZSk7CiAgICAgIH0KICAgIH0pOwogIH0KCiAgaWYgKCFpc0NyZWF0ZSkgewogICAgZm9yIChrZXkgaW4gb2xkRGlycykgewogICAgICBpZiAoIW5ld0RpcnNba2V5XSkgewogICAgICAgIC8vIG5vIGxvbmdlciBwcmVzZW50LCB1bmJpbmQKICAgICAgICBjYWxsSG9vayQxKG9sZERpcnNba2V5XSwgJ3VuYmluZCcsIG9sZFZub2RlLCBvbGRWbm9kZSwgaXNEZXN0cm95KTsKICAgICAgfQogICAgfQogIH0KfQoKdmFyIGVtcHR5TW9kaWZpZXJzID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKCmZ1bmN0aW9uIG5vcm1hbGl6ZURpcmVjdGl2ZXMkMShkaXJzLCB2bSkgewogIHZhciByZXMgPSBPYmplY3QuY3JlYXRlKG51bGwpOwoKICBpZiAoIWRpcnMpIHsKICAgIC8vICRmbG93LWRpc2FibGUtbGluZQogICAgcmV0dXJuIHJlczsKICB9CgogIHZhciBpLCBkaXI7CgogIGZvciAoaSA9IDA7IGkgPCBkaXJzLmxlbmd0aDsgaSsrKSB7CiAgICBkaXIgPSBkaXJzW2ldOwoKICAgIGlmICghZGlyLm1vZGlmaWVycykgewogICAgICAvLyAkZmxvdy1kaXNhYmxlLWxpbmUKICAgICAgZGlyLm1vZGlmaWVycyA9IGVtcHR5TW9kaWZpZXJzOwogICAgfQoKICAgIHJlc1tnZXRSYXdEaXJOYW1lKGRpcildID0gZGlyOwogICAgZGlyLmRlZiA9IHJlc29sdmVBc3NldCh2bS4kb3B0aW9ucywgJ2RpcmVjdGl2ZXMnLCBkaXIubmFtZSwgdHJ1ZSk7CiAgfSAvLyAkZmxvdy1kaXNhYmxlLWxpbmUKCgogIHJldHVybiByZXM7Cn0KCmZ1bmN0aW9uIGdldFJhd0Rpck5hbWUoZGlyKSB7CiAgcmV0dXJuIGRpci5yYXdOYW1lIHx8IGRpci5uYW1lICsgIi4iICsgT2JqZWN0LmtleXMoZGlyLm1vZGlmaWVycyB8fCB7fSkuam9pbignLicpOwp9CgpmdW5jdGlvbiBjYWxsSG9vayQxKGRpciwgaG9vaywgdm5vZGUsIG9sZFZub2RlLCBpc0Rlc3Ryb3kpIHsKICB2YXIgZm4gPSBkaXIuZGVmICYmIGRpci5kZWZbaG9va107CgogIGlmIChmbikgewogICAgdHJ5IHsKICAgICAgZm4odm5vZGUuZWxtLCBkaXIsIHZub2RlLCBvbGRWbm9kZSwgaXNEZXN0cm95KTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgaGFuZGxlRXJyb3IoZSwgdm5vZGUuY29udGV4dCwgImRpcmVjdGl2ZSAiICsgZGlyLm5hbWUgKyAiICIgKyBob29rICsgIiBob29rIik7CiAgICB9CiAgfQp9Cgp2YXIgYmFzZU1vZHVsZXMgPSBbcmVmLCBkaXJlY3RpdmVzXTsKLyogICovCgpmdW5jdGlvbiB1cGRhdGVBdHRycyhvbGRWbm9kZSwgdm5vZGUpIHsKICB2YXIgb3B0cyA9IHZub2RlLmNvbXBvbmVudE9wdGlvbnM7CgogIGlmIChpc0RlZihvcHRzKSAmJiBvcHRzLkN0b3Iub3B0aW9ucy5pbmhlcml0QXR0cnMgPT09IGZhbHNlKSB7CiAgICByZXR1cm47CiAgfQoKICBpZiAoaXNVbmRlZihvbGRWbm9kZS5kYXRhLmF0dHJzKSAmJiBpc1VuZGVmKHZub2RlLmRhdGEuYXR0cnMpKSB7CiAgICByZXR1cm47CiAgfQoKICB2YXIga2V5LCBjdXIsIG9sZDsKICB2YXIgZWxtID0gdm5vZGUuZWxtOwogIHZhciBvbGRBdHRycyA9IG9sZFZub2RlLmRhdGEuYXR0cnMgfHwge307CiAgdmFyIGF0dHJzID0gdm5vZGUuZGF0YS5hdHRycyB8fCB7fTsgLy8gY2xvbmUgb2JzZXJ2ZWQgb2JqZWN0cywgYXMgdGhlIHVzZXIgcHJvYmFibHkgd2FudHMgdG8gbXV0YXRlIGl0CgogIGlmIChpc0RlZihhdHRycy5fX29iX18pKSB7CiAgICBhdHRycyA9IHZub2RlLmRhdGEuYXR0cnMgPSBleHRlbmQoe30sIGF0dHJzKTsKICB9CgogIGZvciAoa2V5IGluIGF0dHJzKSB7CiAgICBjdXIgPSBhdHRyc1trZXldOwogICAgb2xkID0gb2xkQXR0cnNba2V5XTsKCiAgICBpZiAob2xkICE9PSBjdXIpIHsKICAgICAgc2V0QXR0cihlbG0sIGtleSwgY3VyKTsKICAgIH0KICB9IC8vICM0MzkxOiBpbiBJRTksIHNldHRpbmcgdHlwZSBjYW4gcmVzZXQgdmFsdWUgZm9yIGlucHV0W3R5cGU9cmFkaW9dCiAgLy8gIzY2NjY6IElFL0VkZ2UgZm9yY2VzIHByb2dyZXNzIHZhbHVlIGRvd24gdG8gMSBiZWZvcmUgc2V0dGluZyBhIG1heAoKICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KCgogIGlmICgoaXNJRSB8fCBpc0VkZ2UpICYmIGF0dHJzLnZhbHVlICE9PSBvbGRBdHRycy52YWx1ZSkgewogICAgc2V0QXR0cihlbG0sICd2YWx1ZScsIGF0dHJzLnZhbHVlKTsKICB9CgogIGZvciAoa2V5IGluIG9sZEF0dHJzKSB7CiAgICBpZiAoaXNVbmRlZihhdHRyc1trZXldKSkgewogICAgICBpZiAoaXNYbGluayhrZXkpKSB7CiAgICAgICAgZWxtLnJlbW92ZUF0dHJpYnV0ZU5TKHhsaW5rTlMsIGdldFhsaW5rUHJvcChrZXkpKTsKICAgICAgfSBlbHNlIGlmICghaXNFbnVtZXJhdGVkQXR0cihrZXkpKSB7CiAgICAgICAgZWxtLnJlbW92ZUF0dHJpYnV0ZShrZXkpOwogICAgICB9CiAgICB9CiAgfQp9CgpmdW5jdGlvbiBzZXRBdHRyKGVsLCBrZXksIHZhbHVlKSB7CiAgaWYgKGVsLnRhZ05hbWUuaW5kZXhPZignLScpID4gLTEpIHsKICAgIGJhc2VTZXRBdHRyKGVsLCBrZXksIHZhbHVlKTsKICB9IGVsc2UgaWYgKGlzQm9vbGVhbkF0dHIoa2V5KSkgewogICAgLy8gc2V0IGF0dHJpYnV0ZSBmb3IgYmxhbmsgdmFsdWUKICAgIC8vIGUuZy4gPG9wdGlvbiBkaXNhYmxlZD5TZWxlY3Qgb25lPC9vcHRpb24+CiAgICBpZiAoaXNGYWxzeUF0dHJWYWx1ZSh2YWx1ZSkpIHsKICAgICAgZWwucmVtb3ZlQXR0cmlidXRlKGtleSk7CiAgICB9IGVsc2UgewogICAgICAvLyB0ZWNobmljYWxseSBhbGxvd2Z1bGxzY3JlZW4gaXMgYSBib29sZWFuIGF0dHJpYnV0ZSBmb3IgPGlmcmFtZT4sCiAgICAgIC8vIGJ1dCBGbGFzaCBleHBlY3RzIGEgdmFsdWUgb2YgInRydWUiIHdoZW4gdXNlZCBvbiA8ZW1iZWQ+IHRhZwogICAgICB2YWx1ZSA9IGtleSA9PT0gJ2FsbG93ZnVsbHNjcmVlbicgJiYgZWwudGFnTmFtZSA9PT0gJ0VNQkVEJyA/ICd0cnVlJyA6IGtleTsKICAgICAgZWwuc2V0QXR0cmlidXRlKGtleSwgdmFsdWUpOwogICAgfQogIH0gZWxzZSBpZiAoaXNFbnVtZXJhdGVkQXR0cihrZXkpKSB7CiAgICBlbC5zZXRBdHRyaWJ1dGUoa2V5LCBjb252ZXJ0RW51bWVyYXRlZFZhbHVlKGtleSwgdmFsdWUpKTsKICB9IGVsc2UgaWYgKGlzWGxpbmsoa2V5KSkgewogICAgaWYgKGlzRmFsc3lBdHRyVmFsdWUodmFsdWUpKSB7CiAgICAgIGVsLnJlbW92ZUF0dHJpYnV0ZU5TKHhsaW5rTlMsIGdldFhsaW5rUHJvcChrZXkpKTsKICAgIH0gZWxzZSB7CiAgICAgIGVsLnNldEF0dHJpYnV0ZU5TKHhsaW5rTlMsIGtleSwgdmFsdWUpOwogICAgfQogIH0gZWxzZSB7CiAgICBiYXNlU2V0QXR0cihlbCwga2V5LCB2YWx1ZSk7CiAgfQp9CgpmdW5jdGlvbiBiYXNlU2V0QXR0cihlbCwga2V5LCB2YWx1ZSkgewogIGlmIChpc0ZhbHN5QXR0clZhbHVlKHZhbHVlKSkgewogICAgZWwucmVtb3ZlQXR0cmlidXRlKGtleSk7CiAgfSBlbHNlIHsKICAgIC8vICM3MTM4OiBJRTEwICYgMTEgZmlyZXMgaW5wdXQgZXZlbnQgd2hlbiBzZXR0aW5nIHBsYWNlaG9sZGVyIG9uCiAgICAvLyA8dGV4dGFyZWE+Li4uIGJsb2NrIHRoZSBmaXJzdCBpbnB1dCBldmVudCBhbmQgcmVtb3ZlIHRoZSBibG9ja2VyCiAgICAvLyBpbW1lZGlhdGVseS4KCiAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICAgIGlmIChpc0lFICYmICFpc0lFOSAmJiBlbC50YWdOYW1lID09PSAnVEVYVEFSRUEnICYmIGtleSA9PT0gJ3BsYWNlaG9sZGVyJyAmJiB2YWx1ZSAhPT0gJycgJiYgIWVsLl9faWVwaCkgewogICAgICB2YXIgYmxvY2tlciA9IGZ1bmN0aW9uIGJsb2NrZXIoZSkgewogICAgICAgIGUuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CiAgICAgICAgZWwucmVtb3ZlRXZlbnRMaXN0ZW5lcignaW5wdXQnLCBibG9ja2VyKTsKICAgICAgfTsKCiAgICAgIGVsLmFkZEV2ZW50TGlzdGVuZXIoJ2lucHV0JywgYmxvY2tlcik7IC8vICRmbG93LWRpc2FibGUtbGluZQoKICAgICAgZWwuX19pZXBoID0gdHJ1ZTsKICAgICAgLyogSUUgcGxhY2Vob2xkZXIgcGF0Y2hlZCAqLwogICAgfQoKICAgIGVsLnNldEF0dHJpYnV0ZShrZXksIHZhbHVlKTsKICB9Cn0KCnZhciBhdHRycyA9IHsKICBjcmVhdGU6IHVwZGF0ZUF0dHJzLAogIHVwZGF0ZTogdXBkYXRlQXR0cnMKfTsKLyogICovCgpmdW5jdGlvbiB1cGRhdGVDbGFzcyhvbGRWbm9kZSwgdm5vZGUpIHsKICB2YXIgZWwgPSB2bm9kZS5lbG07CiAgdmFyIGRhdGEgPSB2bm9kZS5kYXRhOwogIHZhciBvbGREYXRhID0gb2xkVm5vZGUuZGF0YTsKCiAgaWYgKGlzVW5kZWYoZGF0YS5zdGF0aWNDbGFzcykgJiYgaXNVbmRlZihkYXRhWyJjbGFzcyJdKSAmJiAoaXNVbmRlZihvbGREYXRhKSB8fCBpc1VuZGVmKG9sZERhdGEuc3RhdGljQ2xhc3MpICYmIGlzVW5kZWYob2xkRGF0YVsiY2xhc3MiXSkpKSB7CiAgICByZXR1cm47CiAgfQoKICB2YXIgY2xzID0gZ2VuQ2xhc3NGb3JWbm9kZSh2bm9kZSk7IC8vIGhhbmRsZSB0cmFuc2l0aW9uIGNsYXNzZXMKCiAgdmFyIHRyYW5zaXRpb25DbGFzcyA9IGVsLl90cmFuc2l0aW9uQ2xhc3NlczsKCiAgaWYgKGlzRGVmKHRyYW5zaXRpb25DbGFzcykpIHsKICAgIGNscyA9IGNvbmNhdChjbHMsIHN0cmluZ2lmeUNsYXNzKHRyYW5zaXRpb25DbGFzcykpOwogIH0gLy8gc2V0IHRoZSBjbGFzcwoKCiAgaWYgKGNscyAhPT0gZWwuX3ByZXZDbGFzcykgewogICAgZWwuc2V0QXR0cmlidXRlKCdjbGFzcycsIGNscyk7CiAgICBlbC5fcHJldkNsYXNzID0gY2xzOwogIH0KfQoKdmFyIGtsYXNzID0gewogIGNyZWF0ZTogdXBkYXRlQ2xhc3MsCiAgdXBkYXRlOiB1cGRhdGVDbGFzcwp9OwovKiAgKi8KCi8qICAqLwoKLyogICovCgovKiAgKi8KLy8gaW4gc29tZSBjYXNlcywgdGhlIGV2ZW50IHVzZWQgaGFzIHRvIGJlIGRldGVybWluZWQgYXQgcnVudGltZQovLyBzbyB3ZSB1c2VkIHNvbWUgcmVzZXJ2ZWQgdG9rZW5zIGR1cmluZyBjb21waWxlLgoKdmFyIFJBTkdFX1RPS0VOID0gJ19fcic7CnZhciBDSEVDS0JPWF9SQURJT19UT0tFTiA9ICdfX2MnOwovKiAgKi8KLy8gbm9ybWFsaXplIHYtbW9kZWwgZXZlbnQgdG9rZW5zIHRoYXQgY2FuIG9ubHkgYmUgZGV0ZXJtaW5lZCBhdCBydW50aW1lLgovLyBpdCdzIGltcG9ydGFudCB0byBwbGFjZSB0aGUgZXZlbnQgYXMgdGhlIGZpcnN0IGluIHRoZSBhcnJheSBiZWNhdXNlCi8vIHRoZSB3aG9sZSBwb2ludCBpcyBlbnN1cmluZyB0aGUgdi1tb2RlbCBjYWxsYmFjayBnZXRzIGNhbGxlZCBiZWZvcmUKLy8gdXNlci1hdHRhY2hlZCBoYW5kbGVycy4KCmZ1bmN0aW9uIG5vcm1hbGl6ZUV2ZW50cyhvbikgewogIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogIGlmIChpc0RlZihvbltSQU5HRV9UT0tFTl0pKSB7CiAgICAvLyBJRSBpbnB1dFt0eXBlPXJhbmdlXSBvbmx5IHN1cHBvcnRzIGBjaGFuZ2VgIGV2ZW50CiAgICB2YXIgZXZlbnQgPSBpc0lFID8gJ2NoYW5nZScgOiAnaW5wdXQnOwogICAgb25bZXZlbnRdID0gW10uY29uY2F0KG9uW1JBTkdFX1RPS0VOXSwgb25bZXZlbnRdIHx8IFtdKTsKICAgIGRlbGV0ZSBvbltSQU5HRV9UT0tFTl07CiAgfSAvLyBUaGlzIHdhcyBvcmlnaW5hbGx5IGludGVuZGVkIHRvIGZpeCAjNDUyMSBidXQgbm8gbG9uZ2VyIG5lY2Vzc2FyeQogIC8vIGFmdGVyIDIuNS4gS2VlcGluZyBpdCBmb3IgYmFja3dhcmRzIGNvbXBhdCB3aXRoIGdlbmVyYXRlZCBjb2RlIGZyb20gPCAyLjQKCiAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCgoKICBpZiAoaXNEZWYob25bQ0hFQ0tCT1hfUkFESU9fVE9LRU5dKSkgewogICAgb24uY2hhbmdlID0gW10uY29uY2F0KG9uW0NIRUNLQk9YX1JBRElPX1RPS0VOXSwgb24uY2hhbmdlIHx8IFtdKTsKICAgIGRlbGV0ZSBvbltDSEVDS0JPWF9SQURJT19UT0tFTl07CiAgfQp9Cgp2YXIgdGFyZ2V0JDE7CgpmdW5jdGlvbiBjcmVhdGVPbmNlSGFuZGxlciQxKGV2ZW50LCBoYW5kbGVyLCBjYXB0dXJlKSB7CiAgdmFyIF90YXJnZXQgPSB0YXJnZXQkMTsgLy8gc2F2ZSBjdXJyZW50IHRhcmdldCBlbGVtZW50IGluIGNsb3N1cmUKCiAgcmV0dXJuIGZ1bmN0aW9uIG9uY2VIYW5kbGVyKCkgewogICAgdmFyIHJlcyA9IGhhbmRsZXIuYXBwbHkobnVsbCwgYXJndW1lbnRzKTsKCiAgICBpZiAocmVzICE9PSBudWxsKSB7CiAgICAgIHJlbW92ZSQyKGV2ZW50LCBvbmNlSGFuZGxlciwgY2FwdHVyZSwgX3RhcmdldCk7CiAgICB9CiAgfTsKfSAvLyAjOTQ0NjogRmlyZWZveCA8PSA1MyAoaW4gcGFydGljdWxhciwgRVNSIDUyKSBoYXMgaW5jb3JyZWN0IEV2ZW50LnRpbWVTdGFtcAovLyBpbXBsZW1lbnRhdGlvbiBhbmQgZG9lcyBub3QgZmlyZSBtaWNyb3Rhc2tzIGluIGJldHdlZW4gZXZlbnQgcHJvcGFnYXRpb24sIHNvCi8vIHNhZmUgdG8gZXhjbHVkZS4KCgp2YXIgdXNlTWljcm90YXNrRml4ID0gaXNVc2luZ01pY3JvVGFzayAmJiAhKGlzRkYgJiYgTnVtYmVyKGlzRkZbMV0pIDw9IDUzKTsKCmZ1bmN0aW9uIGFkZCQxKG5hbWUsIGhhbmRsZXIsIGNhcHR1cmUsIHBhc3NpdmUpIHsKICAvLyBhc3luYyBlZGdlIGNhc2UgIzY1NjY6IGlubmVyIGNsaWNrIGV2ZW50IHRyaWdnZXJzIHBhdGNoLCBldmVudCBoYW5kbGVyCiAgLy8gYXR0YWNoZWQgdG8gb3V0ZXIgZWxlbWVudCBkdXJpbmcgcGF0Y2gsIGFuZCB0cmlnZ2VyZWQgYWdhaW4uIFRoaXMKICAvLyBoYXBwZW5zIGJlY2F1c2UgYnJvd3NlcnMgZmlyZSBtaWNyb3Rhc2sgdGlja3MgYmV0d2VlbiBldmVudCBwcm9wYWdhdGlvbi4KICAvLyB0aGUgc29sdXRpb24gaXMgc2ltcGxlOiB3ZSBzYXZlIHRoZSB0aW1lc3RhbXAgd2hlbiBhIGhhbmRsZXIgaXMgYXR0YWNoZWQsCiAgLy8gYW5kIHRoZSBoYW5kbGVyIHdvdWxkIG9ubHkgZmlyZSBpZiB0aGUgZXZlbnQgcGFzc2VkIHRvIGl0IHdhcyBmaXJlZAogIC8vIEFGVEVSIGl0IHdhcyBhdHRhY2hlZC4KICBpZiAodXNlTWljcm90YXNrRml4KSB7CiAgICB2YXIgYXR0YWNoZWRUaW1lc3RhbXAgPSBjdXJyZW50Rmx1c2hUaW1lc3RhbXA7CiAgICB2YXIgb3JpZ2luYWwgPSBoYW5kbGVyOwoKICAgIGhhbmRsZXIgPSBvcmlnaW5hbC5fd3JhcHBlciA9IGZ1bmN0aW9uIChlKSB7CiAgICAgIGlmICggLy8gbm8gYnViYmxpbmcsIHNob3VsZCBhbHdheXMgZmlyZS4KICAgICAgLy8gdGhpcyBpcyBqdXN0IGEgc2FmZXR5IG5ldCBpbiBjYXNlIGV2ZW50LnRpbWVTdGFtcCBpcyB1bnJlbGlhYmxlIGluCiAgICAgIC8vIGNlcnRhaW4gd2VpcmQgZW52aXJvbm1lbnRzLi4uCiAgICAgIGUudGFyZ2V0ID09PSBlLmN1cnJlbnRUYXJnZXQgfHwgLy8gZXZlbnQgaXMgZmlyZWQgYWZ0ZXIgaGFuZGxlciBhdHRhY2htZW50CiAgICAgIGUudGltZVN0YW1wID49IGF0dGFjaGVkVGltZXN0YW1wIHx8IC8vIGJhaWwgZm9yIGVudmlyb25tZW50cyB0aGF0IGhhdmUgYnVnZ3kgZXZlbnQudGltZVN0YW1wIGltcGxlbWVudGF0aW9ucwogICAgICAvLyAjOTQ2MiBpT1MgOSBidWc6IGV2ZW50LnRpbWVTdGFtcCBpcyAwIGFmdGVyIGhpc3RvcnkucHVzaFN0YXRlCiAgICAgIC8vICM5NjgxIFF0V2ViRW5naW5lIGV2ZW50LnRpbWVTdGFtcCBpcyBuZWdhdGl2ZSB2YWx1ZQogICAgICBlLnRpbWVTdGFtcCA8PSAwIHx8IC8vICM5NDQ4IGJhaWwgaWYgZXZlbnQgaXMgZmlyZWQgaW4gYW5vdGhlciBkb2N1bWVudCBpbiBhIG11bHRpLXBhZ2UKICAgICAgLy8gZWxlY3Ryb24vbncuanMgYXBwLCBzaW5jZSBldmVudC50aW1lU3RhbXAgd2lsbCBiZSB1c2luZyBhIGRpZmZlcmVudAogICAgICAvLyBzdGFydGluZyByZWZlcmVuY2UKICAgICAgZS50YXJnZXQub3duZXJEb2N1bWVudCAhPT0gZG9jdW1lbnQpIHsKICAgICAgICByZXR1cm4gb3JpZ2luYWwuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQogICAgfTsKICB9CgogIHRhcmdldCQxLmFkZEV2ZW50TGlzdGVuZXIobmFtZSwgaGFuZGxlciwgc3VwcG9ydHNQYXNzaXZlID8gewogICAgY2FwdHVyZTogY2FwdHVyZSwKICAgIHBhc3NpdmU6IHBhc3NpdmUKICB9IDogY2FwdHVyZSk7Cn0KCmZ1bmN0aW9uIHJlbW92ZSQyKG5hbWUsIGhhbmRsZXIsIGNhcHR1cmUsIF90YXJnZXQpIHsKICAoX3RhcmdldCB8fCB0YXJnZXQkMSkucmVtb3ZlRXZlbnRMaXN0ZW5lcihuYW1lLCBoYW5kbGVyLl93cmFwcGVyIHx8IGhhbmRsZXIsIGNhcHR1cmUpOwp9CgpmdW5jdGlvbiB1cGRhdGVET01MaXN0ZW5lcnMob2xkVm5vZGUsIHZub2RlKSB7CiAgaWYgKGlzVW5kZWYob2xkVm5vZGUuZGF0YS5vbikgJiYgaXNVbmRlZih2bm9kZS5kYXRhLm9uKSkgewogICAgcmV0dXJuOwogIH0KCiAgdmFyIG9uID0gdm5vZGUuZGF0YS5vbiB8fCB7fTsKICB2YXIgb2xkT24gPSBvbGRWbm9kZS5kYXRhLm9uIHx8IHt9OwogIHRhcmdldCQxID0gdm5vZGUuZWxtOwogIG5vcm1hbGl6ZUV2ZW50cyhvbik7CiAgdXBkYXRlTGlzdGVuZXJzKG9uLCBvbGRPbiwgYWRkJDEsIHJlbW92ZSQyLCBjcmVhdGVPbmNlSGFuZGxlciQxLCB2bm9kZS5jb250ZXh0KTsKICB0YXJnZXQkMSA9IHVuZGVmaW5lZDsKfQoKdmFyIGV2ZW50cyA9IHsKICBjcmVhdGU6IHVwZGF0ZURPTUxpc3RlbmVycywKICB1cGRhdGU6IHVwZGF0ZURPTUxpc3RlbmVycwp9OwovKiAgKi8KCnZhciBzdmdDb250YWluZXI7CgpmdW5jdGlvbiB1cGRhdGVET01Qcm9wcyhvbGRWbm9kZSwgdm5vZGUpIHsKICBpZiAoaXNVbmRlZihvbGRWbm9kZS5kYXRhLmRvbVByb3BzKSAmJiBpc1VuZGVmKHZub2RlLmRhdGEuZG9tUHJvcHMpKSB7CiAgICByZXR1cm47CiAgfQoKICB2YXIga2V5LCBjdXI7CiAgdmFyIGVsbSA9IHZub2RlLmVsbTsKICB2YXIgb2xkUHJvcHMgPSBvbGRWbm9kZS5kYXRhLmRvbVByb3BzIHx8IHt9OwogIHZhciBwcm9wcyA9IHZub2RlLmRhdGEuZG9tUHJvcHMgfHwge307IC8vIGNsb25lIG9ic2VydmVkIG9iamVjdHMsIGFzIHRoZSB1c2VyIHByb2JhYmx5IHdhbnRzIHRvIG11dGF0ZSBpdAoKICBpZiAoaXNEZWYocHJvcHMuX19vYl9fKSkgewogICAgcHJvcHMgPSB2bm9kZS5kYXRhLmRvbVByb3BzID0gZXh0ZW5kKHt9LCBwcm9wcyk7CiAgfQoKICBmb3IgKGtleSBpbiBvbGRQcm9wcykgewogICAgaWYgKCEoa2V5IGluIHByb3BzKSkgewogICAgICBlbG1ba2V5XSA9ICcnOwogICAgfQogIH0KCiAgZm9yIChrZXkgaW4gcHJvcHMpIHsKICAgIGN1ciA9IHByb3BzW2tleV07IC8vIGlnbm9yZSBjaGlsZHJlbiBpZiB0aGUgbm9kZSBoYXMgdGV4dENvbnRlbnQgb3IgaW5uZXJIVE1MLAogICAgLy8gYXMgdGhlc2Ugd2lsbCB0aHJvdyBhd2F5IGV4aXN0aW5nIERPTSBub2RlcyBhbmQgY2F1c2UgcmVtb3ZhbCBlcnJvcnMKICAgIC8vIG9uIHN1YnNlcXVlbnQgcGF0Y2hlcyAoIzMzNjApCgogICAgaWYgKGtleSA9PT0gJ3RleHRDb250ZW50JyB8fCBrZXkgPT09ICdpbm5lckhUTUwnKSB7CiAgICAgIGlmICh2bm9kZS5jaGlsZHJlbikgewogICAgICAgIHZub2RlLmNoaWxkcmVuLmxlbmd0aCA9IDA7CiAgICAgIH0KCiAgICAgIGlmIChjdXIgPT09IG9sZFByb3BzW2tleV0pIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfSAvLyAjNjYwMSB3b3JrIGFyb3VuZCBDaHJvbWUgdmVyc2lvbiA8PSA1NSBidWcgd2hlcmUgc2luZ2xlIHRleHROb2RlCiAgICAgIC8vIHJlcGxhY2VkIGJ5IGlubmVySFRNTC90ZXh0Q29udGVudCByZXRhaW5zIGl0cyBwYXJlbnROb2RlIHByb3BlcnR5CgoKICAgICAgaWYgKGVsbS5jaGlsZE5vZGVzLmxlbmd0aCA9PT0gMSkgewogICAgICAgIGVsbS5yZW1vdmVDaGlsZChlbG0uY2hpbGROb2Rlc1swXSk7CiAgICAgIH0KICAgIH0KCiAgICBpZiAoa2V5ID09PSAndmFsdWUnICYmIGVsbS50YWdOYW1lICE9PSAnUFJPR1JFU1MnKSB7CiAgICAgIC8vIHN0b3JlIHZhbHVlIGFzIF92YWx1ZSBhcyB3ZWxsIHNpbmNlCiAgICAgIC8vIG5vbi1zdHJpbmcgdmFsdWVzIHdpbGwgYmUgc3RyaW5naWZpZWQKICAgICAgZWxtLl92YWx1ZSA9IGN1cjsgLy8gYXZvaWQgcmVzZXR0aW5nIGN1cnNvciBwb3NpdGlvbiB3aGVuIHZhbHVlIGlzIHRoZSBzYW1lCgogICAgICB2YXIgc3RyQ3VyID0gaXNVbmRlZihjdXIpID8gJycgOiBTdHJpbmcoY3VyKTsKCiAgICAgIGlmIChzaG91bGRVcGRhdGVWYWx1ZShlbG0sIHN0ckN1cikpIHsKICAgICAgICBlbG0udmFsdWUgPSBzdHJDdXI7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoa2V5ID09PSAnaW5uZXJIVE1MJyAmJiBpc1NWRyhlbG0udGFnTmFtZSkgJiYgaXNVbmRlZihlbG0uaW5uZXJIVE1MKSkgewogICAgICAvLyBJRSBkb2Vzbid0IHN1cHBvcnQgaW5uZXJIVE1MIGZvciBTVkcgZWxlbWVudHMKICAgICAgc3ZnQ29udGFpbmVyID0gc3ZnQ29udGFpbmVyIHx8IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICBzdmdDb250YWluZXIuaW5uZXJIVE1MID0gIjxzdmc+IiArIGN1ciArICI8L3N2Zz4iOwogICAgICB2YXIgc3ZnID0gc3ZnQ29udGFpbmVyLmZpcnN0Q2hpbGQ7CgogICAgICB3aGlsZSAoZWxtLmZpcnN0Q2hpbGQpIHsKICAgICAgICBlbG0ucmVtb3ZlQ2hpbGQoZWxtLmZpcnN0Q2hpbGQpOwogICAgICB9CgogICAgICB3aGlsZSAoc3ZnLmZpcnN0Q2hpbGQpIHsKICAgICAgICBlbG0uYXBwZW5kQ2hpbGQoc3ZnLmZpcnN0Q2hpbGQpOwogICAgICB9CiAgICB9IGVsc2UgaWYgKCAvLyBza2lwIHRoZSB1cGRhdGUgaWYgb2xkIGFuZCBuZXcgVkRPTSBzdGF0ZSBpcyB0aGUgc2FtZS4KICAgIC8vIGB2YWx1ZWAgaXMgaGFuZGxlZCBzZXBhcmF0ZWx5IGJlY2F1c2UgdGhlIERPTSB2YWx1ZSBtYXkgYmUgdGVtcG9yYXJpbHkKICAgIC8vIG91dCBvZiBzeW5jIHdpdGggVkRPTSBzdGF0ZSBkdWUgdG8gZm9jdXMsIGNvbXBvc2l0aW9uIGFuZCBtb2RpZmllcnMuCiAgICAvLyBUaGlzICAjNDUyMSBieSBza2lwcGluZyB0aGUgdW5uZWNlc2FycnkgYGNoZWNrZWRgIHVwZGF0ZS4KICAgIGN1ciAhPT0gb2xkUHJvcHNba2V5XSkgewogICAgICAvLyBzb21lIHByb3BlcnR5IHVwZGF0ZXMgY2FuIHRocm93CiAgICAgIC8vIGUuZy4gYHZhbHVlYCBvbiA8cHJvZ3Jlc3M+IHcvIG5vbi1maW5pdGUgdmFsdWUKICAgICAgdHJ5IHsKICAgICAgICBlbG1ba2V5XSA9IGN1cjsKICAgICAgfSBjYXRjaCAoZSkge30KICAgIH0KICB9Cn0gLy8gY2hlY2sgcGxhdGZvcm1zL3dlYi91dGlsL2F0dHJzLmpzIGFjY2VwdFZhbHVlCgoKZnVuY3Rpb24gc2hvdWxkVXBkYXRlVmFsdWUoZWxtLCBjaGVja1ZhbCkgewogIHJldHVybiAhZWxtLmNvbXBvc2luZyAmJiAoZWxtLnRhZ05hbWUgPT09ICdPUFRJT04nIHx8IGlzTm90SW5Gb2N1c0FuZERpcnR5KGVsbSwgY2hlY2tWYWwpIHx8IGlzRGlydHlXaXRoTW9kaWZpZXJzKGVsbSwgY2hlY2tWYWwpKTsKfQoKZnVuY3Rpb24gaXNOb3RJbkZvY3VzQW5kRGlydHkoZWxtLCBjaGVja1ZhbCkgewogIC8vIHJldHVybiB0cnVlIHdoZW4gdGV4dGJveCAoLm51bWJlciBhbmQgLnRyaW0pIGxvc2VzIGZvY3VzIGFuZCBpdHMgdmFsdWUgaXMKICAvLyBub3QgZXF1YWwgdG8gdGhlIHVwZGF0ZWQgdmFsdWUKICB2YXIgbm90SW5Gb2N1cyA9IHRydWU7IC8vICM2MTU3CiAgLy8gd29yayBhcm91bmQgSUUgYnVnIHdoZW4gYWNjZXNzaW5nIGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgaW4gYW4gaWZyYW1lCgogIHRyeSB7CiAgICBub3RJbkZvY3VzID0gZG9jdW1lbnQuYWN0aXZlRWxlbWVudCAhPT0gZWxtOwogIH0gY2F0Y2ggKGUpIHt9CgogIHJldHVybiBub3RJbkZvY3VzICYmIGVsbS52YWx1ZSAhPT0gY2hlY2tWYWw7Cn0KCmZ1bmN0aW9uIGlzRGlydHlXaXRoTW9kaWZpZXJzKGVsbSwgbmV3VmFsKSB7CiAgdmFyIHZhbHVlID0gZWxtLnZhbHVlOwogIHZhciBtb2RpZmllcnMgPSBlbG0uX3ZNb2RpZmllcnM7IC8vIGluamVjdGVkIGJ5IHYtbW9kZWwgcnVudGltZQoKICBpZiAoaXNEZWYobW9kaWZpZXJzKSkgewogICAgaWYgKG1vZGlmaWVycy5udW1iZXIpIHsKICAgICAgcmV0dXJuIHRvTnVtYmVyKHZhbHVlKSAhPT0gdG9OdW1iZXIobmV3VmFsKTsKICAgIH0KCiAgICBpZiAobW9kaWZpZXJzLnRyaW0pIHsKICAgICAgcmV0dXJuIHZhbHVlLnRyaW0oKSAhPT0gbmV3VmFsLnRyaW0oKTsKICAgIH0KICB9CgogIHJldHVybiB2YWx1ZSAhPT0gbmV3VmFsOwp9Cgp2YXIgZG9tUHJvcHMgPSB7CiAgY3JlYXRlOiB1cGRhdGVET01Qcm9wcywKICB1cGRhdGU6IHVwZGF0ZURPTVByb3BzCn07Ci8qICAqLwoKdmFyIHBhcnNlU3R5bGVUZXh0ID0gY2FjaGVkKGZ1bmN0aW9uIChjc3NUZXh0KSB7CiAgdmFyIHJlcyA9IHt9OwogIHZhciBsaXN0RGVsaW1pdGVyID0gLzsoPyFbXihdKlwpKS9nOwogIHZhciBwcm9wZXJ0eURlbGltaXRlciA9IC86KC4rKS87CiAgY3NzVGV4dC5zcGxpdChsaXN0RGVsaW1pdGVyKS5mb3JFYWNoKGZ1bmN0aW9uIChpdGVtKSB7CiAgICBpZiAoaXRlbSkgewogICAgICB2YXIgdG1wID0gaXRlbS5zcGxpdChwcm9wZXJ0eURlbGltaXRlcik7CiAgICAgIHRtcC5sZW5ndGggPiAxICYmIChyZXNbdG1wWzBdLnRyaW0oKV0gPSB0bXBbMV0udHJpbSgpKTsKICAgIH0KICB9KTsKICByZXR1cm4gcmVzOwp9KTsgLy8gbWVyZ2Ugc3RhdGljIGFuZCBkeW5hbWljIHN0eWxlIGRhdGEgb24gdGhlIHNhbWUgdm5vZGUKCmZ1bmN0aW9uIG5vcm1hbGl6ZVN0eWxlRGF0YShkYXRhKSB7CiAgdmFyIHN0eWxlID0gbm9ybWFsaXplU3R5bGVCaW5kaW5nKGRhdGEuc3R5bGUpOyAvLyBzdGF0aWMgc3R5bGUgaXMgcHJlLXByb2Nlc3NlZCBpbnRvIGFuIG9iamVjdCBkdXJpbmcgY29tcGlsYXRpb24KICAvLyBhbmQgaXMgYWx3YXlzIGEgZnJlc2ggb2JqZWN0LCBzbyBpdCdzIHNhZmUgdG8gbWVyZ2UgaW50byBpdAoKICByZXR1cm4gZGF0YS5zdGF0aWNTdHlsZSA/IGV4dGVuZChkYXRhLnN0YXRpY1N0eWxlLCBzdHlsZSkgOiBzdHlsZTsKfSAvLyBub3JtYWxpemUgcG9zc2libGUgYXJyYXkgLyBzdHJpbmcgdmFsdWVzIGludG8gT2JqZWN0CgoKZnVuY3Rpb24gbm9ybWFsaXplU3R5bGVCaW5kaW5nKGJpbmRpbmdTdHlsZSkgewogIGlmIChBcnJheS5pc0FycmF5KGJpbmRpbmdTdHlsZSkpIHsKICAgIHJldHVybiB0b09iamVjdChiaW5kaW5nU3R5bGUpOwogIH0KCiAgaWYgKHR5cGVvZiBiaW5kaW5nU3R5bGUgPT09ICdzdHJpbmcnKSB7CiAgICByZXR1cm4gcGFyc2VTdHlsZVRleHQoYmluZGluZ1N0eWxlKTsKICB9CgogIHJldHVybiBiaW5kaW5nU3R5bGU7Cn0KLyoqCiAqIHBhcmVudCBjb21wb25lbnQgc3R5bGUgc2hvdWxkIGJlIGFmdGVyIGNoaWxkJ3MKICogc28gdGhhdCBwYXJlbnQgY29tcG9uZW50J3Mgc3R5bGUgY291bGQgb3ZlcnJpZGUgaXQKICovCgoKZnVuY3Rpb24gZ2V0U3R5bGUodm5vZGUsIGNoZWNrQ2hpbGQpIHsKICB2YXIgcmVzID0ge307CiAgdmFyIHN0eWxlRGF0YTsKCiAgaWYgKGNoZWNrQ2hpbGQpIHsKICAgIHZhciBjaGlsZE5vZGUgPSB2bm9kZTsKCiAgICB3aGlsZSAoY2hpbGROb2RlLmNvbXBvbmVudEluc3RhbmNlKSB7CiAgICAgIGNoaWxkTm9kZSA9IGNoaWxkTm9kZS5jb21wb25lbnRJbnN0YW5jZS5fdm5vZGU7CgogICAgICBpZiAoY2hpbGROb2RlICYmIGNoaWxkTm9kZS5kYXRhICYmIChzdHlsZURhdGEgPSBub3JtYWxpemVTdHlsZURhdGEoY2hpbGROb2RlLmRhdGEpKSkgewogICAgICAgIGV4dGVuZChyZXMsIHN0eWxlRGF0YSk7CiAgICAgIH0KICAgIH0KICB9CgogIGlmIChzdHlsZURhdGEgPSBub3JtYWxpemVTdHlsZURhdGEodm5vZGUuZGF0YSkpIHsKICAgIGV4dGVuZChyZXMsIHN0eWxlRGF0YSk7CiAgfQoKICB2YXIgcGFyZW50Tm9kZSA9IHZub2RlOwoKICB3aGlsZSAocGFyZW50Tm9kZSA9IHBhcmVudE5vZGUucGFyZW50KSB7CiAgICBpZiAocGFyZW50Tm9kZS5kYXRhICYmIChzdHlsZURhdGEgPSBub3JtYWxpemVTdHlsZURhdGEocGFyZW50Tm9kZS5kYXRhKSkpIHsKICAgICAgZXh0ZW5kKHJlcywgc3R5bGVEYXRhKTsKICAgIH0KICB9CgogIHJldHVybiByZXM7Cn0KLyogICovCgoKdmFyIGNzc1ZhclJFID0gL14tLS87CnZhciBpbXBvcnRhbnRSRSA9IC9ccyohaW1wb3J0YW50JC87Cgp2YXIgc2V0UHJvcCA9IGZ1bmN0aW9uIHNldFByb3AoZWwsIG5hbWUsIHZhbCkgewogIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogIGlmIChjc3NWYXJSRS50ZXN0KG5hbWUpKSB7CiAgICBlbC5zdHlsZS5zZXRQcm9wZXJ0eShuYW1lLCB2YWwpOwogIH0gZWxzZSBpZiAoaW1wb3J0YW50UkUudGVzdCh2YWwpKSB7CiAgICBlbC5zdHlsZS5zZXRQcm9wZXJ0eShoeXBoZW5hdGUobmFtZSksIHZhbC5yZXBsYWNlKGltcG9ydGFudFJFLCAnJyksICdpbXBvcnRhbnQnKTsKICB9IGVsc2UgewogICAgdmFyIG5vcm1hbGl6ZWROYW1lID0gbm9ybWFsaXplKG5hbWUpOwoKICAgIGlmIChBcnJheS5pc0FycmF5KHZhbCkpIHsKICAgICAgLy8gU3VwcG9ydCB2YWx1ZXMgYXJyYXkgY3JlYXRlZCBieSBhdXRvcHJlZml4ZXIsIGUuZy4KICAgICAgLy8ge2Rpc3BsYXk6IFsiLXdlYmtpdC1ib3giLCAiLW1zLWZsZXhib3giLCAiZmxleCJdfQogICAgICAvLyBTZXQgdGhlbSBvbmUgYnkgb25lLCBhbmQgdGhlIGJyb3dzZXIgd2lsbCBvbmx5IHNldCB0aG9zZSBpdCBjYW4gcmVjb2duaXplCiAgICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSB2YWwubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICBlbC5zdHlsZVtub3JtYWxpemVkTmFtZV0gPSB2YWxbaV07CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGVsLnN0eWxlW25vcm1hbGl6ZWROYW1lXSA9IHZhbDsKICAgIH0KICB9Cn07Cgp2YXIgdmVuZG9yTmFtZXMgPSBbJ1dlYmtpdCcsICdNb3onLCAnbXMnXTsKdmFyIGVtcHR5U3R5bGU7CnZhciBub3JtYWxpemUgPSBjYWNoZWQoZnVuY3Rpb24gKHByb3ApIHsKICBlbXB0eVN0eWxlID0gZW1wdHlTdHlsZSB8fCBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKS5zdHlsZTsKICBwcm9wID0gY2FtZWxpemUocHJvcCk7CgogIGlmIChwcm9wICE9PSAnZmlsdGVyJyAmJiBwcm9wIGluIGVtcHR5U3R5bGUpIHsKICAgIHJldHVybiBwcm9wOwogIH0KCiAgdmFyIGNhcE5hbWUgPSBwcm9wLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgcHJvcC5zbGljZSgxKTsKCiAgZm9yICh2YXIgaSA9IDA7IGkgPCB2ZW5kb3JOYW1lcy5sZW5ndGg7IGkrKykgewogICAgdmFyIG5hbWUgPSB2ZW5kb3JOYW1lc1tpXSArIGNhcE5hbWU7CgogICAgaWYgKG5hbWUgaW4gZW1wdHlTdHlsZSkgewogICAgICByZXR1cm4gbmFtZTsKICAgIH0KICB9Cn0pOwoKZnVuY3Rpb24gdXBkYXRlU3R5bGUob2xkVm5vZGUsIHZub2RlKSB7CiAgdmFyIGRhdGEgPSB2bm9kZS5kYXRhOwogIHZhciBvbGREYXRhID0gb2xkVm5vZGUuZGF0YTsKCiAgaWYgKGlzVW5kZWYoZGF0YS5zdGF0aWNTdHlsZSkgJiYgaXNVbmRlZihkYXRhLnN0eWxlKSAmJiBpc1VuZGVmKG9sZERhdGEuc3RhdGljU3R5bGUpICYmIGlzVW5kZWYob2xkRGF0YS5zdHlsZSkpIHsKICAgIHJldHVybjsKICB9CgogIHZhciBjdXIsIG5hbWU7CiAgdmFyIGVsID0gdm5vZGUuZWxtOwogIHZhciBvbGRTdGF0aWNTdHlsZSA9IG9sZERhdGEuc3RhdGljU3R5bGU7CiAgdmFyIG9sZFN0eWxlQmluZGluZyA9IG9sZERhdGEubm9ybWFsaXplZFN0eWxlIHx8IG9sZERhdGEuc3R5bGUgfHwge307IC8vIGlmIHN0YXRpYyBzdHlsZSBleGlzdHMsIHN0eWxlYmluZGluZyBhbHJlYWR5IG1lcmdlZCBpbnRvIGl0IHdoZW4gZG9pbmcgbm9ybWFsaXplU3R5bGVEYXRhCgogIHZhciBvbGRTdHlsZSA9IG9sZFN0YXRpY1N0eWxlIHx8IG9sZFN0eWxlQmluZGluZzsKICB2YXIgc3R5bGUgPSBub3JtYWxpemVTdHlsZUJpbmRpbmcodm5vZGUuZGF0YS5zdHlsZSkgfHwge307IC8vIHN0b3JlIG5vcm1hbGl6ZWQgc3R5bGUgdW5kZXIgYSBkaWZmZXJlbnQga2V5IGZvciBuZXh0IGRpZmYKICAvLyBtYWtlIHN1cmUgdG8gY2xvbmUgaXQgaWYgaXQncyByZWFjdGl2ZSwgc2luY2UgdGhlIHVzZXIgbGlrZWx5IHdhbnRzCiAgLy8gdG8gbXV0YXRlIGl0LgoKICB2bm9kZS5kYXRhLm5vcm1hbGl6ZWRTdHlsZSA9IGlzRGVmKHN0eWxlLl9fb2JfXykgPyBleHRlbmQoe30sIHN0eWxlKSA6IHN0eWxlOwogIHZhciBuZXdTdHlsZSA9IGdldFN0eWxlKHZub2RlLCB0cnVlKTsKCiAgZm9yIChuYW1lIGluIG9sZFN0eWxlKSB7CiAgICBpZiAoaXNVbmRlZihuZXdTdHlsZVtuYW1lXSkpIHsKICAgICAgc2V0UHJvcChlbCwgbmFtZSwgJycpOwogICAgfQogIH0KCiAgZm9yIChuYW1lIGluIG5ld1N0eWxlKSB7CiAgICBjdXIgPSBuZXdTdHlsZVtuYW1lXTsKCiAgICBpZiAoY3VyICE9PSBvbGRTdHlsZVtuYW1lXSkgewogICAgICAvLyBpZTkgc2V0dGluZyB0byBudWxsIGhhcyBubyBlZmZlY3QsIG11c3QgdXNlIGVtcHR5IHN0cmluZwogICAgICBzZXRQcm9wKGVsLCBuYW1lLCBjdXIgPT0gbnVsbCA/ICcnIDogY3VyKTsKICAgIH0KICB9Cn0KCnZhciBzdHlsZSA9IHsKICBjcmVhdGU6IHVwZGF0ZVN0eWxlLAogIHVwZGF0ZTogdXBkYXRlU3R5bGUKfTsKLyogICovCgp2YXIgd2hpdGVzcGFjZVJFID0gL1xzKy87Ci8qKgogKiBBZGQgY2xhc3Mgd2l0aCBjb21wYXRpYmlsaXR5IGZvciBTVkcgc2luY2UgY2xhc3NMaXN0IGlzIG5vdCBzdXBwb3J0ZWQgb24KICogU1ZHIGVsZW1lbnRzIGluIElFCiAqLwoKZnVuY3Rpb24gYWRkQ2xhc3MoZWwsIGNscykgewogIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogIGlmICghY2xzIHx8ICEoY2xzID0gY2xzLnRyaW0oKSkpIHsKICAgIHJldHVybjsKICB9CiAgLyogaXN0YW5idWwgaWdub3JlIGVsc2UgKi8KCgogIGlmIChlbC5jbGFzc0xpc3QpIHsKICAgIGlmIChjbHMuaW5kZXhPZignICcpID4gLTEpIHsKICAgICAgY2xzLnNwbGl0KHdoaXRlc3BhY2VSRSkuZm9yRWFjaChmdW5jdGlvbiAoYykgewogICAgICAgIHJldHVybiBlbC5jbGFzc0xpc3QuYWRkKGMpOwogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIGVsLmNsYXNzTGlzdC5hZGQoY2xzKTsKICAgIH0KICB9IGVsc2UgewogICAgdmFyIGN1ciA9ICIgIiArIChlbC5nZXRBdHRyaWJ1dGUoJ2NsYXNzJykgfHwgJycpICsgIiAiOwoKICAgIGlmIChjdXIuaW5kZXhPZignICcgKyBjbHMgKyAnICcpIDwgMCkgewogICAgICBlbC5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgKGN1ciArIGNscykudHJpbSgpKTsKICAgIH0KICB9Cn0KLyoqCiAqIFJlbW92ZSBjbGFzcyB3aXRoIGNvbXBhdGliaWxpdHkgZm9yIFNWRyBzaW5jZSBjbGFzc0xpc3QgaXMgbm90IHN1cHBvcnRlZCBvbgogKiBTVkcgZWxlbWVudHMgaW4gSUUKICovCgoKZnVuY3Rpb24gcmVtb3ZlQ2xhc3MoZWwsIGNscykgewogIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogIGlmICghY2xzIHx8ICEoY2xzID0gY2xzLnRyaW0oKSkpIHsKICAgIHJldHVybjsKICB9CiAgLyogaXN0YW5idWwgaWdub3JlIGVsc2UgKi8KCgogIGlmIChlbC5jbGFzc0xpc3QpIHsKICAgIGlmIChjbHMuaW5kZXhPZignICcpID4gLTEpIHsKICAgICAgY2xzLnNwbGl0KHdoaXRlc3BhY2VSRSkuZm9yRWFjaChmdW5jdGlvbiAoYykgewogICAgICAgIHJldHVybiBlbC5jbGFzc0xpc3QucmVtb3ZlKGMpOwogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIGVsLmNsYXNzTGlzdC5yZW1vdmUoY2xzKTsKICAgIH0KCiAgICBpZiAoIWVsLmNsYXNzTGlzdC5sZW5ndGgpIHsKICAgICAgZWwucmVtb3ZlQXR0cmlidXRlKCdjbGFzcycpOwogICAgfQogIH0gZWxzZSB7CiAgICB2YXIgY3VyID0gIiAiICsgKGVsLmdldEF0dHJpYnV0ZSgnY2xhc3MnKSB8fCAnJykgKyAiICI7CiAgICB2YXIgdGFyID0gJyAnICsgY2xzICsgJyAnOwoKICAgIHdoaWxlIChjdXIuaW5kZXhPZih0YXIpID49IDApIHsKICAgICAgY3VyID0gY3VyLnJlcGxhY2UodGFyLCAnICcpOwogICAgfQoKICAgIGN1ciA9IGN1ci50cmltKCk7CgogICAgaWYgKGN1cikgewogICAgICBlbC5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgY3VyKTsKICAgIH0gZWxzZSB7CiAgICAgIGVsLnJlbW92ZUF0dHJpYnV0ZSgnY2xhc3MnKTsKICAgIH0KICB9Cn0KLyogICovCgoKZnVuY3Rpb24gcmVzb2x2ZVRyYW5zaXRpb24oZGVmJCQxKSB7CiAgaWYgKCFkZWYkJDEpIHsKICAgIHJldHVybjsKICB9CiAgLyogaXN0YW5idWwgaWdub3JlIGVsc2UgKi8KCgogIGlmIChfdHlwZW9mKGRlZiQkMSkgPT09ICdvYmplY3QnKSB7CiAgICB2YXIgcmVzID0ge307CgogICAgaWYgKGRlZiQkMS5jc3MgIT09IGZhbHNlKSB7CiAgICAgIGV4dGVuZChyZXMsIGF1dG9Dc3NUcmFuc2l0aW9uKGRlZiQkMS5uYW1lIHx8ICd2JykpOwogICAgfQoKICAgIGV4dGVuZChyZXMsIGRlZiQkMSk7CiAgICByZXR1cm4gcmVzOwogIH0gZWxzZSBpZiAodHlwZW9mIGRlZiQkMSA9PT0gJ3N0cmluZycpIHsKICAgIHJldHVybiBhdXRvQ3NzVHJhbnNpdGlvbihkZWYkJDEpOwogIH0KfQoKdmFyIGF1dG9Dc3NUcmFuc2l0aW9uID0gY2FjaGVkKGZ1bmN0aW9uIChuYW1lKSB7CiAgcmV0dXJuIHsKICAgIGVudGVyQ2xhc3M6IG5hbWUgKyAiLWVudGVyIiwKICAgIGVudGVyVG9DbGFzczogbmFtZSArICItZW50ZXItdG8iLAogICAgZW50ZXJBY3RpdmVDbGFzczogbmFtZSArICItZW50ZXItYWN0aXZlIiwKICAgIGxlYXZlQ2xhc3M6IG5hbWUgKyAiLWxlYXZlIiwKICAgIGxlYXZlVG9DbGFzczogbmFtZSArICItbGVhdmUtdG8iLAogICAgbGVhdmVBY3RpdmVDbGFzczogbmFtZSArICItbGVhdmUtYWN0aXZlIgogIH07Cn0pOwp2YXIgaGFzVHJhbnNpdGlvbiA9IGluQnJvd3NlciAmJiAhaXNJRTk7CnZhciBUUkFOU0lUSU9OID0gJ3RyYW5zaXRpb24nOwp2YXIgQU5JTUFUSU9OID0gJ2FuaW1hdGlvbic7IC8vIFRyYW5zaXRpb24gcHJvcGVydHkvZXZlbnQgc25pZmZpbmcKCnZhciB0cmFuc2l0aW9uUHJvcCA9ICd0cmFuc2l0aW9uJzsKdmFyIHRyYW5zaXRpb25FbmRFdmVudCA9ICd0cmFuc2l0aW9uZW5kJzsKdmFyIGFuaW1hdGlvblByb3AgPSAnYW5pbWF0aW9uJzsKdmFyIGFuaW1hdGlvbkVuZEV2ZW50ID0gJ2FuaW1hdGlvbmVuZCc7CgppZiAoaGFzVHJhbnNpdGlvbikgewogIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwogIGlmICh3aW5kb3cub250cmFuc2l0aW9uZW5kID09PSB1bmRlZmluZWQgJiYgd2luZG93Lm9ud2Via2l0dHJhbnNpdGlvbmVuZCAhPT0gdW5kZWZpbmVkKSB7CiAgICB0cmFuc2l0aW9uUHJvcCA9ICdXZWJraXRUcmFuc2l0aW9uJzsKICAgIHRyYW5zaXRpb25FbmRFdmVudCA9ICd3ZWJraXRUcmFuc2l0aW9uRW5kJzsKICB9CgogIGlmICh3aW5kb3cub25hbmltYXRpb25lbmQgPT09IHVuZGVmaW5lZCAmJiB3aW5kb3cub253ZWJraXRhbmltYXRpb25lbmQgIT09IHVuZGVmaW5lZCkgewogICAgYW5pbWF0aW9uUHJvcCA9ICdXZWJraXRBbmltYXRpb24nOwogICAgYW5pbWF0aW9uRW5kRXZlbnQgPSAnd2Via2l0QW5pbWF0aW9uRW5kJzsKICB9Cn0gLy8gYmluZGluZyB0byB3aW5kb3cgaXMgbmVjZXNzYXJ5IHRvIG1ha2UgaG90IHJlbG9hZCB3b3JrIGluIElFIGluIHN0cmljdCBtb2RlCgoKdmFyIHJhZiA9IGluQnJvd3NlciA/IHdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUgPyB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lLmJpbmQod2luZG93KSA6IHNldFRpbWVvdXQgOgovKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAqLwpmdW5jdGlvbiAoZm4pIHsKICByZXR1cm4gZm4oKTsKfTsKCmZ1bmN0aW9uIG5leHRGcmFtZShmbikgewogIHJhZihmdW5jdGlvbiAoKSB7CiAgICByYWYoZm4pOwogIH0pOwp9CgpmdW5jdGlvbiBhZGRUcmFuc2l0aW9uQ2xhc3MoZWwsIGNscykgewogIHZhciB0cmFuc2l0aW9uQ2xhc3NlcyA9IGVsLl90cmFuc2l0aW9uQ2xhc3NlcyB8fCAoZWwuX3RyYW5zaXRpb25DbGFzc2VzID0gW10pOwoKICBpZiAodHJhbnNpdGlvbkNsYXNzZXMuaW5kZXhPZihjbHMpIDwgMCkgewogICAgdHJhbnNpdGlvbkNsYXNzZXMucHVzaChjbHMpOwogICAgYWRkQ2xhc3MoZWwsIGNscyk7CiAgfQp9CgpmdW5jdGlvbiByZW1vdmVUcmFuc2l0aW9uQ2xhc3MoZWwsIGNscykgewogIGlmIChlbC5fdHJhbnNpdGlvbkNsYXNzZXMpIHsKICAgIHJlbW92ZShlbC5fdHJhbnNpdGlvbkNsYXNzZXMsIGNscyk7CiAgfQoKICByZW1vdmVDbGFzcyhlbCwgY2xzKTsKfQoKZnVuY3Rpb24gd2hlblRyYW5zaXRpb25FbmRzKGVsLCBleHBlY3RlZFR5cGUsIGNiKSB7CiAgdmFyIHJlZiA9IGdldFRyYW5zaXRpb25JbmZvKGVsLCBleHBlY3RlZFR5cGUpOwogIHZhciB0eXBlID0gcmVmLnR5cGU7CiAgdmFyIHRpbWVvdXQgPSByZWYudGltZW91dDsKICB2YXIgcHJvcENvdW50ID0gcmVmLnByb3BDb3VudDsKCiAgaWYgKCF0eXBlKSB7CiAgICByZXR1cm4gY2IoKTsKICB9CgogIHZhciBldmVudCA9IHR5cGUgPT09IFRSQU5TSVRJT04gPyB0cmFuc2l0aW9uRW5kRXZlbnQgOiBhbmltYXRpb25FbmRFdmVudDsKICB2YXIgZW5kZWQgPSAwOwoKICB2YXIgZW5kID0gZnVuY3Rpb24gZW5kKCkgewogICAgZWwucmVtb3ZlRXZlbnRMaXN0ZW5lcihldmVudCwgb25FbmQpOwogICAgY2IoKTsKICB9OwoKICB2YXIgb25FbmQgPSBmdW5jdGlvbiBvbkVuZChlKSB7CiAgICBpZiAoZS50YXJnZXQgPT09IGVsKSB7CiAgICAgIGlmICgrK2VuZGVkID49IHByb3BDb3VudCkgewogICAgICAgIGVuZCgpOwogICAgICB9CiAgICB9CiAgfTsKCiAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICBpZiAoZW5kZWQgPCBwcm9wQ291bnQpIHsKICAgICAgZW5kKCk7CiAgICB9CiAgfSwgdGltZW91dCArIDEpOwogIGVsLmFkZEV2ZW50TGlzdGVuZXIoZXZlbnQsIG9uRW5kKTsKfQoKdmFyIHRyYW5zZm9ybVJFID0gL1xiKHRyYW5zZm9ybXxhbGwpKCx8JCkvOwoKZnVuY3Rpb24gZ2V0VHJhbnNpdGlvbkluZm8oZWwsIGV4cGVjdGVkVHlwZSkgewogIHZhciBzdHlsZXMgPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZShlbCk7IC8vIEpTRE9NIG1heSByZXR1cm4gdW5kZWZpbmVkIGZvciB0cmFuc2l0aW9uIHByb3BlcnRpZXMKCiAgdmFyIHRyYW5zaXRpb25EZWxheXMgPSAoc3R5bGVzW3RyYW5zaXRpb25Qcm9wICsgJ0RlbGF5J10gfHwgJycpLnNwbGl0KCcsICcpOwogIHZhciB0cmFuc2l0aW9uRHVyYXRpb25zID0gKHN0eWxlc1t0cmFuc2l0aW9uUHJvcCArICdEdXJhdGlvbiddIHx8ICcnKS5zcGxpdCgnLCAnKTsKICB2YXIgdHJhbnNpdGlvblRpbWVvdXQgPSBnZXRUaW1lb3V0KHRyYW5zaXRpb25EZWxheXMsIHRyYW5zaXRpb25EdXJhdGlvbnMpOwogIHZhciBhbmltYXRpb25EZWxheXMgPSAoc3R5bGVzW2FuaW1hdGlvblByb3AgKyAnRGVsYXknXSB8fCAnJykuc3BsaXQoJywgJyk7CiAgdmFyIGFuaW1hdGlvbkR1cmF0aW9ucyA9IChzdHlsZXNbYW5pbWF0aW9uUHJvcCArICdEdXJhdGlvbiddIHx8ICcnKS5zcGxpdCgnLCAnKTsKICB2YXIgYW5pbWF0aW9uVGltZW91dCA9IGdldFRpbWVvdXQoYW5pbWF0aW9uRGVsYXlzLCBhbmltYXRpb25EdXJhdGlvbnMpOwogIHZhciB0eXBlOwogIHZhciB0aW1lb3V0ID0gMDsKICB2YXIgcHJvcENvdW50ID0gMDsKICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KCiAgaWYgKGV4cGVjdGVkVHlwZSA9PT0gVFJBTlNJVElPTikgewogICAgaWYgKHRyYW5zaXRpb25UaW1lb3V0ID4gMCkgewogICAgICB0eXBlID0gVFJBTlNJVElPTjsKICAgICAgdGltZW91dCA9IHRyYW5zaXRpb25UaW1lb3V0OwogICAgICBwcm9wQ291bnQgPSB0cmFuc2l0aW9uRHVyYXRpb25zLmxlbmd0aDsKICAgIH0KICB9IGVsc2UgaWYgKGV4cGVjdGVkVHlwZSA9PT0gQU5JTUFUSU9OKSB7CiAgICBpZiAoYW5pbWF0aW9uVGltZW91dCA+IDApIHsKICAgICAgdHlwZSA9IEFOSU1BVElPTjsKICAgICAgdGltZW91dCA9IGFuaW1hdGlvblRpbWVvdXQ7CiAgICAgIHByb3BDb3VudCA9IGFuaW1hdGlvbkR1cmF0aW9ucy5sZW5ndGg7CiAgICB9CiAgfSBlbHNlIHsKICAgIHRpbWVvdXQgPSBNYXRoLm1heCh0cmFuc2l0aW9uVGltZW91dCwgYW5pbWF0aW9uVGltZW91dCk7CiAgICB0eXBlID0gdGltZW91dCA+IDAgPyB0cmFuc2l0aW9uVGltZW91dCA+IGFuaW1hdGlvblRpbWVvdXQgPyBUUkFOU0lUSU9OIDogQU5JTUFUSU9OIDogbnVsbDsKICAgIHByb3BDb3VudCA9IHR5cGUgPyB0eXBlID09PSBUUkFOU0lUSU9OID8gdHJhbnNpdGlvbkR1cmF0aW9ucy5sZW5ndGggOiBhbmltYXRpb25EdXJhdGlvbnMubGVuZ3RoIDogMDsKICB9CgogIHZhciBoYXNUcmFuc2Zvcm0gPSB0eXBlID09PSBUUkFOU0lUSU9OICYmIHRyYW5zZm9ybVJFLnRlc3Qoc3R5bGVzW3RyYW5zaXRpb25Qcm9wICsgJ1Byb3BlcnR5J10pOwogIHJldHVybiB7CiAgICB0eXBlOiB0eXBlLAogICAgdGltZW91dDogdGltZW91dCwKICAgIHByb3BDb3VudDogcHJvcENvdW50LAogICAgaGFzVHJhbnNmb3JtOiBoYXNUcmFuc2Zvcm0KICB9Owp9CgpmdW5jdGlvbiBnZXRUaW1lb3V0KGRlbGF5cywgZHVyYXRpb25zKSB7CiAgLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8KICB3aGlsZSAoZGVsYXlzLmxlbmd0aCA8IGR1cmF0aW9ucy5sZW5ndGgpIHsKICAgIGRlbGF5cyA9IGRlbGF5cy5jb25jYXQoZGVsYXlzKTsKICB9CgogIHJldHVybiBNYXRoLm1heC5hcHBseShudWxsLCBkdXJhdGlvbnMubWFwKGZ1bmN0aW9uIChkLCBpKSB7CiAgICByZXR1cm4gdG9NcyhkKSArIHRvTXMoZGVsYXlzW2ldKTsKICB9KSk7Cn0gLy8gT2xkIHZlcnNpb25zIG9mIENocm9taXVtIChiZWxvdyA2MS4wLjMxNjMuMTAwKSBmb3JtYXRzIGZsb2F0aW5nIHBvaW50ZXIgbnVtYmVycwovLyBpbiBhIGxvY2FsZS1kZXBlbmRlbnQgd2F5LCB1c2luZyBhIGNvbW1hIGluc3RlYWQgb2YgYSBkb3QuCi8vIElmIGNvbW1hIGlzIG5vdCByZXBsYWNlZCB3aXRoIGEgZG90LCB0aGUgaW5wdXQgd2lsbCBiZSByb3VuZGVkIGRvd24gKGkuZS4gYWN0aW5nCi8vIGFzIGEgZmxvb3IgZnVuY3Rpb24pIGNhdXNpbmcgdW5leHBlY3RlZCBiZWhhdmlvcnMKCgpmdW5jdGlvbiB0b01zKHMpIHsKICByZXR1cm4gTnVtYmVyKHMuc2xpY2UoMCwgLTEpLnJlcGxhY2UoJywnLCAnLicpKSAqIDEwMDA7Cn0KLyogICovCgoKZnVuY3Rpb24gZW50ZXIodm5vZGUsIHRvZ2dsZURpc3BsYXkpIHsKICB2YXIgZWwgPSB2bm9kZS5lbG07IC8vIGNhbGwgbGVhdmUgY2FsbGJhY2sgbm93CgogIGlmIChpc0RlZihlbC5fbGVhdmVDYikpIHsKICAgIGVsLl9sZWF2ZUNiLmNhbmNlbGxlZCA9IHRydWU7CgogICAgZWwuX2xlYXZlQ2IoKTsKICB9CgogIHZhciBkYXRhID0gcmVzb2x2ZVRyYW5zaXRpb24odm5vZGUuZGF0YS50cmFuc2l0aW9uKTsKCiAgaWYgKGlzVW5kZWYoZGF0YSkpIHsKICAgIHJldHVybjsKICB9CiAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCgoKICBpZiAoaXNEZWYoZWwuX2VudGVyQ2IpIHx8IGVsLm5vZGVUeXBlICE9PSAxKSB7CiAgICByZXR1cm47CiAgfQoKICB2YXIgY3NzID0gZGF0YS5jc3M7CiAgdmFyIHR5cGUgPSBkYXRhLnR5cGU7CiAgdmFyIGVudGVyQ2xhc3MgPSBkYXRhLmVudGVyQ2xhc3M7CiAgdmFyIGVudGVyVG9DbGFzcyA9IGRhdGEuZW50ZXJUb0NsYXNzOwogIHZhciBlbnRlckFjdGl2ZUNsYXNzID0gZGF0YS5lbnRlckFjdGl2ZUNsYXNzOwogIHZhciBhcHBlYXJDbGFzcyA9IGRhdGEuYXBwZWFyQ2xhc3M7CiAgdmFyIGFwcGVhclRvQ2xhc3MgPSBkYXRhLmFwcGVhclRvQ2xhc3M7CiAgdmFyIGFwcGVhckFjdGl2ZUNsYXNzID0gZGF0YS5hcHBlYXJBY3RpdmVDbGFzczsKICB2YXIgYmVmb3JlRW50ZXIgPSBkYXRhLmJlZm9yZUVudGVyOwogIHZhciBlbnRlciA9IGRhdGEuZW50ZXI7CiAgdmFyIGFmdGVyRW50ZXIgPSBkYXRhLmFmdGVyRW50ZXI7CiAgdmFyIGVudGVyQ2FuY2VsbGVkID0gZGF0YS5lbnRlckNhbmNlbGxlZDsKICB2YXIgYmVmb3JlQXBwZWFyID0gZGF0YS5iZWZvcmVBcHBlYXI7CiAgdmFyIGFwcGVhciA9IGRhdGEuYXBwZWFyOwogIHZhciBhZnRlckFwcGVhciA9IGRhdGEuYWZ0ZXJBcHBlYXI7CiAgdmFyIGFwcGVhckNhbmNlbGxlZCA9IGRhdGEuYXBwZWFyQ2FuY2VsbGVkOwogIHZhciBkdXJhdGlvbiA9IGRhdGEuZHVyYXRpb247IC8vIGFjdGl2ZUluc3RhbmNlIHdpbGwgYWx3YXlzIGJlIHRoZSA8dHJhbnNpdGlvbj4gY29tcG9uZW50IG1hbmFnaW5nIHRoaXMKICAvLyB0cmFuc2l0aW9uLiBPbmUgZWRnZSBjYXNlIHRvIGNoZWNrIGlzIHdoZW4gdGhlIDx0cmFuc2l0aW9uPiBpcyBwbGFjZWQKICAvLyBhcyB0aGUgcm9vdCBub2RlIG9mIGEgY2hpbGQgY29tcG9uZW50LiBJbiB0aGF0IGNhc2Ugd2UgbmVlZCB0byBjaGVjawogIC8vIDx0cmFuc2l0aW9uPidzIHBhcmVudCBmb3IgYXBwZWFyIGNoZWNrLgoKICB2YXIgY29udGV4dCA9IGFjdGl2ZUluc3RhbmNlOwogIHZhciB0cmFuc2l0aW9uTm9kZSA9IGFjdGl2ZUluc3RhbmNlLiR2bm9kZTsKCiAgd2hpbGUgKHRyYW5zaXRpb25Ob2RlICYmIHRyYW5zaXRpb25Ob2RlLnBhcmVudCkgewogICAgY29udGV4dCA9IHRyYW5zaXRpb25Ob2RlLmNvbnRleHQ7CiAgICB0cmFuc2l0aW9uTm9kZSA9IHRyYW5zaXRpb25Ob2RlLnBhcmVudDsKICB9CgogIHZhciBpc0FwcGVhciA9ICFjb250ZXh0Ll9pc01vdW50ZWQgfHwgIXZub2RlLmlzUm9vdEluc2VydDsKCiAgaWYgKGlzQXBwZWFyICYmICFhcHBlYXIgJiYgYXBwZWFyICE9PSAnJykgewogICAgcmV0dXJuOwogIH0KCiAgdmFyIHN0YXJ0Q2xhc3MgPSBpc0FwcGVhciAmJiBhcHBlYXJDbGFzcyA/IGFwcGVhckNsYXNzIDogZW50ZXJDbGFzczsKICB2YXIgYWN0aXZlQ2xhc3MgPSBpc0FwcGVhciAmJiBhcHBlYXJBY3RpdmVDbGFzcyA/IGFwcGVhckFjdGl2ZUNsYXNzIDogZW50ZXJBY3RpdmVDbGFzczsKICB2YXIgdG9DbGFzcyA9IGlzQXBwZWFyICYmIGFwcGVhclRvQ2xhc3MgPyBhcHBlYXJUb0NsYXNzIDogZW50ZXJUb0NsYXNzOwogIHZhciBiZWZvcmVFbnRlckhvb2sgPSBpc0FwcGVhciA/IGJlZm9yZUFwcGVhciB8fCBiZWZvcmVFbnRlciA6IGJlZm9yZUVudGVyOwogIHZhciBlbnRlckhvb2sgPSBpc0FwcGVhciA/IHR5cGVvZiBhcHBlYXIgPT09ICdmdW5jdGlvbicgPyBhcHBlYXIgOiBlbnRlciA6IGVudGVyOwogIHZhciBhZnRlckVudGVySG9vayA9IGlzQXBwZWFyID8gYWZ0ZXJBcHBlYXIgfHwgYWZ0ZXJFbnRlciA6IGFmdGVyRW50ZXI7CiAgdmFyIGVudGVyQ2FuY2VsbGVkSG9vayA9IGlzQXBwZWFyID8gYXBwZWFyQ2FuY2VsbGVkIHx8IGVudGVyQ2FuY2VsbGVkIDogZW50ZXJDYW5jZWxsZWQ7CiAgdmFyIGV4cGxpY2l0RW50ZXJEdXJhdGlvbiA9IHRvTnVtYmVyKGlzT2JqZWN0KGR1cmF0aW9uKSA/IGR1cmF0aW9uLmVudGVyIDogZHVyYXRpb24pOwoKICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyAmJiBleHBsaWNpdEVudGVyRHVyYXRpb24gIT0gbnVsbCkgewogICAgY2hlY2tEdXJhdGlvbihleHBsaWNpdEVudGVyRHVyYXRpb24sICdlbnRlcicsIHZub2RlKTsKICB9CgogIHZhciBleHBlY3RzQ1NTID0gY3NzICE9PSBmYWxzZSAmJiAhaXNJRTk7CiAgdmFyIHVzZXJXYW50c0NvbnRyb2wgPSBnZXRIb29rQXJndW1lbnRzTGVuZ3RoKGVudGVySG9vayk7CiAgdmFyIGNiID0gZWwuX2VudGVyQ2IgPSBvbmNlKGZ1bmN0aW9uICgpIHsKICAgIGlmIChleHBlY3RzQ1NTKSB7CiAgICAgIHJlbW92ZVRyYW5zaXRpb25DbGFzcyhlbCwgdG9DbGFzcyk7CiAgICAgIHJlbW92ZVRyYW5zaXRpb25DbGFzcyhlbCwgYWN0aXZlQ2xhc3MpOwogICAgfQoKICAgIGlmIChjYi5jYW5jZWxsZWQpIHsKICAgICAgaWYgKGV4cGVjdHNDU1MpIHsKICAgICAgICByZW1vdmVUcmFuc2l0aW9uQ2xhc3MoZWwsIHN0YXJ0Q2xhc3MpOwogICAgICB9CgogICAgICBlbnRlckNhbmNlbGxlZEhvb2sgJiYgZW50ZXJDYW5jZWxsZWRIb29rKGVsKTsKICAgIH0gZWxzZSB7CiAgICAgIGFmdGVyRW50ZXJIb29rICYmIGFmdGVyRW50ZXJIb29rKGVsKTsKICAgIH0KCiAgICBlbC5fZW50ZXJDYiA9IG51bGw7CiAgfSk7CgogIGlmICghdm5vZGUuZGF0YS5zaG93KSB7CiAgICAvLyByZW1vdmUgcGVuZGluZyBsZWF2ZSBlbGVtZW50IG9uIGVudGVyIGJ5IGluamVjdGluZyBhbiBpbnNlcnQgaG9vawogICAgbWVyZ2VWTm9kZUhvb2sodm5vZGUsICdpbnNlcnQnLCBmdW5jdGlvbiAoKSB7CiAgICAgIHZhciBwYXJlbnQgPSBlbC5wYXJlbnROb2RlOwogICAgICB2YXIgcGVuZGluZ05vZGUgPSBwYXJlbnQgJiYgcGFyZW50Ll9wZW5kaW5nICYmIHBhcmVudC5fcGVuZGluZ1t2bm9kZS5rZXldOwoKICAgICAgaWYgKHBlbmRpbmdOb2RlICYmIHBlbmRpbmdOb2RlLnRhZyA9PT0gdm5vZGUudGFnICYmIHBlbmRpbmdOb2RlLmVsbS5fbGVhdmVDYikgewogICAgICAgIHBlbmRpbmdOb2RlLmVsbS5fbGVhdmVDYigpOwogICAgICB9CgogICAgICBlbnRlckhvb2sgJiYgZW50ZXJIb29rKGVsLCBjYik7CiAgICB9KTsKICB9IC8vIHN0YXJ0IGVudGVyIHRyYW5zaXRpb24KCgogIGJlZm9yZUVudGVySG9vayAmJiBiZWZvcmVFbnRlckhvb2soZWwpOwoKICBpZiAoZXhwZWN0c0NTUykgewogICAgYWRkVHJhbnNpdGlvbkNsYXNzKGVsLCBzdGFydENsYXNzKTsKICAgIGFkZFRyYW5zaXRpb25DbGFzcyhlbCwgYWN0aXZlQ2xhc3MpOwogICAgbmV4dEZyYW1lKGZ1bmN0aW9uICgpIHsKICAgICAgcmVtb3ZlVHJhbnNpdGlvbkNsYXNzKGVsLCBzdGFydENsYXNzKTsKCiAgICAgIGlmICghY2IuY2FuY2VsbGVkKSB7CiAgICAgICAgYWRkVHJhbnNpdGlvbkNsYXNzKGVsLCB0b0NsYXNzKTsKCiAgICAgICAgaWYgKCF1c2VyV2FudHNDb250cm9sKSB7CiAgICAgICAgICBpZiAoaXNWYWxpZER1cmF0aW9uKGV4cGxpY2l0RW50ZXJEdXJhdGlvbikpIHsKICAgICAgICAgICAgc2V0VGltZW91dChjYiwgZXhwbGljaXRFbnRlckR1cmF0aW9uKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHdoZW5UcmFuc2l0aW9uRW5kcyhlbCwgdHlwZSwgY2IpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgfQoKICBpZiAodm5vZGUuZGF0YS5zaG93KSB7CiAgICB0b2dnbGVEaXNwbGF5ICYmIHRvZ2dsZURpc3BsYXkoKTsKICAgIGVudGVySG9vayAmJiBlbnRlckhvb2soZWwsIGNiKTsKICB9CgogIGlmICghZXhwZWN0c0NTUyAmJiAhdXNlcldhbnRzQ29udHJvbCkgewogICAgY2IoKTsKICB9Cn0KCmZ1bmN0aW9uIGxlYXZlKHZub2RlLCBybSkgewogIHZhciBlbCA9IHZub2RlLmVsbTsgLy8gY2FsbCBlbnRlciBjYWxsYmFjayBub3cKCiAgaWYgKGlzRGVmKGVsLl9lbnRlckNiKSkgewogICAgZWwuX2VudGVyQ2IuY2FuY2VsbGVkID0gdHJ1ZTsKCiAgICBlbC5fZW50ZXJDYigpOwogIH0KCiAgdmFyIGRhdGEgPSByZXNvbHZlVHJhbnNpdGlvbih2bm9kZS5kYXRhLnRyYW5zaXRpb24pOwoKICBpZiAoaXNVbmRlZihkYXRhKSB8fCBlbC5ub2RlVHlwZSAhPT0gMSkgewogICAgcmV0dXJuIHJtKCk7CiAgfQogIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwoKCiAgaWYgKGlzRGVmKGVsLl9sZWF2ZUNiKSkgewogICAgcmV0dXJuOwogIH0KCiAgdmFyIGNzcyA9IGRhdGEuY3NzOwogIHZhciB0eXBlID0gZGF0YS50eXBlOwogIHZhciBsZWF2ZUNsYXNzID0gZGF0YS5sZWF2ZUNsYXNzOwogIHZhciBsZWF2ZVRvQ2xhc3MgPSBkYXRhLmxlYXZlVG9DbGFzczsKICB2YXIgbGVhdmVBY3RpdmVDbGFzcyA9IGRhdGEubGVhdmVBY3RpdmVDbGFzczsKICB2YXIgYmVmb3JlTGVhdmUgPSBkYXRhLmJlZm9yZUxlYXZlOwogIHZhciBsZWF2ZSA9IGRhdGEubGVhdmU7CiAgdmFyIGFmdGVyTGVhdmUgPSBkYXRhLmFmdGVyTGVhdmU7CiAgdmFyIGxlYXZlQ2FuY2VsbGVkID0gZGF0YS5sZWF2ZUNhbmNlbGxlZDsKICB2YXIgZGVsYXlMZWF2ZSA9IGRhdGEuZGVsYXlMZWF2ZTsKICB2YXIgZHVyYXRpb24gPSBkYXRhLmR1cmF0aW9uOwogIHZhciBleHBlY3RzQ1NTID0gY3NzICE9PSBmYWxzZSAmJiAhaXNJRTk7CiAgdmFyIHVzZXJXYW50c0NvbnRyb2wgPSBnZXRIb29rQXJndW1lbnRzTGVuZ3RoKGxlYXZlKTsKICB2YXIgZXhwbGljaXRMZWF2ZUR1cmF0aW9uID0gdG9OdW1iZXIoaXNPYmplY3QoZHVyYXRpb24pID8gZHVyYXRpb24ubGVhdmUgOiBkdXJhdGlvbik7CgogIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIGlzRGVmKGV4cGxpY2l0TGVhdmVEdXJhdGlvbikpIHsKICAgIGNoZWNrRHVyYXRpb24oZXhwbGljaXRMZWF2ZUR1cmF0aW9uLCAnbGVhdmUnLCB2bm9kZSk7CiAgfQoKICB2YXIgY2IgPSBlbC5fbGVhdmVDYiA9IG9uY2UoZnVuY3Rpb24gKCkgewogICAgaWYgKGVsLnBhcmVudE5vZGUgJiYgZWwucGFyZW50Tm9kZS5fcGVuZGluZykgewogICAgICBlbC5wYXJlbnROb2RlLl9wZW5kaW5nW3Zub2RlLmtleV0gPSBudWxsOwogICAgfQoKICAgIGlmIChleHBlY3RzQ1NTKSB7CiAgICAgIHJlbW92ZVRyYW5zaXRpb25DbGFzcyhlbCwgbGVhdmVUb0NsYXNzKTsKICAgICAgcmVtb3ZlVHJhbnNpdGlvbkNsYXNzKGVsLCBsZWF2ZUFjdGl2ZUNsYXNzKTsKICAgIH0KCiAgICBpZiAoY2IuY2FuY2VsbGVkKSB7CiAgICAgIGlmIChleHBlY3RzQ1NTKSB7CiAgICAgICAgcmVtb3ZlVHJhbnNpdGlvbkNsYXNzKGVsLCBsZWF2ZUNsYXNzKTsKICAgICAgfQoKICAgICAgbGVhdmVDYW5jZWxsZWQgJiYgbGVhdmVDYW5jZWxsZWQoZWwpOwogICAgfSBlbHNlIHsKICAgICAgcm0oKTsKICAgICAgYWZ0ZXJMZWF2ZSAmJiBhZnRlckxlYXZlKGVsKTsKICAgIH0KCiAgICBlbC5fbGVhdmVDYiA9IG51bGw7CiAgfSk7CgogIGlmIChkZWxheUxlYXZlKSB7CiAgICBkZWxheUxlYXZlKHBlcmZvcm1MZWF2ZSk7CiAgfSBlbHNlIHsKICAgIHBlcmZvcm1MZWF2ZSgpOwogIH0KCiAgZnVuY3Rpb24gcGVyZm9ybUxlYXZlKCkgewogICAgLy8gdGhlIGRlbGF5ZWQgbGVhdmUgbWF5IGhhdmUgYWxyZWFkeSBiZWVuIGNhbmNlbGxlZAogICAgaWYgKGNiLmNhbmNlbGxlZCkgewogICAgICByZXR1cm47CiAgICB9IC8vIHJlY29yZCBsZWF2aW5nIGVsZW1lbnQKCgogICAgaWYgKCF2bm9kZS5kYXRhLnNob3cgJiYgZWwucGFyZW50Tm9kZSkgewogICAgICAoZWwucGFyZW50Tm9kZS5fcGVuZGluZyB8fCAoZWwucGFyZW50Tm9kZS5fcGVuZGluZyA9IHt9KSlbdm5vZGUua2V5XSA9IHZub2RlOwogICAgfQoKICAgIGJlZm9yZUxlYXZlICYmIGJlZm9yZUxlYXZlKGVsKTsKCiAgICBpZiAoZXhwZWN0c0NTUykgewogICAgICBhZGRUcmFuc2l0aW9uQ2xhc3MoZWwsIGxlYXZlQ2xhc3MpOwogICAgICBhZGRUcmFuc2l0aW9uQ2xhc3MoZWwsIGxlYXZlQWN0aXZlQ2xhc3MpOwogICAgICBuZXh0RnJhbWUoZnVuY3Rpb24gKCkgewogICAgICAgIHJlbW92ZVRyYW5zaXRpb25DbGFzcyhlbCwgbGVhdmVDbGFzcyk7CgogICAgICAgIGlmICghY2IuY2FuY2VsbGVkKSB7CiAgICAgICAgICBhZGRUcmFuc2l0aW9uQ2xhc3MoZWwsIGxlYXZlVG9DbGFzcyk7CgogICAgICAgICAgaWYgKCF1c2VyV2FudHNDb250cm9sKSB7CiAgICAgICAgICAgIGlmIChpc1ZhbGlkRHVyYXRpb24oZXhwbGljaXRMZWF2ZUR1cmF0aW9uKSkgewogICAgICAgICAgICAgIHNldFRpbWVvdXQoY2IsIGV4cGxpY2l0TGVhdmVEdXJhdGlvbik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgd2hlblRyYW5zaXRpb25FbmRzKGVsLCB0eXBlLCBjYik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgfQoKICAgIGxlYXZlICYmIGxlYXZlKGVsLCBjYik7CgogICAgaWYgKCFleHBlY3RzQ1NTICYmICF1c2VyV2FudHNDb250cm9sKSB7CiAgICAgIGNiKCk7CiAgICB9CiAgfQp9IC8vIG9ubHkgdXNlZCBpbiBkZXYgbW9kZQoKCmZ1bmN0aW9uIGNoZWNrRHVyYXRpb24odmFsLCBuYW1lLCB2bm9kZSkgewogIGlmICh0eXBlb2YgdmFsICE9PSAnbnVtYmVyJykgewogICAgd2FybigiPHRyYW5zaXRpb24+IGV4cGxpY2l0ICIgKyBuYW1lICsgIiBkdXJhdGlvbiBpcyBub3QgYSB2YWxpZCBudW1iZXIgLSAiICsgImdvdCAiICsgSlNPTi5zdHJpbmdpZnkodmFsKSArICIuIiwgdm5vZGUuY29udGV4dCk7CiAgfSBlbHNlIGlmIChpc05hTih2YWwpKSB7CiAgICB3YXJuKCI8dHJhbnNpdGlvbj4gZXhwbGljaXQgIiArIG5hbWUgKyAiIGR1cmF0aW9uIGlzIE5hTiAtICIgKyAndGhlIGR1cmF0aW9uIGV4cHJlc3Npb24gbWlnaHQgYmUgaW5jb3JyZWN0LicsIHZub2RlLmNvbnRleHQpOwogIH0KfQoKZnVuY3Rpb24gaXNWYWxpZER1cmF0aW9uKHZhbCkgewogIHJldHVybiB0eXBlb2YgdmFsID09PSAnbnVtYmVyJyAmJiAhaXNOYU4odmFsKTsKfQovKioKICogTm9ybWFsaXplIGEgdHJhbnNpdGlvbiBob29rJ3MgYXJndW1lbnQgbGVuZ3RoLiBUaGUgaG9vayBtYXkgYmU6CiAqIC0gYSBtZXJnZWQgaG9vayAoaW52b2tlcikgd2l0aCB0aGUgb3JpZ2luYWwgaW4gLmZucwogKiAtIGEgd3JhcHBlZCBjb21wb25lbnQgbWV0aG9kIChjaGVjayAuX2xlbmd0aCkKICogLSBhIHBsYWluIGZ1bmN0aW9uICgubGVuZ3RoKQogKi8KCgpmdW5jdGlvbiBnZXRIb29rQXJndW1lbnRzTGVuZ3RoKGZuKSB7CiAgaWYgKGlzVW5kZWYoZm4pKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQoKICB2YXIgaW52b2tlckZucyA9IGZuLmZuczsKCiAgaWYgKGlzRGVmKGludm9rZXJGbnMpKSB7CiAgICAvLyBpbnZva2VyCiAgICByZXR1cm4gZ2V0SG9va0FyZ3VtZW50c0xlbmd0aChBcnJheS5pc0FycmF5KGludm9rZXJGbnMpID8gaW52b2tlckZuc1swXSA6IGludm9rZXJGbnMpOwogIH0gZWxzZSB7CiAgICByZXR1cm4gKGZuLl9sZW5ndGggfHwgZm4ubGVuZ3RoKSA+IDE7CiAgfQp9CgpmdW5jdGlvbiBfZW50ZXIoXywgdm5vZGUpIHsKICBpZiAodm5vZGUuZGF0YS5zaG93ICE9PSB0cnVlKSB7CiAgICBlbnRlcih2bm9kZSk7CiAgfQp9Cgp2YXIgdHJhbnNpdGlvbiA9IGluQnJvd3NlciA/IHsKICBjcmVhdGU6IF9lbnRlciwKICBhY3RpdmF0ZTogX2VudGVyLAogIHJlbW92ZTogZnVuY3Rpb24gcmVtb3ZlJCQxKHZub2RlLCBybSkgewogICAgLyogaXN0YW5idWwgaWdub3JlIGVsc2UgKi8KICAgIGlmICh2bm9kZS5kYXRhLnNob3cgIT09IHRydWUpIHsKICAgICAgbGVhdmUodm5vZGUsIHJtKTsKICAgIH0gZWxzZSB7CiAgICAgIHJtKCk7CiAgICB9CiAgfQp9IDoge307CnZhciBwbGF0Zm9ybU1vZHVsZXMgPSBbYXR0cnMsIGtsYXNzLCBldmVudHMsIGRvbVByb3BzLCBzdHlsZSwgdHJhbnNpdGlvbl07Ci8qICAqLwovLyB0aGUgZGlyZWN0aXZlIG1vZHVsZSBzaG91bGQgYmUgYXBwbGllZCBsYXN0LCBhZnRlciBhbGwKLy8gYnVpbHQtaW4gbW9kdWxlcyBoYXZlIGJlZW4gYXBwbGllZC4KCnZhciBtb2R1bGVzID0gcGxhdGZvcm1Nb2R1bGVzLmNvbmNhdChiYXNlTW9kdWxlcyk7CnZhciBwYXRjaCA9IGNyZWF0ZVBhdGNoRnVuY3Rpb24oewogIG5vZGVPcHM6IG5vZGVPcHMsCiAgbW9kdWxlczogbW9kdWxlcwp9KTsKLyoqCiAqIE5vdCB0eXBlIGNoZWNraW5nIHRoaXMgZmlsZSBiZWNhdXNlIGZsb3cgZG9lc24ndCBsaWtlIGF0dGFjaGluZwogKiBwcm9wZXJ0aWVzIHRvIEVsZW1lbnRzLgogKi8KCi8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwoKaWYgKGlzSUU5KSB7CiAgLy8gaHR0cDovL3d3dy5tYXR0czQxMS5jb20vcG9zdC9pbnRlcm5ldC1leHBsb3Jlci05LW9uaW5wdXQvCiAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignc2VsZWN0aW9uY2hhbmdlJywgZnVuY3Rpb24gKCkgewogICAgdmFyIGVsID0gZG9jdW1lbnQuYWN0aXZlRWxlbWVudDsKCiAgICBpZiAoZWwgJiYgZWwudm1vZGVsKSB7CiAgICAgIHRyaWdnZXIoZWwsICdpbnB1dCcpOwogICAgfQogIH0pOwp9Cgp2YXIgZGlyZWN0aXZlID0gewogIGluc2VydGVkOiBmdW5jdGlvbiBpbnNlcnRlZChlbCwgYmluZGluZywgdm5vZGUsIG9sZFZub2RlKSB7CiAgICBpZiAodm5vZGUudGFnID09PSAnc2VsZWN0JykgewogICAgICAvLyAjNjkwMwogICAgICBpZiAob2xkVm5vZGUuZWxtICYmICFvbGRWbm9kZS5lbG0uX3ZPcHRpb25zKSB7CiAgICAgICAgbWVyZ2VWTm9kZUhvb2sodm5vZGUsICdwb3N0cGF0Y2gnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBkaXJlY3RpdmUuY29tcG9uZW50VXBkYXRlZChlbCwgYmluZGluZywgdm5vZGUpOwogICAgICAgIH0pOwogICAgICB9IGVsc2UgewogICAgICAgIHNldFNlbGVjdGVkKGVsLCBiaW5kaW5nLCB2bm9kZS5jb250ZXh0KTsKICAgICAgfQoKICAgICAgZWwuX3ZPcHRpb25zID0gW10ubWFwLmNhbGwoZWwub3B0aW9ucywgZ2V0VmFsdWUpOwogICAgfSBlbHNlIGlmICh2bm9kZS50YWcgPT09ICd0ZXh0YXJlYScgfHwgaXNUZXh0SW5wdXRUeXBlKGVsLnR5cGUpKSB7CiAgICAgIGVsLl92TW9kaWZpZXJzID0gYmluZGluZy5tb2RpZmllcnM7CgogICAgICBpZiAoIWJpbmRpbmcubW9kaWZpZXJzLmxhenkpIHsKICAgICAgICBlbC5hZGRFdmVudExpc3RlbmVyKCdjb21wb3NpdGlvbnN0YXJ0Jywgb25Db21wb3NpdGlvblN0YXJ0KTsKICAgICAgICBlbC5hZGRFdmVudExpc3RlbmVyKCdjb21wb3NpdGlvbmVuZCcsIG9uQ29tcG9zaXRpb25FbmQpOyAvLyBTYWZhcmkgPCAxMC4yICYgVUlXZWJWaWV3IGRvZXNuJ3QgZmlyZSBjb21wb3NpdGlvbmVuZCB3aGVuCiAgICAgICAgLy8gc3dpdGNoaW5nIGZvY3VzIGJlZm9yZSBjb25maXJtaW5nIGNvbXBvc2l0aW9uIGNob2ljZQogICAgICAgIC8vIHRoaXMgYWxzbyBmaXhlcyB0aGUgaXNzdWUgd2hlcmUgc29tZSBicm93c2VycyBlLmcuIGlPUyBDaHJvbWUKICAgICAgICAvLyBmaXJlcyAiY2hhbmdlIiBpbnN0ZWFkIG9mICJpbnB1dCIgb24gYXV0b2NvbXBsZXRlLgoKICAgICAgICBlbC5hZGRFdmVudExpc3RlbmVyKCdjaGFuZ2UnLCBvbkNvbXBvc2l0aW9uRW5kKTsKICAgICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KCiAgICAgICAgaWYgKGlzSUU5KSB7CiAgICAgICAgICBlbC52bW9kZWwgPSB0cnVlOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0sCiAgY29tcG9uZW50VXBkYXRlZDogZnVuY3Rpb24gY29tcG9uZW50VXBkYXRlZChlbCwgYmluZGluZywgdm5vZGUpIHsKICAgIGlmICh2bm9kZS50YWcgPT09ICdzZWxlY3QnKSB7CiAgICAgIHNldFNlbGVjdGVkKGVsLCBiaW5kaW5nLCB2bm9kZS5jb250ZXh0KTsgLy8gaW4gY2FzZSB0aGUgb3B0aW9ucyByZW5kZXJlZCBieSB2LWZvciBoYXZlIGNoYW5nZWQsCiAgICAgIC8vIGl0J3MgcG9zc2libGUgdGhhdCB0aGUgdmFsdWUgaXMgb3V0LW9mLXN5bmMgd2l0aCB0aGUgcmVuZGVyZWQgb3B0aW9ucy4KICAgICAgLy8gZGV0ZWN0IHN1Y2ggY2FzZXMgYW5kIGZpbHRlciBvdXQgdmFsdWVzIHRoYXQgbm8gbG9uZ2VyIGhhcyBhIG1hdGNoaW5nCiAgICAgIC8vIG9wdGlvbiBpbiB0aGUgRE9NLgoKICAgICAgdmFyIHByZXZPcHRpb25zID0gZWwuX3ZPcHRpb25zOwogICAgICB2YXIgY3VyT3B0aW9ucyA9IGVsLl92T3B0aW9ucyA9IFtdLm1hcC5jYWxsKGVsLm9wdGlvbnMsIGdldFZhbHVlKTsKCiAgICAgIGlmIChjdXJPcHRpb25zLnNvbWUoZnVuY3Rpb24gKG8sIGkpIHsKICAgICAgICByZXR1cm4gIWxvb3NlRXF1YWwobywgcHJldk9wdGlvbnNbaV0pOwogICAgICB9KSkgewogICAgICAgIC8vIHRyaWdnZXIgY2hhbmdlIGV2ZW50IGlmCiAgICAgICAgLy8gbm8gbWF0Y2hpbmcgb3B0aW9uIGZvdW5kIGZvciBhdCBsZWFzdCBvbmUgdmFsdWUKICAgICAgICB2YXIgbmVlZFJlc2V0ID0gZWwubXVsdGlwbGUgPyBiaW5kaW5nLnZhbHVlLnNvbWUoZnVuY3Rpb24gKHYpIHsKICAgICAgICAgIHJldHVybiBoYXNOb01hdGNoaW5nT3B0aW9uKHYsIGN1ck9wdGlvbnMpOwogICAgICAgIH0pIDogYmluZGluZy52YWx1ZSAhPT0gYmluZGluZy5vbGRWYWx1ZSAmJiBoYXNOb01hdGNoaW5nT3B0aW9uKGJpbmRpbmcudmFsdWUsIGN1ck9wdGlvbnMpOwoKICAgICAgICBpZiAobmVlZFJlc2V0KSB7CiAgICAgICAgICB0cmlnZ2VyKGVsLCAnY2hhbmdlJyk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQp9OwoKZnVuY3Rpb24gc2V0U2VsZWN0ZWQoZWwsIGJpbmRpbmcsIHZtKSB7CiAgYWN0dWFsbHlTZXRTZWxlY3RlZChlbCwgYmluZGluZywgdm0pOwogIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwoKICBpZiAoaXNJRSB8fCBpc0VkZ2UpIHsKICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICBhY3R1YWxseVNldFNlbGVjdGVkKGVsLCBiaW5kaW5nLCB2bSk7CiAgICB9LCAwKTsKICB9Cn0KCmZ1bmN0aW9uIGFjdHVhbGx5U2V0U2VsZWN0ZWQoZWwsIGJpbmRpbmcsIHZtKSB7CiAgdmFyIHZhbHVlID0gYmluZGluZy52YWx1ZTsKICB2YXIgaXNNdWx0aXBsZSA9IGVsLm11bHRpcGxlOwoKICBpZiAoaXNNdWx0aXBsZSAmJiAhQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHsKICAgIHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgd2FybigiPHNlbGVjdCBtdWx0aXBsZSB2LW1vZGVsPVwiIiArIGJpbmRpbmcuZXhwcmVzc2lvbiArICJcIj4gIiArICJleHBlY3RzIGFuIEFycmF5IHZhbHVlIGZvciBpdHMgYmluZGluZywgYnV0IGdvdCAiICsgT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHZhbHVlKS5zbGljZSg4LCAtMSksIHZtKTsKICAgIHJldHVybjsKICB9CgogIHZhciBzZWxlY3RlZCwgb3B0aW9uOwoKICBmb3IgKHZhciBpID0gMCwgbCA9IGVsLm9wdGlvbnMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICBvcHRpb24gPSBlbC5vcHRpb25zW2ldOwoKICAgIGlmIChpc011bHRpcGxlKSB7CiAgICAgIHNlbGVjdGVkID0gbG9vc2VJbmRleE9mKHZhbHVlLCBnZXRWYWx1ZShvcHRpb24pKSA+IC0xOwoKICAgICAgaWYgKG9wdGlvbi5zZWxlY3RlZCAhPT0gc2VsZWN0ZWQpIHsKICAgICAgICBvcHRpb24uc2VsZWN0ZWQgPSBzZWxlY3RlZDsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgaWYgKGxvb3NlRXF1YWwoZ2V0VmFsdWUob3B0aW9uKSwgdmFsdWUpKSB7CiAgICAgICAgaWYgKGVsLnNlbGVjdGVkSW5kZXggIT09IGkpIHsKICAgICAgICAgIGVsLnNlbGVjdGVkSW5kZXggPSBpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICB9CiAgfQoKICBpZiAoIWlzTXVsdGlwbGUpIHsKICAgIGVsLnNlbGVjdGVkSW5kZXggPSAtMTsKICB9Cn0KCmZ1bmN0aW9uIGhhc05vTWF0Y2hpbmdPcHRpb24odmFsdWUsIG9wdGlvbnMpIHsKICByZXR1cm4gb3B0aW9ucy5ldmVyeShmdW5jdGlvbiAobykgewogICAgcmV0dXJuICFsb29zZUVxdWFsKG8sIHZhbHVlKTsKICB9KTsKfQoKZnVuY3Rpb24gZ2V0VmFsdWUob3B0aW9uKSB7CiAgcmV0dXJuICdfdmFsdWUnIGluIG9wdGlvbiA/IG9wdGlvbi5fdmFsdWUgOiBvcHRpb24udmFsdWU7Cn0KCmZ1bmN0aW9uIG9uQ29tcG9zaXRpb25TdGFydChlKSB7CiAgZS50YXJnZXQuY29tcG9zaW5nID0gdHJ1ZTsKfQoKZnVuY3Rpb24gb25Db21wb3NpdGlvbkVuZChlKSB7CiAgLy8gcHJldmVudCB0cmlnZ2VyaW5nIGFuIGlucHV0IGV2ZW50IGZvciBubyByZWFzb24KICBpZiAoIWUudGFyZ2V0LmNvbXBvc2luZykgewogICAgcmV0dXJuOwogIH0KCiAgZS50YXJnZXQuY29tcG9zaW5nID0gZmFsc2U7CiAgdHJpZ2dlcihlLnRhcmdldCwgJ2lucHV0Jyk7Cn0KCmZ1bmN0aW9uIHRyaWdnZXIoZWwsIHR5cGUpIHsKICB2YXIgZSA9IGRvY3VtZW50LmNyZWF0ZUV2ZW50KCdIVE1MRXZlbnRzJyk7CiAgZS5pbml0RXZlbnQodHlwZSwgdHJ1ZSwgdHJ1ZSk7CiAgZWwuZGlzcGF0Y2hFdmVudChlKTsKfQovKiAgKi8KLy8gcmVjdXJzaXZlbHkgc2VhcmNoIGZvciBwb3NzaWJsZSB0cmFuc2l0aW9uIGRlZmluZWQgaW5zaWRlIHRoZSBjb21wb25lbnQgcm9vdAoKCmZ1bmN0aW9uIGxvY2F0ZU5vZGUodm5vZGUpIHsKICByZXR1cm4gdm5vZGUuY29tcG9uZW50SW5zdGFuY2UgJiYgKCF2bm9kZS5kYXRhIHx8ICF2bm9kZS5kYXRhLnRyYW5zaXRpb24pID8gbG9jYXRlTm9kZSh2bm9kZS5jb21wb25lbnRJbnN0YW5jZS5fdm5vZGUpIDogdm5vZGU7Cn0KCnZhciBzaG93ID0gewogIGJpbmQ6IGZ1bmN0aW9uIGJpbmQoZWwsIHJlZiwgdm5vZGUpIHsKICAgIHZhciB2YWx1ZSA9IHJlZi52YWx1ZTsKICAgIHZub2RlID0gbG9jYXRlTm9kZSh2bm9kZSk7CiAgICB2YXIgdHJhbnNpdGlvbiQkMSA9IHZub2RlLmRhdGEgJiYgdm5vZGUuZGF0YS50cmFuc2l0aW9uOwogICAgdmFyIG9yaWdpbmFsRGlzcGxheSA9IGVsLl9fdk9yaWdpbmFsRGlzcGxheSA9IGVsLnN0eWxlLmRpc3BsYXkgPT09ICdub25lJyA/ICcnIDogZWwuc3R5bGUuZGlzcGxheTsKCiAgICBpZiAodmFsdWUgJiYgdHJhbnNpdGlvbiQkMSkgewogICAgICB2bm9kZS5kYXRhLnNob3cgPSB0cnVlOwogICAgICBlbnRlcih2bm9kZSwgZnVuY3Rpb24gKCkgewogICAgICAgIGVsLnN0eWxlLmRpc3BsYXkgPSBvcmlnaW5hbERpc3BsYXk7CiAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgZWwuc3R5bGUuZGlzcGxheSA9IHZhbHVlID8gb3JpZ2luYWxEaXNwbGF5IDogJ25vbmUnOwogICAgfQogIH0sCiAgdXBkYXRlOiBmdW5jdGlvbiB1cGRhdGUoZWwsIHJlZiwgdm5vZGUpIHsKICAgIHZhciB2YWx1ZSA9IHJlZi52YWx1ZTsKICAgIHZhciBvbGRWYWx1ZSA9IHJlZi5vbGRWYWx1ZTsKICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwoKICAgIGlmICghdmFsdWUgPT09ICFvbGRWYWx1ZSkgewogICAgICByZXR1cm47CiAgICB9CgogICAgdm5vZGUgPSBsb2NhdGVOb2RlKHZub2RlKTsKICAgIHZhciB0cmFuc2l0aW9uJCQxID0gdm5vZGUuZGF0YSAmJiB2bm9kZS5kYXRhLnRyYW5zaXRpb247CgogICAgaWYgKHRyYW5zaXRpb24kJDEpIHsKICAgICAgdm5vZGUuZGF0YS5zaG93ID0gdHJ1ZTsKCiAgICAgIGlmICh2YWx1ZSkgewogICAgICAgIGVudGVyKHZub2RlLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBlbC5zdHlsZS5kaXNwbGF5ID0gZWwuX192T3JpZ2luYWxEaXNwbGF5OwogICAgICAgIH0pOwogICAgICB9IGVsc2UgewogICAgICAgIGxlYXZlKHZub2RlLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBlbC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgIH0pOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBlbC5zdHlsZS5kaXNwbGF5ID0gdmFsdWUgPyBlbC5fX3ZPcmlnaW5hbERpc3BsYXkgOiAnbm9uZSc7CiAgICB9CiAgfSwKICB1bmJpbmQ6IGZ1bmN0aW9uIHVuYmluZChlbCwgYmluZGluZywgdm5vZGUsIG9sZFZub2RlLCBpc0Rlc3Ryb3kpIHsKICAgIGlmICghaXNEZXN0cm95KSB7CiAgICAgIGVsLnN0eWxlLmRpc3BsYXkgPSBlbC5fX3ZPcmlnaW5hbERpc3BsYXk7CiAgICB9CiAgfQp9Owp2YXIgcGxhdGZvcm1EaXJlY3RpdmVzID0gewogIG1vZGVsOiBkaXJlY3RpdmUsCiAgc2hvdzogc2hvdwp9OwovKiAgKi8KCnZhciB0cmFuc2l0aW9uUHJvcHMgPSB7CiAgbmFtZTogU3RyaW5nLAogIGFwcGVhcjogQm9vbGVhbiwKICBjc3M6IEJvb2xlYW4sCiAgbW9kZTogU3RyaW5nLAogIHR5cGU6IFN0cmluZywKICBlbnRlckNsYXNzOiBTdHJpbmcsCiAgbGVhdmVDbGFzczogU3RyaW5nLAogIGVudGVyVG9DbGFzczogU3RyaW5nLAogIGxlYXZlVG9DbGFzczogU3RyaW5nLAogIGVudGVyQWN0aXZlQ2xhc3M6IFN0cmluZywKICBsZWF2ZUFjdGl2ZUNsYXNzOiBTdHJpbmcsCiAgYXBwZWFyQ2xhc3M6IFN0cmluZywKICBhcHBlYXJBY3RpdmVDbGFzczogU3RyaW5nLAogIGFwcGVhclRvQ2xhc3M6IFN0cmluZywKICBkdXJhdGlvbjogW051bWJlciwgU3RyaW5nLCBPYmplY3RdCn07IC8vIGluIGNhc2UgdGhlIGNoaWxkIGlzIGFsc28gYW4gYWJzdHJhY3QgY29tcG9uZW50LCBlLmcuIDxrZWVwLWFsaXZlPgovLyB3ZSB3YW50IHRvIHJlY3Vyc2l2ZWx5IHJldHJpZXZlIHRoZSByZWFsIGNvbXBvbmVudCB0byBiZSByZW5kZXJlZAoKZnVuY3Rpb24gZ2V0UmVhbENoaWxkKHZub2RlKSB7CiAgdmFyIGNvbXBPcHRpb25zID0gdm5vZGUgJiYgdm5vZGUuY29tcG9uZW50T3B0aW9uczsKCiAgaWYgKGNvbXBPcHRpb25zICYmIGNvbXBPcHRpb25zLkN0b3Iub3B0aW9uc1siYWJzdHJhY3QiXSkgewogICAgcmV0dXJuIGdldFJlYWxDaGlsZChnZXRGaXJzdENvbXBvbmVudENoaWxkKGNvbXBPcHRpb25zLmNoaWxkcmVuKSk7CiAgfSBlbHNlIHsKICAgIHJldHVybiB2bm9kZTsKICB9Cn0KCmZ1bmN0aW9uIGV4dHJhY3RUcmFuc2l0aW9uRGF0YShjb21wKSB7CiAgdmFyIGRhdGEgPSB7fTsKICB2YXIgb3B0aW9ucyA9IGNvbXAuJG9wdGlvbnM7IC8vIHByb3BzCgogIGZvciAodmFyIGtleSBpbiBvcHRpb25zLnByb3BzRGF0YSkgewogICAgZGF0YVtrZXldID0gY29tcFtrZXldOwogIH0gLy8gZXZlbnRzLgogIC8vIGV4dHJhY3QgbGlzdGVuZXJzIGFuZCBwYXNzIHRoZW0gZGlyZWN0bHkgdG8gdGhlIHRyYW5zaXRpb24gbWV0aG9kcwoKCiAgdmFyIGxpc3RlbmVycyA9IG9wdGlvbnMuX3BhcmVudExpc3RlbmVyczsKCiAgZm9yICh2YXIga2V5JDEgaW4gbGlzdGVuZXJzKSB7CiAgICBkYXRhW2NhbWVsaXplKGtleSQxKV0gPSBsaXN0ZW5lcnNba2V5JDFdOwogIH0KCiAgcmV0dXJuIGRhdGE7Cn0KCmZ1bmN0aW9uIHBsYWNlaG9sZGVyKGgsIHJhd0NoaWxkKSB7CiAgaWYgKC9cZC1rZWVwLWFsaXZlJC8udGVzdChyYXdDaGlsZC50YWcpKSB7CiAgICByZXR1cm4gaCgna2VlcC1hbGl2ZScsIHsKICAgICAgcHJvcHM6IHJhd0NoaWxkLmNvbXBvbmVudE9wdGlvbnMucHJvcHNEYXRhCiAgICB9KTsKICB9Cn0KCmZ1bmN0aW9uIGhhc1BhcmVudFRyYW5zaXRpb24odm5vZGUpIHsKICB3aGlsZSAodm5vZGUgPSB2bm9kZS5wYXJlbnQpIHsKICAgIGlmICh2bm9kZS5kYXRhLnRyYW5zaXRpb24pIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgfQp9CgpmdW5jdGlvbiBpc1NhbWVDaGlsZChjaGlsZCwgb2xkQ2hpbGQpIHsKICByZXR1cm4gb2xkQ2hpbGQua2V5ID09PSBjaGlsZC5rZXkgJiYgb2xkQ2hpbGQudGFnID09PSBjaGlsZC50YWc7Cn0KCnZhciBpc05vdFRleHROb2RlID0gZnVuY3Rpb24gaXNOb3RUZXh0Tm9kZShjKSB7CiAgcmV0dXJuIGMudGFnIHx8IGlzQXN5bmNQbGFjZWhvbGRlcihjKTsKfTsKCnZhciBpc1ZTaG93RGlyZWN0aXZlID0gZnVuY3Rpb24gaXNWU2hvd0RpcmVjdGl2ZShkKSB7CiAgcmV0dXJuIGQubmFtZSA9PT0gJ3Nob3cnOwp9OwoKdmFyIFRyYW5zaXRpb24gPSB7CiAgbmFtZTogJ3RyYW5zaXRpb24nLAogIHByb3BzOiB0cmFuc2l0aW9uUHJvcHMsCiAgImFic3RyYWN0IjogdHJ1ZSwKICByZW5kZXI6IGZ1bmN0aW9uIHJlbmRlcihoKSB7CiAgICB2YXIgdGhpcyQxID0gdGhpczsKICAgIHZhciBjaGlsZHJlbiA9IHRoaXMuJHNsb3RzWyJkZWZhdWx0Il07CgogICAgaWYgKCFjaGlsZHJlbikgewogICAgICByZXR1cm47CiAgICB9IC8vIGZpbHRlciBvdXQgdGV4dCBub2RlcyAocG9zc2libGUgd2hpdGVzcGFjZXMpCgoKICAgIGNoaWxkcmVuID0gY2hpbGRyZW4uZmlsdGVyKGlzTm90VGV4dE5vZGUpOwogICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCgogICAgaWYgKCFjaGlsZHJlbi5sZW5ndGgpIHsKICAgICAgcmV0dXJuOwogICAgfSAvLyB3YXJuIG11bHRpcGxlIGVsZW1lbnRzCgoKICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIGNoaWxkcmVuLmxlbmd0aCA+IDEpIHsKICAgICAgd2FybignPHRyYW5zaXRpb24+IGNhbiBvbmx5IGJlIHVzZWQgb24gYSBzaW5nbGUgZWxlbWVudC4gVXNlICcgKyAnPHRyYW5zaXRpb24tZ3JvdXA+IGZvciBsaXN0cy4nLCB0aGlzLiRwYXJlbnQpOwogICAgfQoKICAgIHZhciBtb2RlID0gdGhpcy5tb2RlOyAvLyB3YXJuIGludmFsaWQgbW9kZQoKICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nICYmIG1vZGUgJiYgbW9kZSAhPT0gJ2luLW91dCcgJiYgbW9kZSAhPT0gJ291dC1pbicpIHsKICAgICAgd2FybignaW52YWxpZCA8dHJhbnNpdGlvbj4gbW9kZTogJyArIG1vZGUsIHRoaXMuJHBhcmVudCk7CiAgICB9CgogICAgdmFyIHJhd0NoaWxkID0gY2hpbGRyZW5bMF07IC8vIGlmIHRoaXMgaXMgYSBjb21wb25lbnQgcm9vdCBub2RlIGFuZCB0aGUgY29tcG9uZW50J3MKICAgIC8vIHBhcmVudCBjb250YWluZXIgbm9kZSBhbHNvIGhhcyB0cmFuc2l0aW9uLCBza2lwLgoKICAgIGlmIChoYXNQYXJlbnRUcmFuc2l0aW9uKHRoaXMuJHZub2RlKSkgewogICAgICByZXR1cm4gcmF3Q2hpbGQ7CiAgICB9IC8vIGFwcGx5IHRyYW5zaXRpb24gZGF0YSB0byBjaGlsZAogICAgLy8gdXNlIGdldFJlYWxDaGlsZCgpIHRvIGlnbm9yZSBhYnN0cmFjdCBjb21wb25lbnRzIGUuZy4ga2VlcC1hbGl2ZQoKCiAgICB2YXIgY2hpbGQgPSBnZXRSZWFsQ2hpbGQocmF3Q2hpbGQpOwogICAgLyogaXN0YW5idWwgaWdub3JlIGlmICovCgogICAgaWYgKCFjaGlsZCkgewogICAgICByZXR1cm4gcmF3Q2hpbGQ7CiAgICB9CgogICAgaWYgKHRoaXMuX2xlYXZpbmcpIHsKICAgICAgcmV0dXJuIHBsYWNlaG9sZGVyKGgsIHJhd0NoaWxkKTsKICAgIH0gLy8gZW5zdXJlIGEga2V5IHRoYXQgaXMgdW5pcXVlIHRvIHRoZSB2bm9kZSB0eXBlIGFuZCB0byB0aGlzIHRyYW5zaXRpb24KICAgIC8vIGNvbXBvbmVudCBpbnN0YW5jZS4gVGhpcyBrZXkgd2lsbCBiZSB1c2VkIHRvIHJlbW92ZSBwZW5kaW5nIGxlYXZpbmcgbm9kZXMKICAgIC8vIGR1cmluZyBlbnRlcmluZy4KCgogICAgdmFyIGlkID0gIl9fdHJhbnNpdGlvbi0iICsgdGhpcy5fdWlkICsgIi0iOwogICAgY2hpbGQua2V5ID0gY2hpbGQua2V5ID09IG51bGwgPyBjaGlsZC5pc0NvbW1lbnQgPyBpZCArICdjb21tZW50JyA6IGlkICsgY2hpbGQudGFnIDogaXNQcmltaXRpdmUoY2hpbGQua2V5KSA/IFN0cmluZyhjaGlsZC5rZXkpLmluZGV4T2YoaWQpID09PSAwID8gY2hpbGQua2V5IDogaWQgKyBjaGlsZC5rZXkgOiBjaGlsZC5rZXk7CiAgICB2YXIgZGF0YSA9IChjaGlsZC5kYXRhIHx8IChjaGlsZC5kYXRhID0ge30pKS50cmFuc2l0aW9uID0gZXh0cmFjdFRyYW5zaXRpb25EYXRhKHRoaXMpOwogICAgdmFyIG9sZFJhd0NoaWxkID0gdGhpcy5fdm5vZGU7CiAgICB2YXIgb2xkQ2hpbGQgPSBnZXRSZWFsQ2hpbGQob2xkUmF3Q2hpbGQpOyAvLyBtYXJrIHYtc2hvdwogICAgLy8gc28gdGhhdCB0aGUgdHJhbnNpdGlvbiBtb2R1bGUgY2FuIGhhbmQgb3ZlciB0aGUgY29udHJvbCB0byB0aGUgZGlyZWN0aXZlCgogICAgaWYgKGNoaWxkLmRhdGEuZGlyZWN0aXZlcyAmJiBjaGlsZC5kYXRhLmRpcmVjdGl2ZXMuc29tZShpc1ZTaG93RGlyZWN0aXZlKSkgewogICAgICBjaGlsZC5kYXRhLnNob3cgPSB0cnVlOwogICAgfQoKICAgIGlmIChvbGRDaGlsZCAmJiBvbGRDaGlsZC5kYXRhICYmICFpc1NhbWVDaGlsZChjaGlsZCwgb2xkQ2hpbGQpICYmICFpc0FzeW5jUGxhY2Vob2xkZXIob2xkQ2hpbGQpICYmIC8vICM2Njg3IGNvbXBvbmVudCByb290IGlzIGEgY29tbWVudCBub2RlCiAgICAhKG9sZENoaWxkLmNvbXBvbmVudEluc3RhbmNlICYmIG9sZENoaWxkLmNvbXBvbmVudEluc3RhbmNlLl92bm9kZS5pc0NvbW1lbnQpKSB7CiAgICAgIC8vIHJlcGxhY2Ugb2xkIGNoaWxkIHRyYW5zaXRpb24gZGF0YSB3aXRoIGZyZXNoIG9uZQogICAgICAvLyBpbXBvcnRhbnQgZm9yIGR5bmFtaWMgdHJhbnNpdGlvbnMhCiAgICAgIHZhciBvbGREYXRhID0gb2xkQ2hpbGQuZGF0YS50cmFuc2l0aW9uID0gZXh0ZW5kKHt9LCBkYXRhKTsgLy8gaGFuZGxlIHRyYW5zaXRpb24gbW9kZQoKICAgICAgaWYgKG1vZGUgPT09ICdvdXQtaW4nKSB7CiAgICAgICAgLy8gcmV0dXJuIHBsYWNlaG9sZGVyIG5vZGUgYW5kIHF1ZXVlIHVwZGF0ZSB3aGVuIGxlYXZlIGZpbmlzaGVzCiAgICAgICAgdGhpcy5fbGVhdmluZyA9IHRydWU7CiAgICAgICAgbWVyZ2VWTm9kZUhvb2sob2xkRGF0YSwgJ2FmdGVyTGVhdmUnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICB0aGlzJDEuX2xlYXZpbmcgPSBmYWxzZTsKICAgICAgICAgIHRoaXMkMS4kZm9yY2VVcGRhdGUoKTsKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gcGxhY2Vob2xkZXIoaCwgcmF3Q2hpbGQpOwogICAgICB9IGVsc2UgaWYgKG1vZGUgPT09ICdpbi1vdXQnKSB7CiAgICAgICAgaWYgKGlzQXN5bmNQbGFjZWhvbGRlcihjaGlsZCkpIHsKICAgICAgICAgIHJldHVybiBvbGRSYXdDaGlsZDsKICAgICAgICB9CgogICAgICAgIHZhciBkZWxheWVkTGVhdmU7CgogICAgICAgIHZhciBwZXJmb3JtTGVhdmUgPSBmdW5jdGlvbiBwZXJmb3JtTGVhdmUoKSB7CiAgICAgICAgICBkZWxheWVkTGVhdmUoKTsKICAgICAgICB9OwoKICAgICAgICBtZXJnZVZOb2RlSG9vayhkYXRhLCAnYWZ0ZXJFbnRlcicsIHBlcmZvcm1MZWF2ZSk7CiAgICAgICAgbWVyZ2VWTm9kZUhvb2soZGF0YSwgJ2VudGVyQ2FuY2VsbGVkJywgcGVyZm9ybUxlYXZlKTsKICAgICAgICBtZXJnZVZOb2RlSG9vayhvbGREYXRhLCAnZGVsYXlMZWF2ZScsIGZ1bmN0aW9uIChsZWF2ZSkgewogICAgICAgICAgZGVsYXllZExlYXZlID0gbGVhdmU7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gcmF3Q2hpbGQ7CiAgfQp9OwovKiAgKi8KCnZhciBwcm9wcyA9IGV4dGVuZCh7CiAgdGFnOiBTdHJpbmcsCiAgbW92ZUNsYXNzOiBTdHJpbmcKfSwgdHJhbnNpdGlvblByb3BzKTsKZGVsZXRlIHByb3BzLm1vZGU7CnZhciBUcmFuc2l0aW9uR3JvdXAgPSB7CiAgcHJvcHM6IHByb3BzLAogIGJlZm9yZU1vdW50OiBmdW5jdGlvbiBiZWZvcmVNb3VudCgpIHsKICAgIHZhciB0aGlzJDEgPSB0aGlzOwogICAgdmFyIHVwZGF0ZSA9IHRoaXMuX3VwZGF0ZTsKCiAgICB0aGlzLl91cGRhdGUgPSBmdW5jdGlvbiAodm5vZGUsIGh5ZHJhdGluZykgewogICAgICB2YXIgcmVzdG9yZUFjdGl2ZUluc3RhbmNlID0gc2V0QWN0aXZlSW5zdGFuY2UodGhpcyQxKTsgLy8gZm9yY2UgcmVtb3ZpbmcgcGFzcwoKICAgICAgdGhpcyQxLl9fcGF0Y2hfXyh0aGlzJDEuX3Zub2RlLCB0aGlzJDEua2VwdCwgZmFsc2UsIC8vIGh5ZHJhdGluZwogICAgICB0cnVlIC8vIHJlbW92ZU9ubHkgKCFpbXBvcnRhbnQsIGF2b2lkcyB1bm5lY2Vzc2FyeSBtb3ZlcykKICAgICAgKTsKCiAgICAgIHRoaXMkMS5fdm5vZGUgPSB0aGlzJDEua2VwdDsKICAgICAgcmVzdG9yZUFjdGl2ZUluc3RhbmNlKCk7CiAgICAgIHVwZGF0ZS5jYWxsKHRoaXMkMSwgdm5vZGUsIGh5ZHJhdGluZyk7CiAgICB9OwogIH0sCiAgcmVuZGVyOiBmdW5jdGlvbiByZW5kZXIoaCkgewogICAgdmFyIHRhZyA9IHRoaXMudGFnIHx8IHRoaXMuJHZub2RlLmRhdGEudGFnIHx8ICdzcGFuJzsKICAgIHZhciBtYXAgPSBPYmplY3QuY3JlYXRlKG51bGwpOwogICAgdmFyIHByZXZDaGlsZHJlbiA9IHRoaXMucHJldkNoaWxkcmVuID0gdGhpcy5jaGlsZHJlbjsKICAgIHZhciByYXdDaGlsZHJlbiA9IHRoaXMuJHNsb3RzWyJkZWZhdWx0Il0gfHwgW107CiAgICB2YXIgY2hpbGRyZW4gPSB0aGlzLmNoaWxkcmVuID0gW107CiAgICB2YXIgdHJhbnNpdGlvbkRhdGEgPSBleHRyYWN0VHJhbnNpdGlvbkRhdGEodGhpcyk7CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCByYXdDaGlsZHJlbi5sZW5ndGg7IGkrKykgewogICAgICB2YXIgYyA9IHJhd0NoaWxkcmVuW2ldOwoKICAgICAgaWYgKGMudGFnKSB7CiAgICAgICAgaWYgKGMua2V5ICE9IG51bGwgJiYgU3RyaW5nKGMua2V5KS5pbmRleE9mKCdfX3ZsaXN0JykgIT09IDApIHsKICAgICAgICAgIGNoaWxkcmVuLnB1c2goYyk7CiAgICAgICAgICBtYXBbYy5rZXldID0gYzsKICAgICAgICAgIChjLmRhdGEgfHwgKGMuZGF0YSA9IHt9KSkudHJhbnNpdGlvbiA9IHRyYW5zaXRpb25EYXRhOwogICAgICAgIH0gZWxzZSBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJykgewogICAgICAgICAgdmFyIG9wdHMgPSBjLmNvbXBvbmVudE9wdGlvbnM7CiAgICAgICAgICB2YXIgbmFtZSA9IG9wdHMgPyBvcHRzLkN0b3Iub3B0aW9ucy5uYW1lIHx8IG9wdHMudGFnIHx8ICcnIDogYy50YWc7CiAgICAgICAgICB3YXJuKCI8dHJhbnNpdGlvbi1ncm91cD4gY2hpbGRyZW4gbXVzdCBiZSBrZXllZDogPCIgKyBuYW1lICsgIj4iKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBpZiAocHJldkNoaWxkcmVuKSB7CiAgICAgIHZhciBrZXB0ID0gW107CiAgICAgIHZhciByZW1vdmVkID0gW107CgogICAgICBmb3IgKHZhciBpJDEgPSAwOyBpJDEgPCBwcmV2Q2hpbGRyZW4ubGVuZ3RoOyBpJDErKykgewogICAgICAgIHZhciBjJDEgPSBwcmV2Q2hpbGRyZW5baSQxXTsKICAgICAgICBjJDEuZGF0YS50cmFuc2l0aW9uID0gdHJhbnNpdGlvbkRhdGE7CiAgICAgICAgYyQxLmRhdGEucG9zID0gYyQxLmVsbS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKCiAgICAgICAgaWYgKG1hcFtjJDEua2V5XSkgewogICAgICAgICAga2VwdC5wdXNoKGMkMSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJlbW92ZWQucHVzaChjJDEpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgdGhpcy5rZXB0ID0gaCh0YWcsIG51bGwsIGtlcHQpOwogICAgICB0aGlzLnJlbW92ZWQgPSByZW1vdmVkOwogICAgfQoKICAgIHJldHVybiBoKHRhZywgbnVsbCwgY2hpbGRyZW4pOwogIH0sCiAgdXBkYXRlZDogZnVuY3Rpb24gdXBkYXRlZCgpIHsKICAgIHZhciBjaGlsZHJlbiA9IHRoaXMucHJldkNoaWxkcmVuOwogICAgdmFyIG1vdmVDbGFzcyA9IHRoaXMubW92ZUNsYXNzIHx8ICh0aGlzLm5hbWUgfHwgJ3YnKSArICctbW92ZSc7CgogICAgaWYgKCFjaGlsZHJlbi5sZW5ndGggfHwgIXRoaXMuaGFzTW92ZShjaGlsZHJlblswXS5lbG0sIG1vdmVDbGFzcykpIHsKICAgICAgcmV0dXJuOwogICAgfSAvLyB3ZSBkaXZpZGUgdGhlIHdvcmsgaW50byB0aHJlZSBsb29wcyB0byBhdm9pZCBtaXhpbmcgRE9NIHJlYWRzIGFuZCB3cml0ZXMKICAgIC8vIGluIGVhY2ggaXRlcmF0aW9uIC0gd2hpY2ggaGVscHMgcHJldmVudCBsYXlvdXQgdGhyYXNoaW5nLgoKCiAgICBjaGlsZHJlbi5mb3JFYWNoKGNhbGxQZW5kaW5nQ2JzKTsKICAgIGNoaWxkcmVuLmZvckVhY2gocmVjb3JkUG9zaXRpb24pOwogICAgY2hpbGRyZW4uZm9yRWFjaChhcHBseVRyYW5zbGF0aW9uKTsgLy8gZm9yY2UgcmVmbG93IHRvIHB1dCBldmVyeXRoaW5nIGluIHBvc2l0aW9uCiAgICAvLyBhc3NpZ24gdG8gdGhpcyB0byBhdm9pZCBiZWluZyByZW1vdmVkIGluIHRyZWUtc2hha2luZwogICAgLy8gJGZsb3ctZGlzYWJsZS1saW5lCgogICAgdGhpcy5fcmVmbG93ID0gZG9jdW1lbnQuYm9keS5vZmZzZXRIZWlnaHQ7CiAgICBjaGlsZHJlbi5mb3JFYWNoKGZ1bmN0aW9uIChjKSB7CiAgICAgIGlmIChjLmRhdGEubW92ZWQpIHsKICAgICAgICB2YXIgZWwgPSBjLmVsbTsKICAgICAgICB2YXIgcyA9IGVsLnN0eWxlOwogICAgICAgIGFkZFRyYW5zaXRpb25DbGFzcyhlbCwgbW92ZUNsYXNzKTsKICAgICAgICBzLnRyYW5zZm9ybSA9IHMuV2Via2l0VHJhbnNmb3JtID0gcy50cmFuc2l0aW9uRHVyYXRpb24gPSAnJzsKICAgICAgICBlbC5hZGRFdmVudExpc3RlbmVyKHRyYW5zaXRpb25FbmRFdmVudCwgZWwuX21vdmVDYiA9IGZ1bmN0aW9uIGNiKGUpIHsKICAgICAgICAgIGlmIChlICYmIGUudGFyZ2V0ICE9PSBlbCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKCFlIHx8IC90cmFuc2Zvcm0kLy50ZXN0KGUucHJvcGVydHlOYW1lKSkgewogICAgICAgICAgICBlbC5yZW1vdmVFdmVudExpc3RlbmVyKHRyYW5zaXRpb25FbmRFdmVudCwgY2IpOwogICAgICAgICAgICBlbC5fbW92ZUNiID0gbnVsbDsKICAgICAgICAgICAgcmVtb3ZlVHJhbnNpdGlvbkNsYXNzKGVsLCBtb3ZlQ2xhc3MpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CiAgICB9KTsKICB9LAogIG1ldGhvZHM6IHsKICAgIGhhc01vdmU6IGZ1bmN0aW9uIGhhc01vdmUoZWwsIG1vdmVDbGFzcykgewogICAgICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICAgICAgaWYgKCFoYXNUcmFuc2l0aW9uKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqLwoKCiAgICAgIGlmICh0aGlzLl9oYXNNb3ZlKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2hhc01vdmU7CiAgICAgIH0gLy8gRGV0ZWN0IHdoZXRoZXIgYW4gZWxlbWVudCB3aXRoIHRoZSBtb3ZlIGNsYXNzIGFwcGxpZWQgaGFzCiAgICAgIC8vIENTUyB0cmFuc2l0aW9ucy4gU2luY2UgdGhlIGVsZW1lbnQgbWF5IGJlIGluc2lkZSBhbiBlbnRlcmluZwogICAgICAvLyB0cmFuc2l0aW9uIGF0IHRoaXMgdmVyeSBtb21lbnQsIHdlIG1ha2UgYSBjbG9uZSBvZiBpdCBhbmQgcmVtb3ZlCiAgICAgIC8vIGFsbCBvdGhlciB0cmFuc2l0aW9uIGNsYXNzZXMgYXBwbGllZCB0byBlbnN1cmUgb25seSB0aGUgbW92ZSBjbGFzcwogICAgICAvLyBpcyBhcHBsaWVkLgoKCiAgICAgIHZhciBjbG9uZSA9IGVsLmNsb25lTm9kZSgpOwoKICAgICAgaWYgKGVsLl90cmFuc2l0aW9uQ2xhc3NlcykgewogICAgICAgIGVsLl90cmFuc2l0aW9uQ2xhc3Nlcy5mb3JFYWNoKGZ1bmN0aW9uIChjbHMpIHsKICAgICAgICAgIHJlbW92ZUNsYXNzKGNsb25lLCBjbHMpOwogICAgICAgIH0pOwogICAgICB9CgogICAgICBhZGRDbGFzcyhjbG9uZSwgbW92ZUNsYXNzKTsKICAgICAgY2xvbmUuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgdGhpcy4kZWwuYXBwZW5kQ2hpbGQoY2xvbmUpOwogICAgICB2YXIgaW5mbyA9IGdldFRyYW5zaXRpb25JbmZvKGNsb25lKTsKICAgICAgdGhpcy4kZWwucmVtb3ZlQ2hpbGQoY2xvbmUpOwogICAgICByZXR1cm4gdGhpcy5faGFzTW92ZSA9IGluZm8uaGFzVHJhbnNmb3JtOwogICAgfQogIH0KfTsKCmZ1bmN0aW9uIGNhbGxQZW5kaW5nQ2JzKGMpIHsKICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KICBpZiAoYy5lbG0uX21vdmVDYikgewogICAgYy5lbG0uX21vdmVDYigpOwogIH0KICAvKiBpc3RhbmJ1bCBpZ25vcmUgaWYgKi8KCgogIGlmIChjLmVsbS5fZW50ZXJDYikgewogICAgYy5lbG0uX2VudGVyQ2IoKTsKICB9Cn0KCmZ1bmN0aW9uIHJlY29yZFBvc2l0aW9uKGMpIHsKICBjLmRhdGEubmV3UG9zID0gYy5lbG0uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7Cn0KCmZ1bmN0aW9uIGFwcGx5VHJhbnNsYXRpb24oYykgewogIHZhciBvbGRQb3MgPSBjLmRhdGEucG9zOwogIHZhciBuZXdQb3MgPSBjLmRhdGEubmV3UG9zOwogIHZhciBkeCA9IG9sZFBvcy5sZWZ0IC0gbmV3UG9zLmxlZnQ7CiAgdmFyIGR5ID0gb2xkUG9zLnRvcCAtIG5ld1Bvcy50b3A7CgogIGlmIChkeCB8fCBkeSkgewogICAgYy5kYXRhLm1vdmVkID0gdHJ1ZTsKICAgIHZhciBzID0gYy5lbG0uc3R5bGU7CiAgICBzLnRyYW5zZm9ybSA9IHMuV2Via2l0VHJhbnNmb3JtID0gInRyYW5zbGF0ZSgiICsgZHggKyAicHgsIiArIGR5ICsgInB4KSI7CiAgICBzLnRyYW5zaXRpb25EdXJhdGlvbiA9ICcwcyc7CiAgfQp9Cgp2YXIgcGxhdGZvcm1Db21wb25lbnRzID0gewogIFRyYW5zaXRpb246IFRyYW5zaXRpb24sCiAgVHJhbnNpdGlvbkdyb3VwOiBUcmFuc2l0aW9uR3JvdXAKfTsKLyogICovCi8vIGluc3RhbGwgcGxhdGZvcm0gc3BlY2lmaWMgdXRpbHMKClZ1ZS5jb25maWcubXVzdFVzZVByb3AgPSBtdXN0VXNlUHJvcDsKVnVlLmNvbmZpZy5pc1Jlc2VydmVkVGFnID0gaXNSZXNlcnZlZFRhZzsKVnVlLmNvbmZpZy5pc1Jlc2VydmVkQXR0ciA9IGlzUmVzZXJ2ZWRBdHRyOwpWdWUuY29uZmlnLmdldFRhZ05hbWVzcGFjZSA9IGdldFRhZ05hbWVzcGFjZTsKVnVlLmNvbmZpZy5pc1Vua25vd25FbGVtZW50ID0gaXNVbmtub3duRWxlbWVudDsgLy8gaW5zdGFsbCBwbGF0Zm9ybSBydW50aW1lIGRpcmVjdGl2ZXMgJiBjb21wb25lbnRzCgpleHRlbmQoVnVlLm9wdGlvbnMuZGlyZWN0aXZlcywgcGxhdGZvcm1EaXJlY3RpdmVzKTsKZXh0ZW5kKFZ1ZS5vcHRpb25zLmNvbXBvbmVudHMsIHBsYXRmb3JtQ29tcG9uZW50cyk7IC8vIGluc3RhbGwgcGxhdGZvcm0gcGF0Y2ggZnVuY3Rpb24KClZ1ZS5wcm90b3R5cGUuX19wYXRjaF9fID0gaW5Ccm93c2VyID8gcGF0Y2ggOiBub29wOyAvLyBwdWJsaWMgbW91bnQgbWV0aG9kCgpWdWUucHJvdG90eXBlLiRtb3VudCA9IGZ1bmN0aW9uIChlbCwgaHlkcmF0aW5nKSB7CiAgZWwgPSBlbCAmJiBpbkJyb3dzZXIgPyBxdWVyeShlbCkgOiB1bmRlZmluZWQ7CiAgcmV0dXJuIG1vdW50Q29tcG9uZW50KHRoaXMsIGVsLCBoeWRyYXRpbmcpOwp9OyAvLyBkZXZ0b29scyBnbG9iYWwgaG9vawoKLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi8KCgppZiAoaW5Ccm93c2VyKSB7CiAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICBpZiAoY29uZmlnLmRldnRvb2xzKSB7CiAgICAgIGlmIChkZXZ0b29scykgewogICAgICAgIGRldnRvb2xzLmVtaXQoJ2luaXQnLCBWdWUpOwogICAgICB9IGVsc2UgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICd0ZXN0JykgewogICAgICAgIGNvbnNvbGVbY29uc29sZS5pbmZvID8gJ2luZm8nIDogJ2xvZyddKCdEb3dubG9hZCB0aGUgVnVlIERldnRvb2xzIGV4dGVuc2lvbiBmb3IgYSBiZXR0ZXIgZGV2ZWxvcG1lbnQgZXhwZXJpZW5jZTpcbicgKyAnaHR0cHM6Ly9naXRodWIuY29tL3Z1ZWpzL3Z1ZS1kZXZ0b29scycpOwogICAgICB9CiAgICB9CgogICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgJiYgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICd0ZXN0JyAmJiBjb25maWcucHJvZHVjdGlvblRpcCAhPT0gZmFsc2UgJiYgdHlwZW9mIGNvbnNvbGUgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgIGNvbnNvbGVbY29uc29sZS5pbmZvID8gJ2luZm8nIDogJ2xvZyddKCJZb3UgYXJlIHJ1bm5pbmcgVnVlIGluIGRldmVsb3BtZW50IG1vZGUuXG4iICsgIk1ha2Ugc3VyZSB0byB0dXJuIG9uIHByb2R1Y3Rpb24gbW9kZSB3aGVuIGRlcGxveWluZyBmb3IgcHJvZHVjdGlvbi5cbiIgKyAiU2VlIG1vcmUgdGlwcyBhdCBodHRwczovL3Z1ZWpzLm9yZy9ndWlkZS9kZXBsb3ltZW50Lmh0bWwiKTsKICAgIH0KICB9LCAwKTsKfQovKiAgKi8KCgpleHBvcnQgZGVmYXVsdCBWdWU7"},null]}